<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta http-equiv="refresh" content="0; url=/">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dashboard (Deprecated)</title>
    <style>body{font-family:Arial,Helvetica,sans-serif;padding:2rem;text-align:center}</style>
</head>
<body>
    <h3>Plantilla obsoleta</h3>
    <p>Esta copia de <strong>dashboard</strong> está obsoleta. Se redirige al dashboard principal.</p>
    <p><a href="/">Ir al dashboard</a></p>
</body>
</html>
            
            <div class="col-md-2 d-none d-md-flex flex-column sidebar p-3" style="height: 100vh; overflow-y: auto;">
                
                <div class="logo-container text-center">
                    <!-- Logo completo -->
                    <img src="/static/logo-club-recrear.svg" alt="Club Recrear" class="logo-full">
                </div>

                <ul class="nav nav-pills flex-column flex-grow-1" id="dashboardTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active w-100 text-start" id="home-tab" data-bs-toggle="tab" data-bs-target="#home" type="button" role="tab">
                            <i class="bi bi-house-door-fill"></i> <span class="nav-text">Home</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link w-100 text-start" id="ticket-tab" data-bs-toggle="tab" data-bs-target="#ticket" type="button" role="tab">
                            <i class="bi bi-ticket-perforated-fill"></i> <span class="nav-text">Tickets</span>
                        </button>
                    </li>   
                    <li class="nav-item" role="presentation" id="adminNavItem">
                        <button class="nav-link w-100 text-start" id="admin-tab" data-bs-toggle="tab" data-bs-target="#admin" type="button" role="tab">
                            <i class="bi bi-shield-lock-fill"></i> <span class="nav-text">Admin</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link w-100 text-start" id="config-tab" data-bs-toggle="tab" data-bs-target="#config" type="button" role="tab">
                            <i class="bi bi-gear-fill"></i> <span class="nav-text">Config</span>
                        </button>
                    </li>
                    <li class="nav-item mt-2" role="presentation">
                        <button class="nav-link w-100 text-start btn-logout-sidebar" data-bs-toggle="modal" data-bs-target="#logoutModal">
                            <i class="bi bi-box-arrow-left"></i> <span class="nav-text">Salir</span>
                        </button>
                    </li>
                </ul>

            </div>

            <div class="col h-100 columna-cont">
                <div class="main-wrapper" id="main-content" role="main">
                    
                    <div class="tab-content" id="myTabContent">
                        
                        <div class="tab-pane fade show active" id="home" role="tabpanel">
                            <!-- Mobile Header - Solo en Home (sin filtros) -->
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <div>
                                    <h2 class="fw-bold title-gradient mb-1">Dashboard</h2>
                                    <p class="text-muted">Resumen de actividad de hoy</p>
                                </div>
                                <div class="d-flex align-items-center gap-3">
                                    <!-- Botón de Notificaciones -->
                                    <button class="notification-badge-btn d-none d-md-inline-flex" onclick="toggleNotifications()">
                                        <i class="bi bi-bell-fill text-muted fs-5"></i>
                                        <span class="badge-count" id="notifBadgeDesktop">0</span>
                                    </button>
                                    <!-- Botón de Solicitudes Pendientes -->
                                    <button class="btn btn-outline-primary rounded-pill position-relative d-none d-md-inline-flex align-items-center gap-2" data-bs-toggle="offcanvas" data-bs-target="#solicitudesOffcanvas" aria-controls="solicitudesOffcanvas">
                                        <i class="bi bi-inbox-fill"></i>
                                        <span>Solicitudes</span>
                                        <span class="badge bg-danger rounded-pill" id="solicitudesCounterDesktop">0</span>
                                    </button>
                                    <button class="btn btn-primary rounded-pill px-4 py-2 fw-bold d-none d-md-inline-block btn-new-ticket-pretty" style="box-shadow: 0 4px 15px rgba(0, 156, 180, 0.3);" data-bs-toggle="modal" data-bs-target="#newTicketModal">
                                        <i class="bi bi-plus-lg me-2"></i> Nuevo Ticket
                                    </button>
                                </div>
                            </div>

                            <div class="row g-4 mb-5">
                                <div class="col-md-4">
                                    <div class="kpi-card">
                                        <div class="kpi-icon icon-blue">
                                            <i class="bi bi-ticket-fill"></i>
                                        </div>
                                        <div>
                                            <p class="kpi-title">Tickets Abiertos</p>
                                            <h3 class="kpi-value" id="kpi-tickets-abiertos">0</h3>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="kpi-card">
                                        <div class="kpi-icon icon-teal">
                                            <i class="bi bi-bar-chart-fill"></i>
                                        </div>
                                        <div>
                                            <p class="kpi-title">Nuevos Hoy</p>
                                            <h3 class="kpi-value" id="kpi-nuevos-hoy">0</h3>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="kpi-card">
                                        <div class="kpi-icon icon-purple">
                                            <i class="bi bi-alarm-fill"></i>
                                        </div>
                                        <div>
                                            <p class="kpi-title">Mis Tickets</p>
                                            <h3 class="kpi-value" id="kpi-mis-tickets">0</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Tickets Recientes con Historial -->
                            <div class="row g-4 mb-4">
                                <div class="col-md-12">
                                    <div class="card border-0 shadow-sm rounded-4 p-4">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h5 class="fw-bold text-brand-blue mb-0">Tickets Recientes</h5>
                                            <button class="btn btn-sm btn-outline-secondary rounded-pill" disabled style="cursor: not-allowed;">
                                                <i class="bi bi-clock-history me-1"></i> Próximamente
                                            </button>
                                        </div>
                                        <div class="table-responsive">
                                            <table class="table table-hover align-middle recent-tickets-table">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th class="col-id">ID</th>
                                                        <th class="col-asunto">Asunto</th>
                                                        <th class="d-none d-md-table-cell col-emisor">Emisor</th>
                                                        <th class="d-none d-md-table-cell col-receptor">Receptor</th>
                                                        <th class="col-prioridad">Prioridad</th>
                                                        <th class="col-estado">Estado</th>
                                                        <th class="d-none d-md-table-cell col-acciones"></th>
                                                    </tr>
                                                </thead>
                                                <tbody id="recent-tickets-tbody">
                                                    <tr>
                                                        <td colspan="7" class="text-center text-muted py-4">
                                                            <i class="bi bi-hourglass-split fs-3 d-block mb-2"></i>
                                                            Cargando tickets recientes...
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Métricas Detalladas -->
                            <div class="row g-4 mb-4">
                                <div class="col-md-4 col-6">
                                    <div class="metric-card">
                                        <div class="metric-card-header">
                                            <span class="text-muted small">Resueltos Hoy</span>
                                        </div>
                                        <div class="metric-value" id="kpiResueltosHoy">0</div>
                                        <div class="mini-chart mt-2">
                                            <div class="chart-bar" style="height: 30%"></div>
                                            <div class="chart-bar" style="height: 50%"></div>
                                            <div class="chart-bar" style="height: 65%"></div>
                                            <div class="chart-bar" style="height: 45%"></div>
                                            <div class="chart-bar" style="height: 75%"></div>
                                            <div class="chart-bar" style="height: 60%"></div>
                                            <div class="chart-bar" style="height: 90%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="metric-card">
                                        <div class="metric-card-header">
                                            <span class="text-muted small">Satisfacción</span>
                                        </div>
                                        <div class="metric-value" id="kpiSatisfaccion">0%</div>
                                        <div class="progress mt-3" style="height: 8px;">
                                            <div class="progress-bar" role="progressbar" id="kpiSatisfaccionBar" style="width: 0%; background: var(--brand-gradient)"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="metric-card">
                                        <div class="metric-card-header">
                                            <span class="text-muted small">Pendientes</span>
                                        </div>
                                        <div class="metric-value" id="kpiPendientes">0</div>
                                        <div class="metric-badges" id="kpiPendientesBadges">
                                            <span class="text-muted small">Sin datos</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Dashboard de Métricas Avanzadas -->
                            <div class="row g-4 mb-4">
                                <div class="col-12">
                                    <div class="card border-0 shadow-sm rounded-4 p-4 blur-overlay-container">
                                        <!-- Overlay de Próximamente -->
                                        <div class="coming-soon-overlay">
                                            <div class="coming-soon-badge">
                                                <i class="bi bi-rocket-takeoff-fill"></i>
                                                Próximamente
                                            </div>
                                            <p class="mt-3 text-muted fw-medium d-none d-md-block" style="background: rgba(255,255,255,0.8); padding: 5px 15px; border-radius: 20px;">Estamos preparando métricas avanzadas para ti</p>
                                        </div>

                                        <div class="blur-content">
                                            <div class="d-flex justify-content-between align-items-center mb-4">
                                                <div>
                                                    <h5 class="fw-bold text-brand-blue mb-1">
                                                        <i class="bi bi-graph-up me-2"></i>Métricas Avanzadas
                                                    </h5>
                                                    <small class="text-muted">Análisis detallado del rendimiento</small>
                                                </div>
                                                <select class="form-select" style="width: auto;" onchange="updateMetricsPeriod(this.value)">
                                                    <option value="today">Hoy</option>
                                                    <option value="week">Esta Semana</option>
                                                    <option value="month" selected>Este Mes</option>
                                                    <option value="year">Este Año</option>
                                                </select>
                                            </div>

                                            <div class="row g-3 mb-4">
                                                <!-- Tasa de Resolución -->
                                                <div class="col-md-3 col-6">
                                                    <div class="advanced-metric-card">
                                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                                            <div class="metric-icon" style="background: rgba(25, 135, 84, 0.15); color: #198754;">
                                                                <i class="bi bi-check2-circle"></i>
                                                            </div>
                                                            <span class="badge bg-success-subtle text-success">+5.2%</span>
                                                        </div>
                                                        <h3 class="fw-bold mb-1">87%</h3>
                                                        <p class="text-muted small mb-0">Tasa Resolución</p>
                                                    </div>
                                                </div>

                                                <!-- Tiempo Respuesta Promedio -->
                                                <div class="col-md-3 col-6">
                                                    <div class="advanced-metric-card">
                                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                                            <div class="metric-icon" style="background: rgba(13, 202, 240, 0.15); color: #0dcaf0;">
                                                                <i class="bi bi-clock"></i>
                                                            </div>
                                                            <span class="badge bg-info-subtle text-info">-12%</span>
                                                        </div>
                                                        <h3 class="fw-bold mb-1">1.8h</h3>
                                                        <p class="text-muted small mb-0">Tiempo Respuesta</p>
                                                    </div>
                                                </div>

                                                <!-- CSAT Score -->
                                                <div class="col-md-3 col-6">
                                                    <div class="advanced-metric-card">
                                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                                            <div class="metric-icon" style="background: rgba(255, 193, 7, 0.15); color: #ffc107;">
                                                                <i class="bi bi-star-fill"></i>
                                                            </div>
                                                            <span class="badge bg-warning-subtle text-warning">+3.1%</span>
                                                        </div>
                                                        <h3 class="fw-bold mb-1">4.7</h3>
                                                        <p class="text-muted small mb-0">Calificación CSAT</p>
                                                    </div>
                                                </div>

                                                <!-- Tickets por Agente -->
                                                <div class="col-md-3 col-6">
                                                    <div class="advanced-metric-card">
                                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                                            <div class="metric-icon" style="background: rgba(111, 66, 193, 0.15); color: #6f42c1;">
                                                                <i class="bi bi-people"></i>
                                                            </div>
                                                            <span class="badge bg-secondary-subtle text-secondary">15.2</span>
                                                        </div>
                                                        <h3 class="fw-bold mb-1">76</h3>
                                                        <p class="text-muted small mb-0">Tickets/Agente</p>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Gráficos (placeholders para cuando se implemente) -->
                                            <div class="row g-3">
                                                <div class="col-md-8">
                                                    <div class="chart-placeholder">
                                                        <i class="bi bi-bar-chart-line fs-1 text-muted mb-3"></i>
                                                        <p class="text-muted">Gráfico de tendencias de tickets</p>
                                                        <small class="text-muted">Se implementará con Chart.js cuando conectes el backend</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="chart-placeholder">
                                                        <i class="bi bi-pie-chart fs-1 text-muted mb-3"></i>
                                                        <p class="text-muted">Distribución por canal</p>
                                                        <small class="text-muted">WhatsApp, Email, Chat</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Base de Conocimiento -->
                            <div class="card border-0 shadow-sm rounded-4 p-4 mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="fw-bold text-brand-blue mb-0">
                                        <i class="bi bi-book me-2"></i>Base de Conocimiento
                                    </h5>
                                    <button class="btn btn-sm btn-outline-primary rounded-pill" data-bs-toggle="modal" data-bs-target="#knowledgeBaseModal">
                                        Ver todo <i class="bi bi-arrow-right ms-1"></i>
                                    </button>
                                </div>
                                <div class="row g-3">
                                    <div class="col-md-3 col-6">
                                        <div class="kb-card" onclick="openKBCategory('tech')">
                                            <div class="kb-icon tech">
                                                <i class="bi bi-gear-wide-connected"></i>
                                            </div>
                                            <div class="kb-title">Soporte Técnico</div>
                                            <div class="kb-count">15 artículos</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-6">
                                        <div class="kb-card" onclick="openKBCategory('account')">
                                            <div class="kb-icon account">
                                                <i class="bi bi-person-badge"></i>
                                            </div>
                                            <div class="kb-title">Cuenta y Acceso</div>
                                            <div class="kb-count">12 artículos</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-6">
                                        <div class="kb-card" onclick="openKBCategory('payments')">
                                            <div class="kb-icon payments">
                                                <i class="bi bi-credit-card"></i>
                                            </div>
                                            <div class="kb-title">Pagos y Facturación</div>
                                            <div class="kb-count">8 artículos</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-6">
                                        <div class="kb-card" onclick="openKBCategory('general')">
                                            <div class="kb-icon general">
                                                <i class="bi bi-question-circle"></i>
                                            </div>
                                            <div class="kb-title">Preguntas Frecuentes</div>
                                            <div class="kb-count">20 artículos</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <div class="tab-pane fade" id="ticket" role="tabpanel">
                            <!-- Mobile Header - Solo en Tickets (con búsqueda y filtros) -->
                            <div class="d-md-none mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-3 px-3 pt-3">
                                    <h4 class="fw-bold text-brand-blue mb-0">Tickets</h4>
                                    <button class="btn btn-outline-primary" onclick="showFiltersModal()">
                                        <i class="bi bi-funnel"></i>
                                    </button>
                                </div>
                                
                                <!-- Filtros rápidos móvil -->
                                <div class="px-3 mb-3">
                                    <div class="d-flex gap-2 overflow-auto pb-2" style="-webkit-overflow-scrolling: touch; scrollbar-width: none;">
                                        <button class="btn btn-sm btn-primary rounded-pill active" onclick="filterMobileTickets('all')" style="white-space: nowrap; flex-shrink: 0;">
                                            <i class="bi bi-grid-fill me-1"></i>Todos
                                        </button>
                                        <button class="btn btn-sm btn-outline-warning rounded-pill" onclick="filterMobileTickets('pendiente')" style="white-space: nowrap; flex-shrink: 0;">
                                            Pendiente
                                        </button>
                                        <button class="btn btn-sm btn-outline-info rounded-pill" onclick="filterMobileTickets('en-proceso')" style="white-space: nowrap; flex-shrink: 0;">
                                            En Proceso
                                        </button>
                                        <button class="btn btn-sm btn-outline-success rounded-pill" onclick="filterMobileTickets('resuelto')" style="white-space: nowrap; flex-shrink: 0;">
                                            Resuelto
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger rounded-pill" onclick="filterMobileTickets('por-tomar')" style="white-space: nowrap; flex-shrink: 0;">
                                            <i class="bi bi-hand-thumbs-up me-1"></i>Por tomar
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Barra de búsqueda móvil -->
                                <div class="px-3">
                                    <div class="input-group">
                                        <span class="input-group-text bg-white border-end-0">
                                            <i class="bi bi-search text-muted"></i>
                                        </span>
                                        <input type="text" class="form-control border-start-0 ps-0" id="mobileSearchInput" placeholder="Buscar tickets...">
                                    </div>
                                    <div class="mt-2">
                                                <select class="form-select form-select-sm d-none" id="ticketOrderSelectMobile" aria-label="Ordenar tickets" onchange="onTicketOrderChange(this.value)">
                                                    <option value="desc">Nuevos</option>
                                                    <option value="asc">Viejos</option>
                                                </select>
                                                <div class="custom-order-dropdown" data-target-select="ticketOrderSelectMobile" tabindex="0" title="Ordenar tickets" aria-label="Ordenar tickets">
                                                    <div class="cod-selected"><span class="cod-text">Nuevos</span> <span class="cod-arrow" aria-hidden="true"></span> <span class="cod-icon"><i class="bi bi-chevron-down ms-2"></i></span></div>
                                                    <div class="cod-menu">
                                                        <div class="cod-item" data-value="desc">Nuevos</div>
                                                        <div class="cod-item" data-value="asc">Viejos</div>
                                                    </div>
                                                </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Mobile Tickets List (WhatsApp style) -->
                            <div class="tickets-list d-md-none" id="mobileTicketsList">
                                <!-- Los tickets se cargan dinámicamente desde la API -->
                            </div>

                            <!-- ========== NUEVO LAYOUT DESKTOP - 3 COLUMNAS ========== -->
                            <div class="tickets-main-container d-none d-md-flex">
                                
                                <!-- Panel Izquierdo - Lista de Tickets -->
                                <div class="tickets-list-panel">
                                    <div class="tickets-list-header">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h4>Tickets</h4>
                                            <div class="d-flex gap-2 align-items-center">
                                                <select class="form-select form-select-sm d-none" id="ticketOrderSelect" style="width: 160px;" aria-label="Ordenar tickets" onchange="onTicketOrderChange(this.value)">
                                                    <option value="desc">Nuevos</option>
                                                    <option value="asc">Viejos</option>
                                                </select>
                                                <div class="custom-order-dropdown" data-target-select="ticketOrderSelect" title="Ordenar tickets" aria-label="Ordenar tickets">
                                                    <div class="cod-selected"><span class="cod-text">Viejos</span> <span class="cod-arrow" aria-hidden="true"></span> <span class="cod-icon"><i class="bi bi-chevron-down ms-2"></i></span></div>
                                                    <div class="cod-menu">
                                                        <div class="cod-item" data-value="desc">Nuevos</div>
                                                        <div class="cod-item" data-value="asc">Viejos</div>
                                                    </div>
                                                </div>
                                                <!-- Botón de colapso de filtros -->
                                                <button class="btn btn-sm btn-outline-secondary rounded-circle" 
                                                        id="toggleFiltersBtn" 
                                                        onclick="toggleFiltersPanel()" 
                                                        title="Colapsar/Expandir filtros">
                                                    <i class="bi bi-chevron-up" id="toggleFiltersIcon"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-primary rounded-circle" data-bs-toggle="modal" data-bs-target="#filtersModal" title="Filtrar">
                                                    <i class="bi bi-funnel"></i>
                                                </button>
                                                <button class="btn btn-sm btn-primary rounded-circle" data-bs-toggle="modal" data-bs-target="#newTicketModal" title="Nuevo ticket" style="background: var(--brand-gradient); border: none;">
                                                    <i class="bi bi-plus-lg"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Contenedor colapsable de filtros -->
                                    <div id="filtersContainer" class="filters-collapsible-container">
                                    <!-- Filtros Rápidos de Estado -->
                                    <div class="tickets-quick-filters">
                                        <button class="quick-filter-btn filter-all" onclick="filterTicketsByStatus('all', this)">
                                            <i class="bi bi-grid-fill me-1"></i>Todos
                                        </button>
                                        <button class="quick-filter-btn filter-pending active" onclick="filterTicketsByStatus('pendiente', this)">
                                            Nuevo/Pendiente
                                        </button>
                                            <button class="quick-filter-btn filter-por-tomar" onclick="filterTicketsByStatus('por-tomar', this)">
                                                <i class="bi bi-hand-thumbs-up me-1"></i>Por tomar
                                            </button>
                                        <button class="quick-filter-btn filter-process active" onclick="filterTicketsByStatus('en-proceso', this)">
                                            En Proceso
                                        </button>
                                        <button class="quick-filter-btn filter-resolved" onclick="filterTicketsByStatus('resuelto', this)">
                                            Resuelto
                                        </button>
                                        <button class="quick-filter-btn filter-closed" onclick="filterTicketsByStatus('cerrado', this)">
                                            Cerrado
                                        </button>
                                        <!-- Botón 'Sin responder' eliminado; se mantiene 'Por tomar' -->
                                    </div>
                                    
                                    <!-- Filtros Rápidos de Prioridad -->
                                    <div class="tickets-quick-filters mt-2 mb-3 priority-filters">
                                        <button class="quick-filter-btn priority-filter-btn priority-critical" 
                                                onclick="filtrarPorPrioridad('urgente', this)" 
                                                data-prioridad="urgente"
                                                data-bs-toggle="tooltip" 
                                                data-bs-placement="top" 
                                                title="Prioridad Urgente">
                                            <i class="bi bi-exclamation-triangle-fill"></i>
                                        </button>
                                        <button class="quick-filter-btn priority-filter-btn priority-high" 
                                                onclick="filtrarPorPrioridad('alta', this)" 
                                                data-prioridad="alta"
                                                data-bs-toggle="tooltip" 
                                                data-bs-placement="top" 
                                                title="Prioridad Alta">
                                            <i class="bi bi-flag-fill"></i>
                                        </button>
                                        <button class="quick-filter-btn priority-filter-btn priority-normal" 
                                                onclick="filtrarPorPrioridad('media', this)" 
                                                data-prioridad="media"
                                                data-bs-toggle="tooltip" 
                                                data-bs-placement="top" 
                                                title="Prioridad Media">
                                            <i class="bi bi-flag"></i>
                                        </button>
                                        <button class="quick-filter-btn priority-filter-btn priority-low" 
                                                onclick="filtrarPorPrioridad('baja', this)" 
                                                data-prioridad="baja"
                                                data-bs-toggle="tooltip" 
                                                data-bs-placement="top" 
                                                title="Prioridad Baja">
                                            <i class="bi bi-flag"></i>
                                        </button>
                                    </div>
                                    
                                    <!-- Nuevos Filtros - Departamento, Receptor y Emisor -->
                                    <div class="tickets-advanced-filters">
                                        <div class="filter-group">
                                            <label class="filter-label">
                                                <i class="bi bi-building me-1"></i>Departamento
                                            </label>
                                            <select class="form-select form-select-sm filter-select" id="departmentFilter" onchange="onDepartmentFilterChange()">
                                                <option value="">Todos</option>
                                                <!-- Se cargan dinámicamente desde API -->
                                            </select>
                                        </div>
                                        <div class="filter-group">
                                            <label class="filter-label">
                                                <i class="bi bi-person-badge me-1"></i>Receptor
                                            </label>
                                            <select class="form-select form-select-sm filter-select" id="operatorFilter" onchange="applyAdvancedFilters()">
                                                <option value="">Todos</option>
                                                <!-- Se cargan dinámicamente desde API -->
                                            </select>
                                        </div>
                                        <div class="filter-group">
                                            <label class="filter-label">
                                                <i class="bi bi-person-circle me-1"></i>Emisor
                                            </label>
                                            <select class="form-select form-select-sm filter-select" id="senderFilter" onchange="applyAdvancedFilters()">
                                                <option value="">Todos</option>
                                                <!-- Se cargan dinámicamente desde API -->
                                            </select>
                                        </div>
                                    </div>
                                    </div>
                                    <!-- Fin contenedor colapsable -->
                                    
                                    <div class="tickets-search-bar">
                                        <div class="input-group">
                                            <span class="input-group-text bg-transparent border-0">
                                                <i class="bi bi-search text-muted"></i>
                                            </span>
                                            <input type="text" class="form-control" id="desktopSearchInput" placeholder="Buscar tickets...">
                                        </div>
                                    </div>
                                    
                                    <div class="tickets-scroll-container" id="ticketsScrollContainer">
                                        <!-- Los tickets se cargarán dinámicamente desde la API -->
                                        <div class="text-center py-5">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Cargando tickets...</span>
                                            </div>
                                            <p class="mt-3 text-muted">Cargando tickets desde la base de datos...</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Panel Central - Chat -->
                                <div class="tickets-chat-panel" id="ticketsChatPanel">
                                    <!-- Chat Header Compacto -->
                                    <div class="chat-header">
                                        <div class="d-flex align-items-center">
                                            <button class="btn btn-sm btn-outline-primary rounded-circle me-2" onclick="closeTicketChat()" style="width: 36px; height: 36px;" title="Volver al listado">
                                                <i class="bi bi-arrow-left"></i>
                                            </button>
                                            <div class="chat-user-avatar me-3" style="width: 45px; height: 45px; font-size: 1.4rem;">
                                                <i class="bi bi-person-circle"></i>
                                            </div>
                                            <div class="flex-grow-1 min-width-0">
                                                <div class="d-flex align-items-center gap-2 flex-wrap">
                                                    <h5 class="mb-0 fw-bold text-brand-blue" id="chatHeaderNombre">—</h5>
                                                    <span class="badge bg-secondary" style="font-size: 0.7rem;" id="chatHeaderTicketId">#—</span>
                                                    <span class="badge" id="chatHeaderEstado">—</span>
                                                    <span class="badge" id="chatHeaderPrioridad">—</span>
                                                    <span class="badge bg-info-subtle text-info" id="chatHeaderDepartamento" style="display: none; font-size: 0.7rem;">
                                                        <i class="bi bi-building me-1"></i><span id="chatHeaderDepartamentoText">—</span>
                                                    </span>
                                                    <span class="text-muted small" id="chatHeaderCanal" style="display: none;">
                                                        <i class="bi bi-dot"></i><i id="chatHeaderCanalIcon" class="bi bi-envelope-fill me-1"></i><span id="chatHeaderCanalText">Email</span>
                                                    </span>
                                                </div>
                                                <div class="d-flex align-items-center gap-2 flex-wrap">
                                                    <small class="text-muted text-truncate" id="chatHeaderAsunto" style="max-width: 400px;">Sin asunto</small>
                                                    <small class="text-muted" id="chatHeaderFecha" style="display: none;">
                                                        <i class="bi bi-calendar3 me-1"></i><span id="chatHeaderFechaText">—</span>
                                                    </small>
                                                </div>
                                            </div>
                                            <div class="d-flex align-items-center gap-2">
                                                <button class="btn btn-sm btn-outline-secondary rounded-circle d-xl-none" style="width: 36px; height: 36px;" data-bs-toggle="offcanvas" data-bs-target="#ticketDetailsOffcanvas" title="Ver detalles">
                                                    <i class="bi bi-info-circle"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Barra de acciones del ticket -->
                                    <div class="ticket-actions-bar">
                                        <!-- Cambiar Estado -->
                                        <div class="position-relative">
                                            <button class="ticket-action-btn" id="statusActionBtn" onclick="toggleActionDropdown('statusDropdown', event)" data-bs-toggle="tooltip" title="Cambiar estado del ticket">
                                                <i class="bi bi-arrow-repeat"></i>
                                                <span class="d-none d-md-inline">Estado</span>
                                            </button>
                                            <div class="ticket-action-dropdown" id="statusDropdown">
                                                <div class="ticket-action-dropdown-item status-pending" data-state="pendiente" onclick="changeTicketStatus('pendiente')">
                                                    <i class="bi bi-clock-fill"></i>
                                                    <span>Pendiente</span>
                                                </div>
                                                <div class="ticket-action-dropdown-item status-process" data-state="en-proceso" onclick="changeTicketStatus('en-proceso')">
                                                    <i class="bi bi-gear-fill"></i>
                                                    <span>En Proceso</span>
                                                </div>
                                                <div class="ticket-action-dropdown-item status-resolved" data-state="resuelto" onclick="changeTicketStatus('resuelto')">
                                                    <i class="bi bi-check-circle-fill"></i>
                                                    <span>Resuelto</span>
                                                </div>
                                                <div class="ticket-action-dropdown-item status-closed" data-state="cerrado" onclick="changeTicketStatus('cerrado')">
                                                    <i class="bi bi-x-circle-fill"></i>
                                                    <span>Cerrado</span>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Cambiar Prioridad -->
                                        <div class="position-relative">
                                            <button class="ticket-action-btn" onclick="toggleActionDropdown('priorityDropdown', event)" data-bs-toggle="tooltip" title="Cambiar prioridad">
                                                <i class="bi bi-flag-fill"></i>
                                                <span class="d-none d-md-inline">Prioridad</span>
                                            </button>
                                            <div class="ticket-action-dropdown" id="priorityDropdown">
                                                <div class="ticket-action-dropdown-item priority-critical" onclick="changeTicketPriority('urgente')">
                                                    <i class="bi bi-exclamation-triangle-fill text-danger"></i>
                                                    <span>Urgente</span>
                                                </div>
                                                <div class="ticket-action-dropdown-item priority-high" onclick="changeTicketPriority('alta')">
                                                    <i class="bi bi-flag-fill text-warning"></i>
                                                    <span>Alta</span>
                                                </div>
                                                <div class="ticket-action-dropdown-item priority-normal" onclick="changeTicketPriority('media')">
                                                    <i class="bi bi-flag-fill text-primary"></i>
                                                    <span>Media</span>
                                                </div>
                                                <div class="ticket-action-dropdown-item priority-low" onclick="changeTicketPriority('baja')">
                                                    <i class="bi bi-flag text-secondary"></i>
                                                    <span>Baja</span>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Asignar Agente -->
                                        <div class="position-relative">
                                            <button class="ticket-action-btn" onclick="toggleActionDropdown('assignDropdown', event)" data-bs-toggle="tooltip" title="Asignar o derivar a otro agente">
                                                <i class="bi bi-person-plus-fill"></i>
                                                <span class="d-none d-md-inline">Asignar</span>
                                            </button>
                                            <div class="ticket-action-dropdown" id="assignDropdown">
                                                <div class="ticket-action-dropdown-item" onclick="assignTicket('agente1')">
                                                    <i class="bi bi-person-circle"></i>
                                                    <span>Juan Martínez</span>
                                                </div>
                                                <div class="ticket-action-dropdown-item" onclick="assignTicket('agente2')">
                                                    <i class="bi bi-person-circle"></i>
                                                    <span>María García</span>
                                                </div>
                                                <div class="ticket-action-dropdown-item" onclick="assignTicket('agente3')">
                                                    <i class="bi bi-person-circle"></i>
                                                    <span>Carlos López</span>
                                                </div>
                                                <div class="ticket-action-dropdown-item" onclick="assignTicket('me')">
                                                    <i class="bi bi-person-check-fill"></i>
                                                    <span><strong>Asignarme a mí</strong></span>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Agregar Etiqueta -->
                                        <button class="ticket-action-btn" onclick="openTagModal()" data-bs-toggle="tooltip" title="Agregar etiquetas">
                                            <i class="bi bi-tag-fill"></i>
                                            <span class="d-none d-lg-inline">Etiquetas</span>
                                        </button>

                                        <!-- Nota Interna -->
                                        <button class="ticket-action-btn" onclick="toggleInternalNote()" data-bs-toggle="tooltip" title="Agregar nota interna (no visible para el cliente)">
                                            <i class="bi bi-pencil-square"></i>
                                            <span class="d-none d-lg-inline">Nota</span>
                                        </button>

                                        <!-- Más opciones -->
                                        <div class="position-relative ms-auto">
                                            <button class="ticket-action-btn btn-icon-only" onclick="toggleActionDropdown('moreOptionsDropdown', event)" data-bs-toggle="tooltip" title="Más opciones">
                                                <i class="bi bi-three-dots"></i>
                                            </button>
                                            <div class="ticket-action-dropdown" id="moreOptionsDropdown" style="right: 0; left: auto;">
                                                <div class="ticket-action-dropdown-item" onclick="mergeTickets()">
                                                    <i class="bi bi-link-45deg"></i>
                                                    <span>Fusionar tickets</span>
                                                </div>
                                                <div class="ticket-action-dropdown-item" onclick="exportTicket()">
                                                    <i class="bi bi-download"></i>
                                                    <span>Exportar conversación</span>
                                                </div>
                                                <div class="ticket-action-dropdown-item" onclick="printTicket()">
                                                    <i class="bi bi-printer"></i>
                                                    <span>Imprimir</span>
                                                </div>
                                                <div class="ticket-action-dropdown-item text-danger" onclick="deleteTicket()">
                                                    <i class="bi bi-trash-fill"></i>
                                                    <span>Eliminar ticket</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Chat Messages -->
                                    <div class="chat-messages" id="chatMessagesDesktop">
                                        <!-- Los mensajes se cargarán dinámicamente desde la API -->
                                    </div>

                                    <!-- Chat Input Compacto -->
                                    <div class="chat-input position-relative">
                                        <!-- Panel de Respuestas Rápidas Inline Desktop -->
                                        <div class="quick-replies-panel" id="quickRepliesInlineDesktop">
                                            <div class="p-3 border-bottom d-flex justify-content-between align-items-center bg-light">
                                                <span class="fw-bold text-brand-blue"><i class="bi bi-lightning-fill me-1"></i>Respuestas Rápidas</span>
                                                <button class="btn btn-sm btn-link p-0" onclick="toggleQuickRepliesDesktop()"><i class="bi bi-x-lg"></i></button>
                                            </div>
                                            <div class="quick-reply-item" onclick="insertQuickReplyDesktop('Hola, gracias por contactarnos. Mi nombre es María y estaré ayudándote con tu solicitud.')">
                                                <div class="quick-reply-title">Saludo Inicial</div>
                                                <div class="quick-reply-preview">Hola, gracias por contactarnos...</div>
                                            </div>
                                            <div class="quick-reply-item" onclick="insertQuickReplyDesktop('Para poder ayudarte mejor, necesito que me proporciones la siguiente información: tu nombre de usuario y una descripción detallada del problema.')">
                                                <div class="quick-reply-title">Solicitar Información</div>
                                                <div class="quick-reply-preview">Para poder ayudarte mejor...</div>
                                            </div>
                                            <div class="quick-reply-item" onclick="insertQuickReplyDesktop('Hemos enviado un enlace de recuperación a tu correo electrónico. Por favor revisa tu bandeja de entrada y la carpeta de spam.')">
                                                <div class="quick-reply-title">Reset de Contraseña</div>
                                                <div class="quick-reply-preview">Hemos enviado un enlace...</div>
                                            </div>
                                            <div class="quick-reply-item" onclick="insertQuickReplyDesktop('Me alegra que hayamos podido resolver tu problema. Si tienes alguna otra consulta, no dudes en contactarnos. ¡Que tengas un excelente día!')">
                                                <div class="quick-reply-title">Ticket Resuelto</div>
                                                <div class="quick-reply-preview">Me alegra que hayamos podido...</div>
                                            </div>
                                            <div class="p-2 border-top text-center">
                                                <a href="#" class="small text-brand-blue" data-bs-toggle="modal" data-bs-target="#quickRepliesModal" onclick="toggleQuickRepliesDesktop()">Ver todas las respuestas</a>
                                            </div>
                                        </div>
                                        <div class="w-100 d-flex flex-column">
                                            <!-- Barra de adjuntos seleccionados (tipo WhatsApp) -->
                                            <div id="chatAttachmentsBarDesktop" class="d-none mb-2">
                                                <div id="chatAttachmentsListDesktop" class="d-flex flex-wrap gap-2"></div>
                                            </div>

                                            <div class="d-flex align-items-center gap-2">
                                                <input type="file" id="fileAttachmentDesktop" multiple hidden>
                                                <button class="btn btn-link text-muted p-0" onclick="document.getElementById('fileAttachmentDesktop').click()" title="Adjuntar archivo">
                                                    <i class="bi bi-paperclip fs-5"></i>
                                                </button>
                                                <button class="btn btn-link text-muted p-0" onclick="toggleQuickRepliesDesktop()" title="Respuestas rápidas">
                                                    <i class="bi bi-lightning-fill fs-5"></i>
                                                </button>
                                                <input type="text" class="form-control border-0 flex-grow-1" id="chatMessageInputDesktop" placeholder="Escribe un mensaje...">
                                                <button class="btn btn-link p-0" onclick="sendChatMessageDesktop()">
                                                    <i class="bi bi-send-fill fs-5 text-brand-blue"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Panel Derecho - Detalles y Respuestas Rápidas -->
                                <div class="tickets-details-panel">
                                    <div class="tickets-details-header">
                                        <h5><i class="bi bi-info-circle me-2"></i>Detalles</h5>
                                    </div>
                                    
                                    <div class="tickets-details-content">
                                        <!-- Info del Ticket -->
                                        <div class="tickets-details-section">
                                            <h6>Información</h6>
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="text-muted small">ID:</span>
                                                <span class="fw-bold text-brand-blue">#1001</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="text-muted small">Canal:</span>
                                                <span class="d-flex align-items-center gap-1">
                                                    <i class="bi bi-envelope-fill text-primary"></i>
                                                    <span class="small">Email</span>
                                                </span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="text-muted small">Estado:</span>
                                                <span class="badge bg-warning text-dark">Pendiente</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="text-muted small">Prioridad:</span>
                                                <span class="badge bg-danger">Alta</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="text-muted small">Creado:</span>
                                                <span class="small">16/12/2025 10:30</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="text-muted small">Actualizado:</span>
                                                <span class="small">16/12/2025 10:37</span>
                                            </div>
                                        </div>
                                        
                                        <!-- Usuario -->
                                        <div class="tickets-details-section">
                                            <h6>Solicitante</h6>
                                            <div class="d-flex align-items-center gap-2">
                                                <div class="ticket-card-user-avatar" style="width: 36px; height: 36px; font-size: 0.85rem;">
                                                    <i class="bi bi-person-fill"></i>
                                                </div>
                                                <div>
                                                    <div class="fw-semibold">Juan Pérez</div>
                                                    <small class="text-muted">juan.perez@email.com</small>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Respuestas Rápidas -->
                                        <div class="tickets-details-section">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h6 class="mb-0"><i class="bi bi-lightning-fill me-1"></i>Respuestas Rápidas</h6>
                                                <a href="#" class="small text-brand-blue" data-bs-toggle="modal" data-bs-target="#quickRepliesModal">Ver más</a>
                                            </div>
                                            <!-- Respuestas rápidas unificadas (móvil y desktop) -->
                                            <div class="quick-replies-compact-container">
                                                <div class="text-center text-muted py-3 small">
                                                    <i class="bi bi-hourglass-split"></i> Cargando...
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Acciones -->
                                        <div class="tickets-details-section">
                                            <h6>Acciones</h6>
                                            <div class="d-grid gap-2">
                                                <button class="btn btn-outline-primary btn-sm">
                                                    <i class="bi bi-check-circle me-2"></i> Cambiar Estado
                                                </button>
                                                <button class="btn btn-outline-primary btn-sm">
                                                    <i class="bi bi-flag me-2"></i> Cambiar Prioridad
                                                </button>
                                                <button class="btn btn-outline-danger btn-sm">
                                                    <i class="bi bi-x-circle me-2"></i> Cerrar Ticket
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- ========== FIN NUEVO LAYOUT DESKTOP ========== -->

                            <!-- Chat Container Mobile (cuando se selecciona un ticket) -->
                            <div class="chat-container d-none" id="mobileChatContainer">
                                <!-- Chat Header -->
                                <div class="chat-header">
                                    <div class="d-flex align-items-center">
                                        <button class="btn btn-link text-brand-blue p-0 me-3" id="chatBackButton" type="button" onclick="closeMobileChat(); return false;">
                                            <i class="bi bi-arrow-left fs-4"></i>
                                        </button>
                                        <div class="chat-user-avatar me-3">
                                            <i class="bi bi-person-circle"></i>
                                        </div>
                                        <div class="flex-grow-1 cursor-pointer" data-bs-toggle="offcanvas" data-bs-target="#ticketDetailsOffcanvas" style="cursor: pointer;">
                                            <h5 class="mb-0 fw-bold text-brand-blue">
                                                <span id="chatHeaderNombreMobile">—</span> 
                                                <span class="badge bg-secondary" style="font-size: 0.65rem;" id="chatHeaderTicketIdMobile">#—</span>
                                            </h5>
                                            <small class="text-muted" id="chatHeaderAsuntoMobile">Sin asunto</small>
                                        </div>
                                        <div class="d-flex align-items-center gap-2">
                                            <div class="d-flex flex-column gap-1">
                                                <span class="badge d-flex align-items-center justify-content-center px-2 py-1" id="chatHeaderEstadoMobile" style="min-width:80px; font-size: 0.75rem;">—</span>
                                                <span class="badge d-flex align-items-center justify-content-center px-2 py-1" id="chatHeaderPrioridadMobile" style="min-width:80px; font-size: 0.75rem;">—</span>
                                            </div>
                                            <button class="btn btn-sm btn-outline-secondary rounded-circle d-flex align-items-center justify-content-center" style="width: 36px; height: 36px;" data-bs-toggle="offcanvas" data-bs-target="#ticketDetailsOffcanvas">
                                                <i class="bi bi-three-dots-vertical"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Barra de acciones del ticket (Mobile) -->
                                <div class="ticket-actions-bar">
                                    <!-- Cambiar Estado -->
                                    <div class="position-relative">
                                        <button class="ticket-action-btn btn-icon-only" id="statusActionBtnMobile" onclick="toggleActionDropdown('statusDropdownMobile', event)" data-bs-toggle="tooltip" title="Estado">
                                            <i class="bi bi-arrow-repeat"></i>
                                        </button>
                                        <div class="ticket-action-dropdown" id="statusDropdownMobile">
                                            <div class="ticket-action-dropdown-item status-pending" data-state="pendiente" onclick="changeTicketStatus('pendiente')">
                                                <i class="bi bi-clock-fill"></i>
                                                <span>Pendiente</span>
                                            </div>
                                            <div class="ticket-action-dropdown-item status-process" data-state="en-proceso" onclick="changeTicketStatus('en-proceso')">
                                                <i class="bi bi-gear-fill"></i>
                                                <span>En Proceso</span>
                                            </div>
                                            <div class="ticket-action-dropdown-item status-resolved" data-state="resuelto" onclick="changeTicketStatus('resuelto')">
                                                <i class="bi bi-check-circle-fill"></i>
                                                <span>Resuelto</span>
                                            </div>
                                            <div class="ticket-action-dropdown-item status-closed" data-state="cerrado" onclick="changeTicketStatus('cerrado')">
                                                <i class="bi bi-x-circle-fill"></i>
                                                <span>Cerrado</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Cambiar Prioridad -->
                                    <div class="position-relative">
                                        <button class="ticket-action-btn btn-icon-only" onclick="toggleActionDropdown('priorityDropdownMobile', event)" data-bs-toggle="tooltip" title="Prioridad">
                                            <i class="bi bi-flag-fill"></i>
                                        </button>
                                        <div class="ticket-action-dropdown" id="priorityDropdownMobile">
                                            <div class="ticket-action-dropdown-item priority-low" onclick="changeTicketPriority('baja')">
                                                <i class="bi bi-flag"></i>
                                                <span>Baja</span>
                                            </div>
                                            <div class="ticket-action-dropdown-item priority-normal" onclick="changeTicketPriority('normal')">
                                                <i class="bi bi-flag-fill"></i>
                                                <span>Normal</span>
                                            </div>
                                            <div class="ticket-action-dropdown-item priority-high" onclick="changeTicketPriority('alta')">
                                                <i class="bi bi-flag-fill"></i>
                                                <span>Alta</span>
                                            </div>
                                            <div class="ticket-action-dropdown-item priority-critical" onclick="changeTicketPriority('urgente')">
                                                <i class="bi bi-exclamation-triangle-fill"></i>
                                                <span>Urgente</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Asignar Agente -->
                                    <div class="position-relative">
                                        <button class="ticket-action-btn btn-icon-only" onclick="toggleActionDropdown('assignDropdownMobile', event)" data-bs-toggle="tooltip" title="Asignar">
                                            <i class="bi bi-person-plus-fill"></i>
                                        </button>
                                        <div class="ticket-action-dropdown" id="assignDropdownMobile">
                                            <div class="ticket-action-dropdown-item" onclick="assignTicket('agente1')">
                                                <i class="bi bi-person-circle"></i>
                                                <span>Juan Martínez</span>
                                            </div>
                                            <div class="ticket-action-dropdown-item" onclick="assignTicket('agente2')">
                                                <i class="bi bi-person-circle"></i>
                                                <span>María García</span>
                                            </div>
                                            <div class="ticket-action-dropdown-item" onclick="assignTicket('agente3')">
                                                <i class="bi bi-person-circle"></i>
                                                <span>Carlos López</span>
                                            </div>
                                            <div class="ticket-action-dropdown-item" onclick="assignTicket('me')">
                                                <i class="bi bi-person-check-fill"></i>
                                                <span><strong>Asignarme a mí</strong></span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Etiquetas -->
                                    <button class="ticket-action-btn btn-icon-only" onclick="openTagModal()" data-bs-toggle="tooltip" title="Etiquetas">
                                        <i class="bi bi-tag-fill"></i>
                                    </button>

                                    <!-- Nota Interna -->
                                    <button class="ticket-action-btn btn-icon-only" onclick="toggleInternalNote()" data-bs-toggle="tooltip" title="Nota interna">
                                        <i class="bi bi-pencil-square"></i>
                                    </button>

                                    <!-- Más opciones -->
                                    <div class="position-relative ms-auto">
                                        <button class="ticket-action-btn btn-icon-only" onclick="toggleActionDropdown('moreOptionsDropdownMobile', event)" data-bs-toggle="tooltip" title="Más">
                                            <i class="bi bi-three-dots"></i>
                                        </button>
                                        <div class="ticket-action-dropdown" id="moreOptionsDropdownMobile" style="right: 0; left: auto;">
                                            <div class="ticket-action-dropdown-item" onclick="mergeTickets()">
                                                <i class="bi bi-link-45deg"></i>
                                                <span>Fusionar tickets</span>
                                            </div>
                                            <div class="ticket-action-dropdown-item" onclick="exportTicket()">
                                                <i class="bi bi-download"></i>
                                                <span>Exportar</span>
                                            </div>
                                            <div class="ticket-action-dropdown-item" onclick="printTicket()">
                                                <i class="bi bi-printer"></i>
                                                <span>Imprimir</span>
                                            </div>
                                            <div class="ticket-action-dropdown-item text-danger" onclick="deleteTicket()">
                                                <i class="bi bi-trash-fill"></i>
                                                <span>Eliminar</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Chat Messages -->
                                <div class="chat-messages" id="chatMessages">
                                    <!-- Los mensajes se cargarán dinámicamente desde la API -->
                                </div>

                                <!-- Chat Input -->
                                <div class="chat-input position-relative">
                                    <!-- Panel de Respuestas Rápidas Inline -->
                                    <div class="quick-replies-panel" id="quickRepliesInline">
                                        <div class="p-3 border-bottom d-flex justify-content-between align-items-center bg-light">
                                            <span class="fw-bold text-brand-blue"><i class="bi bi-lightning-fill me-1"></i>Respuestas Rápidas</span>
                                            <button class="btn btn-sm btn-link p-0" onclick="toggleQuickReplies()"><i class="bi bi-x-lg"></i></button>
                                        </div>
                                        <div class="quick-reply-item" onclick="insertQuickReply('Hola, gracias por contactarnos. Mi nombre es María y estaré ayudándote con tu solicitud.')">
                                            <div class="quick-reply-title">Saludo Inicial</div>
                                            <div class="quick-reply-preview">Hola, gracias por contactarnos...</div>
                                        </div>
                                        <div class="quick-reply-item" onclick="insertQuickReply('Para poder ayudarte mejor, necesito que me proporciones la siguiente información: tu nombre de usuario y una descripción detallada del problema.')">
                                            <div class="quick-reply-title">Solicitar Información</div>
                                            <div class="quick-reply-preview">Para poder ayudarte mejor...</div>
                                        </div>
                                        <div class="quick-reply-item" onclick="insertQuickReply('Hemos enviado un enlace de recuperación a tu correo electrónico. Por favor revisa tu bandeja de entrada y la carpeta de spam.')">
                                            <div class="quick-reply-title">Reset de Contraseña</div>
                                            <div class="quick-reply-preview">Hemos enviado un enlace...</div>
                                        </div>
                                        <div class="quick-reply-item" onclick="insertQuickReply('Me alegra que hayamos podido resolver tu problema. Si tienes alguna otra consulta, no dudes en contactarnos. ¡Que tengas un excelente día!')">
                                            <div class="quick-reply-title">Ticket Resuelto</div>
                                            <div class="quick-reply-preview">Me alegra que hayamos podido...</div>
                                        </div>
                                        <div class="p-2 border-top text-center">
                                            <a href="#" class="small text-brand-blue" data-bs-toggle="modal" data-bs-target="#quickRepliesModal" onclick="toggleQuickReplies()">Ver todas las respuestas</a>
                                        </div>
                                    </div>
                                    <div class="w-100 d-flex flex-column">
                                        <!-- Barra de adjuntos seleccionados (tipo WhatsApp) -->
                                        <div id="chatAttachmentsBarMobile" class="d-none mb-2">
                                            <div id="chatAttachmentsListMobile" class="d-flex flex-wrap gap-2"></div>
                                        </div>

                                        <div class="d-flex align-items-center gap-2">
                                            <input type="file" id="fileAttachment" multiple hidden>
                                            <button class="btn btn-link text-muted p-0" onclick="document.getElementById('fileAttachment').click()" title="Adjuntar archivo">
                                                <i class="bi bi-paperclip fs-5"></i>
                                            </button>
                                            <button class="btn btn-link text-muted p-0" onclick="toggleQuickReplies()" title="Respuestas rápidas">
                                                <i class="bi bi-lightning-fill fs-5"></i>
                                            </button>
                                            <input type="text" class="form-control border-0 flex-grow-1" id="chatMessageInput" placeholder="Escribe un mensaje...">
                                            <button class="btn btn-link p-0" onclick="sendChatMessage()">
                                                <i class="bi bi-send-fill fs-5 text-brand-blue"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Offcanvas - Detalles del Ticket -->
                            <div class="offcanvas offcanvas-end" tabindex="-1" id="ticketDetailsOffcanvas" aria-labelledby="ticketDetailsLabel" style="width: 400px;">
                                <div class="offcanvas-header border-bottom" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.05), rgba(0, 156, 180, 0.05));">
                                    <h5 class="offcanvas-title fw-bold title-gradient" id="ticketDetailsLabel">Información del Ticket</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                                </div>
                                <div class="offcanvas-body p-0">
                                    
                                    <!-- Información General -->
                                    <div class="p-4 border-bottom">
                                        <h6 class="text-muted text-uppercase small fw-bold mb-3">Detalles</h6>
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="text-muted small">Ticket ID:</span>
                                                <span class="fw-bold text-brand-blue">#1001</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="text-muted small">Canal:</span>
                                                <span class="d-flex align-items-center gap-1">
                                                    <i class="bi bi-envelope-fill text-primary"></i>
                                                    <span class="small">Email</span>
                                                </span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="text-muted small">Estado:</span>
                                                <span class="badge bg-warning text-dark">Pendiente</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="text-muted small">Prioridad:</span>
                                                <span class="badge bg-danger">Alta</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="text-muted small">Creado:</span>
                                                <span class="small">11/12/2025 10:30</span>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="text-muted small fw-bold mb-2">Asunto</label>
                                            <p class="mb-0">Problema con acceso al sistema</p>
                                        </div>
                                    </div>

                                    <!-- Operadores de Soporte -->
                                    <div class="p-4 border-bottom">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h6 class="text-muted text-uppercase small fw-bold mb-0">Equipo de Soporte</h6>
                                            <button class="btn btn-sm rounded-pill" style="background: var(--brand-gradient); color: white; border: none;">
                                                <i class="bi bi-plus-circle me-1"></i> Agregar
                                            </button>
                                        </div>
                                        <div class="participant-list">
                                            <div class="participant-item">
                                                <div class="participant-avatar bg-primary">
                                                    <i class="bi bi-person-fill"></i>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <div class="fw-semibold">María González</div>
                                                    <small class="text-muted">Operador Principal</small>
                                                </div>
                                                <span class="badge bg-success-subtle text-success">Activo</span>
                                            </div>
                                            <div class="participant-item">
                                                <div class="participant-avatar bg-info">
                                                    <i class="bi bi-person-fill"></i>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <div class="fw-semibold">Carlos Ruiz</div>
                                                    <small class="text-muted">Supervisor</small>
                                                </div>
                                                <span class="badge bg-secondary-subtle text-secondary">Observador</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Usuarios Involucrados -->
                                    <div class="p-4 border-bottom" id="ticketUsersSection" style="display:none;">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h6 class="text-muted text-uppercase small fw-bold mb-0">Usuarios</h6>
                                            <button class="btn btn-sm rounded-pill" style="background: var(--brand-gradient); color: white; border: none; display:none;">
                                                <i class="bi bi-plus-circle me-1"></i> Agregar
                                            </button>
                                        </div>
                                        <div class="participant-list" id="ticketUsersList"></div>
                                    </div>

                                    <!-- Archivos Adjuntos -->
                                    <div class="p-4 border-bottom" id="ticketAdjuntosSection">
                                        <h6 class="text-muted text-uppercase small fw-bold mb-3">Archivos Adjuntos</h6>
                                        <div class="row g-2" id="ticketAdjuntosGrid"></div>
                                        <div class="text-muted small" id="ticketAdjuntosEmpty" style="display:none;">
                                            <i class="bi bi-paperclip"></i> No hay archivos adjuntos
                                        </div>
                                    </div>

                                    <!-- Actividad del Ticket -->
                                    <div class="p-4">
                                        <h6 class="text-muted text-uppercase small fw-bold mb-3">
                                            <i class="bi bi-clock-history me-2"></i>Actividad del Ticket
                                        </h6>
                                        <div class="ticket-activity-timeline">
                                            <!-- Actividad más reciente -->
                                            <div class="activity-item">
                                                <div class="activity-icon bg-success">
                                                    <i class="bi bi-reply-fill"></i>
                                                </div>
                                                <div class="activity-content">
                                                    <div class="activity-header">
                                                        <strong>María González</strong> respondió al ticket
                                                    </div>
                                                    <div class="activity-time">Hace 5 minutos</div>
                                                </div>
                                            </div>

                                            <!-- Cambio de estado -->
                                            <div class="activity-item">
                                                <div class="activity-icon bg-info">
                                                    <i class="bi bi-arrow-repeat"></i>
                                                </div>
                                                <div class="activity-content">
                                                    <div class="activity-header">
                                                        <strong>Sistema</strong> cambió el estado a <span class="badge bg-info text-white">En Proceso</span>
                                                    </div>
                                                    <div class="activity-time">Hace 15 minutos</div>
                                                </div>
                                            </div>

                                            <!-- Asignación -->
                                            <div class="activity-item">
                                                <div class="activity-icon bg-primary">
                                                    <i class="bi bi-person-plus-fill"></i>
                                                </div>
                                                <div class="activity-content">
                                                    <div class="activity-header">
                                                        <strong>Carlos Ruiz</strong> asignó el ticket a <strong>María González</strong>
                                                    </div>
                                                    <div class="activity-time">Hace 1 hora</div>
                                                </div>
                                            </div>

                                            <!-- Cambio de prioridad -->
                                            <div class="activity-item">
                                                <div class="activity-icon bg-warning">
                                                    <i class="bi bi-flag-fill"></i>
                                                </div>
                                                <div class="activity-content">
                                                    <div class="activity-header">
                                                        <strong>Carlos Ruiz</strong> cambió la prioridad a <span class="badge bg-danger">Alta</span>
                                                    </div>
                                                    <div class="activity-time">Hace 2 horas</div>
                                                </div>
                                            </div>

                                            <!-- Mensaje del cliente -->
                                            <div class="activity-item">
                                                <div class="activity-icon bg-secondary">
                                                    <i class="bi bi-chat-dots-fill"></i>
                                                </div>
                                                <div class="activity-content">
                                                    <div class="activity-header">
                                                        <strong>Juan Pérez</strong> envió un mensaje
                                                    </div>
                                                    <div class="activity-time">Hace 3 horas</div>
                                                </div>
                                            </div>

                                            <!-- Archivo adjunto -->
                                            <div class="activity-item">
                                                <div class="activity-icon bg-info">
                                                    <i class="bi bi-paperclip"></i>
                                                </div>
                                                <div class="activity-content">
                                                    <div class="activity-header">
                                                        <strong>Juan Pérez</strong> adjuntó <span class="text-muted">captura.png</span>
                                                    </div>
                                                    <div class="activity-time">Hace 3 horas</div>
                                                </div>
                                            </div>

                                            <!-- Creación del ticket -->
                                            <div class="activity-item">
                                                <div class="activity-icon bg-success">
                                                    <i class="bi bi-plus-circle-fill"></i>
                                                </div>
                                                <div class="activity-content">
                                                    <div class="activity-header">
                                                        <strong>Juan Pérez</strong> creó el ticket
                                                    </div>
                                                    <div class="activity-time">11 Dic, 10:30 AM</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="admin" role="tabpanel">
                            <!-- Mobile Header -->
                            <div class="d-md-none d-flex justify-content-between align-items-center mb-3 px-3 pt-3">
                                <h4 class="fw-bold text-brand-blue mb-0">Administración</h4>
                            </div>
                            
                            <h2 class="fw-bold mb-4 title-gradient d-none d-md-block">
                                <i class="bi bi-shield-lock-fill me-2"></i>Administración del Sistema
                            </h2>

                            <!-- Tabs de Administración -->
                            <ul class="nav nav-pills mb-4 flex-nowrap overflow-auto" id="adminTabs" role="tablist" style="-webkit-overflow-scrolling: touch;">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active rounded-pill text-nowrap m-2" id="users-tab" data-bs-toggle="pill" data-bs-target="#users-content" type="button" role="tab">
                                        <i class="bi bi-people-fill me-2"></i><span class="d-none d-sm-inline">Usuarios</span><span class="d-sm-none">Usuarios</span>
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link rounded-pill text-nowrap m-2" id="permissions-tab" data-bs-toggle="pill" data-bs-target="#permissions-content" type="button" role="tab">
                                        <i class="bi bi-key-fill me-2"></i><span class="d-none d-sm-inline">Permisos</span><span class="d-sm-none">Permisos</span>
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link rounded-pill text-nowrap m-2" id="audit-tab" data-bs-toggle="pill" data-bs-target="#audit-content" type="button" role="tab">
                                        <i class="bi bi-clock-history me-2"></i><span class="d-none d-sm-inline">Auditoría</span><span class="d-sm-none">Auditoría</span>
                                    </button>
                                </li>
                            </ul>

                            <div class="tab-content" id="adminTabContent">
                                
                                <!-- Gestión de Usuarios -->
                                <div class="tab-pane fade show active" id="users-content" role="tabpanel">
                                    <div class="card border-0 shadow-sm rounded-4 mb-4">
                                        <div class="card-body p-3 p-md-4">
                                            <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mb-3 mb-md-4 gap-2">
                                                <h5 class="fw-bold text-brand-blue mb-0">
                                                    <i class="bi bi-people-fill me-2 d-none d-sm-inline"></i>Gestión de Usuarios
                                                </h5>
                                                <button class="btn btn-primary rounded-pill btn-sm btn-md-normal" style="background: var(--brand-gradient); border: none;" data-bs-toggle="modal" data-bs-target="#newUserModal">
                                                    <i class="bi bi-plus-lg me-1 me-md-2"></i><span class="d-none d-sm-inline">Nuevo Usuario</span><span class="d-sm-none">Nuevo</span>
                                                </button>
                                            </div>
                                            
                                            <!-- Barra de búsqueda -->
                                            <div class="input-group mb-4">
                                                <span class="input-group-text bg-light border-end-0">
                                                    <i class="bi bi-search text-muted"></i>
                                                </span>
                                                <input type="text" class="form-control border-start-0 ps-0" placeholder="Buscar usuarios..." id="searchUsers" onkeyup="searchUsers()">
                                            </div>

                                            <!-- Tabla de Usuarios - Desktop -->
                                            <div class="table-responsive d-none d-md-block">
                                                <table class="table table-hover align-middle admin-users-table">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th>Usuario</th>
                                                            <th>Rol</th>
                                                            <th class="d-none d-lg-table-cell">Email</th>
                                                            <th>Estado</th>
                                                            <th class="d-none d-xl-table-cell">Último acceso</th>
                                                            <th class="text-center">Acciones</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="adminUsersTbody"></tbody>
                                                </table>
                                            </div>

                                            <!-- Cards de Usuarios - Mobile -->
                                            <div class="d-md-none" id="usersCardsMobile"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Gestión de Permisos -->
                                <div class="tab-pane fade" id="permissions-content" role="tabpanel">
                                    <div class="card border-0 shadow-sm rounded-4 mb-4">
                                        <div class="card-body p-3 p-md-4">
                                            <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mb-3 mb-md-4 gap-2">
                                                <div>
                                                    <h5 class="fw-bold text-brand-blue mb-1">
                                                        <i class="bi bi-key-fill me-2 d-none d-sm-inline"></i>Roles y Permisos
                                                    </h5>
                                                    <small class="text-muted">Gestiona los roles y sus permisos en el sistema</small>
                                                </div>
                                                <button class="btn btn-primary rounded-pill btn-sm btn-md-normal" style="background: var(--brand-gradient); border: none;" data-bs-toggle="modal" data-bs-target="#newRoleModal">
                                                    <i class="bi bi-plus-lg me-1 me-md-2"></i><span class="d-none d-sm-inline">Nuevo Rol</span><span class="d-sm-none">Nuevo</span>
                                                </button>
                                            </div>
                                            
                                            <!-- Contenedor dinámico de roles -->
                                            <div id="rolesList" class="row g-3 g-md-4"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Auditoría -->
                                <div class="tab-pane fade" id="audit-content" role="tabpanel">
                                    <div class="card border-0 shadow-sm rounded-4 mb-4">
                                        <div class="card-body p-3 p-md-4">
                                            <h5 class="fw-bold text-brand-blue mb-3 mb-md-4">
                                                <i class="bi bi-clock-history me-2 d-none d-sm-inline"></i>Auditoría de Actividades
                                            </h5>
                                            
                                            <!-- Filtros -->
                                            <div class="row g-2 g-md-3 mb-3 mb-md-4 align-items-end audit-filters-row">
                                                <div class="col-12 col-md-3">
                                                    <label class="form-label small text-muted">Departamento</label>
                                                    <select class="form-select" id="auditDeptoFilter" onchange="onAuditDeptoChange()">
                                                        <option value="">Todos los departamentos</option>
                                                    </select>
                                                </div>
                                                <div class="col-12 col-md-3">
                                                    <label class="form-label small text-muted">Usuario</label>
                                                    <select class="form-select" id="auditUserFilter" onchange="onAuditUserChange()">
                                                        <option value="">Todos los usuarios</option>
                                                    </select>
                                                </div>
                                                <div class="col-12 col-md-3">
                                                    <label class="form-label small text-muted">Tipo de acción</label>
                                                    <select class="form-select" id="auditActionFilter" onchange="filterAuditLog()">
                                                        <option value="all">Todas las acciones</option>
                                                        <option value="login">Inicio de sesión</option>
                                                        <option value="admin">Admin</option>
                                                        <option value="ticket">Tickets</option>
                                                        <option value="mensaje">Mensajes</option>
                                                        <option value="departamento">Departamentos</option>
                                                        <option value="operador">Usuarios</option>
                                                        <option value="read">Lecturas</option>
                                                        <option value="write">Escrituras</option>
                                                    </select>
                                                </div>
                                                <div class="col-12 col-md-3">
                                                    <label class="form-label small text-muted">Fecha</label>
                                                    <input type="date" class="form-control" id="auditDateFilter" onchange="filterAuditLog()">
                                                </div>
                                            </div>

                                            <!-- Timeline de Auditoría (dinámico) -->
                                            <div class="audit-timeline" id="auditTimelineList">
                                                <div class="text-muted small">Cargando auditoría...</div>
                                            </div>

                                            <div class="d-flex justify-content-between align-items-center mt-3 gap-2 flex-wrap">
                                                <div class="text-muted small" id="auditTimelineSummary">Mostrando 5 por página.</div>
                                                <nav aria-label="Paginación auditoría" id="auditTimelinePager"></nav>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <div class="tab-pane fade" id="config" role="tabpanel">
                            <!-- Mobile Header - Solo en Config (sin botones) -->
                            <div class="d-md-none d-flex justify-content-between align-items-center mb-3 px-3 pt-3">
                                <h4 class="fw-bold text-brand-blue mb-0">Configuración</h4>
                            </div>
                            
                            <h2 class="fw-bold mb-4 title-gradient d-none d-md-block">Configuración</h2>
                            
                            <!-- Perfil de Usuario -->
                            <div class="card border-0 shadow-sm rounded-4 mb-4 card-hover">
                                <div class="card-body p-4">
                                    <div class="d-flex align-items-center mb-4">
                                        <div class="user-avatar-container me-3">
                                            <div class="user-avatar">
                                                <i class="bi bi-person-fill"></i>
                                            </div>
                                            <span class="user-status online" title="En línea"></span>
                                        </div>
                                        <div>
                                            <h5 class="mb-0 fw-bold text-brand-blue" id="userProfileName">Cargando...</h5>
                                            <p class="text-muted mb-0 small" id="userProfileRole">...</p>
                                            <span class="badge bg-success rounded-pill mt-1" style="font-size: 0.65rem;">
                                                <i class="bi bi-circle-fill me-1" style="font-size: 6px;"></i>En línea
                                            </span>
                                        </div>
                                    </div>
                                    <button class="btn btn-primary btn-ripple w-100 rounded-pill mb-2" style="background: var(--brand-gradient); border: none;" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                                        <i class="bi bi-pencil-square me-2"></i> Editar Perfil
                                    </button>
                                    <button class="btn btn-outline-secondary btn-ripple w-100 rounded-pill btn-change-password" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                                        <i class="bi bi-shield-lock me-2"></i> Cambiar Contraseña
                                    </button>
                                </div>
                            </div>

                            <!-- Preferencias -->
                            <div class="card border-0 shadow-sm rounded-4 mb-4 card-hover">
                                <div class="card-body p-4">
                                    <h6 class="fw-bold text-brand-blue mb-3">
                                        <i class="bi bi-sliders me-2"></i> Preferencias
                                    </h6>
                                    <div class="mb-3">
                                        <label class="form-label small text-muted mb-2">Notificaciones</label>
                                        <div class="form-check form-switch d-flex align-items-center mb-2">
                                            <input class="form-check-input me-3" type="checkbox" role="switch" id="notifEmail" checked>
                                            <label class="form-check-label" for="notifEmail">Notificaciones por email</label>
                                        </div>
                                        <div class="form-check form-switch d-flex align-items-center">
                                            <input class="form-check-input me-3" type="checkbox" role="switch" id="notifSound" checked>
                                            <label class="form-check-label" for="notifSound">Sonido de notificaciones</label>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="form-label small text-muted">Tema</label>
                                        <select class="form-select" id="themeSelector" onchange="changeTheme(this.value)">
                                            <option value="light" selected>Claro</option>
                                            <option value="dark">Oscuro</option>
                                            <option value="auto">Automático</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Información del Sistema -->
                            <div class="card border-0 shadow-sm rounded-4 mb-4 card-hover">
                                <div class="card-body p-4">
                                    <h6 class="fw-bold text-brand-blue mb-3">
                                        <i class="bi bi-info-circle me-2"></i> Información
                                    </h6>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="text-muted small">Versión:</span>
                                        <span class="fw-semibold small">1.1.1</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="text-muted small">Última actualización:</span>
                                        <span class="fw-semibold small">09/01/2026</span>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Logout -->
    <div class="modal fade" id="logoutModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold text-brand-blue">Confirmar salida</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <i class="bi bi-exclamation-circle text-danger display-1 mb-3"></i>
                    <p class="mb-0 fs-5">¿Estás seguro que quieres cerrar tu sesión?</p>
                </div>
                <div class="modal-footer border-0 justify-content-center pb-4">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancelar</button>
                    <a href="/" class="btn btn-danger rounded-pill px-4">Sí, salir</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Calificación/Rating -->
    <div class="modal fade" id="ratingModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.05), rgba(0, 156, 180, 0.05));">
                    <h5 class="modal-title fw-bold title-gradient">
                        <i class="bi bi-star-fill me-2"></i>Califica tu experiencia
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-4 text-center">
                    <p class="mb-4">¿Cómo fue tu experiencia con nuestro soporte?</p>
                    <div class="rating-stars mb-4">
                        <i class="bi bi-star-fill rating-star" id="star1" onclick="setRating(1)"></i>
                        <i class="bi bi-star-fill rating-star" id="star2" onclick="setRating(2)"></i>
                        <i class="bi bi-star-fill rating-star" id="star3" onclick="setRating(3)"></i>
                        <i class="bi bi-star-fill rating-star" id="star4" onclick="setRating(4)"></i>
                        <i class="bi bi-star-fill rating-star" id="star5" onclick="setRating(5)"></i>
                    </div>
                    <div class="mb-3">
                        <label for="feedbackText" class="form-label fw-semibold text-brand-blue">
                            Comentarios (opcional)
                        </label>
                        <textarea class="form-control" id="feedbackText" rows="3" 
                                  placeholder="Cuéntanos tu experiencia..."></textarea>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary rounded-pill px-4" 
                            style="background: var(--brand-gradient); border:none;" onclick="submitRating()">
                        <i class="bi bi-send-fill me-1"></i> Enviar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Editar Perfil -->
    <div class="modal fade" id="editProfileModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.05), rgba(0, 156, 180, 0.05));">
                    <h5 class="modal-title fw-bold title-gradient">
                        <i class="bi bi-pencil-square me-2"></i>Editar Perfil
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label class="form-label fw-semibold text-brand-blue">Nombre Completo</label>
                        <input type="text" class="form-control" value="María González">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold text-brand-blue">Email</label>
                        <input type="email" class="form-control" value="maria.gonzalez@clubrecrear.com">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold text-brand-blue">Teléfono</label>
                        <input type="tel" class="form-control" value="+57 300 123 4567">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold text-brand-blue">Cargo</label>
                        <input type="text" class="form-control" value="Operador de Soporte">
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary rounded-pill px-4" style="background: var(--brand-gradient); border:none;">
                        <i class="bi bi-check-lg me-1"></i> Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Cambiar Contraseña -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.05), rgba(0, 156, 180, 0.05));">
                    <h5 class="modal-title fw-bold title-gradient">
                        <i class="bi bi-shield-lock me-2"></i>Cambiar Contraseña
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label class="form-label fw-semibold text-brand-blue">Contraseña Actual</label>
                        <input type="password" class="form-control" placeholder="Ingresa tu contraseña actual">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold text-brand-blue">Nueva Contraseña</label>
                        <input type="password" class="form-control" placeholder="Ingresa tu nueva contraseña">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold text-brand-blue">Confirmar Nueva Contraseña</label>
                        <input type="password" class="form-control" placeholder="Confirma tu nueva contraseña">
                    </div>
                    <div class="alert alert-info d-flex align-items-center" role="alert">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        <small>La contraseña debe tener al menos 8 caracteres</small>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary rounded-pill px-4" style="background: var(--brand-gradient); border:none;">
                        <i class="bi bi-check-lg me-1"></i> Cambiar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Nuevo Ticket -->
    <!-- Modal Crear Nuevo Ticket (Decorado) -->
    <div class="modal fade" id="newTicketModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content modal-pretty-content">
                <div class="modal-header modal-pretty-header">
                    <h5 class="modal-title">
                        <i class="bi bi-stars me-2"></i>Crear Nuevo Ticket
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body modal-pretty-body">
                    <form id="newTicketForm">
                        <!-- Asunto -->
                        <div class="mb-4">
                            <label for="ticketSubject" class="form-label form-label-pretty">
                                <i class="bi bi-chat-square-text"></i> Asunto <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control form-control-pretty" id="ticketSubject" placeholder="Describe brevemente el problema" required>
                        </div>

                        <!-- Descripción -->
                        <div class="mb-4">
                            <label for="ticketDescription" class="form-label form-label-pretty">
                                <i class="bi bi-justify-left"></i> Descripción <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control form-control-pretty" id="ticketDescription" rows="4" placeholder="Proporciona detalles sobre el problema o solicitud..." required></textarea>
                        </div>

                        <div class="row">
                            <!-- Prioridad -->
                            <div class="col-md-6 mb-4">
                                <label for="ticketPriority" class="form-label form-label-pretty">
                                    <i class="bi bi-flag-fill"></i> Prioridad <span class="text-danger">*</span>
                                </label>
                                <select class="form-select form-control-pretty" id="ticketPriority" required>
                                    <option value="">Seleccionar...</option>
                                    <option value="4">Baja (Verde)</option>
                                    <option value="3" selected>Media (Azul)</option>
                                    <option value="2">Alta (Naranja)</option>
                                    <option value="1">Urgente (Rojo)</option>
                                </select>
                            </div>

                            <!-- Departamento -->
                            <div class="col-md-6 mb-4">
                                <label for="ticketDepartamento" class="form-label form-label-pretty">
                                    <i class="bi bi-building"></i> Departamento <span class="text-danger">*</span>
                                </label>
                                <select class="form-select form-control-pretty" id="ticketDepartamento" required>
                                    <option value="">Seleccionar...</option>
                                    <!-- Se llenará dinámicamente con JavaScript -->
                                </select>
                            </div>
                        </div>

                        <!-- Usuario afectado (solo si es operador) -->
                        <div class="mb-4">
                            <label for="ticketUser" class="form-label form-label-pretty">
                                <i class="bi bi-person-fill"></i> Usuario afectado
                            </label>
                            <input type="text" class="form-control form-control-pretty" id="ticketUser" placeholder="Nombre (opcional)">
                            <small class="text-muted ms-2">Indica si estás creando el ticket para alguien más</small>
                        </div>

                        <!-- Operador Asignado - Solo visible para Admin y Supervisor -->
                        <div class="mb-4" id="divOperadorAsignado" style="display: none;">
                            <label for="ticketOperadorAsignado" class="form-label form-label-pretty">
                                <i class="bi bi-person-check-fill"></i> Asignar a Operador
                            </label>
                            <select class="form-select form-control-pretty" id="ticketOperadorAsignado" onclick="validarDepartamentoSeleccionado()">
                                <option value="">-- Seleccionar operador --</option>
                                <!-- Se llena dinámicamente con JavaScript -->
                            </select>
                            <small class="text-muted ms-2" id="helpTextOperador">Primero selecciona un departamento</small>
                        </div>

                        <!-- Etiquetas/Tags -->
                        <div class="mb-4">
                            <label class="form-label form-label-pretty">
                                <i class="bi bi-tags-fill"></i> Etiquetas
                            </label>
                            <div id="selectedTagsDisplay" class="mb-2 d-flex flex-wrap gap-2">
                                <span class="text-muted">Sin etiquetas</span>
                            </div>
                            <div id="tagSelector" class="tag-selector"></div>
                        </div>

                        <!-- Archivos adjuntos -->
                        <div class="mb-3">
                            <label for="ticketAttachments" class="form-label form-label-pretty">
                                <i class="bi bi-paperclip"></i> Archivos adjuntos
                                <span class="badge bg-primary rounded-pill ms-2" id="attachmentCount">0</span>
                            </label>
                            <div class="attachment-dropzone-pretty" onclick="document.getElementById('ticketAttachments').click()">
                                <i class="bi bi-cloud-arrow-up-fill fs-1 text-brand-blue mb-2 d-block"></i>
                                <p class="mb-1 fw-bold text-dark">Haz clic o arrastra archivos aquí</p>
                                <small class="text-muted">Soporta PDF, imágenes, docs (máx. 10MB)</small>
                            </div>
                            <input type="file" class="form-control d-none" id="ticketAttachments" multiple onchange="handleFileSelect(event)" 
                                   accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,.jpg,.jpeg,.png,.gif,.zip">
                        </div>

                        <!-- Lista de archivos adjuntos -->
                        <div id="attachmentList" class="attachments-container mb-3"></div>

                        <div class="alert alert-light border border-info d-flex align-items-center rounded-4" role="alert">
                            <i class="bi bi-info-circle-fill text-info me-3 fs-4"></i>
                            <div class="small text-muted">Asegúrate de proporcionar toda la info necesaria. Los campos con <span class="text-danger fw-bold">*</span> son obligatorios.</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer modal-pretty-footer">
                    <button type="button" class="btn btn-modal-cancel" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-modal-action" onclick="createTicket()">
                        <i class="bi bi-send-fill me-2"></i> Crear Ticket
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Búsqueda de Tickets -->
    <div class="modal fade" id="searchTicketsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header border-0 pb-2" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.05), rgba(0, 156, 180, 0.05));">
                    <div class="w-100">
                        <div class="input-group">
                            <span class="input-group-text bg-transparent border-0">
                                <i class="bi bi-search text-brand-blue"></i>
                            </span>
                            <input type="text" class="form-control border-0 shadow-none" id="searchTicketInput" placeholder="Buscar tickets por ID, asunto, usuario..." autofocus>
                            <button type="button" class="btn-close ms-2" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                        </div>
                    </div>
                </div>
                <div class="modal-body p-0" style="max-height: 60vh; overflow-y: auto;">
                    <div id="searchResults">
                        <!-- Resultados de búsqueda aparecerán aquí -->
                        <div class="text-center py-5 text-muted">
                            <i class="bi bi-search display-4 d-block mb-3 opacity-25"></i>
                            <p>Comienza a escribir para buscar tickets...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Filtros -->
    <div class="modal fade" id="filtersModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.05), rgba(0, 156, 180, 0.05));">
                    <h5 class="modal-title fw-bold title-gradient">
                        <i class="bi bi-funnel-fill me-2"></i>Filtrar Tickets
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-4">
                    <!-- Estado -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold text-brand-blue">Estado</label>
                        <div class="d-flex flex-wrap gap-2">
                            <input type="checkbox" class="btn-check" id="filter-estado-nuevo" value="Nuevo">
                            <label class="btn btn-outline-info btn-sm rounded-pill" for="filter-estado-nuevo">Nuevo</label>
                            
                            <input type="checkbox" class="btn-check" id="filter-estado-proceso" value="En Proceso" checked>
                            <label class="btn btn-outline-primary btn-sm rounded-pill" for="filter-estado-proceso">En Proceso</label>
                            
                            <input type="checkbox" class="btn-check" id="filter-estado-pendiente" value="Pendiente" checked>
                            <label class="btn btn-outline-warning btn-sm rounded-pill" for="filter-estado-pendiente">Pendiente</label>
                            
                            <input type="checkbox" class="btn-check" id="filter-estado-resuelto" value="Resuelto">
                            <label class="btn btn-outline-success btn-sm rounded-pill" for="filter-estado-resuelto">Resuelto</label>
                            
                            <input type="checkbox" class="btn-check" id="filter-estado-cerrado" value="Cerrado">
                            <label class="btn btn-outline-secondary btn-sm rounded-pill" for="filter-estado-cerrado">Cerrado</label>
                            
                            <input type="checkbox" class="btn-check" id="filter-estado-sinresponder" value="Sin responder">
                            <label class="btn btn-outline-danger btn-sm rounded-pill" for="filter-estado-sinresponder">Sin responder</label>
                        </div>
                    </div>

                    <!-- Prioridad -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold text-brand-blue">Prioridad</label>
                        <div class="d-flex flex-wrap gap-2">
                            <input type="checkbox" class="btn-check" id="filter-priority-urgente" value="Urgente">
                            <label class="btn btn-outline-danger btn-sm rounded-pill" for="filter-priority-urgente">
                                <i class="bi bi-exclamation-triangle-fill me-1"></i>Urgente
                            </label>
                            
                            <input type="checkbox" class="btn-check" id="filter-priority-alta" value="Alta">
                            <label class="btn btn-outline-warning btn-sm rounded-pill" for="filter-priority-alta">
                                <i class="bi bi-flag-fill me-1"></i>Alta
                            </label>
                            
                            <input type="checkbox" class="btn-check" id="filter-priority-media" value="Media">
                            <label class="btn btn-outline-primary btn-sm rounded-pill" for="filter-priority-media">
                                <i class="bi bi-flag me-1"></i>Media
                            </label>
                            
                            <input type="checkbox" class="btn-check" id="filter-priority-baja" value="Baja">
                            <label class="btn btn-outline-secondary btn-sm rounded-pill" for="filter-priority-baja">
                                <i class="bi bi-flag me-1"></i>Baja
                            </label>
                        </div>
                    </div>

                    <!-- Rango de fechas -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold text-brand-blue">Fecha de creación</label>
                        <div class="row g-2">
                            <div class="col-6">
                                <input type="date" class="form-control" placeholder="Desde">
                            </div>
                            <div class="col-6">
                                <input type="date" class="form-control" placeholder="Hasta">
                            </div>
                        </div>
                    </div>

                    <!-- Canal -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold text-brand-blue">Canal de Origen</label>
                        <div class="d-flex flex-wrap gap-2">
                            <input type="checkbox" class="btn-check" id="channel-email">
                            <label class="btn btn-outline-primary btn-sm rounded-pill" for="channel-email">
                                <i class="bi bi-envelope-fill me-1"></i>Email
                            </label>
                            
                            <input type="checkbox" class="btn-check" id="channel-whatsapp">
                            <label class="btn btn-outline-success btn-sm rounded-pill" for="channel-whatsapp">
                                <i class="bi bi-whatsapp me-1"></i>WhatsApp
                            </label>
                            
                            <input type="checkbox" class="btn-check" id="channel-chat">
                            <label class="btn btn-outline-info btn-sm rounded-pill" for="channel-chat">
                                <i class="bi bi-chat-dots-fill me-1"></i>Chat Web
                            </label>
                            
                            <input type="checkbox" class="btn-check" id="channel-phone">
                            <label class="btn btn-outline-warning btn-sm rounded-pill" for="channel-phone">
                                <i class="bi bi-telephone-fill me-1"></i>Teléfono
                            </label>
                            
                            <input type="checkbox" class="btn-check" id="channel-form">
                            <label class="btn btn-outline-secondary btn-sm rounded-pill" for="channel-form">
                                <i class="bi bi-file-text-fill me-1"></i>Formulario
                            </label>
                            
                            <input type="checkbox" class="btn-check" id="channel-app">
                            <label class="btn btn-outline-dark btn-sm rounded-pill" for="channel-app">
                                <i class="bi bi-phone-fill me-1"></i>App Móvil
                            </label>
                        </div>
                    </div>

                    <!-- Asignado a -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold text-brand-blue">Asignado a</label>
                        <select class="form-select">
                            <option value="">Todos los operadores</option>
                            <option value="1">María González</option>
                            <option value="2">Carlos Ruiz</option>
                            <option value="3">Ana Martínez</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer border-0 justify-content-between">
                    <button type="button" class="btn btn-link text-muted" onclick="resetFilters()">
                        <i class="bi bi-arrow-counterclockwise me-1"></i> Limpiar filtros
                    </button>
                    <div>
                        <button type="button" class="btn btn-light rounded-pill px-4 me-2" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary rounded-pill px-4" style="background: var(--brand-gradient); border:none;" onclick="applyFilters()">
                            <i class="bi bi-check-lg me-1"></i> Aplicar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Offcanvas de Solicitudes Pendientes -->
    <div class="offcanvas offcanvas-end offcanvas-solicitudes" tabindex="-1" id="solicitudesOffcanvas" aria-labelledby="solicitudesOffcanvasLabel">
        <div class="offcanvas-header" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.08), rgba(0, 156, 180, 0.08));">
            <div>
                <h5 class="offcanvas-title fw-bold title-gradient" id="solicitudesOffcanvasLabel">
                    <i class="bi bi-inbox-fill me-2"></i>Solicitudes Pendientes
                </h5>
                <small class="text-muted">Tickets que esperan tu aprobación</small>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
        </div>
        <div class="offcanvas-body p-3" style="background: #f8f9fa;">
            <!-- Filtros rápidos -->
            <div class="d-flex gap-2 mb-3 flex-wrap">
                <button class="btn btn-sm btn-primary rounded-pill active" onclick="filterSolicitudes('todas')">Todas</button>
                <button class="btn btn-sm btn-outline-danger rounded-pill" onclick="filterSolicitudes('urgente')">Urgente</button>
                <button class="btn btn-sm btn-outline-warning rounded-pill" onclick="filterSolicitudes('alta')">Alta</button>
                <button class="btn btn-sm btn-outline-info rounded-pill" onclick="filterSolicitudes('media')">Media</button>
                <button class="btn btn-sm btn-outline-success rounded-pill" onclick="filterSolicitudes('baja')">Baja</button>
            </div>

            <!-- Lista de solicitudes -->
            <div id="solicitudesList">
                <!-- Las solicitudes se cargarán dinámicamente desde la API -->
            </div>

            <!-- Estado vacío -->
            <div class="solicitudes-empty d-none" id="solicitudesEmpty">
                <i class="bi bi-inbox"></i>
                <h6 class="fw-bold">No hay solicitudes pendientes</h6>
                <p class="small text-muted">Los tickets sin asignar aparecerán aquí para que puedas tomarlos.</p>
            </div>
        </div>
        
        <!-- Footer del offcanvas -->
        <div class="offcanvas-footer p-3 border-top bg-white">
            <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">
                    <span id="solicitudesCount">3</span> solicitudes pendientes
                </small>
                <button class="btn btn-sm btn-outline-primary rounded-pill" onclick="actualizarSolicitudes()">
                    <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Detalle de Solicitud -->
    <div class="modal fade" id="detalleSolicitudModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.05), rgba(0, 156, 180, 0.05));">
                    <h5 class="modal-title fw-bold title-gradient">
                        <i class="bi bi-ticket-detailed me-2"></i>Detalle de Solicitud
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="row">
                        <div class="col-md-8">
                            <h5 class="fw-bold text-brand-blue mb-3" id="detalleSolicitudTitulo">Sistema caído completamente</h5>
                            <div class="mb-3" id="detalleSolicitudDescripcion">
                                <p>El sistema principal no está funcionando desde esta mañana. Ningún usuario puede acceder y estamos perdiendo operaciones importantes.</p>
                                <p>Ya intentamos reiniciar los servidores pero el problema persiste. Necesitamos asistencia urgente.</p>
                            </div>
                            
                            <!-- Archivos adjuntos de la solicitud -->
                            <div class="mb-3" id="detalleSolicitudAdjuntos">
                                <h6 class="text-muted small fw-bold mb-2">Archivos Adjuntos</h6>
                                <div class="d-flex flex-wrap gap-2">
                                    <div class="badge bg-light text-dark border p-2 d-flex align-items-center gap-2">
                                        <i class="bi bi-file-earmark-image text-primary"></i>
                                        <span>error_screenshot.png</span>
                                    </div>
                                    <div class="badge bg-light text-dark border p-2 d-flex align-items-center gap-2">
                                        <i class="bi bi-file-earmark-text text-info"></i>
                                        <span>logs.txt</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-0 bg-light rounded-3 p-3">
                                <h6 class="text-muted small fw-bold mb-3">Información</h6>
                                <div class="mb-2">
                                    <small class="text-muted d-block">Solicitante</small>
                                    <span class="fw-semibold" id="detalleSolicitudUsuario">Roberto Méndez</span>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted d-block">Email</small>
                                    <span class="fw-semibold" id="detalleSolicitudEmail">roberto@email.com</span>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted d-block">Prioridad</small>
                                    <span class="badge prioridad-critica" id="detalleSolicitudPrioridad">Urgente</span>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted d-block">Categoría</small>
                                    <span id="detalleSolicitudCategoria">Soporte Técnico</span>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted d-block">Fecha de solicitud</small>
                                    <span id="detalleSolicitudFecha">12/12/2025, 10:30</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 justify-content-between">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cerrar</button>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn-rechazar px-4" onclick="abrirModalDerivarDesdeDetalle()">
                            <i class="bi bi-arrow-left-right me-1"></i>Derivar/Rechazar
                        </button>
                        <button type="button" class="btn-aceptar px-4" onclick="verTicketDesdeDetalle()">
                            <i class="bi bi-eye me-1"></i>Ver Ticket
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Derivar/Rechazar Solicitud -->
    <div class="modal fade" id="rechazarSolicitudModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.05), rgba(0, 156, 180, 0.05));">
                    <h5 class="modal-title fw-bold text-brand-blue">
                        <i class="bi bi-arrow-left-right me-2"></i>Derivar o Rechazar Ticket
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-4">
                    <p class="text-muted mb-3">Selecciona la acción que deseas realizar con este ticket.</p>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Acción <span class="text-danger">*</span></label>
                        <select class="form-select mb-2" id="accionTicketSelect" onchange="toggleDerivarSection()">
                            <option value="">Seleccionar acción...</option>
                            <option value="derivar">Derivar a otro agente</option>
                            <option value="duplicado">Rechazar - Ticket duplicado</option>
                            <option value="informacion">Rechazar - Información insuficiente</option>
                            <option value="fuera-alcance">Rechazar - Fuera del alcance de soporte</option>
                            <option value="resuelto">Rechazar - Ya fue resuelto</option>
                            <option value="otro">Rechazar - Otro motivo</option>
                        </select>
                    </div>
                    
                    <!-- Sección de Derivar (oculta inicialmente) -->
                    <div id="derivarSection" class="mb-3" style="display: none;">
                        <label class="form-label fw-semibold">Derivar a <span class="text-danger">*</span></label>
                        <select class="form-select mb-2" id="agenteDerivadoSelect">
                            <option value="">Seleccionar agente...</option>
                            <!-- Se carga dinámicamente con cargarOperadoresAsignacion() -->
                        </select>
                        <small class="text-muted">El ticket será reasignado al agente seleccionado</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Comentario</label>
                        <textarea class="form-control" id="comentarioRechazo" rows="3" placeholder="Agrega un comentario o instrucciones..."></textarea>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary rounded-pill px-4" onclick="confirmarAccion()" style="background: var(--brand-gradient); border: none;">
                        <i class="bi bi-check-lg me-1"></i>Confirmar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Reportes -->
    <div class="modal fade" id="reportModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.05), rgba(0, 156, 180, 0.05));">
                    <h5 class="modal-title fw-bold title-gradient">
                        <i class="bi bi-file-earmark-bar-graph me-2"></i>Reportes y Estadísticas
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-4">
                    <!-- Filtros de reporte -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <label class="form-label small text-muted">Rango de fechas</label>
                            <select class="form-select" id="reportDateRange">
                                <option value="today">Hoy</option>
                                <option value="week" selected>Última semana</option>
                                <option value="month">Último mes</option>
                                <option value="quarter">Último trimestre</option>
                                <option value="custom">Personalizado</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small text-muted">Categoría</label>
                            <select class="form-select">
                                <option value="">Todas</option>
                                <option value="tech">Soporte Técnico</option>
                                <option value="account">Cuenta y Acceso</option>
                                <option value="payments">Pagos</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small text-muted">Operador</label>
                            <select class="form-select">
                                <option value="">Todos</option>
                                <option value="1">María González</option>
                                <option value="2">Carlos Ruiz</option>
                                <option value="3">Ana Martínez</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button class="btn btn-primary w-100" style="background: var(--brand-gradient); border: none;">
                                <i class="bi bi-funnel me-1"></i> Aplicar Filtros
                            </button>
                        </div>
                    </div>

                    <!-- Resumen de estadísticas -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <div class="p-3 rounded-3 bg-light text-center">
                                <div class="fs-3 fw-bold text-brand-blue">156</div>
                                <div class="small text-muted">Total Tickets</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 rounded-3 bg-light text-center">
                                <div class="fs-3 fw-bold text-success">142</div>
                                <div class="small text-muted">Resueltos</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 rounded-3 bg-light text-center">
                                <div class="fs-3 fw-bold text-warning">2.8h</div>
                                <div class="small text-muted">Tiempo Promedio</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 rounded-3 bg-light text-center">
                                <div class="fs-3 fw-bold text-info">91%</div>
                                <div class="small text-muted">Satisfacción</div>
                            </div>
                        </div>
                    </div>

                    <!-- Gráficos simulados -->
                    <div class="row g-4">
                        <div class="col-md-8">
                            <div class="p-3 rounded-3 border">
                                <h6 class="fw-bold mb-3">Tickets por Día</h6>
                                <div class="d-flex align-items-end justify-content-between" style="height: 150px;">
                                    <div class="text-center flex-fill">
                                        <div class="mx-1 rounded-top" style="height: 80px; background: var(--brand-gradient);"></div>
                                        <small class="text-muted">Lun</small>
                                    </div>
                                    <div class="text-center flex-fill">
                                        <div class="mx-1 rounded-top" style="height: 120px; background: var(--brand-gradient);"></div>
                                        <small class="text-muted">Mar</small>
                                    </div>
                                    <div class="text-center flex-fill">
                                        <div class="mx-1 rounded-top" style="height: 95px; background: var(--brand-gradient);"></div>
                                        <small class="text-muted">Mié</small>
                                    </div>
                                    <div class="text-center flex-fill">
                                        <div class="mx-1 rounded-top" style="height: 140px; background: var(--brand-gradient);"></div>
                                        <small class="text-muted">Jue</small>
                                    </div>
                                    <div class="text-center flex-fill">
                                        <div class="mx-1 rounded-top" style="height: 110px; background: var(--brand-gradient);"></div>
                                        <small class="text-muted">Vie</small>
                                    </div>
                                    <div class="text-center flex-fill">
                                        <div class="mx-1 rounded-top" style="height: 60px; background: rgba(0,156,180,0.5);"></div>
                                        <small class="text-muted">Sáb</small>
                                    </div>
                                    <div class="text-center flex-fill">
                                        <div class="mx-1 rounded-top" style="height: 40px; background: rgba(0,156,180,0.5);"></div>
                                        <small class="text-muted">Dom</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3 rounded-3 border h-100">
                                <h6 class="fw-bold mb-3">Por Categoría</h6>
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between small mb-1">
                                        <span>Soporte Técnico</span>
                                        <span class="fw-bold">45%</span>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar" style="width: 45%; background: #007bff;"></div>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between small mb-1">
                                        <span>Cuenta y Acceso</span>
                                        <span class="fw-bold">25%</span>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar" style="width: 25%; background: #6f42c1;"></div>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between small mb-1">
                                        <span>Pagos</span>
                                        <span class="fw-bold">20%</span>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar" style="width: 20%; background: #28a745;"></div>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between small mb-1">
                                        <span>Otros</span>
                                        <span class="fw-bold">10%</span>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar" style="width: 10%; background: #fd7e14;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-outline-primary rounded-pill px-4">
                        <i class="bi bi-file-earmark-pdf me-1"></i> Exportar PDF
                    </button>
                    <button type="button" class="btn btn-outline-success rounded-pill px-4">
                        <i class="bi bi-file-earmark-excel me-1"></i> Exportar Excel
                    </button>
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Base de Conocimiento -->
    <div class="modal fade" id="knowledgeBaseModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.05), rgba(0, 156, 180, 0.05));">
                    <h5 class="modal-title fw-bold title-gradient">
                        <i class="bi bi-book me-2"></i>Base de Conocimiento
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-4">
                    <!-- Buscador -->
                    <div class="input-group mb-4">
                        <span class="input-group-text bg-white"><i class="bi bi-search text-muted"></i></span>
                        <input type="text" class="form-control" id="kbSearchInput" placeholder="Buscar artículos...">
                    </div>

                    <!-- Categorías -->
                    <div class="row g-4" id="kbCategories">
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm rounded-3 h-100">
                                <div class="card-header bg-transparent d-flex align-items-center gap-2 py-3">
                                    <div class="kb-icon tech" style="width: 35px; height: 35px; font-size: 1rem; margin: 0;">
                                        <i class="bi bi-gear-wide-connected"></i>
                                    </div>
                                    <h6 class="mb-0 fw-bold">Soporte Técnico</h6>
                                </div>
                                <div class="card-body p-0">
                                    <div class="list-group list-group-flush">
                                        <a href="#" class="list-group-item list-group-item-action py-3" onclick="openKBArticle('kb-1')">
                                            <div class="fw-semibold">¿Cómo restablecer mi contraseña?</div>
                                            <small class="text-muted">Pasos para recuperar el acceso a tu cuenta</small>
                                        </a>
                                        <a href="#" class="list-group-item list-group-item-action py-3" onclick="openKBArticle('kb-2')">
                                            <div class="fw-semibold">Problemas con el inicio de sesión</div>
                                            <small class="text-muted">Soluciones comunes para errores de acceso</small>
                                        </a>
                                        <a href="#" class="list-group-item list-group-item-action py-3" onclick="openKBArticle('kb-3')">
                                            <div class="fw-semibold">Error de conexión al servidor</div>
                                            <small class="text-muted">Qué hacer cuando no puedes conectarte</small>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm rounded-3 h-100">
                                <div class="card-header bg-transparent d-flex align-items-center gap-2 py-3">
                                    <div class="kb-icon payments" style="width: 35px; height: 35px; font-size: 1rem; margin: 0;">
                                        <i class="bi bi-credit-card"></i>
                                    </div>
                                    <h6 class="mb-0 fw-bold">Pagos y Facturación</h6>
                                </div>
                                <div class="card-body p-0">
                                    <div class="list-group list-group-flush">
                                        <a href="#" class="list-group-item list-group-item-action py-3" onclick="openKBArticle('kb-4')">
                                            <div class="fw-semibold">Métodos de pago aceptados</div>
                                            <small class="text-muted">Tarjetas, transferencias y otros métodos</small>
                                        </a>
                                        <a href="#" class="list-group-item list-group-item-action py-3" onclick="openKBArticle('kb-5')">
                                            <div class="fw-semibold">¿Cómo solicitar un reembolso?</div>
                                            <small class="text-muted">Proceso y tiempos de devolución</small>
                                        </a>
                                        <a href="#" class="list-group-item list-group-item-action py-3" onclick="openKBArticle('kb-6')">
                                            <div class="fw-semibold">Descargar facturas</div>
                                            <small class="text-muted">Accede a tu historial de facturación</small>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm rounded-3 h-100">
                                <div class="card-header bg-transparent d-flex align-items-center gap-2 py-3">
                                    <div class="kb-icon account" style="width: 35px; height: 35px; font-size: 1rem; margin: 0;">
                                        <i class="bi bi-person-badge"></i>
                                    </div>
                                    <h6 class="mb-0 fw-bold">Cuenta y Acceso</h6>
                                </div>
                                <div class="card-body p-0">
                                    <div class="list-group list-group-flush">
                                        <a href="#" class="list-group-item list-group-item-action py-3" onclick="openKBArticle('kb-7')">
                                            <div class="fw-semibold">Actualizar datos personales</div>
                                            <small class="text-muted">Cómo modificar tu información de perfil</small>
                                        </a>
                                        <a href="#" class="list-group-item list-group-item-action py-3" onclick="openKBArticle('kb-8')">
                                            <div class="fw-semibold">Cambiar mi correo electrónico</div>
                                            <small class="text-muted">Pasos para actualizar tu email</small>
                                        </a>
                                        <a href="#" class="list-group-item list-group-item-action py-3" onclick="openKBArticle('kb-9')">
                                            <div class="fw-semibold">Eliminar mi cuenta</div>
                                            <small class="text-muted">Proceso de baja definitiva</small>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm rounded-3 h-100">
                                <div class="card-header bg-transparent d-flex align-items-center gap-2 py-3">
                                    <div class="kb-icon general" style="width: 35px; height: 35px; font-size: 1rem; margin: 0;">
                                        <i class="bi bi-question-circle"></i>
                                    </div>
                                    <h6 class="mb-0 fw-bold">Preguntas Frecuentes</h6>
                                </div>
                                <div class="card-body p-0">
                                    <div class="list-group list-group-flush">
                                        <a href="#" class="list-group-item list-group-item-action py-3" onclick="openKBArticle('kb-10')">
                                            <div class="fw-semibold">Horarios de atención</div>
                                            <small class="text-muted">Cuándo estamos disponibles para ayudarte</small>
                                        </a>
                                        <a href="#" class="list-group-item list-group-item-action py-3" onclick="openKBArticle('kb-11')">
                                            <div class="fw-semibold">Tiempos de respuesta</div>
                                            <small class="text-muted">Cuánto tardamos en responder tu ticket</small>
                                        </a>
                                        <a href="#" class="list-group-item list-group-item-action py-3" onclick="openKBArticle('kb-12')">
                                            <div class="fw-semibold">Política de privacidad</div>
                                            <small class="text-muted">Cómo protegemos tus datos</small>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-outline-primary rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#newArticleModal">
                        <i class="bi bi-plus-lg me-1"></i> Nuevo Artículo
                    </button>
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Historial de Auditoría -->
    <div class="modal fade" id="auditHistoryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.05), rgba(0, 156, 180, 0.05));">
                    <h5 class="modal-title fw-bold title-gradient">
                        <i class="bi bi-clock-history me-2"></i>Historial del Ticket <span id="auditTicketId">#1001</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="audit-timeline" id="auditTimelineContent">
                        <div class="audit-item action-create">
                            <div class="audit-time">12/12/2025, 10:30</div>
                            <div class="audit-action">Ticket creado</div>
                            <div class="audit-user">por Juan Pérez</div>
                            <div class="audit-details">
                                <strong>Asunto:</strong> Problema con acceso al sistema<br>
                                <strong>Prioridad:</strong> Alta<br>
                                <strong>Categoría:</strong> Soporte Técnico
                            </div>
                        </div>
                        <div class="audit-item action-assign">
                            <div class="audit-time">12/12/2025, 10:35</div>
                            <div class="audit-action">Ticket asignado</div>
                            <div class="audit-user">a María González</div>
                            <div class="audit-details">
                                Asignación automática basada en disponibilidad
                            </div>
                        </div>
                        <div class="audit-item action-update">
                            <div class="audit-time">12/12/2025, 10:45</div>
                            <div class="audit-action">Estado cambiado a "En Proceso"</div>
                            <div class="audit-user">por María González</div>
                        </div>
                        <div class="audit-item action-update">
                            <div class="audit-time">12/12/2025, 11:00</div>
                            <div class="audit-action">Respuesta enviada</div>
                            <div class="audit-user">por María González</div>
                            <div class="audit-details">
                                "Hola Juan, estamos revisando el problema..."
                            </div>
                        </div>
                        <div class="audit-item action-update">
                            <div class="audit-time">12/12/2025, 11:30</div>
                            <div class="audit-action">Archivo adjuntado</div>
                            <div class="audit-user">por Juan Pérez</div>
                            <div class="audit-details">
                                screenshot_error.png (245 KB)
                            </div>
                        </div>
                        <div class="audit-item action-update">
                            <div class="audit-time">12/12/2025, 12:00</div>
                            <div class="audit-action">Prioridad cambiada</div>
                            <div class="audit-user">por María González</div>
                            <div class="audit-details">
                                De "Alta" a "Crítica" - Afecta a múltiples usuarios
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-outline-primary rounded-pill px-4" onclick="exportAuditHistory()">
                        <i class="bi bi-download me-1"></i> Exportar
                    </button>
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Respuestas Predefinidas -->
    <div class="modal fade" id="quickRepliesModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.05), rgba(0, 156, 180, 0.05));">
                    <h5 class="modal-title fw-bold title-gradient">
                        <i class="bi bi-lightning-fill me-2"></i>Respuestas Predefinidas
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-4">
                    <!-- Buscador -->
                    <div class="input-group mb-4">
                        <span class="input-group-text bg-white"><i class="bi bi-search text-muted"></i></span>
                        <input type="text" class="form-control" id="quickReplySearch" placeholder="Buscar respuestas...">
                    </div>

                    <!-- Lista de respuestas -->
                    <div class="list-group" id="quickRepliesList">
                        <div class="list-group-item list-group-item-action p-3" onclick="selectQuickReply('saludo')">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1 fw-bold text-brand-blue">Saludo Inicial</h6>
                                    <p class="mb-1 text-muted small">Hola $nombre, gracias por contactarnos. Mi nombre es $operador y estaré ayudándote con tu solicitud...</p>
                                </div>
                                <span class="badge bg-light text-dark">General</span>
                            </div>
                        </div>
                        <div class="list-group-item list-group-item-action p-3" onclick="selectQuickReply('seguimiento')">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1 fw-bold text-brand-blue">Solicitar Información</h6>
                                    <p class="mb-1 text-muted small">Para poder ayudarte mejor, necesito que me proporciones la siguiente información...</p>
                                </div>
                                <span class="badge bg-light text-dark">Seguimiento</span>
                            </div>
                        </div>
                        <div class="list-group-item list-group-item-action p-3" onclick="selectQuickReply('password')">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1 fw-bold text-brand-blue">Reset de Contraseña</h6>
                                    <p class="mb-1 text-muted small">Hemos enviado un enlace de recuperación a tu correo electrónico. Por favor revisa tu bandeja de entrada...</p>
                                </div>
                                <span class="badge bg-info text-white">Técnico</span>
                            </div>
                        </div>
                        <div class="list-group-item list-group-item-action p-3" onclick="selectQuickReply('escalado')">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1 fw-bold text-brand-blue">Escalado a Soporte</h6>
                                    <p class="mb-1 text-muted small">Tu caso ha sido escalado a nuestro equipo de soporte técnico especializado. Te contactarán en breve...</p>
                                </div>
                                <span class="badge bg-warning text-dark">Escalado</span>
                            </div>
                        </div>
                        <div class="list-group-item list-group-item-action p-3" onclick="selectQuickReply('resuelto')">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1 fw-bold text-brand-blue">Ticket Resuelto</h6>
                                    <p class="mb-1 text-muted small">Me alegra que hayamos podido resolver tu problema. Si tienes alguna otra consulta, no dudes en contactarnos...</p>
                                </div>
                                <span class="badge bg-success text-white">Cierre</span>
                            </div>
                        </div>
                        <div class="list-group-item list-group-item-action p-3" onclick="selectQuickReply('pago')">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1 fw-bold text-brand-blue">Problema de Pago</h6>
                                    <p class="mb-1 text-muted small">Entendemos tu preocupación respecto al pago. Hemos verificado en nuestro sistema y...</p>
                                </div>
                                <span class="badge bg-success text-white">Pagos</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 justify-content-between">
                    <button type="button" class="btn btn-outline-primary rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#newQuickReplyModal">
                        <i class="bi bi-plus-lg me-1"></i> Nueva Respuesta
                    </button>
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Previsualización de Adjunto (tipo Drive) -->
    <div class="modal fade" id="adjuntoPreviewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl modal-fullscreen-sm-down">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.05), rgba(0, 156, 180, 0.05));">
                    <div class="d-flex align-items-center gap-3" style="min-width: 0;">
                        <div class="bg-white rounded-3 border d-flex align-items-center justify-content-center" style="width: 44px; height: 44px; flex: 0 0 44px;">
                            <i id="adjuntoPreviewIcon" class="bi bi-file-earmark text-muted"></i>
                        </div>
                        <div class="d-flex flex-column" style="min-width: 0;">
                            <h5 class="modal-title fw-bold title-gradient text-truncate mb-0" id="adjuntoPreviewTitle">Adjunto</h5>
                            <small class="text-muted" id="adjuntoPreviewMeta">&nbsp;</small>
                        </div>
                    </div>
                    <div class="d-flex align-items-center gap-2 flex-wrap justify-content-end">
                        <button type="button" class="btn btn-light border rounded-pill btn-sm px-3" id="adjuntoPreviewBtnShare">
                            <i class="bi bi-share me-1"></i> Compartir
                        </button>
                        <button type="button" class="btn btn-light border rounded-pill btn-sm px-3" id="adjuntoPreviewBtnCopyLink">
                            <i class="bi bi-link-45deg me-1"></i> Copiar enlace
                        </button>
                        <button type="button" class="btn btn-outline-primary rounded-pill btn-sm px-3" id="adjuntoPreviewBtnDownload">
                            <i class="bi bi-download me-1"></i> Descargar
                        </button>
                        <button type="button" class="btn btn-light border rounded-pill btn-sm px-3" id="adjuntoPreviewBtnOpenTab">
                            <i class="bi bi-box-arrow-up-right me-1"></i> Nueva pestaña
                        </button>
                        <button type="button" class="btn-close ms-1" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                </div>
                <div class="modal-body p-0">
                    <div id="adjuntoPreviewBody" class="p-3 bg-light" style="min-height: 55vh;">
                        <div class="d-flex align-items-center justify-content-center text-muted" style="min-height: 55vh;">
                            <div class="text-center">
                                <div class="spinner-border" role="status" aria-hidden="true"></div>
                                <div class="mt-2">Cargando vista previa...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Crear Nueva Respuesta Predefinida -->
    <div class="modal fade" id="newQuickReplyModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.05), rgba(0, 156, 180, 0.05));">
                    <h5 class="modal-title fw-bold title-gradient">
                        <i class="bi bi-plus-circle me-2"></i>Nueva Respuesta Predefinida
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label class="form-label fw-semibold text-brand-blue">Título <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="newReplyTitle" placeholder="Ej: Saludo inicial">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold text-brand-blue">Categoría</label>
                        <select class="form-select" id="newReplyCategory">
                            <option value="general">General</option>
                            <option value="tecnico">Técnico</option>
                            <option value="pagos">Pagos</option>
                            <option value="seguimiento">Seguimiento</option>
                            <option value="cierre">Cierre</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold text-brand-blue">Contenido <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="newReplyContent" rows="5" placeholder="Escribe el contenido de la respuesta..."></textarea>
                        <small class="text-muted">Variables disponibles: $nombre, $operador, $ticket_id, $fecha</small>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary rounded-pill px-4" style="background: var(--brand-gradient); border: none;" onclick="saveQuickReply()">
                        <i class="bi bi-check-lg me-1"></i> Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Todas las Notificaciones -->
    <div class="modal fade" id="allNotificationsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.05), rgba(0, 156, 180, 0.05));">
                    <h5 class="modal-title fw-bold title-gradient">
                        <i class="bi bi-bell-fill me-2"></i>Centro de Notificaciones
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-0">
                    <!-- Filtros -->
                    <div class="p-3 border-bottom bg-light">
                        <div class="d-flex flex-wrap gap-2 align-items-center">
                            <span class="fw-semibold text-brand-dark me-2">Filtrar:</span>
                            <button class="btn btn-sm btn-primary rounded-pill active" data-filter="all" onclick="filterAllNotifications('all')">
                                Todas
                            </button>
                            <button class="btn btn-sm btn-outline-secondary rounded-pill" data-filter="unread" onclick="filterAllNotifications('unread')">
                                <i class="bi bi-circle-fill text-danger me-1" style="font-size: 6px; vertical-align: middle;"></i>No leídas
                            </button>
                            <button class="btn btn-sm btn-outline-secondary rounded-pill" data-filter="ticket" onclick="filterAllNotifications('ticket')">
                                <i class="bi bi-ticket-perforated me-1"></i>Tickets
                            </button>
                            <button class="btn btn-sm btn-outline-secondary rounded-pill" data-filter="system" onclick="filterAllNotifications('system')">
                                <i class="bi bi-gear me-1"></i>Sistema
                            </button>
                            <button class="btn btn-sm btn-outline-secondary rounded-pill" data-filter="alert" onclick="filterAllNotifications('alert')">
                                <i class="bi bi-exclamation-triangle me-1"></i>Alertas
                            </button>
                        </div>
                    </div>
                    
                    <!-- Lista de notificaciones -->
                    <div class="all-notifications-list" id="allNotificationsList" style="max-height: 400px; overflow-y: auto;">
                        <!-- Se llena dinámicamente -->
                    </div>
                    
                    <!-- Paginación -->
                    <div class="p-3 border-top d-flex justify-content-between align-items-center">
                        <span class="text-muted small" id="notificationsPagination">Mostrando 1-10 de 25</span>
                        <nav aria-label="Paginación de notificaciones">
                            <ul class="pagination pagination-sm mb-0">
                                <li class="page-item disabled">
                                    <a class="page-link" href="#" onclick="changeNotificationPage(-1)">
                                        <i class="bi bi-chevron-left"></i>
                                    </a>
                                </li>
                                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                <li class="page-item"><a class="page-link" href="#">2</a></li>
                                <li class="page-item"><a class="page-link" href="#">3</a></li>
                                <li class="page-item">
                                    <a class="page-link" href="#" onclick="changeNotificationPage(1)">
                                        <i class="bi bi-chevron-right"></i>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
                <div class="modal-footer border-0 justify-content-between">
                    <button type="button" class="btn btn-outline-danger rounded-pill px-4" onclick="clearAllNotifications()">
                        <i class="bi bi-trash me-1"></i> Limpiar todas
                    </button>
                    <button type="button" class="btn btn-outline-primary rounded-pill px-4" onclick="markAllAsRead()">
                        <i class="bi bi-check-all me-1"></i> Marcar todas como leídas
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nuevo Usuario -->
    <div class="modal fade" id="newUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.05), rgba(0, 156, 180, 0.05));">
                    <h5 class="modal-title fw-bold title-gradient">
                        <i class="bi bi-person-plus-fill me-2"></i>Nuevo Usuario
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="newUserForm">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Nombre completo <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" placeholder="Ej: Juan Pérez" id="newUserFullName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Nombre de usuario <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">@</span>
                                <input type="text" class="form-control" placeholder="jperez" id="newUserUsername" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" placeholder="juan.perez@clubrecrear.com" id="newUserEmail" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Contraseña temporal <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" placeholder="Mínimo 8 caracteres" id="newUserPassword" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Perfil <span class="text-danger">*</span></label>
                            <select class="form-select" id="newUserRole" required>
                                <option value="">Seleccionar perfil...</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Departamento <span class="text-danger">*</span></label>
                            <select class="form-select" id="newUserDepto" required>
                                <option value="">Seleccionar departamento...</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Rol en departamento <span class="text-danger">*</span></label>
                            <select class="form-select" id="newUserDeptoRol" required>
                                <option value="Agente">Agente</option>
                                <option value="Supervisor">Supervisor</option>
                                <option value="Jefe">Jefe</option>
                            </select>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="sendWelcomeEmail" checked>
                            <label class="form-check-label" for="sendWelcomeEmail">
                                Enviar email de bienvenida con credenciales
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary rounded-pill px-4" style="background: var(--brand-gradient); border: none;" onclick="saveNewUser()">
                        <i class="bi bi-check-lg me-1"></i>Crear Usuario
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Editar Usuario -->
    <div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.05), rgba(0, 156, 180, 0.05));">
                    <h5 class="modal-title fw-bold title-gradient">
                        <i class="bi bi-pencil-fill me-2"></i>Editar Usuario
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="editUserForm">
                        <div class="text-center mb-4">
                            <div class="user-avatar mx-auto" style="width: 70px; height: 70px; background: linear-gradient(135deg, #0065B7, #009CB4); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">
                                <i class="bi bi-person-fill"></i>
                            </div>
                            <h6 class="mt-2 fw-semibold" id="editUserName">María González</h6>
                            <small class="text-muted" id="editUserUsername">@mgonzalez</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Nombre completo</label>
                            <input type="text" class="form-control" id="editUserFullName" value="María González">
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Email</label>
                            <input type="email" class="form-control" id="editUserEmail" value="maria.gonzalez@clubrecrear.com">
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Rol</label>
                            <select class="form-select" id="editUserRole">
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Estado</label>
                            <select class="form-select" id="editUserStatus">
                                <option value="active" selected>Activo</option>
                                <option value="inactive">Inactivo</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Departamento</label>
                            <select class="form-select" id="editUserDepto">
                                <option value="">Sin cambios</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Rol en departamento</label>
                            <select class="form-select" id="editUserDeptoRol">
                                <option value="Agente">Agente</option>
                                <option value="Supervisor">Supervisor</option>
                                <option value="Jefe">Jefe</option>
                            </select>
                        </div>
                        <div class="border-top pt-3 mt-3">
                            <button type="button" class="btn btn-outline-warning w-100 rounded-pill mb-2" onclick="resetUserPassword()">
                                <i class="bi bi-key-fill me-2"></i>Restablecer contraseña
                            </button>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary rounded-pill px-4" style="background: var(--brand-gradient); border: none;" onclick="saveUserChanges()">
                        <i class="bi bi-check-lg me-1"></i>Guardar Cambios
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ver Actividad Usuario -->
    <div class="modal fade" id="userActivityModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.05), rgba(0, 156, 180, 0.05));">
                    <h5 class="modal-title fw-bold title-gradient">
                        <i class="bi bi-clock-history me-2"></i>Actividad del Usuario
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="d-flex align-items-center mb-4 pb-3 border-bottom">
                        <div class="user-avatar me-3" style="width: 50px; height: 50px; background: linear-gradient(135deg, #0065B7, #009CB4); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem;">
                            <i class="bi bi-person-fill"></i>
                        </div>
                        <div>
                            <h6 class="mb-1 fw-semibold" id="activityUserName">María González</h6>
                            <small class="text-muted" id="activityUserEmail">maria.gonzalez@clubrecrear.com</small>
                        </div>
                    </div>

                    <!-- Filtros de actividad -->
                    <div class="d-flex gap-2 mb-4">
                        <select class="form-select form-select-sm" style="max-width: 200px;">
                            <option value="all">Todas las actividades</option>
                            <option value="login">Inicios de sesión</option>
                            <option value="ticket">Acciones en tickets</option>
                            <option value="config">Cambios de configuración</option>
                        </select>
                        <input type="date" class="form-control form-control-sm" style="max-width: 180px;">
                    </div>

                    <!-- Timeline de actividad -->
                    <div class="activity-timeline" style="max-height: 400px; overflow-y: auto;">
                        <div class="activity-item">
                            <div class="activity-icon bg-success">
                                <i class="bi bi-box-arrow-in-right"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-header">
                                    Inició sesión en el sistema
                                </div>
                                <div class="activity-time">16/12/2025 - 14:35:22</div>
                            </div>
                        </div>

                        <div class="activity-item">
                            <div class="activity-icon bg-primary">
                                <i class="bi bi-ticket-perforated"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-header">
                                    Respondió al ticket <strong>#1001</strong>
                                </div>
                                <div class="activity-time">16/12/2025 - 14:20:15</div>
                            </div>
                        </div>

                        <div class="activity-item">
                            <div class="activity-icon bg-info">
                                <i class="bi bi-arrow-repeat"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-header">
                                    Cambió el estado del ticket <strong>#1002</strong> a <span class="badge bg-warning">En progreso</span>
                                </div>
                                <div class="activity-time">16/12/2025 - 13:45:30</div>
                            </div>
                        </div>

                        <div class="activity-item">
                            <div class="activity-icon bg-warning">
                                <i class="bi bi-person-add"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-header">
                                    Se asignó el ticket <strong>#1005</strong>
                                </div>
                                <div class="activity-time">16/12/2025 - 12:30:00</div>
                            </div>
                        </div>

                        <div class="activity-item">
                            <div class="activity-icon bg-success">
                                <i class="bi bi-box-arrow-in-right"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-header">
                                    Inició sesión en el sistema
                                </div>
                                <div class="activity-time">16/12/2025 - 08:15:00</div>
                            </div>
                        </div>

                        <div class="activity-item">
                            <div class="activity-icon bg-danger">
                                <i class="bi bi-box-arrow-right"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-header">
                                    Cerró sesión
                                </div>
                                <div class="activity-time">15/12/2025 - 18:00:00</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-outline-primary rounded-pill px-4" onclick="exportUserActivity()">
                        <i class="bi bi-download me-2"></i>Exportar actividad
                    </button>
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nuevo Rol -->
    <div class="modal fade" id="newRoleModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.05), rgba(0, 156, 180, 0.05));">
                    <h5 class="modal-title fw-bold title-gradient">
                        <i class="bi bi-key-fill me-2"></i>Nuevo Rol
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="newRoleForm">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Nombre del rol <span class="text-danger">*</span></label>
                            <input type="text" id="newRoleName" class="form-control" placeholder="Ej: Gerente de Soporte" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Descripción</label>
                            <textarea id="newRoleDescription" class="form-control" rows="2" placeholder="Breve descripción del rol y sus responsabilidades"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold mb-3">Permisos</label>
                            <div class="border rounded-3 p-3" id="newRolePermissions">
                                <div class="text-muted small">Cargando permisos...</div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary rounded-pill px-4" style="background: var(--brand-gradient); border: none;" onclick="saveNewRole()">
                        <i class="bi bi-check-lg me-1"></i>Crear Rol
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Editar Permisos del Rol -->
    <div class="modal fade" id="editRoleModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.05), rgba(0, 156, 180, 0.05));">
                    <h5 class="modal-title fw-bold title-gradient">
                        <i class="bi bi-key-fill me-2"></i>Editar permisos
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Nombre del rol</label>
                        <input type="text" class="form-control" id="editRoleNameInput" placeholder="Nombre del rol">
                        <div class="text-muted small mt-1" id="editRoleNameHelp" style="display:none;">Este rol es base del sistema y no se puede renombrar.</div>
                    </div>

                    <div class="mb-3 d-flex align-items-center justify-content-between">
                        <div>
                            <div class="fw-semibold">Estado</div>
                            <div class="text-muted small" id="editRoleActiveHelp" style="display:none;">Este rol base no se puede desactivar.</div>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="editRoleActiveSwitch">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold mb-2">Permisos</label>
                        <div class="border rounded-3 p-3" id="editRolePermissions">
                            <div class="text-muted small">Cargando permisos...</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary rounded-pill px-4" style="background: var(--brand-gradient); border: none;" onclick="saveRole()">
                        <i class="bi bi-check-lg me-1"></i>Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-bottom-nav d-md-none">
        <button class="mobile-nav-item active" type="button" onclick="switchTab('home', this)">
            <i class="bi bi-house-door-fill"></i>
            <span>Home</span>
        </button>
        <button class="mobile-nav-item" type="button" onclick="switchTab('ticket', this)">
            <i class="bi bi-ticket-perforated-fill"></i>
            <span>Tickets</span>
        </button>
        <button class="mobile-nav-item position-relative" type="button" data-bs-toggle="offcanvas" data-bs-target="#solicitudesOffcanvas" aria-controls="solicitudesOffcanvas">
            <i class="bi bi-inbox-fill"></i>
            <span>Solicitudes</span>
            <span class="mobile-nav-badge" id="solicitudesCounterMobile">3</span>
        </button>
        <button class="mobile-nav-item" type="button" onclick="switchTab('admin', this)" id="adminMobileNav">
            <i class="bi bi-shield-lock-fill"></i>
            <span>Admin</span>
        </button>
        <button class="mobile-nav-item" type="button" onclick="switchTab('config', this)">
            <i class="bi bi-gear-fill"></i>
            <span>Config</span>
        </button>
        <button class="mobile-nav-item mobile-nav-logout" type="button" data-bs-toggle="modal" data-bs-target="#logoutModal">
            <i class="bi bi-box-arrow-left"></i>
            <span>Salir</span>
        </button>
    </nav>

    <!-- Floating Action Button (Mobile) -->
    <button class="fab d-md-none" id="fabButton">
        <i class="bi bi-plus-lg"></i>
    </button>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/auth.js"></script>
    <script src="/static/js/dashboard-api.js"></script>
    <script src="/static/js/tickets-reales.js?v=20260119_1"></script>
    <script src="/static/js/ticket-chat.js?v=20260119_1"></script>
    <script src="/static/js/ticket-estado-prioridad.js"></script>
    <script>
        // Variables globales
        let isMobile = window.innerWidth < 768;
        let selectedFiles = [];

        // Detectar cambios de tamaño
        window.addEventListener('resize', function() {
            isMobile = window.innerWidth < 768;
            syncLayoutState();
        });

        // Initialize mobile navigation
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Mobile navigation initialized');
            syncLayoutState();
            
            // Re-sincronizar cuando se abre/cierra modales para evitar glitches visuales
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                modal.addEventListener('show.bs.modal', function() {
                    requestAnimationFrame(syncLayoutState);
                });
                modal.addEventListener('hidden.bs.modal', function() {
                    requestAnimationFrame(syncLayoutState);
                });
            });
        });

        function syncLayoutState() {
            const activePane = document.querySelector('.tab-pane.active');
            const mainWrapper = document.querySelector('.main-wrapper');
            
            // Limpiar cualquier estilo inline de borderRadius para que CSS tome control
            if (mainWrapper && mainWrapper.style.borderRadius) {
                mainWrapper.style.borderRadius = '';
            }
            
            if (activePane) {
                if (typeof handleSidebarCollapse === 'function') {
                    handleSidebarCollapse(activePane.id);
                }
            }
        }



        // Función para cambiar de pestaña
        function switchTab(tabName, clickedElement = null) {
            console.log('switchTab llamado con:', tabName);
            const mobileNavItems = document.querySelectorAll('.mobile-nav-item');
            const fab = document.querySelector('.fab');
            
            // Actualizar estado visual de los botones
            mobileNavItems.forEach(nav => nav.classList.remove('active'));
            if (clickedElement) clickedElement.classList.add('active');
            
            // Activar el tab de Bootstrap
            const tabElement = document.querySelector('#' + tabName + '-tab');
            console.log('Buscando tab:', '#' + tabName + '-tab', 'Encontrado:', tabElement);
            if (tabElement) {
                const tab = new bootstrap.Tab(tabElement);
                tab.show();
                console.log('Tab activado:', tabName);
            } else {
                console.error('No se encontró el tab:', tabName);
            }
            
            // Mostrar FAB en Home y Tickets, ocultar en Config
            const fabButton = document.getElementById('fabButton');
            if (isMobile && fabButton) {
                if (tabName === 'home' || tabName === 'ticket') {
                    fabButton.style.display = 'flex';
                } else {
                    fabButton.style.display = 'none';
                }
            }
            
            // Si está en la pestaña de tickets en móvil, asegurar que se muestra la lista
            if (tabName === 'ticket' && isMobile) {
                const ticketsList = document.getElementById('mobileTicketsList');
                const chatContainer = document.getElementById('mobileChatContainer');
                const bottomNav = document.querySelector('.mobile-bottom-nav');
                
                if (ticketsList && chatContainer) {
                    ticketsList.classList.remove('d-none');
                    chatContainer.classList.add('d-none');
                    chatContainer.classList.remove('d-flex');
                }
                if (bottomNav) bottomNav.style.display = 'flex';
            }
            
            // Colapsar/expandir sidebar según la pestaña (Desktop)
            handleSidebarCollapse(tabName);
        }
        
        // ========================================
        // NUEVO LAYOUT DE TICKETS - FUNCIONES
        // ========================================
        
        // Manejar el colapso del sidebar - ACTUALIZADO
        function handleSidebarCollapse(tabName) {
            const sidebar = document.querySelector('.sidebar');
            const mainWrapper = document.querySelector('.main-wrapper');
            const body = document.body;
            
            if (!sidebar) return;
            
            // Usar clases CSS en lugar de estilos inline para mejor control
            if (tabName === 'ticket' && !isMobile) {
                body.classList.add('tab-ticket-active');
                sidebar.classList.add('collapsed');
            } else {
                body.classList.remove('tab-ticket-active');
                sidebar.classList.remove('collapsed');
            }
            
            // NO aplicar estilos inline - dejar que CSS maneje el border-radius
            // Esto evita conflictos de especificidad
        }
        
        // Cerrar el chat y volver al listado expandido
        function closeTicketChat() {
            const mainContainer = document.querySelector('.tickets-main-container');
            if (mainContainer) {
                mainContainer.classList.remove('ticket-selected');
            }
            
            // Quitar la clase active de todos los tickets
            document.querySelectorAll('.ticket-card').forEach(card => {
                card.classList.remove('active');
            });
        }
        
        // Seleccionar ticket en desktop
        function selectTicketDesktop(ticketId, element) {
            // Remover clase active de todos los ticket cards
            document.querySelectorAll('.ticket-card').forEach(card => {
                card.classList.remove('active');
            });
            
            // Agregar clase active al card seleccionado
            if (element) {
                element.classList.add('active');
            }
            
            // Actualizar también el sidebar mini si existe
            document.querySelectorAll('.ticket-history-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Activar el layout reducido (mostrar chat y detalles)
            const mainContainer = document.querySelector('.tickets-main-container');
            if (mainContainer) {
                mainContainer.classList.add('ticket-selected');
            }
            
            // Aquí se cargaría dinámicamente el contenido del ticket
            console.log('Ticket seleccionado:', ticketId);
            
            // ELIMINADO: updateChatHeader() porque ahora se usa actualizarChatHeader() desde tickets-reales.js
            
            // Scroll to top del chat
            const chatMessages = document.getElementById('chatMessagesDesktop');
            if (chatMessages) {
                chatMessages.scrollTop = 0;
            }
        }
        
        // Actualizar header del chat con datos del ticket seleccionado
        function updateChatHeader(ticketId, ticketCard) {
            const chatPanel = document.getElementById('ticketsChatPanel');
            if (!chatPanel) return;
            
            // Obtener datos del ticket card
            const subject = ticketCard?.querySelector('.ticket-card-subject')?.textContent || 'Sin asunto';
            const badges = ticketCard?.querySelector('.ticket-card-badges')?.innerHTML || '';
            
            const header = chatPanel.querySelector('.chat-header');
            if (header) {
                const headerContent = header.querySelector('.flex-grow-1');
                if (headerContent) {
                    headerContent.innerHTML = `
                        <div class="d-flex align-items-center gap-2">
                            <h5 class="mb-0 fw-bold text-brand-blue">#${ticketId}</h5>
                            ${badges}
                        </div>
                        <small class="text-muted d-block text-truncate">${subject}</small>
                    `;
                }
            }
        }
        
        // Enviar mensaje en chat desktop
        function sendChatMessageDesktop() {
            // Llamar a la función enviarMensaje() de ticket-chat.js
            // que guarda el mensaje en la base de datos
            if (typeof enviarMensaje === 'function') {
                enviarMensaje();
            } else {
                console.error('Función enviarMensaje() no está disponible');
            }
        }
        
        // Insertar respuesta rápida en chat desktop
        function insertQuickReplyDesktop(text) {
            const input = document.getElementById('chatMessageInputDesktop');
            if (input) {
                input.value = text;
                input.focus();
            }
            // Cerrar el panel de respuestas rápidas después de seleccionar una
            const panel = document.getElementById('quickRepliesInlineDesktop');
            if (panel && panel.classList.contains('show')) {
                panel.classList.remove('show');
            }
        }
        
        // Variable para almacenar el filtro de estado actual
        let currentStatusFilter = 'all';
        
        // Estado global de filtros (debe ser accesible desde otros scripts)
        // Usar tokens normalizados (coinciden con data-status)
        window.activeStatusFilters = ['pendiente', 'en-proceso'];
        window.activePriorityId = null; // null = todos

        function normalizeStatusToken(status) {
            if (!status) return '';
            let s = String(status).toLowerCase().trim();
            s = s.replace(/\s+/g, ' ');
            s = s.replace(/_/g, '-');

            // Normalizar acentos comunes
            s = s
                .replace(/á/g, 'a')
                .replace(/é/g, 'e')
                .replace(/í/g, 'i')
                .replace(/ó/g, 'o')
                .replace(/ú/g, 'u');

            // Variantes → tokens usados en data-status
            if (s === 'nuevo') return 'pendiente';
            if (s === 'pendiente') return 'pendiente';
            if (s === 'en proceso' || s === 'en progreso' || s === 'en-proceso' || s === 'en-progreso') return 'en-proceso';
            if (s === 'sin responder' || s === 'sin-responder' || s === 'sin respuesta' || s === 'sin-respuesta') return 'sin-respuesta';
            if (s === 'resuelto') return 'resuelto';
            if (s === 'cerrado') return 'cerrado';
            if (s === 'rechazado') return 'rechazado';
            return s.replace(/\s+/g, '-');
        }
        
        function filterTicketsByStatus(status, element) {
            const normalized = status === 'all' ? 'all' : normalizeStatusToken(status);
            // Si se hace clic en "Todos", desactivar todos los demás
            if (normalized === 'all') {
                window.activeStatusFilters = [];
                document.querySelectorAll('.quick-filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                if (element) {
                    element.classList.add('active');
                }
            } else {
                // Remover "Todos" si está activo
                document.querySelector('.quick-filter-btn.filter-all')?.classList.remove('active');
                
                // Toggle del filtro seleccionado
                if (window.activeStatusFilters.includes(normalized)) {
                    window.activeStatusFilters = window.activeStatusFilters.filter(f => f !== normalized);
                    element?.classList.remove('active');
                } else {
                    window.activeStatusFilters.push(normalized);
                    element?.classList.add('active');
                }
                
                // Si no hay filtros activos, activar "Todos"
                if (window.activeStatusFilters.length === 0) {
                    document.querySelector('.quick-filter-btn.filter-all')?.classList.add('active');
                }
            }
            
            applyAllFilters();
        }
        
        // Función para aplicar todos los filtros
        function applyAllFilters() {
            const ticketCards = document.querySelectorAll('#ticketsScrollContainer .ticket-card, #recent-tickets-tbody tr');
            const searchInput = document.getElementById('desktopSearchInput');
            const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
            const departmentSelect = document.getElementById('departmentFilter');
            // Si el filtro de departamento está oculto por permisos (o deshabilitado), no debe afectar el listado.
            const departmentFilter = (departmentSelect && departmentSelect.offsetParent !== null && !departmentSelect.disabled)
                ? (departmentSelect.value || '')
                : '';
            const operatorFilter = document.getElementById('operatorFilter')?.value || '';
            const senderFilter = document.getElementById('senderFilter')?.value || '';
            const activeStatusFiltersRaw = Array.isArray(window.activeStatusFilters) ? window.activeStatusFilters : [];
            const activeStatusFilters = activeStatusFiltersRaw
                .map(normalizeStatusToken)
                .filter(Boolean);
            const activePriorityId = window.activePriorityId;
            
            console.log('🔍 Aplicando filtros:', {
                departamentoFilter: departmentFilter,
                receptorFilter: operatorFilter,
                emisorFilter: senderFilter,
                prioridadId: activePriorityId,
                totalElements: ticketCards.length
            });
            
            let visibleCount = 0;
            
            ticketCards.forEach(card => {
                let show = true;
                const isRow = card.tagName === 'TR';
                
                // Filtro de departamento
                // Preferir el depto destino del ticket (data-depto-id). Si no existe (tickets antiguos),
                // usar el depto del Owner actual (data-depto-owner-id).
                if (show && departmentFilter) {
                    const deptoId = card.getAttribute('data-depto-id') || card.getAttribute('data-depto-owner-id');
                    if (String(deptoId) !== String(departmentFilter)) {
                        show = false;
                    }
                }
                
                // Filtro de estado (soporta estado especial 'por-tomar')
                if (show && activeStatusFilters.length > 0) {
                    const rawStatus = card.getAttribute('data-status');
                    const status = normalizeStatusToken(rawStatus || 'pendiente');

                    // Evaluar si la tarjeta cumple alguno de los filtros activos
                    const passesStatus = activeStatusFilters.some(f => {
                        if (!f) return false;
                        if (f === 'por-tomar') {
                            // Condición especial: tarjeta marcada como por tomar
                            if (card.classList && card.classList.contains('ticket-card-por-tomar')) return true;
                            // O buscar badge con texto "Por tomar"
                            const badgeText = (card.querySelector && card.querySelector('.ticket-card-badges .badge')?.textContent || '').toLowerCase();
                            if (badgeText.includes('por tomar')) return true;
                            // Para filas de tabla, buscar texto en la fila
                            if (card.tagName === 'TR' && card.textContent.toLowerCase().includes('por tomar')) return true;
                            return false;
                        }

                        // Filtros normales basados en data-status
                        return String(status) === String(f);
                    });

                    if (!passesStatus) show = false;
                }
                
                // Filtro de búsqueda
                if (show && searchTerm) {
                    let textContent = '';
                    if (isRow) {
                        textContent = card.textContent.toLowerCase();
                    } else {
                        const id = card.querySelector('.ticket-card-id')?.textContent.toLowerCase() || '';
                        const subject = card.querySelector('.ticket-card-subject')?.textContent.toLowerCase() || '';
                        const preview = card.querySelector('.ticket-card-preview')?.textContent.toLowerCase() || '';
                        const user = card.querySelector('.ticket-card-user-name')?.textContent.toLowerCase() || '';
                        textContent = id + ' ' + subject + ' ' + preview + ' ' + user;
                    }
                    
                    if (!textContent.includes(searchTerm)) show = false;
                }
                
                // Filtro de receptor (destinatario/asignado)
                if (show && operatorFilter) {
                    const receptorId = card.getAttribute('data-operador-id');

                    // Soportar filtro explícito para tickets sin asignar
                    if (String(operatorFilter) === '__unassigned__') {
                        if (String(receptorId || '') !== '') {
                            show = false;
                        }
                    } else {
                        if (String(receptorId) !== String(operatorFilter)) {
                            show = false;
                        }
                    }
                }
                
                // Filtro de emisor (quien creó el ticket)
                if (show && senderFilter) {
                    const emisorId = card.getAttribute('data-remitente-id');
                    // Si el ticket no tiene emisor definido, no lo ocultamos si el filtro es "Todos" (vacío)
                    // Pero si hay un filtro seleccionado, y el ticket no tiene emisor, se oculta.
                    if (!emisorId) {
                        show = false;
                    } else if (String(emisorId) !== String(senderFilter)) {
                        show = false;
                    }
                }

                // Filtro de prioridad (por ID)
                if (show && activePriorityId) {
                    const prioridadId = card.getAttribute('data-prioridad');
                    if (String(prioridadId) !== String(activePriorityId)) {
                        show = false;
                    }
                }
                
                if (show) {
                    if (isRow) {
                        card.style.display = '';
                    } else {
                        // No forzar display, para no romper el layout del card
                        card.style.display = '';
                    }
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });
            
            console.log('✅ Tickets visibles:', visibleCount, 'de', ticketCards.length);
            
            // Mostrar/ocultar estado vacío
            const emptyState = document.querySelector('.empty-state');
            if (emptyState) {
                emptyState.style.display = visibleCount === 0 ? 'block' : 'none';
            }
        }
        
        // Función para aplicar filtros avanzados
        function applyAdvancedFilters() {
            applyAllFilters();
        }
        
        // Búsqueda de tickets desktop
        function setupDesktopTicketSearch() {
            const searchInput = document.getElementById('desktopSearchInput');
            if (!searchInput) return;
            
            searchInput.addEventListener('input', function(e) {
                applyAllFilters();
            });
        }
        
        // Filtrar tickets móviles
        function filterMobileTickets(status) {
            // Actualizar botones activos en móvil
            const mobileFilters = document.querySelectorAll('#ticket .d-md-none .btn-sm');
            mobileFilters.forEach(btn => {
                btn.classList.remove('active', 'btn-primary');
                btn.classList.add('btn-outline-warning', 'btn-outline-info', 'btn-outline-success', 'btn-outline-danger');
            });
            
            event.target.classList.add('active');
            if (status === 'all') {
                event.target.classList.remove('btn-outline-primary');
                event.target.classList.add('btn-primary');
            }
            
            // Aplicar filtro a tickets móviles
            const mobileTickets = document.querySelectorAll('#mobileTicketsList .tickets-list-item');

            mobileTickets.forEach(ticket => {
                const ticketStatus = ticket.getAttribute('data-status');

                if (status === 'all') {
                    ticket.style.display = '';
                } else if (status === 'por-tomar') {
                    // Mostrar si la tarjeta está marcada como por tomar o contiene esa etiqueta
                    const isPorTomar = (ticket.classList && ticket.classList.contains('ticket-card-por-tomar')) || (ticket.textContent || '').toLowerCase().includes('por tomar');
                    ticket.style.display = isPorTomar ? '' : 'none';
                } else {
                    if (ticketStatus === status) {
                        ticket.style.display = '';
                    } else {
                        ticket.style.display = 'none';
                    }
                }
            });
        }
        
        // Escape HTML para prevenir XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Sincronizar tabs móviles con tabs de escritorio
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar tooltips de Bootstrap
            const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
            const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
            
            // Inicializar búsqueda de tickets desktop
            setupDesktopTicketSearch();
            
            // Aplicar filtros predeterminados (Pendiente y En Proceso)
            applyAllFilters();
            
            // Verificar sidebar colapsado al cargar según tab activo
            const activeTab = document.querySelector('.nav-link.active');
            if (activeTab) {
                const tabTarget = activeTab.getAttribute('data-bs-target');
                if (tabTarget === '#ticket') {
                    handleSidebarCollapse('ticket');
                }
            }
            
            // Estado inicial: móvil muestra lista, desktop usa el nuevo layout
            const initialIsMobile = window.innerWidth < 768;
            const ticketsList = document.getElementById('mobileTicketsList');
            const chatContainer = document.getElementById('mobileChatContainer');
            const bottomNav = document.querySelector('.mobile-bottom-nav');

            // En desktop, el mobileChatContainer siempre debe estar oculto
            // El nuevo layout de tickets usa tickets-main-container
            if (!initialIsMobile) {
                if (chatContainer) {
                    chatContainer.classList.add('d-none');
                    chatContainer.classList.remove('d-flex');
                }
                if (ticketsList) ticketsList.classList.add('d-none');
                if (bottomNav) bottomNav.style.display = 'none';
            } else {
                if (chatContainer) {
                    chatContainer.classList.add('d-none');
                    chatContainer.classList.remove('d-flex');
                }
                if (ticketsList) ticketsList.classList.remove('d-none');
            }

            // Configurar event listeners para los botones de navegación móvil
            const mobileNavButtons = document.querySelectorAll('.mobile-nav-item');
            mobileNavButtons.forEach((button, index) => {
                // El botón índice 2 es Solicitudes (offcanvas), no necesita handler especial aquí
                // ya que usa data-bs-toggle="offcanvas"
                if (index === 2) return; // Solicitudes - manejado por Bootstrap
                
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Mapeo: 0=home, 1=ticket, 2=solicitudes(skip), 3=admin, 4=config
                    const tabs = ['home', 'ticket', null, 'admin', 'config'];
                    const tabName = tabs[index];
                    
                    if (!tabName) return; // Si es null, no hacer nada
                    
                    // Actualizar estado visual (excepto el botón de solicitudes)
                    mobileNavButtons.forEach((btn, i) => {
                        if (i !== 2) btn.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // Activar el tab de Bootstrap
                    const tabElement = document.querySelector('#' + tabName + '-tab');
                    if (tabElement) {
                        const tab = new bootstrap.Tab(tabElement);
                        tab.show();
                    }
                    
                    // Mostrar FAB en Home y Tickets, ocultar en Config
                    const fabButton = document.getElementById('fabButton');
                    if (fabButton) {
                        if (tabName === 'home' || tabName === 'ticket') {
                            fabButton.style.display = 'flex';
                        } else {
                            fabButton.style.display = 'none';
                        }
                    }
                    
                    // Si está en la pestaña de tickets en móvil, asegurar que se muestra la lista
                    if (tabName === 'ticket' && window.innerWidth < 768) {
                        const ticketsList = document.getElementById('mobileTicketsList');
                        const chatContainer = document.getElementById('mobileChatContainer');
                        const bottomNav = document.querySelector('.mobile-bottom-nav');
                        
                        if (ticketsList && chatContainer) {
                            ticketsList.classList.remove('d-none');
                            chatContainer.classList.add('d-none');
                            chatContainer.classList.remove('d-flex');
                        }
                        if (bottomNav) bottomNav.style.display = 'flex';
                    }
                }, { passive: false });
            });
            
            // Sincronizar cuando se cambia de tab desde desktop
            const tabElements = document.querySelectorAll('button[data-bs-toggle="tab"]');
            tabElements.forEach(tab => {
                tab.addEventListener('shown.bs.tab', function (event) {
                    const target = event.target.getAttribute('data-bs-target');
                    const mobileNavItems = document.querySelectorAll('.mobile-nav-item');
                    // Mapeo: 0=home, 1=ticket, 2=solicitudes(skip), 3=config
                    const navTargets = { '#home': 0, '#ticket': 1, '#config': 3 };
                    
                    if (navTargets[target] !== undefined) {
                        mobileNavItems.forEach((nav, i) => {
                            if (i !== 2) nav.classList.remove('active'); // No tocar solicitudes
                        });
                        if (mobileNavItems[navTargets[target]]) {
                            mobileNavItems[navTargets[target]].classList.add('active');
                        }
                    }
                    
                    // Colapsar/expandir sidebar según la pestaña
                    const tabName = target.replace('#', '');
                    handleSidebarCollapse(tabName);
                });
            });

            // Botón FAB para nuevo ticket
            const fabButton = document.getElementById('fabButton');
            if (fabButton) {
                fabButton.addEventListener('click', function() {
                    const newTicketModal = new bootstrap.Modal(document.getElementById('newTicketModal'));
                    newTicketModal.show();
                });
            }

            // Preview de archivos adjuntos con DataTransfer para poder eliminar
            const ticketAttachments = document.getElementById('ticketAttachments');
            if (ticketAttachments) {
                ticketAttachments.addEventListener('change', function(e) {
                    const files = Array.from(e.target.files);
                    selectedFiles = files;
                    updateAttachmentPreview();
                });
            }

            function updateAttachmentPreview() {
                const preview = document.getElementById('attachmentPreview');
                const list = document.getElementById('attachmentList');
                
                if (selectedFiles.length > 0) {
                    preview.style.display = 'block';
                    list.innerHTML = '';
                    
                    selectedFiles.forEach((file, index) => {
                        const fileSize = (file.size / 1024 / 1024).toFixed(2);
                        const fileIcon = getFileIcon(file.type);
                        
                        const container = document.createElement('div');
                        container.className = 'position-relative';
                        container.style.display = 'inline-block';
                        
                        const badge = document.createElement('div');
                        badge.className = 'badge bg-light text-dark border d-flex align-items-center gap-2 py-2 px-3 pe-4';
                        badge.innerHTML = `
                            <i class="bi ${fileIcon} text-primary"></i>
                            <div class="d-flex flex-column align-items-start">
                                <span class="text-truncate" style="max-width: 180px; font-weight: 500;">${file.name}</span>
                                <small class="text-muted" style="font-size: 0.7rem;">${fileSize} MB</small>
                            </div>
                        `;
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.type = 'button';
                        deleteBtn.className = 'btn btn-sm p-0 position-absolute';
                        deleteBtn.style.cssText = 'right: 4px; top: 4px; width: 20px; height: 20px; border-radius: 50%; background: #dc3545; border: 2px solid white; color: white; display: flex; align-items: center; justify-content: center; line-height: 1; font-size: 12px;';
                        deleteBtn.innerHTML = '<i class="bi bi-x"></i>';
                        deleteBtn.title = 'Eliminar archivo';
                        deleteBtn.onclick = function() { removeAttachment(index); };
                        
                        container.appendChild(badge);
                        container.appendChild(deleteBtn);
                        list.appendChild(container);
                    });
                } else {
                    preview.style.display = 'none';
                }
            }

            function removeAttachment(index) {
                selectedFiles.splice(index, 1);
                
                // Actualizar el input file con los archivos restantes
                const dataTransfer = new DataTransfer();
                selectedFiles.forEach(file => {
                    dataTransfer.items.add(file);
                });
                document.getElementById('ticketAttachments').files = dataTransfer.files;
                
                updateAttachmentPreview();
            }
        });

        // Función auxiliar para obtener el icono según el tipo de archivo
        function getFileIcon(fileType) {
            if (fileType.startsWith('image/')) return 'bi-file-earmark-image';
            if (fileType.includes('pdf')) return 'bi-file-earmark-pdf';
            if (fileType.includes('word')) return 'bi-file-earmark-word';
            if (fileType.includes('excel') || fileType.includes('spreadsheet')) return 'bi-file-earmark-excel';
            if (fileType.includes('zip') || fileType.includes('rar')) return 'bi-file-earmark-zip';
            return 'bi-file-earmark';
        }

        // Función para crear el ticket
        // La función createTicket está en ticket-chat.js
        // No duplicar aquí

        // Mostrar modal de filtros
        function showFiltersModal() {
            const filtersModal = new bootstrap.Modal(document.getElementById('filtersModal'));
            filtersModal.show();
        }

        // Aplicar filtros
        function applyFilters() {
            console.log('Aplicando filtros...');
            const filtersModal = bootstrap.Modal.getInstance(document.getElementById('filtersModal'));
            if (filtersModal) filtersModal.hide();
        }

        // Limpiar filtros
        function resetFilters() {
            document.querySelectorAll('.btn-check').forEach(check => {
                if (check.id !== 'filter-all') {
                    check.checked = false;
                }
            });
            const filterAll = document.getElementById('filter-all');
            if (filterAll) filterAll.checked = true;

            document.querySelectorAll('input[type="date"]').forEach(input => {
                input.value = '';
            });

            document.querySelectorAll('select').forEach(select => {
                select.selectedIndex = 0;
            });

            console.log('Filtros limpiados');
        }

        // Abrir chat individual en móvil
        function openMobileChat(ticketId) {
            const isMobileNow = window.innerWidth < 768;
            if (!isMobileNow) {
                console.warn('[openMobileChat] No es vista mobile, abortando');
                return;
            }
            
            const ticketsList = document.getElementById('mobileTicketsList');
            const chatContainer = document.getElementById('mobileChatContainer');
            const bottomNav = document.querySelector('.mobile-bottom-nav');
            const fab = document.querySelector('.fab');
            
            console.log('[openMobileChat] Mostrando chat para ticket:', ticketId);
            console.log('[openMobileChat] ticketsList encontrado:', !!ticketsList);
            console.log('[openMobileChat] chatContainer encontrado:', !!chatContainer);
            
            // Ocultar lista y mostrar chat
            if (ticketsList) ticketsList.classList.add('d-none');
            if (chatContainer) {
                chatContainer.classList.remove('d-none');
                chatContainer.classList.add('d-flex');
                console.log('[openMobileChat] ✅ chatContainer ahora visible');
            }
            
            // Ocultar bottom nav y FAB cuando está en chat
            const fabButton = document.getElementById('fabButton');
            if (bottomNav) bottomNav.style.display = 'none';
            if (fabButton) fabButton.style.display = 'none';
            
            console.log('[openMobileChat] Chat móvil abierto para ticket:', ticketId);
        }

        // Cerrar chat y volver a lista en móvil
        function closeMobileChat() {
            const mobileNow = window.innerWidth < 768;
            if (!mobileNow) return;

            const ticketsList = document.getElementById('mobileTicketsList');
            const chatContainer = document.getElementById('mobileChatContainer');
            const bottomNav = document.querySelector('.mobile-bottom-nav');

            if (ticketsList) ticketsList.classList.remove('d-none');
            if (chatContainer) {
                chatContainer.classList.add('d-none');
                chatContainer.classList.remove('d-flex');
            }

            if (bottomNav) bottomNav.style.display = '';

            const fabButton = document.getElementById('fabButton');
            const activePane = document.querySelector('.tab-pane.show.active');
            const activeId = activePane ? activePane.id : null;
            if (fabButton) {
                fabButton.style.display = (activeId === 'home' || activeId === 'ticket') ? 'flex' : 'none';
            }
        }

        // ===== FUNCIONES DE ACCIONES DE TICKETS =====
        
        // Toggle dropdown de acciones
        function toggleActionDropdown(dropdownId, event) {
            event.stopPropagation();
            const dropdown = document.getElementById(dropdownId);
            const allDropdowns = document.querySelectorAll('.ticket-action-dropdown');
            
            // Cerrar todos los demás dropdowns
            allDropdowns.forEach(dd => {
                if (dd.id !== dropdownId) {
                    dd.classList.remove('show');
                }
            });
            
            // Toggle el dropdown actual
            dropdown.classList.toggle('show');
        }

        // Cerrar dropdowns al hacer click fuera
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.ticket-action-btn')) {
                const allDropdowns = document.querySelectorAll('.ticket-action-dropdown');
                allDropdowns.forEach(dd => dd.classList.remove('show'));
            }
        });

        // Las funciones changeTicketStatus, changeTicketPriority están definidas en ticket-estado-prioridad.js

        // Asignar ticket a agente
        function assignTicket(agentId) {
            console.log('Asignando ticket a:', agentId);
            const allDropdowns = document.querySelectorAll('.ticket-action-dropdown');
            allDropdowns.forEach(dd => dd.classList.remove('show'));
            
            const agentName = agentId === 'me' ? 'ti mismo' : 'otro agente';
            showToast(`Ticket asignado a ${agentName}`, 'success');
        }

        // Abrir modal de etiquetas
        function openTagModal() {
            console.log('Abriendo modal de etiquetas');
            showToast('Funcionalidad de etiquetas próximamente', 'info');
        }

        // Toggle nota interna
        function toggleInternalNote() {
            console.log('Toggle nota interna');
            showToast('Agregando nota interna...', 'info');
        }

        // Fusionar tickets
        function mergeTickets() {
            console.log('Fusionar tickets');
            const allDropdowns = document.querySelectorAll('.ticket-action-dropdown');
            allDropdowns.forEach(dd => dd.classList.remove('show'));
            showToast('Funcionalidad de fusión próximamente', 'info');
        }

        // ===== FUNCIÓN DE COLAPSO DE FILTROS =====
        
        function toggleFiltersPanel() {
            const filtersContainer = document.getElementById('filtersContainer');
            const toggleIcon = document.getElementById('toggleFiltersIcon');
            const ticketsPanel = document.querySelector('.tickets-list-panel');
            
            // Toggle la clase collapsed
            filtersContainer.classList.toggle('collapsed');
            
            // Rotar el ícono
            if (filtersContainer.classList.contains('collapsed')) {
                toggleIcon.style.transform = 'rotate(180deg)';
                ticketsPanel.classList.add('filters-collapsed');
            } else {
                toggleIcon.style.transform = 'rotate(0deg)';
                ticketsPanel.classList.remove('filters-collapsed');
            }
        }

        // Exportar ticket
        function exportTicket() {
            console.log('Exportar ticket');
            const allDropdowns = document.querySelectorAll('.ticket-action-dropdown');
            allDropdowns.forEach(dd => dd.classList.remove('show'));
            showToast('Exportando conversación...', 'info');
        }

        // Imprimir ticket
        function printTicket() {
            console.log('Imprimir ticket');
            const allDropdowns = document.querySelectorAll('.ticket-action-dropdown');
            allDropdowns.forEach(dd => dd.classList.remove('show'));
            window.print();
        }

        // Eliminar ticket
        function deleteTicket() {
            const allDropdowns = document.querySelectorAll('.ticket-action-dropdown');
            allDropdowns.forEach(dd => dd.classList.remove('show'));
            
            if (confirm('¿Estás seguro de que deseas eliminar este ticket? Esta acción no se puede deshacer.')) {
                console.log('Eliminando ticket');
                showToast('Ticket eliminado', 'warning');
            }
        }

        // Función helper para mostrar toast
        function showToast(message, type = 'info') {
            // Crear toast container si no existe
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
                document.body.appendChild(toastContainer);
            }
            
            // Crear toast
            const toast = document.createElement('div');
            toast.className = `alert alert-${type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info'} alert-dismissible fade show`;
            toast.style.cssText = 'min-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
            toast.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            toastContainer.appendChild(toast);
            
            // Auto-remover después de 3 segundos
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Abrir ticket desde el sidebar
        function openTicketFromSidebar(ticketId, element = null) {
            // Activar la pestaña de tickets
            const ticketTab = document.getElementById('ticket-tab');
            if (ticketTab) {
                const tab = new bootstrap.Tab(ticketTab);
                tab.show();
            }

            // Remover clase active de todos los items del historial
            document.querySelectorAll('.ticket-history-item').forEach(item => {
                item.classList.remove('active');
            });

            // Agregar clase active al item clickeado
            if (element) {
                element.classList.add('active');
            }

            // En móvil, abrir el chat
            if (isMobile) {
                openMobileChat(ticketId);
            } else {
                const chatContainer = document.getElementById('mobileChatContainer');
                if (chatContainer) {
                    chatContainer.classList.remove('d-none');
                    chatContainer.classList.add('d-flex');
                }
            }

            console.log('Abriendo ticket desde sidebar:', ticketId);

            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                chatMessages.scrollTop = 0;
            }
        }

        // Abrir detalle del ticket desde tabla de tickets recientes
        function abrirDetalleTicket(ticketId) {
            // Activar la pestaña de tickets
            const ticketTab = document.getElementById('ticket-tab');
            if (ticketTab) {
                const tab = new bootstrap.Tab(ticketTab);
                tab.show();
            }

            // Cargar el ticket en el chat
            if (typeof cargarTicketEnChat === 'function') {
                cargarTicketEnChat(ticketId);
            } else if (typeof openTicketFromSidebar === 'function') {
                openTicketFromSidebar(ticketId);
            }

            // En móvil, abrir el chat
            if (window.innerWidth < 768) {
                const mobileChatContainer = document.getElementById('mobileChatContainer');
                if (mobileChatContainer) {
                    mobileChatContainer.classList.remove('d-none');
                    mobileChatContainer.classList.add('d-flex');
                }
            }

            console.log('Abriendo detalle del ticket:', ticketId);
        }

        // Búsqueda de tickets en tiempo real
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchTicketInput');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase().trim();
                    const searchResults = document.getElementById('searchResults');
                    
                    if (searchTerm === '') {
                        searchResults.innerHTML = `
                            <div class="text-center py-5 text-muted">
                                <i class="bi bi-search display-4 d-block mb-3 opacity-25"></i>
                                <p>Comienza a escribir para buscar tickets...</p>
                            </div>
                        `;
                        return;
                    }

                    // Simular búsqueda (aquí se haría una llamada AJAX al backend)
                    const allTickets = [
                        { id: '1001', subject: 'Problema con acceso', user: 'Juan Pérez', status: 'Pendiente', date: '11/12/2025' },
                        { id: '1002', subject: 'Ayuda con cuenta', user: 'Ana García', status: 'Abierto', date: '10/12/2025' },
                        { id: '1003', subject: 'Error en pagos', user: 'Carlos López', status: 'Cerrado', date: '09/12/2025' },
                        { id: '1004', subject: 'Consulta membresía', user: 'María Rodríguez', status: 'Pendiente', date: '08/12/2025' },
                        { id: '1005', subject: 'Reset password', user: 'Pedro Martínez', status: 'Abierto', date: '07/12/2025' },
                        { id: '1006', subject: 'Actualizar datos', user: 'Laura Sánchez', status: 'Pendiente', date: '06/12/2025' }
                    ];

                    const filteredTickets = allTickets.filter(ticket => 
                        ticket.id.toLowerCase().includes(searchTerm) ||
                        ticket.subject.toLowerCase().includes(searchTerm) ||
                        ticket.user.toLowerCase().includes(searchTerm) ||
                        ticket.status.toLowerCase().includes(searchTerm)
                    );

                    if (filteredTickets.length === 0) {
                        searchResults.innerHTML = `
                            <div class="text-center py-5 text-muted">
                                <i class="bi bi-inbox display-4 d-block mb-3 opacity-25"></i>
                                <p>No se encontraron tickets con "${searchTerm}"</p>
                            </div>
                        `;
                        return;
                    }

                    let resultsHTML = '<div class="list-group list-group-flush">';
                    filteredTickets.forEach(ticket => {
                        const statusBadge = ticket.status === 'Pendiente' ? 'bg-warning text-dark' : 
                                          ticket.status === 'Abierto' ? 'bg-primary' : 'bg-success';
                        
                        resultsHTML += `
                            <a href="#" class="list-group-item list-group-item-action" onclick="openTicketFromSearch('${ticket.id}'); return false;">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1 fw-bold text-brand-blue">#${ticket.id}</h6>
                                        <p class="mb-1">${ticket.subject}</p>
                                        <small class="text-muted">
                                            <i class="bi bi-person me-1"></i>${ticket.user}
                                            <i class="bi bi-calendar ms-2 me-1"></i>${ticket.date}
                                        </small>
                                    </div>
                                    <span class="badge ${statusBadge} ms-2">${ticket.status}</span>
                                </div>
                            </a>
                        `;
                    });
                    resultsHTML += '</div>';
                    
                    searchResults.innerHTML = resultsHTML;
                });
            }
        });

        // Abrir ticket desde búsqueda
        function openTicketFromSearch(ticketId) {
            // Cerrar el modal de búsqueda
            const searchModal = bootstrap.Modal.getInstance(document.getElementById('searchTicketsModal'));
            if (searchModal) {
                searchModal.hide();
            }

            // Abrir el ticket
            openTicketFromSidebar(ticketId);
            
            // Actualizar el estado active en el sidebar
            document.querySelectorAll('.ticket-history-item').forEach(item => {
                item.classList.remove('active');
                if (item.onclick && item.onclick.toString().includes(ticketId)) {
                    item.classList.add('active');
                }
            });
        }

        // Búsqueda en tiempo real para móvil
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar datos del usuario actual
            cargarDatosUsuario();
            
            const mobileSearchInput = document.getElementById('mobileSearchInput');
            if (mobileSearchInput) {
                mobileSearchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase().trim();
                    const ticketItems = document.querySelectorAll('#mobileTicketsList .tickets-list-item');
                    
                    ticketItems.forEach(item => {
                        const ticketTitle = item.querySelector('.ticket-title')?.textContent.toLowerCase() || '';
                        const ticketPreview = item.querySelector('.ticket-preview')?.textContent.toLowerCase() || '';
                        
                        if (ticketTitle.includes(searchTerm) || ticketPreview.includes(searchTerm)) {
                            item.style.display = '';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                });
            }
        });

        // ========================================
        // CARGAR DATOS DEL USUARIO
        // ========================================
        
        async function cargarDatosUsuario() {
            try {
                // Obtener usuario desde localStorage (guardado en login)
                const currentUser = AuthService.getCurrentUser();
                
                if (currentUser) {
                    // Actualizar nombre en configuración
                    const profileName = document.getElementById('userProfileName');
                    const profileRole = document.getElementById('userProfileRole');
                    
                    if (profileName) {
                        profileName.textContent = currentUser.nombre || 'Usuario';
                    }
                    
                    if (profileRole) {
                        const roleMap = {
                            'Admin': 'Administrador',
                            'Supervisor': 'Supervisor',
                            'Agente': 'Operador de Soporte'
                        };
                        profileRole.textContent = roleMap[currentUser.rol] || currentUser.rol || 'Operador';
                    }
                    
                    console.log('✅ Datos de usuario cargados:', currentUser.nombre);
                } else {
                    console.warn('⚠️ No se encontraron datos de usuario');
                }
            } catch (error) {
                console.error('❌ Error al cargar datos del usuario:', error);
            }
        }

        // ========================================
        // GESTIÓN DE SOLICITUDES PENDIENTES
        // ========================================
        
        let solicitudActual = null; // Almacena el ID de la solicitud actual para modales

        // Datos de solicitudes (se cargan desde la API)
        const solicitudesData = {};

        // TODO: Implementar carga de solicitudes desde API
        // function cargarSolicitudesDesdeAPI() { ... }

        // Filtrar solicitudes por prioridad
        function filterSolicitudes(prioridad) {
            const cards = document.querySelectorAll('.solicitud-card');
            const buttons = document.querySelectorAll('#solicitudesOffcanvas .btn-sm');
            
            // Actualizar botones activos
            buttons.forEach(btn => btn.classList.remove('active', 'btn-primary'));
            event.target.classList.add('active', 'btn-primary');
            
            cards.forEach(card => {
                if (prioridad === 'todas' || card.dataset.prioridad === prioridad) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Ver ticket (todos los tickets ya están aprobados automáticamente)
        function verTicket(solicitudId) {
            // Aquí se haría la navegación al ticket específico
            console.log('Viendo ticket:', solicitudId);
            
            // Cerrar offcanvas de solicitudes
            const offcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('solicitudesOffcanvas'));
            if (offcanvas) offcanvas.hide();
            
            // Cambiar a la pestaña de tickets
            const ticketTab = document.querySelector('[data-bs-target="#ticket"]');
            if (ticketTab) {
                ticketTab.click();
            }
            
            // Mostrar toast
            mostrarToast('info', 'Navegando al ticket', `Mostrando detalles del ticket #${solicitudId}`);
        }

        // Abrir modal de derivar/rechazar
        function abrirModalDerivar(solicitudId) {
            solicitudActual = solicitudId;
            // Limpiar formulario
            document.getElementById('accionTicketSelect').value = '';
            document.getElementById('agenteDerivadoSelect').value = '';
            document.getElementById('comentarioRechazo').value = '';
            document.getElementById('derivarSection').style.display = 'none';
            
            const modal = new bootstrap.Modal(document.getElementById('rechazarSolicitudModal'));
            modal.show();
        }

        // Toggle sección de derivar
        function toggleDerivarSection() {
            const accion = document.getElementById('accionTicketSelect').value;
            const derivarSection = document.getElementById('derivarSection');
            
            if (accion === 'derivar') {
                derivarSection.style.display = 'block';
            } else {
                derivarSection.style.display = 'none';
            }
        }

        // Confirmar acción (derivar o rechazar)
        function confirmarAccion() {
            const accion = document.getElementById('accionTicketSelect').value;
            const comentario = document.getElementById('comentarioRechazo').value;
            
            if (!accion) {
                alert('Por favor selecciona una acción.');
                return;
            }
            
            let mensaje = '';
            let tipoMensaje = 'info';
            
            if (accion === 'derivar') {
                const agente = document.getElementById('agenteDerivadoSelect').value;
                if (!agente) {
                    alert('Por favor selecciona un agente para derivar.');
                    return;
                }
                
                // Aquí se haría la llamada AJAX para derivar
                console.log('Derivando ticket:', solicitudActual, { agente, comentario });
                mensaje = 'Ticket derivado correctamente al agente seleccionado.';
                tipoMensaje = 'success';
            } else {
                // Es un rechazo
                console.log('Rechazando ticket:', solicitudActual, { motivo: accion, comentario });
                mensaje = 'Ticket rechazado. Se ha notificado al usuario.';
                tipoMensaje = 'info';
            }
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('rechazarSolicitudModal'));
            modal.hide();
            
            // Remover la card con animación
            const card = document.querySelector(`.solicitud-card[data-id="${solicitudActual}"]`);
            if (card) {
                card.style.transition = 'all 0.3s ease';
                card.style.opacity = '0';
                card.style.transform = 'translateX(-100%)';
                
                setTimeout(() => {
                    card.remove();
                    actualizarContadorSolicitudes();
                    solicitudActual = null;
                    
                    mostrarToast(tipoMensaje, accion === 'derivar' ? 'Ticket derivado' : 'Ticket rechazado', mensaje);
                }, 300);
            }
            
            // Cerrar modal de detalle si está abierto
            const detalleModal = bootstrap.Modal.getInstance(document.getElementById('detalleSolicitudModal'));
            if (detalleModal) detalleModal.hide();
        }

        // Ver detalle de solicitud
        function verDetalleSolicitud(solicitudId) {
            solicitudActual = solicitudId;
            const data = solicitudesData[solicitudId];
            
            if (!data) {
                console.error('Solicitud no encontrada:', solicitudId);
                return;
            }
            
            // Llenar modal con datos
            document.getElementById('detalleSolicitudTitulo').textContent = data.titulo;
            document.getElementById('detalleSolicitudDescripcion').innerHTML = data.descripcion.replace(/\n/g, '<br>');
            document.getElementById('detalleSolicitudUsuario').textContent = data.usuario;
            document.getElementById('detalleSolicitudEmail').textContent = data.email;
            document.getElementById('detalleSolicitudCategoria').textContent = data.categoria;
            document.getElementById('detalleSolicitudFecha').textContent = data.fecha;
            
            // Prioridad con badge
            const prioridadBadge = document.getElementById('detalleSolicitudPrioridad');
            prioridadBadge.textContent = data.prioridad.charAt(0).toUpperCase() + data.prioridad.slice(1);
            prioridadBadge.className = 'badge prioridad-' + data.prioridad;
            
            // Adjuntos
            const adjuntosContainer = document.getElementById('detalleSolicitudAdjuntos');
            if (data.adjuntos && data.adjuntos.length > 0) {
                adjuntosContainer.style.display = '';
                const adjuntosHTML = data.adjuntos.map(adj => {
                    const icon = getFileIconByName(adj);
                    return `<div class="badge bg-light text-dark border p-2 d-flex align-items-center gap-2">
                        <i class="bi ${icon} text-primary"></i>
                        <span>${adj}</span>
                    </div>`;
                }).join('');
                adjuntosContainer.querySelector('.d-flex').innerHTML = adjuntosHTML;
            } else {
                adjuntosContainer.style.display = 'none';
            }
            
            // Mostrar modal
            const detalleModal = new bootstrap.Modal(document.getElementById('detalleSolicitudModal'));
            detalleModal.show();
        }

        // Funciones para acciones desde el modal de detalle
        function verTicketDesdeDetalle() {
            if (solicitudActual) {
                verTicket(solicitudActual);
            }
        }

        function abrirModalDerivarDesdeDetalle() {
            // Cerrar modal de detalle primero
            const detalleModal = bootstrap.Modal.getInstance(document.getElementById('detalleSolicitudModal'));
            if (detalleModal) detalleModal.hide();
            
            // Abrir modal de derivar/rechazar
            setTimeout(() => {
                abrirModalDerivar(solicitudActual);
            }, 300);
        }

        // Actualizar contador de solicitudes
        function actualizarContadorSolicitudes() {
            const cards = document.querySelectorAll('.solicitud-card');
            const count = cards.length;
            
            // Actualizar todos los contadores
            document.getElementById('solicitudesCounterDesktop').textContent = count;
            document.getElementById('solicitudesCounterMobile').textContent = count;
            document.getElementById('solicitudesCount').textContent = count;
            
            // Mostrar/ocultar badges si es 0
            const desktopBadge = document.getElementById('solicitudesCounterDesktop');
            const mobileBadge = document.getElementById('solicitudesCounterMobile');
            
            if (count === 0) {
                desktopBadge.style.display = 'none';
                mobileBadge.style.display = 'none';
                document.getElementById('solicitudesEmpty').classList.remove('d-none');
                document.getElementById('solicitudesList').style.display = 'none';
            } else {
                desktopBadge.style.display = '';
                mobileBadge.style.display = '';
                document.getElementById('solicitudesEmpty').classList.add('d-none');
                document.getElementById('solicitudesList').style.display = '';
            }
        }

        // Actualizar lista de solicitudes
        async function actualizarSolicitudes() {
            const btn = event.target.closest('button');
            const icon = btn.querySelector('i');
            
            // Animar icono
            icon.classList.add('spin-animation');
            btn.disabled = true;
            
            try {
                await cargarSolicitudes();
                mostrarToast('info', 'Actualizado', 'Lista de solicitudes actualizada.');
            } catch (error) {
                mostrarToast('error', 'Error', 'No se pudo actualizar las solicitudes.');
            } finally {
                icon.classList.remove('spin-animation');
                btn.disabled = false;
            }
        }

        // Helper para obtener icono por nombre de archivo
        function getFileIconByName(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const iconMap = {
                'png': 'bi-file-earmark-image',
                'jpg': 'bi-file-earmark-image',
                'jpeg': 'bi-file-earmark-image',
                'gif': 'bi-file-earmark-image',
                'pdf': 'bi-file-earmark-pdf',
                'doc': 'bi-file-earmark-word',
                'docx': 'bi-file-earmark-word',
                'xls': 'bi-file-earmark-excel',
                'xlsx': 'bi-file-earmark-excel',
                'txt': 'bi-file-earmark-text',
                'zip': 'bi-file-earmark-zip',
                'rar': 'bi-file-earmark-zip'
            };
            return iconMap[ext] || 'bi-file-earmark';
        }

        // Mostrar toast de notificación mejorado
        function mostrarToast(tipo, titulo, mensaje) {
            const toastContainer = document.getElementById('toastContainer');
            
            const icons = {
                success: 'bi-check-circle-fill',
                error: 'bi-x-circle-fill',
                warning: 'bi-exclamation-triangle-fill',
                info: 'bi-info-circle-fill'
            };
            
            const toastId = 'toast-' + Date.now();
            
            const toastHTML = `
                <div class="toast-custom ${tipo}" id="${toastId}" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-icon">
                        <i class="bi ${icons[tipo] || icons.info}"></i>
                    </div>
                    <div class="toast-content">
                        <div class="toast-title">${titulo}</div>
                        <div class="toast-message">${mensaje}</div>
                    </div>
                    <button class="toast-close" onclick="closeToast('${toastId}')" aria-label="Cerrar">
                        <i class="bi bi-x-lg"></i>
                    </button>
                    <div class="toast-progress"></div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHTML);
            
            // Auto-remover después de 4 segundos
            setTimeout(() => {
                closeToast(toastId);
            }, 4000);
        }
        
        // Cerrar toast con animación
        function closeToast(toastId) {
            const toast = document.getElementById(toastId);
            if (toast) {
                toast.classList.add('toast-exit');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }
        }

        // Agregar estilos de animación para el spinner
        document.head.insertAdjacentHTML('beforeend', `
            <style>
                .spin-animation {
                    animation: spin 1s linear infinite;
                }
                @keyframes spin {
                    from { transform: rotate(0deg); }
                    to { transform: rotate(360deg); }
                }
            </style>
        `);

        // ========================================
        // SISTEMA DE NOTIFICACIONES EN TIEMPO REAL
        // ========================================

        // Datos de notificaciones (se cargan desde la API)
        let notificationsData = [];

        function formatRelativeTime(inputDate) {
            try {
                const date = new Date(inputDate);
                if (Number.isNaN(date.getTime())) return '';

                const diffMs = Date.now() - date.getTime();
                const diffMin = Math.floor(diffMs / 60000);
                if (diffMin < 1) return 'Justo ahora';
                if (diffMin < 60) return `Hace ${diffMin} minuto${diffMin === 1 ? '' : 's'}`;

                const diffHr = Math.floor(diffMin / 60);
                if (diffHr < 24) return `Hace ${diffHr} hora${diffHr === 1 ? '' : 's'}`;

                const diffDay = Math.floor(diffHr / 24);
                return `Hace ${diffDay} día${diffDay === 1 ? '' : 's'}`;
            } catch {
                return '';
            }
        }

        function mapNotificationToUI(n) {
            const titulo = n.titulo || '';
            const mensaje = n.mensaje || '';
            const texto = `${titulo} ${mensaje}`.toLowerCase();

            let uiType = 'new-ticket';
            if ((n.entidad_tipo || '').toLowerCase() === 'mensaje') uiType = 'response';
            if (texto.includes('asign')) uiType = 'assigned';
            if (texto.includes('cerr')) uiType = 'closed';
            if (texto.includes('urgente') || (n.tipo || '').toLowerCase() === 'error') uiType = 'urgent';

            return {
                id: n.id_notificacion,
                title: titulo,
                text: mensaje,
                unread: !Boolean(n.leido),
                type: uiType,
                time: formatRelativeTime(n.fecha_creacion),
                entidad_tipo: n.entidad_tipo,
                entidad_id: n.entidad_id
            };
        }

        async function cargarNotificacionesDesdeAPI({ limit = 20 } = {}) {
            try {
                const res = await apiRequest(`/notificaciones?limit=${limit}&offset=0`);
                if (!res || !res.success) {
                    notificationsData = [];
                    renderNotifications();
                    return;
                }

                notificationsData = (res.notificaciones || []).map(mapNotificationToUI);
                renderNotifications();
            } catch (e) {
                console.warn('No se pudieron cargar notificaciones', e);
                notificationsData = [];
                renderNotifications();
            }
        }

        // Inicializar notificaciones
        document.addEventListener('DOMContentLoaded', function() {
            cargarNotificacionesDesdeAPI();

            // Polling simple (mantener dashboard actualizado)
            setInterval(() => {
                cargarNotificacionesDesdeAPI();
            }, 30000);
        });

        // Renderizar notificaciones
        function renderNotifications() {
            const list = document.getElementById('notificationsList');
            const unreadCount = notificationsData.filter(n => n.unread).length;
            
            // Actualizar contadores
            document.getElementById('unreadCount').textContent = unreadCount;
            const desktopBadge = document.getElementById('notifBadgeDesktop');
            const mobileBadge = document.getElementById('notifBadgeMobile');
            
            if (desktopBadge) desktopBadge.textContent = unreadCount;
            if (mobileBadge) mobileBadge.textContent = unreadCount;
            
            // Ocultar badges si no hay notificaciones
            if (unreadCount === 0) {
                if (desktopBadge) desktopBadge.style.display = 'none';
                if (mobileBadge) mobileBadge.style.display = 'none';
            } else {
                if (desktopBadge) desktopBadge.style.display = 'flex';
                if (mobileBadge) mobileBadge.style.display = 'flex';
            }
            
            // Renderizar lista
            if (!notificationsData || notificationsData.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-4 text-muted">No hay notificaciones</div>
                `;
                return;
            }

            list.innerHTML = notificationsData.map(n => `
                <div class="notification-item ${n.unread ? 'unread' : ''}" onclick="handleNotificationClick(${n.id})">
                    <div class="notification-icon ${n.type}">
                        <i class="bi ${getNotificationIcon(n.type)}"></i>
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">${n.title}</div>
                        <div class="notification-text">${n.text}</div>
                        <div class="notification-time">${n.time}</div>
                    </div>
                </div>
            `).join('');

            // Refrescar indicadores de “no leído” en las cards de tickets
            try {
                if (window.actualizarIndicadoresNoLeidosTickets) {
                    window.actualizarIndicadoresNoLeidosTickets();
                }
            } catch {}
        }

        // Obtener icono según tipo de notificación
        function getNotificationIcon(type) {
            const icons = {
                'new-ticket': 'bi-ticket-fill',
                'response': 'bi-chat-dots-fill',
                'urgent': 'bi-exclamation-triangle-fill',
                'assigned': 'bi-person-fill-add',
                'closed': 'bi-check-circle-fill'
            };
            return icons[type] || 'bi-bell-fill';
        }

        // Toggle panel de notificaciones
        function toggleNotifications() {
            const panel = document.getElementById('notificationsPanel');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        }

        // Abrir ticket asociado a una notificación (si aplica)
        async function abrirEntidadDesdeNotificacion(notif) {
            try {
                if (!notif) return;
                const entidadTipo = String(notif.entidad_tipo || '').toLowerCase().trim();
                const entidadId = notif.entidad_id;

                // Para notificaciones de "mensaje" guardamos el id_ticket en entidad_id
                const esTicket = (entidadTipo === 'ticket' || entidadTipo === 'mensaje');
                if (!esTicket || !entidadId) return;

                // Asegurar que la UI esté en la pestaña de Tickets
                if (typeof openTicketFromSidebar === 'function') {
                    openTicketFromSidebar(entidadId);
                } else {
                    const ticketTab = document.getElementById('ticket-tab');
                    if (ticketTab && window.bootstrap && window.bootstrap.Tab) {
                        const tab = new bootstrap.Tab(ticketTab);
                        tab.show();
                    }
                }

                if (typeof seleccionarTicket === 'function') {
                    await seleccionarTicket(entidadId);
                } else {
                    console.warn('⚠️ seleccionarTicket no disponible para abrir el ticket');
                }
            } catch (e) {
                console.warn('No se pudo abrir entidad desde notificación', e);
            }
        }

        // Click en notificación
        function handleNotificationClick(id) {
            const notif = notificationsData.find(n => n.id === id);
            if (notif) {
                // Marcar leída en backend
                apiRequest(`/notificaciones/${id}/leer`, { method: 'POST' })
                    .then(() => {
                        notif.unread = false;
                        renderNotifications();
                    })
                    .catch(() => {
                        // Si falla, igual actualizar UI local
                        notif.unread = false;
                        renderNotifications();
                    });

                // Abrir ticket asociado (si aplica)
                abrirEntidadDesdeNotificacion(notif);
            }
            toggleNotifications();
        }

        // Marcar todas como leídas
        function markAllAsRead() {
            apiRequest('/notificaciones/leer-todas', { method: 'POST' })
                .then(() => {
                    notificationsData.forEach(n => n.unread = false);
                    renderNotifications();
                    const allNotificationsList = document.getElementById('allNotificationsList');
                    if (allNotificationsList && allNotificationsList.innerHTML !== '') {
                        renderAllNotifications();
                    }
                    mostrarToast('success', 'Notificaciones', 'Todas las notificaciones marcadas como leídas');
                })
                .catch(() => {
                    notificationsData.forEach(n => n.unread = false);
                    renderNotifications();
                    mostrarToast('warning', 'Notificaciones', 'Se marcó localmente (falló el servidor)');
                });
            // Si el modal está abierto, actualizar también
        }

        // Reproducir sonido de notificación
        function playNotificationSound() {
            // Se puede agregar un sonido aquí si el usuario lo tiene habilitado
            console.log('🔔 Nueva notificación');
        }

        // Ver todas las notificaciones
        function showAllNotifications() {
            toggleNotifications();
            renderAllNotifications();
            const modal = new bootstrap.Modal(document.getElementById('allNotificationsModal'));
            modal.show();
        }

        // Renderizar todas las notificaciones en el modal
        function renderAllNotifications(filter = 'all') {
            const list = document.getElementById('allNotificationsList');
            let filteredNotifications = [...notificationsData];
            
            // Aplicar filtro
            if (filter === 'unread') {
                filteredNotifications = filteredNotifications.filter(n => n.unread);
            } else if (filter === 'ticket') {
                filteredNotifications = filteredNotifications.filter(n => ['new-ticket', 'assigned', 'closed'].includes(n.type));
            } else if (filter === 'system') {
                filteredNotifications = filteredNotifications.filter(n => n.type === 'assigned');
            } else if (filter === 'alert') {
                filteredNotifications = filteredNotifications.filter(n => n.type === 'urgent');
            }
            
            if (filteredNotifications.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-bell-slash fs-1 mb-3 d-block"></i>
                        <p class="mb-0">No hay notificaciones para mostrar</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = filteredNotifications.map(n => `
                <div class="notification-item ${n.unread ? 'unread' : ''}" onclick="handleNotificationClickFromModal(${n.id})" style="cursor: pointer; padding: 1rem; border-bottom: 1px solid rgba(0,0,0,0.05);">
                    <div class="d-flex align-items-start gap-3">
                        <div class="notification-icon ${n.type}" style="width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <i class="bi ${getNotificationIcon(n.type)}"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="fw-semibold ${n.unread ? 'text-brand-dark' : 'text-muted'}">${n.title}</div>
                                    <div class="small ${n.unread ? 'text-dark' : 'text-muted'}">${n.text}</div>
                                </div>
                                ${n.unread ? '<span class="badge bg-danger rounded-pill" style="font-size: 0.65rem;">Nueva</span>' : ''}
                            </div>
                            <div class="text-muted small mt-1">
                                <i class="bi bi-clock me-1"></i>${n.time}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Actualizar paginación
            document.getElementById('notificationsPagination').textContent = 
                `Mostrando ${filteredNotifications.length} de ${notificationsData.length}`;
        }

        // Filtrar notificaciones en el modal
        function filterAllNotifications(filter) {
            // Actualizar botones activos
            document.querySelectorAll('#allNotificationsModal [data-filter]').forEach(btn => {
                btn.classList.remove('active', 'btn-primary');
                btn.classList.add('btn-outline-secondary');
            });
            const activeBtn = document.querySelector(`#allNotificationsModal [data-filter="${filter}"]`);
            if (activeBtn) {
                activeBtn.classList.remove('btn-outline-secondary');
                activeBtn.classList.add('active', 'btn-primary');
            }
            
            renderAllNotifications(filter);
        }

        // Click en notificación desde el modal
        function handleNotificationClickFromModal(id) {
            const notif = notificationsData.find(n => n.id === id);
            if (notif) {
                // Marcar leída en backend
                apiRequest(`/notificaciones/${id}/leer`, { method: 'POST' })
                    .then(() => {
                        notif.unread = false;
                        renderNotifications();
                        renderAllNotifications();
                    })
                    .catch(() => {
                        notif.unread = false;
                        renderNotifications();
                        renderAllNotifications();
                    });

                // Abrir ticket asociado (si aplica)
                abrirEntidadDesdeNotificacion(notif);
            }
            try {
                if (notif) {
                    mostrarToast('info', 'Notificación', `Abriendo: ${notif.title}`);
                }
            } catch {}
        }

        // Limpiar todas las notificaciones
        function clearAllNotifications() {
            if (confirm('¿Estás seguro de que deseas eliminar todas las notificaciones?')) {
                apiRequest('/notificaciones/borrar-todas', { method: 'POST' })
                    .then(() => {
                        notificationsData = [];
                        renderNotifications();
                        renderAllNotifications();
                        mostrarToast('success', 'Notificaciones', 'Todas las notificaciones han sido eliminadas');
                    })
                    .catch(() => {
                        // Fallback local (pero se volverán a cargar en el próximo polling)
                        notificationsData = [];
                        renderNotifications();
                        renderAllNotifications();
                        mostrarToast('warning', 'Notificaciones', 'Se limpió localmente (falló el servidor)');
                    });
            }
        }

        // Cambiar página de notificaciones
        function changeNotificationPage(direction) {
            // Implementación de paginación si es necesaria
            console.log('Cambiar página:', direction);
        }

        // Cerrar panel al hacer click fuera
        document.addEventListener('click', function(e) {
            const panel = document.getElementById('notificationsPanel');
            const isClickInside = panel.contains(e.target) || 
                                  e.target.closest('.notification-badge-btn');
            if (!isClickInside && panel.style.display === 'block') {
                panel.style.display = 'none';
            }
        });

        // ========================================
        // BASE DE CONOCIMIENTO
        // ========================================

        function openKBCategory(category) {
            const modal = new bootstrap.Modal(document.getElementById('knowledgeBaseModal'));
            modal.show();
            // Aquí se podría filtrar por categoría
            console.log('Abriendo categoría KB:', category);
        }

        function openKBArticle(articleId) {
            // Aquí se cargaría el artículo completo
            console.log('Abriendo artículo:', articleId);
            mostrarToast('info', 'Base de Conocimiento', 'Cargando artículo...');
        }

        // ========================================
        // HISTORIAL Y AUDITORÍA
        // ========================================

        // Datos de auditoría (se cargan desde la API)
        const auditData = {};

        // TODO: Implementar carga de auditoría desde API
        // function cargarAuditoriaDesdeAPI(ticketId) { ... }

        function showAuditHistory(ticketId) {
            document.getElementById('auditTicketId').textContent = '#' + ticketId;
            
            const timeline = document.getElementById('auditTimelineContent');
            const data = auditData[ticketId] || [];
            
            timeline.innerHTML = data.map(item => `
                <div class="audit-item action-${item.type}">
                    <div class="audit-time">${item.time}</div>
                    <div class="audit-action">${item.action}</div>
                    <div class="audit-user">por ${item.user}</div>
                    ${item.details ? `<div class="audit-details">${item.details}</div>` : ''}
                </div>
            `).join('');
            
            const modal = new bootstrap.Modal(document.getElementById('auditHistoryModal'));
            modal.show();
        }

        function exportAuditHistory() {
            mostrarToast('info', 'Exportando', 'El historial se descargará en breve...');
            console.log('Exportando historial de auditoría');
        }

        // ========================================
        // RESPUESTAS PREDEFINIDAS
        // ========================================

        // Datos de respuestas predefinidas
        const quickRepliesData = {
            'saludo': 'Hola $nombre, gracias por contactarnos. Mi nombre es $operador y estaré ayudándote con tu solicitud. ¿En qué puedo asistirte?',
            'seguimiento': 'Para poder ayudarte mejor, necesito que me proporciones la siguiente información:\n\n1. Tu nombre de usuario\n2. Una descripción detallada del problema\n3. Cualquier mensaje de error que hayas recibido',
            'password': 'Hemos enviado un enlace de recuperación a tu correo electrónico registrado. Por favor revisa tu bandeja de entrada y también la carpeta de spam. El enlace es válido por 24 horas.',
            'escalado': 'Tu caso ha sido escalado a nuestro equipo de soporte técnico especializado. Un experto se pondrá en contacto contigo en las próximas 2 horas.',
            'resuelto': 'Me alegra que hayamos podido resolver tu problema. Si tienes alguna otra consulta, no dudes en contactarnos. ¡Que tengas un excelente día! 😊',
            'pago': 'Entendemos tu preocupación respecto al pago. Hemos verificado en nuestro sistema y encontramos que la transacción fue procesada correctamente. Si tienes alguna duda adicional, con gusto te ayudamos.'
        };

        function toggleQuickReplies() {
            const panel = document.getElementById('quickRepliesInline');
            panel.classList.toggle('show');
        }
        
        function toggleQuickRepliesDesktop() {
            const panel = document.getElementById('quickRepliesInlineDesktop');
            panel.classList.toggle('show');
        }

        function insertQuickReply(text) {
            const input = document.getElementById('chatMessageInput');
            input.value = text;
            input.focus();
            toggleQuickReplies();
        }

        function selectQuickReply(key) {
            const text = quickRepliesData[key] || '';
            // Reemplazar variables
            const finalText = text
                .replace('$nombre', 'Usuario')
                .replace('$operador', 'María')
                .replace('$ticket_id', '#1001')
                .replace('$fecha', new Date().toLocaleDateString());
            
            insertQuickReply(finalText);
            
            // Cerrar modal si está abierto
            const modal = bootstrap.Modal.getInstance(document.getElementById('quickRepliesModal'));
            if (modal) modal.hide();
        }

        function saveQuickReply() {
            const title = document.getElementById('newReplyTitle').value;
            const content = document.getElementById('newReplyContent').value;
            const category = document.getElementById('newReplyCategory').value;
            
            if (!title || !content) {
                alert('Por favor completa todos los campos requeridos.');
                return;
            }
            
            // Aquí se guardaría en el backend
            console.log('Guardando respuesta:', { title, content, category });
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('newQuickReplyModal'));
            if (modal) modal.hide();
            
            // Limpiar formulario
            document.getElementById('newReplyTitle').value = '';
            document.getElementById('newReplyContent').value = '';
            
            mostrarToast('success', 'Guardado', 'Respuesta predefinida creada exitosamente');
        }

        function sendChatMessage() {
            // Llamar a la función enviarMensaje() de ticket-chat.js
            // que guarda el mensaje en la base de datos
            if (typeof enviarMensaje === 'function') {
                enviarMensaje();
            } else {
                console.error('Función enviarMensaje() no está disponible');
            }
        }

        // Cargar tema guardado al inicializar
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedTheme();
        });

        // ============================================
        // SISTEMA DE TEMAS (Dark Mode)
        // ============================================
        
        function changeTheme(theme) {
            if (theme === 'auto') {
                // Detectar preferencia del sistema
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
            } else {
                document.documentElement.setAttribute('data-theme', theme);
            }
            
            // Guardar preferencia
            localStorage.setItem('theme', theme);
            
            mostrarToast('success', 'Tema actualizado', `Tema ${theme === 'dark' ? 'oscuro' : theme === 'light' ? 'claro' : 'automático'} aplicado`);
        }
        
        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            const themeSelector = document.getElementById('themeSelector');
            
            if (themeSelector) {
                themeSelector.value = savedTheme;
            }
            
            if (savedTheme === 'auto') {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
            } else {
                document.documentElement.setAttribute('data-theme', savedTheme);
            }
        }
        
        // Escuchar cambios en la preferencia del sistema
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'auto') {
                document.documentElement.setAttribute('data-theme', e.matches ? 'dark' : 'light');
            }
        });

        // ============================================
        // MODALES DE CONFIRMACIÓN
        // ============================================
        
        function showConfirmModal(options) {
            const { type = 'warning', title, message, confirmText = 'Confirmar', cancelText = 'Cancelar', onConfirm } = options;
            
            const icons = {
                warning: 'bi-exclamation-triangle-fill',
                danger: 'bi-x-circle-fill',
                success: 'bi-check-circle-fill',
                info: 'bi-info-circle-fill'
            };
            
            const confirmBtnClass = type === 'danger' ? 'btn-danger' : 'btn-primary';
            
            const modalHTML = `
                <div class="modal fade confirm-modal" id="confirmModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered modal-sm">
                        <div class="modal-content border-0 shadow">
                            <div class="modal-body">
                                <div class="confirm-icon ${type}">
                                    <i class="bi ${icons[type]}"></i>
                                </div>
                                <h5 class="confirm-title">${title}</h5>
                                <p class="confirm-message">${message}</p>
                                <div class="confirm-actions">
                                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">${cancelText}</button>
                                    <button type="button" class="btn ${confirmBtnClass}" id="confirmModalBtn">${confirmText}</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remover modal anterior si existe
            const existingModal = document.getElementById('confirmModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            const modalElement = document.getElementById('confirmModal');
            const modal = new bootstrap.Modal(modalElement);
            
            document.getElementById('confirmModalBtn').addEventListener('click', function() {
                modal.hide();
                if (onConfirm) onConfirm();
            });
            
            modalElement.addEventListener('hidden.bs.modal', function() {
                modalElement.remove();
            });
            
            modal.show();
        }

        // ============================================
        // SKELETON LOADERS
        // ============================================
        
        function showSkeletonLoader(containerId, count = 3) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            let skeletonHTML = '';
            for (let i = 0; i < count; i++) {
                skeletonHTML += `
                    <div class="skeleton-card mb-3">
                        <div class="d-flex align-items-center">
                            <div class="skeleton skeleton-icon me-3"></div>
                            <div class="flex-grow-1">
                                <div class="skeleton skeleton-title"></div>
                                <div class="skeleton skeleton-value"></div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = skeletonHTML;
        }
        
        function hideSkeletonLoader(containerId, content) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = content;
        }

        // ============================================
        // EMPTY STATES
        // ============================================
        
        function showEmptyState(containerId, options) {
            const { icon = 'bi-inbox', title = 'No hay datos', message = '', actionText = '', onAction = null } = options;
            
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const actionButton = actionText ? `<button class="empty-state-action btn-ripple" onclick="${onAction}">${actionText}</button>` : '';
            
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="bi ${icon}"></i>
                    </div>
                    <h5 class="empty-state-title">${title}</h5>
                    <p class="empty-state-text">${message}</p>
                    ${actionButton}
                </div>
            `;
        }

        // ============================================
        // ADMINISTRATION TAB FUNCTIONS
        // ============================================
        
        // Search users in the admin table and mobile cards
        function searchUsers() {
            const searchInput = document.getElementById('searchUsers');
            const filter = searchInput.value.toLowerCase();
            
            // Search in desktop table
            const tableBody = document.getElementById('adminUsersTbody');
            if (tableBody) {
                const rows = tableBody.getElementsByTagName('tr');
                
                for (let i = 0; i < rows.length; i++) {
                    const nameCell = rows[i].getElementsByTagName('td')[0];
                    const emailCell = rows[i].getElementsByTagName('td')[2];
                    const roleCell = rows[i].getElementsByTagName('td')[1];
                    
                    if (nameCell && emailCell && roleCell) {
                        const nameText = nameCell.textContent || nameCell.innerText;
                        const emailText = emailCell.textContent || emailCell.innerText;
                        const roleText = roleCell.textContent || roleCell.innerText;
                        
                        if (nameText.toLowerCase().indexOf(filter) > -1 || 
                            emailText.toLowerCase().indexOf(filter) > -1 || 
                            roleText.toLowerCase().indexOf(filter) > -1) {
                            rows[i].style.display = '';
                        } else {
                            rows[i].style.display = 'none';
                        }
                    }
                }
            }
            
            // Search in mobile cards
            const mobileCards = document.getElementById('usersCardsMobile');
            if (mobileCards) {
                const cards = mobileCards.querySelectorAll('.card');
                
                cards.forEach(card => {
                    const cardText = card.textContent || card.innerText;
                    
                    if (cardText.toLowerCase().indexOf(filter) > -1) {
                        card.style.display = '';
                    } else {
                        card.style.display = 'none';
                    }
                });
            }
        }
        
        // Add new user modal
        function addNewUser() {
            const newUserModal = new bootstrap.Modal(document.getElementById('newUserModal'));
            newUserModal.show();
        }
        
        // Edit user
        async function editUser(userId) {
            try {
                window.editingUserId = userId;

                // Asegurar catálogos
                await cargarRolesNuevoUsuario();
                await cargarDepartamentosAdmin();
                await cargarRolesEditUsuario();

                const u = (window.adminUsuariosCache && window.adminUsuariosCache[userId]) ? window.adminUsuariosCache[userId] : null;

                if (u) {
                    document.getElementById('editUserName').textContent = u.nombre || '';
                    document.getElementById('editUserUsername').textContent = `#${u.id}`;
                    document.getElementById('editUserFullName').value = u.nombre || '';
                    document.getElementById('editUserEmail').value = u.email || '';

                    // Estado
                    const estadoSelect = document.getElementById('editUserStatus');
                    if (estadoSelect) estadoSelect.value = Number(u.estado) === 1 ? 'active' : 'inactive';

                    // Rol global: por nombre
                    seleccionarRolPorNombre('editUserRole', u.rol);

                    // Depto: si viene en cache
                    const deptoSelect = document.getElementById('editUserDepto');
                    if (deptoSelect && Array.isArray(u.departamentos) && u.departamentos.length > 0) {
                        const primer = u.departamentos[0];
                        const deptoId = primer.id_depto || primer.id_departamento;
                        if (deptoId) deptoSelect.value = String(deptoId);

                        const deptoRolSelect = document.getElementById('editUserDeptoRol');
                        if (deptoRolSelect && primer.rol) deptoRolSelect.value = primer.rol;
                    }
                }

                const userModal = new bootstrap.Modal(document.getElementById('editUserModal'));
                userModal.show();
            } catch (e) {
                console.error('Error abriendo edición:', e);
                showToast('No se pudo abrir el editor de usuario', 'warning');
            }
        }
        
        // View user activity
        function viewUserActivity(userName) {
            const activityModal = new bootstrap.Modal(document.getElementById('userActivityModal'));
            document.getElementById('activityUserName').textContent = userName;
            activityModal.show();
        }
        
        // Toggle user status
        function toggleUserStatus(userId, currentStatus) {
            showToast('Funcionalidad de activar/desactivar pendiente', 'info');
        }
        
        // Save new user
        async function saveNewUser() {
            const nombre = document.getElementById('newUserFullName')?.value?.trim();
            const username = document.getElementById('newUserUsername')?.value?.trim();
            const email = document.getElementById('newUserEmail')?.value?.trim();
            const password = document.getElementById('newUserPassword')?.value;
            const rolId = document.getElementById('newUserRole')?.value;
            const deptoId = document.getElementById('newUserDepto')?.value;
            const deptoRol = document.getElementById('newUserDeptoRol')?.value;

            if (!nombre || !username || !email || !password || !rolId || !deptoId || !deptoRol) {
                showToast('Completa todos los campos requeridos', 'warning');
                return;
            }

            try {
                const payload = {
                    email,
                    nombre,
                    id_rol_global: parseInt(rolId, 10),
                    password
                };

                const resp = await apiRequest('/auth/registro', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });

                if (!resp || !resp.success) {
                    showToast(resp?.error || 'No se pudo crear el usuario', 'warning');
                    return;
                }

                // Asignar depto
                if (resp.operador_id) {
                    const asignResp = await apiRequest(`/departamentos/${deptoId}/miembros`, {
                        method: 'POST',
                        body: JSON.stringify({ id_operador: resp.operador_id, rol: deptoRol })
                    });
                    if (!asignResp || !asignResp.success) {
                        showToast(asignResp?.error || 'Usuario creado, pero no se pudo asignar el departamento', 'warning');
                    }
                }

                showToast('Usuario creado correctamente', 'success');

                const modal = bootstrap.Modal.getInstance(document.getElementById('newUserModal'));
                if (modal) modal.hide();

                // Reset form
                const form = document.getElementById('newUserForm');
                if (form) form.reset();

                await cargarUsuariosAdmin();
            } catch (error) {
                console.error('Error creando usuario:', error);
                showToast('Error creando usuario', 'warning');
            }
        }
        
        // Save user changes
        async function saveUserChanges() {
            const userId = window.editingUserId;
            if (!userId) {
                showToast('Usuario inválido', 'warning');
                return;
            }

            const nombre = document.getElementById('editUserFullName')?.value?.trim();
            const email = document.getElementById('editUserEmail')?.value?.trim();
            const rolId = document.getElementById('editUserRole')?.value;
            const estado = document.getElementById('editUserStatus')?.value;

            const deptoId = document.getElementById('editUserDepto')?.value;
            const deptoRol = document.getElementById('editUserDeptoRol')?.value;

            if (!nombre || !email || !rolId || !estado) {
                showToast('Completa nombre, email, rol y estado', 'warning');
                return;
            }

            const estadoNum = estado === 'active' ? 1 : 0;

            const payload = {
                nombre,
                email,
                id_rol_global: parseInt(rolId, 10),
                estado: estadoNum
            };

            // Si se seleccionó un depto, aplicar asignación/cambio rol
            if (deptoId) {
                payload.depto_id = parseInt(deptoId, 10);
                payload.depto_rol = deptoRol || 'Agente';
            }

            try {
                const resp = await apiRequest(`/admin/usuarios/${userId}`, {
                    method: 'PATCH',
                    body: JSON.stringify(payload)
                });

                if (!resp || !resp.success) {
                    showToast(resp?.error || 'No se pudo guardar cambios', 'warning');
                    return;
                }

                showToast('Cambios guardados correctamente', 'success');

                const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
                if (modal) modal.hide();

                await cargarUsuariosAdmin();
            } catch (e) {
                console.error('Error guardando cambios:', e);
                showToast('Error guardando cambios', 'warning');
            }
        }
        
        // Reset user password
        function resetUserPassword() {
            if (confirm('¿Enviar email con nueva contraseña temporal al usuario?')) {
                console.log('Resetting password...');
                alert('Se ha enviado un email al usuario con la nueva contraseña');
            }
        }
        
        // Export user activity
        function exportUserActivity() {
            console.log('Exporting user activity...');
            alert('Descargando actividad del usuario...');
        }
        
        // Save new role
        let permisosCatalogoAdmin = null;
        let rolesAdminCache = null;
        let editRoleState = { rolId: null };

        async function cargarCatalogoPermisosAdmin(force = false) {
            if (permisosCatalogoAdmin && !force) return permisosCatalogoAdmin;
            const resp = await apiRequest('/admin/permisos');
            if (!resp || !resp.success || !Array.isArray(resp.data)) {
                throw new Error(resp?.error || 'No se pudo cargar catálogo de permisos');
            }
            permisosCatalogoAdmin = resp.data;
            return permisosCatalogoAdmin;
        }

        function renderPermisosCheckboxes(containerEl, permisos, selectedIds = new Set(), prefix = 'perm') {
            if (!containerEl) return;
            if (!Array.isArray(permisos) || permisos.length === 0) {
                containerEl.innerHTML = '<div class="text-muted small">(sin permisos disponibles)</div>';
                return;
            }

            containerEl.innerHTML = permisos.map(p => {
                const id = `${prefix}_${p.id}`;
                const checked = selectedIds.has(p.id) ? 'checked' : '';
                const desc = (p.descripcion || '').trim();
                return `
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="${id}" data-perm-id="${p.id}" ${checked}>
                        <label class="form-check-label" for="${id}">
                            <div class="fw-semibold" style="font-size: 0.95rem;">${p.codigo}</div>
                            ${desc ? `<div class="text-muted small">${desc}</div>` : ''}
                        </label>
                    </div>
                `;
            }).join('');
        }

        function getSelectedPermisoIdsFrom(containerEl) {
            if (!containerEl) return [];
            const inputs = containerEl.querySelectorAll('input[type="checkbox"][data-perm-id]');
            const ids = [];
            inputs.forEach(inp => {
                if (inp.checked) ids.push(parseInt(inp.dataset.permId, 10));
            });
            return ids.filter(n => Number.isFinite(n));
        }

        async function prepararNuevoRolModal() {
            const cont = document.getElementById('newRolePermissions');
            try {
                const permisos = await cargarCatalogoPermisosAdmin();
                renderPermisosCheckboxes(cont, permisos, new Set(), 'newrole_perm');
            } catch (e) {
                console.error(e);
                if (cont) cont.innerHTML = '<div class="text-danger small">Error cargando permisos</div>';
            }
        }

        async function saveNewRole() {
            const nameEl = document.getElementById('newRoleName');
            const permsEl = document.getElementById('newRolePermissions');

            const nombre = (nameEl?.value || '').trim();
            if (!nombre) {
                showToast('El nombre del rol es requerido', 'warning');
                return;
            }

            const permiso_ids = getSelectedPermisoIdsFrom(permsEl);

            try {
                const resp = await apiRequest('/admin/roles', {
                    method: 'POST',
                    body: JSON.stringify({ nombre, permiso_ids })
                });

                if (!resp || !resp.success) {
                    showToast(resp?.error || 'No se pudo crear el rol', 'warning');
                    return;
                }

                showToast('Rol creado correctamente', 'success');

                const modal = bootstrap.Modal.getInstance(document.getElementById('newRoleModal'));
                if (modal) modal.hide();

                if (nameEl) nameEl.value = '';
                const descEl = document.getElementById('newRoleDescription');
                if (descEl) descEl.value = '';

                await cargarRolesPermisosAdmin(true);
            } catch (e) {
                console.error('Error creando rol:', e);
                showToast('Error creando rol', 'warning');
            }
        }
        
        // ============================================
        // AUDITORÍA (DINÁMICA)
        // ============================================

        function fmtFecha(fechaIso) {
            try {
                const d = new Date(fechaIso);
                if (isNaN(d.getTime())) return fechaIso;
                return d.toLocaleString();
            } catch {
                return fechaIso;
            }
        }

        function auditIconFor(accion) {
            const a = (accion || '').toString().toLowerCase();
            if (a.includes('login') || a.includes('sesión') || a.includes('sesion')) {
                return { cls: 'bg-success', icon: 'bi-box-arrow-in-right' };
            }
            if (a.includes('estado')) {
                return { cls: 'bg-info', icon: 'bi-arrow-repeat' };
            }
            if (a.includes('asign')) {
                return { cls: 'bg-warning', icon: 'bi-person-plus' };
            }
            if (a.includes('mensaje') || a.includes('respuesta')) {
                return { cls: 'bg-primary', icon: 'bi-chat-dots' };
            }
            if (a.includes('ticket')) {
                return { cls: 'bg-primary', icon: 'bi-ticket-perforated' };
            }
            if (a.includes('crear') || a.includes('crea')) {
                return { cls: 'bg-success', icon: 'bi-plus-circle' };
            }
            if (a.includes('cerr')) {
                return { cls: 'bg-danger', icon: 'bi-box-arrow-right' };
            }
            return { cls: 'bg-secondary', icon: 'bi-clock-history' };
        }

        function prettyAuditActionLabel(raw) {
            const v = (raw ?? '').toString().trim();
            const lower = v.toLowerCase();

            // Normalizaciones típicas de la tabla historial_acciones_ticket
            const map = {
                'asignacion': 'Asignación',
                'mensaje publico': 'Mensaje público',
                'mensaje público': 'Mensaje público',
                'cambio de estado': 'Cambio de estado',
                'cambio de prioridad': 'Cambio de prioridad'
            };
            if (map[lower]) return map[lower];

            // Title Case simple
            return v
                .replace(/_/g, ' ')
                .split(' ')
                .filter(Boolean)
                .map(w => w.charAt(0).toUpperCase() + w.slice(1))
                .join(' ');
        }

        async function cargarDepartamentosAuditoria() {
            const select = document.getElementById('auditDeptoFilter');
            if (!select) return;

            try {
                const resp = await apiRequest('/departamentos');
                const deptos = (resp && resp.success && Array.isArray(resp.departamentos))
                    ? resp.departamentos
                    : (resp && resp.success && Array.isArray(resp.data) ? resp.data : null);

                if (!deptos) {
                    select.innerHTML = '<option value="">Error cargando departamentos</option>';
                    return;
                }

                select.innerHTML = '<option value="">Todos los departamentos</option>' + deptos
                    .map(d => {
                        const id = d.id_departamento ?? d.id_depto ?? d.id;
                        const nombre = d.nombre ?? d.descripcion;
                        return `<option value="${id}">${nombre}</option>`;
                    })
                    .join('');
            } catch (e) {
                console.error('Error cargando departamentos auditoría:', e);
            }
        }

        async function onAuditDeptoChange() {
            await cargarAccionesAuditoriaPorDepto();
            await cargarUsuariosAuditoriaPorDepto();
            await cargarAuditoriaTimeline();
        }

        async function cargarAccionesAuditoriaPorDepto() {
            const deptoSelect = document.getElementById('auditDeptoFilter');
            const actionSelect = document.getElementById('auditActionFilter');
            if (!actionSelect) return;

            const deptoId = deptoSelect ? deptoSelect.value : '';
            const operadorId = document.getElementById('auditUserFilter')?.value || '';
            actionSelect.innerHTML = '<option value="all">Todas las acciones</option>';

            // Sin depto ni usuario: no cargar (evitar volumen)
            if (!deptoId && !operadorId) return;

            try {
                const params = new URLSearchParams();
                if (deptoId) params.set('depto_id', deptoId);
                if (operadorId) params.set('operador_id', operadorId);
                const resp = await apiRequest(`/admin/auditoria/acciones?${params.toString()}`);
                if (!resp || !resp.success || !Array.isArray(resp.data)) return;

                const acciones = resp.data;
                actionSelect.innerHTML = '<option value="all">Todas las acciones</option>' + acciones
                    .map(a => {
                        const value = String(a).replace(/\"/g, '&quot;');
                        const label = prettyAuditActionLabel(a);
                        return `<option value="${value}">${label}</option>`;
                    })
                    .join('');
            } catch (e) {
                console.error('Error cargando acciones auditoría:', e);
            }
        }

        async function cargarUsuariosAuditoriaPorDepto() {
            const deptoSelect = document.getElementById('auditDeptoFilter');
            const userSelect = document.getElementById('auditUserFilter');
            if (!userSelect) return;

            const deptoId = deptoSelect ? deptoSelect.value : '';

            userSelect.innerHTML = '<option value="">Todos los usuarios</option>';

            if (!deptoId) {
                // Sin depto: no cargamos todos los usuarios para evitar volumen
                return;
            }

            try {
                const resp = await apiRequest(`/departamentos/${deptoId}/miembros?solo_activos=true`);
                if (!resp || !resp.success || !Array.isArray(resp.miembros)) {
                    return;
                }

                const miembros = resp.miembros;
                userSelect.innerHTML = '<option value="">Todos los usuarios</option>' + miembros
                    .map(m => `<option value="${m.id_operador}">${m.operador_nombre || m.nombre || ('Operador #' + m.id_operador)}</option>`)
                    .join('');
            } catch (e) {
                console.error('Error cargando usuarios por depto:', e);
            }
        }

        function getAuditFilters() {
            const deptoId = document.getElementById('auditDeptoFilter')?.value || '';
            const operadorId = document.getElementById('auditUserFilter')?.value || '';
            const accion = document.getElementById('auditActionFilter')?.value || 'all';
            const fecha = document.getElementById('auditDateFilter')?.value || '';

            return { deptoId, operadorId, accion, fecha };
        }

        function auditDetailLabel(r) {
            const accion = String(r?.accion || '').toLowerCase().trim();
            const va = r?.valor_anterior;
            const vn = r?.valor_nuevo;

            if (accion === 'ticket creado') {
                return vn ? `Título: ${vn}` : null;
            }
            if (accion === 'ticket recibido') {
                const depto = r?.depto_nombre || vn;
                return depto ? `Depto receptor: ${depto}` : null;
            }
            if (accion.includes('cambio de estado')) {
                return `Estado: ${(va ?? '')} → ${(vn ?? '')}`.trim();
            }
            if (accion.includes('cambio de prioridad')) {
                return `Prioridad: ${(va ?? '')} → ${(vn ?? '')}`.trim();
            }
            if (accion.includes('mensaje')) {
                return vn ? `Asunto: ${vn}` : null;
            }
            if (accion.includes('adjunto')) {
                return vn ? `Archivo: ${vn}` : null;
            }

            if (va != null || vn != null) {
                return `Cambio: ${(va ?? '')} → ${(vn ?? '')}`.trim();
            }

            return r?.detalle || null;
        }

        const auditTimelineState = {
            rows: [],
            page: 1,
            pageSize: 5
        };

        function setAuditTimelinePage(page) {
            const totalPages = Math.max(1, Math.ceil((auditTimelineState.rows || []).length / auditTimelineState.pageSize));
            const next = Math.min(Math.max(1, Number(page) || 1), totalPages);
            auditTimelineState.page = next;
            renderAuditTimeline();
        }

        function renderAuditTimelinePagination() {
            const pager = document.getElementById('auditTimelinePager');
            const summary = document.getElementById('auditTimelineSummary');
            if (!pager) return;

            const total = (auditTimelineState.rows || []).length;
            const size = auditTimelineState.pageSize;
            const totalPages = Math.max(1, Math.ceil(total / size));
            const current = Math.min(Math.max(1, auditTimelineState.page), totalPages);

            const startIndex = total === 0 ? 0 : (current - 1) * size + 1;
            const endIndex = Math.min(current * size, total);
            if (summary) {
                summary.textContent = total === 0
                    ? 'Mostrando 0 registros.'
                    : `Mostrando ${startIndex}-${endIndex} de ${total} (5 por página).`;
            }

            if (total === 0 || totalPages === 1) {
                pager.innerHTML = '';
                return;
            }

            const windowSize = 5;
            let startPage = Math.max(1, current - Math.floor(windowSize / 2));
            let endPage = Math.min(totalPages, startPage + windowSize - 1);
            startPage = Math.max(1, endPage - windowSize + 1);

            const pageButtons = [];
            for (let p = startPage; p <= endPage; p++) {
                pageButtons.push(`
                    <li class="page-item ${p === current ? 'active' : ''}">
                        <button class="page-link" type="button" onclick="setAuditTimelinePage(${p})">${p}</button>
                    </li>
                `);
            }

            pager.innerHTML = `
                <ul class="pagination pagination-sm mb-0">
                    <li class="page-item ${current === 1 ? 'disabled' : ''}">
                        <button class="page-link" type="button" aria-label="Anterior" onclick="setAuditTimelinePage(${current - 1})">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                    </li>
                    ${startPage > 1 ? `
                        <li class="page-item">
                            <button class="page-link" type="button" onclick="setAuditTimelinePage(1)">1</button>
                        </li>
                        ${startPage > 2 ? `<li class="page-item disabled"><span class="page-link">…</span></li>` : ''}
                    ` : ''}
                    ${pageButtons.join('')}
                    ${endPage < totalPages ? `
                        ${endPage < totalPages - 1 ? `<li class="page-item disabled"><span class="page-link">…</span></li>` : ''}
                        <li class="page-item">
                            <button class="page-link" type="button" onclick="setAuditTimelinePage(${totalPages})">${totalPages}</button>
                        </li>
                    ` : ''}
                    <li class="page-item ${current === totalPages ? 'disabled' : ''}">
                        <button class="page-link" type="button" aria-label="Siguiente" onclick="setAuditTimelinePage(${current + 1})">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    </li>
                </ul>
            `;
        }

        function renderAuditTimeline() {
            const cont = document.getElementById('auditTimelineList');
            if (!cont) return;

            const rows = auditTimelineState.rows || [];
            if (rows.length === 0) {
                cont.innerHTML = '<div class="text-muted small">(sin registros)</div>';
                renderAuditTimelinePagination();
                return;
            }

            const totalPages = Math.max(1, Math.ceil(rows.length / auditTimelineState.pageSize));
            const current = Math.min(Math.max(1, auditTimelineState.page), totalPages);
            auditTimelineState.page = current;

            const start = (current - 1) * auditTimelineState.pageSize;
            const pageRows = rows.slice(start, start + auditTimelineState.pageSize);

            cont.innerHTML = pageRows.map(r => {
                const meta = auditIconFor(r.accion);
                const header = `<strong>${r.operador_nombre || 'Operador'}</strong> ${prettyAuditActionLabel(r.accion)}`;
                const ticketLabel = r.id_ticket ? `Ticket #${r.id_ticket}` : (r.endpoint || null);
                const cambio = auditDetailLabel(r);
                const depto = r.depto_nombre ? `Depto: ${r.depto_nombre}` : null;
                const userExt = r.id_usuarioext ? `UsuarioExt: ${r.id_usuarioext}` : null;
                const details = [ticketLabel, cambio, depto, userExt].filter(Boolean).join(' | ');

                return `
                    <div class="audit-item">
                        <div class="audit-icon ${meta.cls}">
                            <i class="bi ${meta.icon}"></i>
                        </div>
                        <div class="audit-content">
                            <div class="audit-header">${header}</div>
                            ${details ? `<div class="audit-details text-muted small">${details}</div>` : ''}
                            <div class="audit-time">${fmtFecha(r.fecha)}</div>
                        </div>
                    </div>
                `;
            }).join('');

            renderAuditTimelinePagination();
        }

        async function cargarAuditoriaTimeline() {
            const cont = document.getElementById('auditTimelineList');
            if (!cont) return;

            const { deptoId, operadorId, accion, fecha } = getAuditFilters();

            // Recomendación de UX: pedir depto para acotar el historial
            if (!deptoId) {
                cont.innerHTML = '<div class="text-muted small">Selecciona un departamento para ver su historial.</div>';
                auditTimelineState.rows = [];
                auditTimelineState.page = 1;
                renderAuditTimelinePagination();
                return;
            }

            try {
                cont.innerHTML = '<div class="text-muted small">Cargando auditoría...</div>';

                const params = new URLSearchParams();
                params.set('depto_id', deptoId);
                if (operadorId) params.set('operador_id', operadorId);
                if (accion && accion !== 'all') params.set('accion', accion);
                if (fecha) params.set('fecha', fecha);
                params.set('limit', '200');

                const resp = await apiRequest(`/admin/auditoria?${params.toString()}`);
                if (!resp || !resp.success || !Array.isArray(resp.data)) {
                    cont.innerHTML = '<div class="text-danger small">Error cargando auditoría</div>';
                    return;
                }

                const rows = resp.data;
                if (rows.length === 0) {
                    auditTimelineState.rows = [];
                    auditTimelineState.page = 1;
                    renderAuditTimeline();
                    return;
                }

                auditTimelineState.rows = rows;
                auditTimelineState.page = 1;
                renderAuditTimeline();

            } catch (e) {
                console.error('Error cargando auditoría:', e);
                cont.innerHTML = '<div class="text-danger small">Error cargando auditoría</div>';
                auditTimelineState.rows = [];
                auditTimelineState.page = 1;
                renderAuditTimelinePagination();
            }
        }

        // Hook de filtros
        function filterAuditLog() {
            cargarAuditoriaTimeline();
        }

        async function onAuditUserChange() {
            await cargarAccionesAuditoriaPorDepto();
            await cargarAuditoriaTimeline();
        }

        
        // Edit role permissions
        async function cargarRolesPermisosAdmin(force = false) {
            if (rolesAdminCache && !force) {
                renderRolesList(rolesAdminCache);
                return;
            }

            const rolesList = document.getElementById('rolesList');
            if (rolesList) rolesList.innerHTML = '<div class="text-muted">Cargando roles...</div>';

            const resp = await apiRequest('/admin/roles');
            if (!resp || !resp.success || !Array.isArray(resp.data)) {
                if (rolesList) rolesList.innerHTML = '<div class="text-danger">Error cargando roles</div>';
                return;
            }

            rolesAdminCache = resp.data;
            renderRolesList(rolesAdminCache);
        }

        function renderRolesList(roles) {
            const rolesList = document.getElementById('rolesList');
            if (!rolesList) return;

            if (!Array.isArray(roles) || roles.length === 0) {
                rolesList.innerHTML = '<div class="text-muted">(sin roles)</div>';
                return;
            }

            rolesList.innerHTML = roles.map(r => {
                const count = Array.isArray(r.permisos) ? r.permisos.length : 0;
                const permisosPreview = (r.permisos || []).slice(0, 4).map(p => p.codigo).join(', ');
                const extra = count > 4 ? ` +${count - 4}` : '';

                return `
                    <div class="col-12 col-md-6 col-xl-4">
                        <div class="card border-0 shadow-sm rounded-4 h-100">
                            <div class="card-body p-3 p-md-4">
                                <div class="d-flex justify-content-between align-items-start gap-2">
                                    <div>
                                        <div class="fw-bold text-brand-blue" style="font-size: 1.05rem;">${r.nombre}</div>
                                        <div class="text-muted small">${count} permiso(s)</div>
                                    </div>
                                    <span class="badge rounded-pill ${r.activo ? 'bg-success-subtle text-success' : 'bg-secondary-subtle text-secondary'}">${r.activo ? 'Activo' : 'Inactivo'}</span>
                                </div>

                                <div class="mt-3">
                                    <div class="text-muted small">Permisos</div>
                                    <div class="small">${permisosPreview || '(sin permisos)'}${extra}</div>
                                </div>

                                <div class="mt-3 d-flex justify-content-end">
                                    <button class="btn btn-outline-primary rounded-pill btn-sm" onclick="editRole(${r.id})">
                                        <i class="bi bi-pencil-square me-1"></i>Editar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function editRole(roleId) {
            try {
                const roles = rolesAdminCache || (await (async () => {
                    const resp = await apiRequest('/admin/roles');
                    if (resp?.success && Array.isArray(resp.data)) return resp.data;
                    return [];
                })());

                const role = roles.find(r => String(r.id) === String(roleId));
                if (!role) {
                    showToast('Rol no encontrado', 'warning');
                    return;
                }

                editRoleState.rolId = role.id;
                editRoleState.rolNombre = role.nombre || '';
                editRoleState.rolActivo = !!role.activo;

                const rolesBase = ['Admin', 'Supervisor', 'Agente'];
                const esBase = rolesBase.includes(editRoleState.rolNombre);

                const nameInput = document.getElementById('editRoleNameInput');
                const nameHelp = document.getElementById('editRoleNameHelp');
                if (nameInput) {
                    nameInput.value = editRoleState.rolNombre;
                    nameInput.disabled = esBase;
                }
                if (nameHelp) nameHelp.style.display = esBase ? '' : 'none';

                const activeSwitch = document.getElementById('editRoleActiveSwitch');
                const activeHelp = document.getElementById('editRoleActiveHelp');
                const lockActive = (editRoleState.rolNombre === 'Admin');
                if (activeSwitch) {
                    activeSwitch.checked = !!editRoleState.rolActivo;
                    activeSwitch.disabled = lockActive;
                }
                if (activeHelp) activeHelp.style.display = lockActive ? '' : 'none';

                const permisosCatalogo = await cargarCatalogoPermisosAdmin();
                const selected = new Set((role.permisos || []).map(p => p.id));
                renderPermisosCheckboxes(document.getElementById('editRolePermissions'), permisosCatalogo, selected, `editrole_${role.id}`);

                const modalEl = document.getElementById('editRoleModal');
                const modal = new bootstrap.Modal(modalEl);
                modal.show();
            } catch (e) {
                console.error('Error abriendo edición de rol:', e);
                showToast('Error abriendo edición de rol', 'warning');
            }
        }

        async function saveRole() {
            const rolId = editRoleState.rolId;
            if (!rolId) {
                showToast('Rol inválido', 'warning');
                return;
            }

            const permiso_ids = getSelectedPermisoIdsFrom(document.getElementById('editRolePermissions'));

            const nameInput = document.getElementById('editRoleNameInput');
            const activeSwitch = document.getElementById('editRoleActiveSwitch');

            const payload = { permiso_ids };
            if (nameInput && !nameInput.disabled) {
                payload.nombre = (nameInput.value || '').trim();
            }
            if (activeSwitch && !activeSwitch.disabled) {
                payload.activo = activeSwitch.checked ? 1 : 0;
            }

            try {
                const resp = await apiRequest(`/admin/roles/${rolId}`, {
                    method: 'PATCH',
                    body: JSON.stringify(payload)
                });

                if (!resp || !resp.success) {
                    showToast(resp?.error || 'No se pudo guardar el rol', 'warning');
                    return;
                }

                showToast('Rol actualizado', 'success');
                const modal = bootstrap.Modal.getInstance(document.getElementById('editRoleModal'));
                if (modal) modal.hide();

                await cargarRolesPermisosAdmin(true);
            } catch (e) {
                console.error('Error guardando rol:', e);
                showToast('Error guardando rol', 'warning');
            }
        }

        // ============================================
        // ADMIN: CARGA Y RENDER DE USUARIOS
        // ============================================

        async function configurarAdminSegunPermisos() {
            const adminNavItem = document.getElementById('adminNavItem');
            const adminMobileBtn = document.getElementById('adminMobileNav');
            const adminPane = document.getElementById('admin');

            const esAdmin = !!(window.perfilUsuario && window.perfilUsuario.es_admin);

            if (!esAdmin) {
                if (adminNavItem) adminNavItem.style.display = 'none';
                if (adminMobileBtn) adminMobileBtn.style.display = 'none';
                if (adminPane) adminPane.style.display = 'none';
                return;
            }

            if (adminNavItem) adminNavItem.style.display = '';
            if (adminMobileBtn) adminMobileBtn.style.display = '';
            if (adminPane) adminPane.style.display = '';

            await cargarRolesNuevoUsuario();
            await cargarDepartamentosAdmin();
            await cargarRolesEditUsuario();
            await cargarUsuariosAdmin();

            // Permisos (roles)
            await cargarRolesPermisosAdmin(true);

            // Auditoría
            await cargarDepartamentosAuditoria();
            await cargarUsuariosAuditoriaPorDepto();
            await cargarAuditoriaTimeline();

            const permissionsTab = document.getElementById('permissions-tab');
            if (permissionsTab && !permissionsTab.dataset.bound) {
                permissionsTab.addEventListener('shown.bs.tab', async () => {
                    await cargarRolesPermisosAdmin(true);
                });
                permissionsTab.dataset.bound = '1';
            }

            const auditTab = document.getElementById('audit-tab');
            if (auditTab && !auditTab.dataset.bound) {
                auditTab.addEventListener('shown.bs.tab', async () => {
                    await cargarDepartamentosAuditoria();
                    await cargarUsuariosAuditoriaPorDepto();
                    await cargarAuditoriaTimeline();
                });
                auditTab.dataset.bound = '1';
            }

            const newRoleModal = document.getElementById('newRoleModal');
            if (newRoleModal && !newRoleModal.dataset.bound) {
                newRoleModal.addEventListener('show.bs.modal', async () => {
                    await prepararNuevoRolModal();
                });
                newRoleModal.dataset.bound = '1';
            }

            const newUserModal = document.getElementById('newUserModal');
            if (newUserModal) {
                newUserModal.addEventListener('show.bs.modal', async () => {
                    // permitir recarga al abrir
                    const select = document.getElementById('newUserRole');
                    if (select) select.dataset.loaded = '0';
                    await cargarRolesNuevoUsuario();
                    await cargarDepartamentosAdmin(true);
                });
            }
        }

        async function cargarRolesNuevoUsuario() {
            const select = document.getElementById('newUserRole');
            if (!select) return;

            // Evitar re-render si ya está cargado
            if (select.dataset.loaded === '1') return;

            try {
                const resp = await apiRequest('/operadores/roles');
                if (!resp || !resp.success || !Array.isArray(resp.data)) {
                    select.innerHTML = '<option value="">Error cargando roles</option>';
                    return;
                }

                const roles = resp.data;
                select.innerHTML = '<option value="">Seleccionar perfil...</option>' + roles
                    .map(r => `<option value="${r.id}">${r.nombre}</option>`)
                    .join('');

                select.dataset.loaded = '1';
            } catch (e) {
                console.error('Error cargando roles:', e);
                select.innerHTML = '<option value="">Error cargando roles</option>';
            }
        }

        async function cargarRolesEditUsuario() {
            const select = document.getElementById('editUserRole');
            if (!select) return;

            try {
                const resp = await apiRequest('/operadores/roles');
                if (!resp || !resp.success || !Array.isArray(resp.data)) {
                    select.innerHTML = '<option value="">Error cargando roles</option>';
                    return;
                }

                const roles = resp.data;
                select.innerHTML = roles
                    .map(r => `<option value="${r.id}">${r.nombre}</option>`)
                    .join('');
            } catch (e) {
                console.error('Error cargando roles (edit):', e);
                select.innerHTML = '<option value="">Error cargando roles</option>';
            }
        }

        function seleccionarRolPorNombre(selectId, rolNombre) {
            const select = document.getElementById(selectId);
            if (!select || !rolNombre) return;
            const options = Array.from(select.options);
            const match = options.find(o => (o.textContent || '').trim() === String(rolNombre).trim());
            if (match) select.value = match.value;
        }

        async function cargarDepartamentosAdmin(forceReload = false) {
            const selectNew = document.getElementById('newUserDepto');
            const selectEdit = document.getElementById('editUserDepto');
            if (!selectNew && !selectEdit) return;

            if (!forceReload && window.adminDepartamentosCache) {
                renderDepartamentosAdmin(window.adminDepartamentosCache);
                return;
            }

            try {
                const resp = await apiRequest('/departamentos');
                if (!resp || !resp.success || !Array.isArray(resp.departamentos)) {
                    if (selectNew) selectNew.innerHTML = '<option value="">Error cargando departamentos</option>';
                    if (selectEdit) selectEdit.innerHTML = '<option value="">Error cargando departamentos</option>';
                    return;
                }

                window.adminDepartamentosCache = resp.departamentos;
                renderDepartamentosAdmin(resp.departamentos);
            } catch (e) {
                console.error('Error cargando departamentos admin:', e);
                if (selectNew) selectNew.innerHTML = '<option value="">Error cargando departamentos</option>';
                if (selectEdit) selectEdit.innerHTML = '<option value="">Error cargando departamentos</option>';
            }
        }

        function renderDepartamentosAdmin(departamentos) {
            const selectNew = document.getElementById('newUserDepto');
            const selectEdit = document.getElementById('editUserDepto');

            const optionsHtml = '<option value="">Seleccionar departamento...</option>' + departamentos
                .map(d => `<option value="${d.id_departamento}">${d.nombre}</option>`)
                .join('');

            if (selectNew) selectNew.innerHTML = optionsHtml;

            if (selectEdit) {
                selectEdit.innerHTML = '<option value="">Sin cambios</option>' + departamentos
                    .map(d => `<option value="${d.id_departamento}">${d.nombre}</option>`)
                    .join('');
            }
        }

        async function cargarUsuariosAdmin() {
            const tbody = document.getElementById('adminUsersTbody');
            const mobileContainer = document.getElementById('usersCardsMobile');
            if (!tbody && !mobileContainer) return;

            try {
                if (tbody) tbody.innerHTML = '<tr><td colspan="6" class="text-muted">Cargando...</td></tr>';
                if (mobileContainer) mobileContainer.innerHTML = '<div class="text-muted">Cargando...</div>';

                const resp = await apiRequest('/admin/usuarios');
                if (!resp || !resp.success || !Array.isArray(resp.usuarios)) {
                    if (tbody) tbody.innerHTML = '<tr><td colspan="6" class="text-muted">No se pudieron cargar usuarios</td></tr>';
                    if (mobileContainer) mobileContainer.innerHTML = '<div class="text-muted">No se pudieron cargar usuarios</div>';
                    return;
                }

                // Cache por ID para edición
                window.adminUsuariosCache = {};
                resp.usuarios.forEach(u => { window.adminUsuariosCache[u.id] = u; });

                renderUsuariosAdmin(resp.usuarios);
            } catch (e) {
                console.error('Error cargando usuarios admin:', e);
                if (tbody) tbody.innerHTML = '<tr><td colspan="6" class="text-muted">Error cargando usuarios</td></tr>';
                if (mobileContainer) mobileContainer.innerHTML = '<div class="text-muted">Error cargando usuarios</div>';
            }
        }

        function rolBadgeClass(rol) {
            if (rol === 'Admin') return 'bg-primary';
            if (rol === 'Supervisor') return 'bg-info';
            return 'bg-success';
        }

        function renderUsuariosAdmin(usuarios) {
            const tbody = document.getElementById('adminUsersTbody');
            const mobileContainer = document.getElementById('usersCardsMobile');

            if (tbody) {
                tbody.innerHTML = usuarios.map(u => {
                    const estadoActivo = Number(u.estado) === 1;
                    const estadoHtml = estadoActivo
                        ? '<span class="badge bg-success"><i class="bi bi-circle-fill me-1" style="font-size: 6px;"></i>Activo</span>'
                        : '<span class="badge bg-secondary"><i class="bi bi-circle-fill me-1" style="font-size: 6px;"></i>Inactivo</span>';

                    const rolBadge = `<span class="badge ${rolBadgeClass(u.rol)}">${u.rol || '—'}</span>`;

                    return `
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="user-avatar me-2" style="width: 35px; height: 35px; background: linear-gradient(135deg, #0065B7, #009CB4); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">
                                        <i class="bi bi-person-fill"></i>
                                    </div>
                                    <div>
                                        <div class="fw-semibold">${u.nombre || ''}</div>
                                        <small class="text-muted">#${u.id}</small>
                                    </div>
                                </div>
                            </td>
                            <td>${rolBadge}</td>
                            <td class="d-none d-lg-table-cell">${u.email || ''}</td>
                            <td>${estadoHtml}</td>
                            <td class="d-none d-xl-table-cell">—</td>
                            <td class="text-center">
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="bi bi-three-dots-vertical"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item" href="#" onclick="editUser(${u.id})"><i class="bi bi-pencil me-2"></i>Editar</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="viewUserActivity('${(u.nombre || '').replace(/'/g, "\\'")}')"><i class="bi bi-clock-history me-2"></i>Ver actividad</a></li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            if (mobileContainer) {
                mobileContainer.innerHTML = usuarios.map(u => {
                    const estadoActivo = Number(u.estado) === 1;
                    const estadoHtml = estadoActivo
                        ? '<span class="badge bg-success"><i class="bi bi-circle-fill me-1" style="font-size: 6px;"></i>Activo</span>'
                        : '<span class="badge bg-secondary"><i class="bi bi-circle-fill me-1" style="font-size: 6px;"></i>Inactivo</span>';

                    const rolBadge = `<span class="badge ${rolBadgeClass(u.rol)}">${u.rol || '—'}</span>`;

                    return `
                        <div class="card mb-3 border-0 shadow-sm">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div class="d-flex align-items-center">
                                        <div class="user-avatar me-2" style="width: 45px; height: 45px; background: linear-gradient(135deg, #0065B7, #009CB4); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">
                                            <i class="bi bi-person-fill"></i>
                                        </div>
                                        <div>
                                            <div class="fw-semibold">${u.nombre || ''}</div>
                                            <small class="text-muted">#${u.id}</small>
                                        </div>
                                    </div>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="bi bi-three-dots-vertical"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li><a class="dropdown-item" href="#" onclick="editUser(${u.id})"><i class="bi bi-pencil me-2"></i>Editar</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="viewUserActivity('${(u.nombre || '').replace(/'/g, "\\'")}')"><i class="bi bi-clock-history me-2"></i>Ver actividad</a></li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="row g-2 small">
                                    <div class="col-6">
                                        <div class="text-muted mb-1">Rol</div>
                                        ${rolBadge}
                                    </div>
                                    <div class="col-6">
                                        <div class="text-muted mb-1">Estado</div>
                                        ${estadoHtml}
                                    </div>
                                    <div class="col-12 mt-2">
                                        <div class="text-muted mb-1">Email</div>
                                        <div class="text-truncate">${u.email || ''}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // Cargar lista de operadores en el dropdown
        async function cargarOperadoresAsignacion() {
            const selectOperadores = document.getElementById('ticketOperadorAsignado');
            const selectDerivar = document.getElementById('agenteDerivadoSelect');
            
            try {
                const data = await apiRequest('/operadores');
                
                if (data.success && data.operadores) {
                    // Guardar todos los operadores en variable global
                    todosLosOperadores = data.operadores;
                    
                    // Inicialmente deshabilitar el select de operadores
                    if (selectOperadores) {
                        selectOperadores.innerHTML = '<option value="">Primero selecciona un departamento</option>';
                        selectOperadores.disabled = true;
                    }
                    
                    // Cargar en select de derivar (sin filtro)
                    if (selectDerivar) {
                        selectDerivar.innerHTML = '<option value="">Seleccionar agente...</option>';
                        todosLosOperadores.forEach(operador => {
                            const option = document.createElement('option');
                            option.value = operador.id_operador;
                            option.textContent = `${operador.nombre} - ${operador.rol || 'Operador'}`;
                            selectDerivar.appendChild(option);
                        });
                    }
                    
                    console.log('✅ Operadores cargados:', todosLosOperadores.length);
                }
            } catch (error) {
                console.error('Error cargando operadores:', error);
            }
        }
        
        // Filtrar operadores por departamento seleccionado
        function filtrarOperadoresPorDepartamento(idDepartamento) {
            const selectOperadores = document.getElementById('ticketOperadorAsignado');
            if (!selectOperadores) return;
            
            if (!idDepartamento) {
                // Si no hay departamento, deshabilitar select
                selectOperadores.innerHTML = '<option value="">Primero selecciona un departamento</option>';
                selectOperadores.disabled = true;
                return;
            }
            
            // Filtrar operadores que pertenezcan al departamento
            const operadoresFiltrados = todosLosOperadores.filter(operador => {
                // Verificar si el operador tiene departamentos
                if (operador.departamentos && Array.isArray(operador.departamentos)) {
                    return operador.departamentos.some(depto => 
                        depto.id_depto == idDepartamento || depto.id_departamento == idDepartamento
                    );
                }
                return false;
            });
            
            // Limpiar y llenar el select
            selectOperadores.innerHTML = '<option value="">-- Sin asignar (disponible para tomar) --</option>';
            selectOperadores.disabled = false;
            
            if (operadoresFiltrados.length === 0) {
                const optionSinOp = document.createElement('option');
                optionSinOp.value = '';
                optionSinOp.textContent = 'No hay operadores en este departamento';
                optionSinOp.disabled = true;
                selectOperadores.appendChild(optionSinOp);
            } else {
                operadoresFiltrados.forEach(operador => {
                    const option = document.createElement('option');
                    option.value = operador.id_operador;
                    option.textContent = operador.nombre;
                    selectOperadores.appendChild(option);
                });
            }
            
            console.log(`🔍 Filtrados ${operadoresFiltrados.length} operadores del departamento ${idDepartamento}`);
        }

        // Cargar departamentos en el dropdown
        async function cargarDepartamentos() {
            const selectDepartamento = document.getElementById('ticketDepartamento');
            if (!selectDepartamento) return;

            try {
                const data = await apiRequest('/departamentos');
                
                if (data.success && data.departamentos) {
                    selectDepartamento.innerHTML = '<option value="">Seleccionar...</option>';
                    data.departamentos.forEach(depto => {
                        const option = document.createElement('option');
                        option.value = depto.id_departamento;
                        option.textContent = depto.nombre;
                        selectDepartamento.appendChild(option);
                    });
                    
                    // Agregar evento onChange para filtrar operadores
                    selectDepartamento.addEventListener('change', function() {
                        const idDepartamento = this.value;
                        const helpText = document.getElementById('helpTextOperador');
                        
                        if (idDepartamento) {
                            console.log('📋 Departamento seleccionado:', idDepartamento);
                            filtrarOperadoresPorDepartamento(idDepartamento);
                            
                            // Actualizar texto de ayuda
                            if (helpText) {
                                helpText.textContent = 'Operador responsable de resolver el ticket (opcional)';
                                helpText.className = 'text-muted';
                            }
                        } else {
                            // Si se deselecciona el departamento
                            const selectOperadores = document.getElementById('ticketOperadorAsignado');
                            if (selectOperadores) {
                                selectOperadores.innerHTML = '<option value="">Primero selecciona un departamento</option>';
                                selectOperadores.disabled = true;
                            }
                            
                            // Actualizar texto de ayuda
                            if (helpText) {
                                helpText.textContent = 'Primero selecciona un departamento';
                                helpText.className = 'text-warning';
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error cargando departamentos:', error);
                selectDepartamento.innerHTML = '<option value="">Error al cargar departamentos</option>';
            }
        }
        
        // Validar que se haya seleccionado un departamento antes de elegir operador
        function validarDepartamentoSeleccionado() {
            const selectDepartamento = document.getElementById('ticketDepartamento');
            const selectOperadores = document.getElementById('ticketOperadorAsignado');
            
            if (!selectDepartamento || !selectOperadores) return;
            
            // Si el select está deshabilitado, mostrar notificación
            if (selectOperadores.disabled) {
                const idDepartamento = selectDepartamento.value;
                
                if (!idDepartamento) {
                    // Mostrar toast de advertencia
                    if (typeof mostrarToast === 'function') {
                        mostrarToast('warning', 'Departamento requerido', 'Por favor, selecciona primero un departamento para poder asignar un operador.');
                    } else {
                        alert('⚠️ Por favor, selecciona primero un departamento para poder asignar un operador.');
                    }
                    
                    // Enfocar el select de departamento
                    selectDepartamento.focus();
                    selectDepartamento.classList.add('border-warning');
                    setTimeout(() => {
                        selectDepartamento.classList.remove('border-warning');
                    }, 2000);
                }
            }
        }

        // Variable global para almacenar todos los operadores
        let todosLosOperadores = [];
        
        // Variable global para el perfil completo del usuario
        // Variable global para perfil de usuario (accesible desde otros scripts)
        window.perfilUsuario = null;
        let perfilUsuario = null;

        // Función para cargar el perfil completo del usuario
        async function cargarPerfilUsuario() {
            try {
                console.log('👤 Cargando perfil completo del usuario...');
                const data = await apiRequest('/operadores/me');
                
                if (data.success && data.operador) {
                    perfilUsuario = data.operador;
                    window.perfilUsuario = data.operador; // Hacer disponible globalmente
                    console.log('✅ Perfil cargado:', perfilUsuario);
                    console.log('   - Rol global:', perfilUsuario.rol_global);
                    console.log('   - Es admin:', perfilUsuario.es_admin);
                    console.log('   - Es supervisor:', perfilUsuario.es_supervisor);
                    console.log('   - Departamentos:', perfilUsuario.departamentos);
                    
                    // Actualizar UI según permisos
                    configurarFiltrosSegunPermisos();
                    configurarCamposFormularioSegunRol();
                    await configurarAdminSegunPermisos();
                    
                    return perfilUsuario;
                } else {
                    console.error('❌ Error al cargar perfil:', data);
                    return null;
                }
            } catch (error) {
                console.error('❌ Error cargando perfil del usuario:', error);
                return null;
            }
        }

        // Configurar filtros según permisos del usuario
        function configurarFiltrosSegunPermisos() {
            if (!perfilUsuario) return;
            
            const departmentFilter = document.getElementById('departmentFilter');
            const operatorFilter = document.getElementById('operatorFilter');
            const senderFilter = document.getElementById('senderFilter');
            
            // Admin: ve todo
            if (perfilUsuario.es_admin) {
                console.log('🔑 Usuario Admin: acceso completo a filtros');
                // No hay restricciones, los filtros funcionan normalmente
                return;
            }
            
            // Supervisor: ve solo sus departamentos
            if (perfilUsuario.es_supervisor) {
                console.log('👔 Usuario Supervisor: filtros limitados a sus departamentos');
                // Solo puede ver departamentos donde es miembro
                // Los tickets ya vienen filtrados desde el backend
                return;
            }
            
            // Operador normal: ocultar filtros de departamento y operador
            console.log('👷 Usuario Operador: filtros restringidos');
            const advancedFilters = document.querySelector('.tickets-advanced-filters');
            if (advancedFilters) {
                // Para operadores normales, ocultar SOLO el filtro de departamento.
                // Deben poder filtrar por Receptor y Emisor para distinguir:
                // - tickets que emitieron (a quién se asignó / quién lo tomó)
                // - tickets que recibieron (quién los emitió)
                const departmentGroup = departmentFilter?.closest('.filter-group');
                if (departmentGroup) departmentGroup.style.display = 'none';
                if (departmentFilter) {
                    // Evitar "filtro fantasma": si está oculto, no debe filtrar.
                    departmentFilter.value = '';
                    departmentFilter.disabled = true;
                }
            }
        }

        // Función para configurar campos del formulario según el rol del usuario
        function configurarCamposFormularioSegunRol() {
            if (!window.perfilUsuario) return;
            
            const divOperadorAsignado = document.getElementById('divOperadorAsignado');
            
            if (!divOperadorAsignado) return;
            
            // Solo Administradores y Supervisores pueden asignar operadores
            if (window.perfilUsuario.es_admin || window.perfilUsuario.es_supervisor) {
                console.log('🔑 Mostrando campo de asignar operador (Admin/Supervisor)');
                divOperadorAsignado.style.display = 'block';
            } else {
                console.log('👷 Ocultando campo de asignar operador (Agente)');
                divOperadorAsignado.style.display = 'none';
            }
        }

        // Función para cargar filtros de operadores y emisores dinámicamente
        async function cargarFiltrosOperadoresRemitentes() {
            try {
                console.log('👥 Cargando receptores y emisores según contexto...');
                
                // Cargar RECEPTORES del endpoint específico
                const dataReceptores = await apiRequest('/tickets/receptores');
                if (dataReceptores.success && dataReceptores.receptores) {
                    console.log('✅ Receptores cargados:', dataReceptores.receptores.length);
                    actualizarFiltroReceptores(dataReceptores.receptores);
                }
                
                // Cargar EMISORES del endpoint específico
                const dataEmisores = await apiRequest('/tickets/emisores');
                if (dataEmisores.success && dataEmisores.emisores) {
                    console.log('✅ Emisores cargados:', dataEmisores.emisores.length);
                    actualizarFiltroEmisores(dataEmisores.emisores);
                }
                
            } catch (error) {
                console.error('❌ Error cargando filtros de receptores/emisores:', error);
            }
        }

        // Función para cargar solicitudes (tickets sin asignar)
        async function cargarSolicitudes() {
            try {
                console.log('📋 Cargando solicitudes (tickets sin asignar)...');
                
                // Pedir un límite amplio para no truncar solicitudes si hay muchos tickets
                const data = await apiRequest('/tickets?limit=500&offset=0');
                if (data.success && data.tickets) {
                    // Filtrar solo tickets SIN OWNER (sin asignar) y que NO sean del usuario actual
                    const idUsuarioActual = (
                        perfilUsuario?.id_operador ??
                        perfilUsuario?.operador_id ??
                        perfilUsuario?.id
                    );
                    const ticketsSinAsignar = data.tickets.filter(t => {
                        const noTieneOwner = !t.id_operador;
                        const noEsMio = String(t.id_operador_emisor ?? '') !== String(idUsuarioActual ?? '');
                        return noTieneOwner && noEsMio;
                    });
                    
                    console.log(`✅ Solicitudes cargadas: ${ticketsSinAsignar.length} tickets sin asignar (excluyendo propios)`);
                    renderizarSolicitudes(ticketsSinAsignar);
                    actualizarContadorSolicitudes();
                }
                
            } catch (error) {
                console.error('❌ Error cargando solicitudes:', error);
                document.getElementById('solicitudesEmpty').classList.remove('d-none');
                document.getElementById('solicitudesList').style.display = 'none';
            }
        }

        // Función para renderizar solicitudes en el offcanvas
        function renderizarSolicitudes(tickets) {
            const container = document.getElementById('solicitudesList');
            container.innerHTML = '';
            
            if (tickets.length === 0) {
                document.getElementById('solicitudesEmpty').classList.remove('d-none');
                document.getElementById('solicitudesList').style.display = 'none';
                return;
            }
            
            document.getElementById('solicitudesEmpty').classList.add('d-none');
            document.getElementById('solicitudesList').style.display = '';
            
            tickets.forEach(ticket => {
                const prioridadClase = getPrioridadClase(ticket.prioridad);
                const tiempoTranscurrido = calcularTiempoTranscurrido(ticket.fecha_ini);
                
                const card = document.createElement('div');
                card.className = 'solicitud-card';
                card.setAttribute('data-prioridad', prioridadClase);
                card.setAttribute('data-id', ticket.id_ticket);
                
                card.innerHTML = `
                    <div class="solicitud-header">
                        <div class="solicitud-avatar">
                            <i class="bi bi-person"></i>
                        </div>
                        <div class="solicitud-info">
                            <h6 class="solicitud-titulo">${ticket.titulo}</h6>
                            <p class="solicitud-usuario">
                                <i class="bi bi-person me-1"></i>${ticket.usuario?.nombre || ticket.remitente_nombre || 'Usuario'}
                            </p>
                        </div>
                    </div>
                    <div class="solicitud-meta">
                        <span class="badge prioridad-${prioridadClase}">${ticket.prioridad}</span>
                        <span class="badge bg-secondary">${ticket.estado}</span>
                        <small class="text-muted"><i class="bi bi-clock me-1"></i>${tiempoTranscurrido}</small>
                    </div>
                    <p class="solicitud-descripcion">
                        ${ticket.descripcion?.substring(0, 150) || 'Sin descripción'}${ticket.descripcion?.length > 150 ? '...' : ''}
                    </p>
                    <div class="solicitud-acciones">
                        <button class="btn-aceptar" onclick="tomarTicket(${ticket.id_ticket})">
                            <i class="bi bi-hand-thumbs-up me-1"></i>Tomar Ticket
                        </button>
                        <button class="btn-rechazar" onclick="verTicket(${ticket.id_ticket})">
                            <i class="bi bi-eye me-1"></i>Ver Detalle
                        </button>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        // Función para tomar un ticket (auto-asignarse)
        async function tomarTicket(idTicket) {
            try {
                const confirmacion = confirm('¿Deseas tomar este ticket y asignártelo?');
                if (!confirmacion) return;
                
                const response = await fetch(`/api/tickets/${idTicket}/tomar`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${await getValidToken()}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    mostrarToast('success', 'Éxito', 'Ticket asignado correctamente');
                    // Recargar solicitudes y tickets
                    await cargarSolicitudes();
                    if (typeof cargarTicketsReales === 'function') {
                        await cargarTicketsReales();
                    }
                    if (typeof cargarTickets === 'function') {
                        await cargarTickets();
                    }

                    // Si el usuario estaba viendo este ticket, refrescar detalle para habilitar chat
                    if (typeof seleccionarTicket === 'function' && window.currentTicketId && String(window.currentTicketId) === String(idTicket)) {
                        await seleccionarTicket(idTicket);
                    }
                } else {
                    mostrarToast('error', 'Error', data.error || 'No se pudo tomar el ticket');
                }
                
            } catch (error) {
                console.error('Error tomando ticket:', error);
                mostrarToast('error', 'Error', 'Error al procesar la solicitud');
            }
        }

        // Compatibilidad: algunos flujos antiguos llaman loadTickets()
        window.loadTickets = window.loadTickets || (async function() {
            if (typeof cargarTicketsReales === 'function') {
                await cargarTicketsReales();
            }
            if (typeof cargarTickets === 'function') {
                await cargarTickets();
            }
        });
        
        // Función auxiliar para obtener token válido (refresh si es necesario)
        async function getValidToken() {
            const accessToken = sessionStorage.getItem('access_token');
            
            // Verificar si el token está próximo a expirar
            try {
                const payload = JSON.parse(atob(accessToken.split('.')[1]));
                const expiracion = payload.exp * 1000; // Convertir a milisegundos
                const ahora = Date.now();
                
                // Si expira en menos de 5 minutos, renovar
                if (expiracion - ahora < 5 * 60 * 1000) {
                    console.log('Token próximo a expirar, renovando...');
                    await refreshToken();
                    return sessionStorage.getItem('access_token');
                }
            } catch (e) {
                console.warn('No se pudo verificar expiración del token:', e);
            }
            
            return accessToken;
        }
        
        // Función para renovar el token
        async function refreshToken() {
            try {
                const refreshToken = sessionStorage.getItem('refresh_token');
                if (!refreshToken) {
                    throw new Error('No hay refresh token');
                }
                
                const response = await fetch('/api/auth/refresh', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${refreshToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.access_token) {
                    sessionStorage.setItem('access_token', data.access_token);
                    console.log('✅ Token renovado exitosamente');
                } else {
                    throw new Error('No se recibió nuevo token');
                }
            } catch (error) {
                console.error('Error renovando token:', error);
                mostrarToast('warning', 'Sesión expirada', 'Por favor, inicia sesión nuevamente');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 2000);
                throw error;
            }
        }
        
        // Función para mostrar modal de tomar ticket desde lista principal
        window.mostrarModalTomarTicket = function(idTicket, titulo) {
            // Crear modal dinámicamente
            const modalId = 'modalTomarTicket';
            let modal = document.getElementById(modalId);
            
            if (modal) {
                modal.remove();
            }
            
                const modalHTML = `
                <div class="modal fade modal-tomar" id="${modalId}" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header modal-tomar-header">
                                <div class="d-flex align-items-center gap-3">
                                    <div class="modal-icon-circle">
                                        <i class="bi bi-hand-thumbs-up"></i>
                                    </div>
                                    <div>
                                        <h5 class="modal-title mb-0">Tomar Ticket</h5>
                                        <small class="text-white-50">Asignarás este ticket a tu usuario</small>
                                    </div>
                                </div>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info d-flex align-items-center gap-2">
                                    <i class="bi bi-info-circle"></i>
                                    <div>Estás a punto de asignarte el siguiente ticket:</div>
                                </div>
                                <div class="card card-tomar-preview border-0 shadow-sm mt-3">
                                    <div class="card-body p-3">
                                        <h6 class="card-subtitle mb-1 text-muted">Ticket #${idTicket}</h6>
                                        <h5 class="card-title mb-0">${titulo}</h5>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <p class="mb-2 fw-bold">Al tomar este ticket:</p>
                                    <ul class="small mb-0">
                                        <li>Serás responsable de su resolución</li>
                                        <li>El ticket se asignará automáticamente a tu nombre</li>
                                        <li>Desaparecerá de la lista de solicitudes</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="modal-footer border-0 pt-0">
                                <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">
                                    <i class="bi bi-x-circle me-1"></i>Cancelar
                                </button>
                                <button type="button" class="btn btn-tomar rounded-pill px-4" onclick="confirmarTomarTicket(${idTicket})">
                                    <i class="bi bi-hand-thumbs-up me-1"></i>Confirmar y Tomar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            modal = new bootstrap.Modal(document.getElementById(modalId));
            modal.show();
        };
        
        // Confirmar tomar ticket desde modal
        window.confirmarTomarTicket = async function(idTicket) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalTomarTicket'));
            if (modal) modal.hide();
            
            await tomarTicket(idTicket);
        };

        // Helper: Obtener clase de prioridad
        function getPrioridadClase(prioridad) {
            const map = {
                'Urgente': 'urgente',
                'Alta': 'alta',
                'Media': 'media',
                'Baja': 'baja'
            };
            return map[prioridad] || 'media';
        }

        // Helper: Calcular tiempo transcurrido
        function calcularTiempoTranscurrido(fechaIni) {
            const ahora = new Date();
            const fecha = new Date(fechaIni);
            const diffMs = ahora - fecha;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 60) return `Hace ${diffMins} min`;
            if (diffMins < 1440) return `Hace ${Math.floor(diffMins / 60)} hora(s)`;
            return `Hace ${Math.floor(diffMins / 1440)} día(s)`;
        }


        // Función para actualizar solo el filtro de Receptores
        function actualizarFiltroReceptores(receptores) {
            const selectOperador = document.getElementById('operatorFilter');
            if (selectOperador) {
                selectOperador.innerHTML = '<option value="">Todos</option>';
                selectOperador.innerHTML += '<option value="__unassigned__">Sin asignar</option>';
                receptores.forEach(op => {
                    const option = document.createElement('option');
                    option.value = op.id_operador;
                    option.textContent = op.nombre;
                    selectOperador.appendChild(option);
                });
            }
        }

        // Función para actualizar solo el filtro de Emisores
        function actualizarFiltroEmisores(emisores) {
            const selectRemitente = document.getElementById('senderFilter');
            if (selectRemitente) {
                selectRemitente.innerHTML = '<option value="">Todos</option>';
                emisores.forEach(op => {
                    const option = document.createElement('option');
                    option.value = op.id_operador;
                    option.textContent = op.nombre;
                    selectRemitente.appendChild(option);
                });
            }
        }

        // Función LEGACY para actualizar ambos filtros (mantener por compatibilidad con otras partes del código)
        function actualizarFiltrosOperadores(operadores) {
            // Esta función ahora delega a las funciones específicas
            actualizarFiltroReceptores(operadores);
            actualizarFiltroEmisores(operadores);
        }

        // Función para cargar departamentos en el filtro (según permisos)
        async function cargarFiltroDepartamentos() {
            try {
                console.log('🏛️ Cargando departamentos para filtro...');
                
                // Esperar a que el perfil esté cargado
                if (!perfilUsuario) {
                    console.log('⏳ Esperando perfil de usuario...');
                    await cargarPerfilUsuario();
                }
                
                const selectDepartamento = document.getElementById('departmentFilter');
                if (!selectDepartamento) {
                    console.error('❌ No se encontró el select #departmentFilter');
                    return;
                }
                
                // Admin: todos los departamentos
                if (perfilUsuario && perfilUsuario.es_admin) {
                    console.log('🔑 Admin: cargando todos los departamentos');
                    const data = await apiRequest('/departamentos');
                    
                    if (data.success && data.departamentos) {
                        selectDepartamento.innerHTML = '<option value="">Todos</option>';
                        data.departamentos.forEach(depto => {
                            const option = document.createElement('option');
                            option.value = depto.id_departamento || depto.id_depto;
                            option.textContent = depto.nombre || depto.descripcion;
                            selectDepartamento.appendChild(option);
                        });
                        console.log('✅ Departamentos cargados (Admin):', data.departamentos.length);
                    }
                } else if (perfilUsuario && perfilUsuario.departamentos && perfilUsuario.departamentos.length > 0) {
                    // Supervisor/Agente: solo sus departamentos
                    console.log('👔 Cargando solo departamentos del usuario:', perfilUsuario.departamentos);
                    selectDepartamento.innerHTML = '<option value="">Todos mis departamentos</option>';
                    
                    perfilUsuario.departamentos.forEach(depto => {
                        const option = document.createElement('option');
                        option.value = depto.id_depto;
                        option.textContent = depto.departamento_nombre;
                        option.setAttribute('data-rol', depto.rol_departamento);
                        selectDepartamento.appendChild(option);
                    });
                    console.log('✅ Departamentos del usuario cargados:', perfilUsuario.departamentos.length);
                    // Nota: no auto-seleccionar aunque haya 1 depto.
                    // Si el filtro está oculto por permisos o el ticket viene sin id_depto,
                    // el auto-select puede dejar el listado en 0 visibles.
                } else {
                    console.warn('⚠️ Usuario sin departamentos asignados');
                    selectDepartamento.innerHTML = '<option value="">Sin departamentos</option>';
                }
            } catch (error) {
                console.error('❌ Error cargando departamentos para filtros:', error);
            }
        }

        // Función cuando cambia el filtro de departamento
        async function onDepartmentFilterChange() {
            const selectDepartment = document.getElementById('departmentFilter');
            const departmentFilter = selectDepartment ? selectDepartment.value : '';
            
            console.log('📂 Departamento seleccionado:', departmentFilter);
            
            // El filtro de departamento solo afecta visualmente qué tickets se muestran
            // Los emisores/receptores ya vienen filtrados desde el backend según el contexto del usuario
            
            // Aplicar filtros de tickets
            applyAdvancedFilters();
        }

        // Llamar al cargar la página y cuando se abre el modal de nuevo ticket
        document.addEventListener('DOMContentLoaded', async function() {
            // PRIMERO: Cargar perfil del usuario para conocer permisos
            await cargarPerfilUsuario();
            
            // Luego cargar el resto en paralelo
            cargarOperadoresAsignacion();
            cargarDepartamentos();
            cargarRespuestasRapidas();
            cargarSolicitudes(); // Cargar solicitudes (tickets sin asignar)
            
            // Cargar filtros (dependen del perfil)
            await cargarFiltroDepartamentos();
            await cargarFiltrosOperadoresRemitentes();

            const newTicketModal = document.getElementById('newTicketModal');
            if (newTicketModal) {
                newTicketModal.addEventListener('show.bs.modal', function() {
                    cargarOperadoresAsignacion();
                    cargarDepartamentos();
                });
            }
        });
        
        // Cargar respuestas rápidas del operador
        async function cargarRespuestasRapidas() {
            try {
                const data = await apiRequest('/tickets/respuestas-rapidas');
                
                if (!data.success || !data.data) {
                    console.warn('⚠️ No se pudieron cargar respuestas rápidas');
                    return;
                }
                
                const respuestas = data.data;
                console.log(`✅ ${respuestas.length} respuestas rápidas cargadas`);
                
                // Contenedores de respuestas rápidas
                const containersInline = document.querySelectorAll('.quick-replies-inline-container');
                const containersCompact = document.querySelectorAll('.quick-replies-compact-container');
                
                // Generar HTML para inline (panel colapsable)
                containersInline.forEach(container => {
                    container.innerHTML = respuestas.map(r => `
                        <div class="quick-reply-item" onclick="insertQuickReplyDesktop('${r.contenido.replace(/'/g, "\\'")}')">
                            <div class="quick-reply-item-title">${r.titulo}</div>
                            <div class="quick-reply-item-preview">${truncarTexto(r.contenido, 50)}</div>
                        </div>
                    `).join('');
                });
                
                // Generar HTML para compact (sidebar derecho)
                containersCompact.forEach(container => {
                    container.innerHTML = respuestas.slice(0, 4).map(r => `
                        <div class="quick-reply-compact" onclick="insertQuickReplyDesktop('${r.contenido.replace(/'/g, "\\'")}')">
                            <div class="quick-reply-compact-title">${r.titulo}</div>
                            <div class="quick-reply-compact-preview">${truncarTexto(r.contenido, 30)}...</div>
                        </div>
                    `).join('');
                });
                
            } catch (error) {
                console.error('❌ Error al cargar respuestas rápidas:', error);
            }
        }
        
        function truncarTexto(texto, maxLength) {
            return texto.length > maxLength ? texto.substring(0, maxLength) + '...' : texto;
        }
    </script>
    <script src="/static/js/features.js"></script>
</body>
</html>