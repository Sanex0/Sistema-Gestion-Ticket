<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Club Recrear</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
</head>
<body>
    <!-- Skip Link para Accesibilidad -->
    <a href="#main-content" class="skip-link">Saltar al contenido principal</a>
    
    <!-- Contenedor de Toasts Mejorados -->
    <div class="toast-container-custom" id="toastContainer" aria-live="polite" aria-atomic="true"></div>

    <!-- Panel de Notificaciones Flotante -->
    <div class="notifications-panel" id="notificationsPanel" role="dialog" aria-label="Panel de notificaciones">
        <div class="notifications-container">
            <div class="notifications-header">
                <div>
                    <h6 class="mb-0 fw-bold">Notificaciones</h6>
                    <small class="opacity-75"><span id="unreadCount">4</span> sin leer</small>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-light rounded-pill" onclick="markAllAsRead()">
                        <i class="bi bi-check-all"></i> Marcar todas
                    </button>
                    <button class="btn btn-sm btn-link text-white p-0" onclick="toggleNotifications()">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            </div>
            <div class="notifications-list" id="notificationsList">
                <!-- Las notificaciones se cargan dinámicamente -->
            </div>
            <div class="p-3 border-top text-center">
                <a href="#" class="text-decoration-none text-brand-blue fw-semibold" onclick="showAllNotifications()">
                    Ver todas las notificaciones
                </a>
            </div>
        </div>
    </div>

    <!-- Navbar superior con logo - Solo móvil -->
    <nav class="navbar-top d-md-none">
        <div class="container-fluid d-flex justify-content-between align-items-center py-2 px-3">
            <div style="width: 40px;"></div>
            <img src="{{ url_for('static', filename='logo-club-recrear.svg') }}" alt="Club Recrear" class="navbar-logo">
            <button class="notification-badge-btn" onclick="toggleNotifications()">
                <i class="bi bi-bell-fill text-white fs-5"></i>
                <span class="badge-count" id="notifBadgeMobile">4</span>
            </button>
        </div>
    </nav>

    <div class="container-fluid h-100 p-0">
        <div class="row h-100 g-0 row-principal" >
            
            <div class="col-md-2 d-none d-md-flex flex-column sidebar p-3" style="height: 100vh; overflow-y: auto;">
                
                <div class="logo-container text-center">
                    <!-- Logo completo -->
                    <img src="{{ url_for('static', filename='logo-club-recrear.svg') }}" alt="Club Recrear" class="logo-full">
                </div>

                <ul class="nav nav-pills flex-column flex-grow-1" id="dashboardTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active w-100 text-start" id="home-tab" data-bs-toggle="tab" data-bs-target="#home" type="button" role="tab">
                            <i class="bi bi-house-door-fill"></i> <span class="nav-text">Home</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link w-100 text-start" id="ticket-tab" data-bs-toggle="tab" data-bs-target="#ticket" type="button" role="tab">
                            <i class="bi bi-ticket-perforated-fill"></i> <span class="nav-text">Tickets</span>
                        </button>
                    </li>   
                    <li class="nav-item" role="presentation">
                        <button class="nav-link w-100 text-start" id="admin-tab" data-bs-toggle="tab" data-bs-target="#admin" type="button" role="tab">
                            <i class="bi bi-shield-lock-fill"></i> <span class="nav-text">Admin</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link w-100 text-start" id="config-tab" data-bs-toggle="tab" data-bs-target="#config" type="button" role="tab">
                            <i class="bi bi-gear-fill"></i> <span class="nav-text">Config</span>
                        </button>
                    </li>
                    <li class="nav-item mt-2" role="presentation">
                        <button class="nav-link w-100 text-start btn-logout-sidebar" data-bs-toggle="modal" data-bs-target="#logoutModal">
                            <i class="bi bi-box-arrow-left"></i> <span class="nav-text">Salir</span>
                        </button>
                    </li>
                </ul>

            </div>

            <div class="col h-100 columna-cont">
                <div class="main-wrapper" id="main-content" role="main">
                    
                    <div class="tab-content" id="myTabContent">
                        
                        <div class="tab-pane fade show active" id="home" role="tabpanel">
                            <!-- Mobile Header - Solo en Home (sin filtros) -->
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <div>
                                    <h2 class="fw-bold title-gradient mb-1">Dashboard</h2>
                                    <p class="text-muted">Resumen de actividad de hoy</p>
                                </div>
                                <div class="d-flex align-items-center gap-3">
                                    <!-- Botón de Notificaciones -->
                                    <button class="notification-badge-btn d-none d-md-inline-flex" onclick="toggleNotifications()">
                                        <i class="bi bi-bell-fill text-muted fs-5"></i>
                                        <span class="badge-count" id="notifBadgeDesktop">4</span>
                                    </button>
                                    <!-- Botón de Solicitudes Pendientes -->
                                    <button class="btn btn-outline-primary rounded-pill position-relative d-none d-md-inline-flex align-items-center gap-2" data-bs-toggle="offcanvas" data-bs-target="#solicitudesOffcanvas" aria-controls="solicitudesOffcanvas">
                                        <i class="bi bi-inbox-fill"></i>
                                        <span>Solicitudes</span>
                                        <span class="badge bg-danger rounded-pill" id="solicitudesCounterDesktop">3</span>
                                    </button>
                                    <button class="btn btn-primary rounded-pill px-4 py-2 fw-bold d-none d-md-inline-block" style="background: var(--brand-gradient); border:none; box-shadow: 0 4px 15px rgba(0, 156, 180, 0.3);" data-bs-toggle="modal" data-bs-target="#newTicketModal">
                                        <i class="bi bi-plus-lg me-2"></i> Nuevo Ticket
                                    </button>
                                </div>
                            </div>

                            <div class="row g-4 mb-5">
                                <div class="col-md-4">
                                    <div class="kpi-card">
                                        <div class="kpi-icon icon-blue">
                                            <i class="bi bi-ticket-fill"></i>
                                        </div>
                                        <div>
                                            <p class="kpi-title">Tickets Abiertos</p>
                                            <h3 class="kpi-value" id="kpi-tickets-abiertos">0</h3>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="kpi-card">
                                        <div class="kpi-icon icon-teal">
                                            <i class="bi bi-bar-chart-fill"></i>
                                        </div>
                                        <div>
                                            <p class="kpi-title">Nuevos Hoy</p>
                                            <h3 class="kpi-value" id="kpi-nuevos-hoy">0</h3>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="kpi-card">
                                        <div class="kpi-icon icon-purple">
                                            <i class="bi bi-alarm-fill"></i>
                                        </div>
                                        <div>
                                            <p class="kpi-title">Mis Tickets</p>
                                            <h3 class="kpi-value" id="kpi-mis-tickets">0</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Tickets Recientes con Historial -->
                            <div class="row g-4 mb-4">
                                <div class="col-md-12">
                                    <div class="card border-0 shadow-sm rounded-4 p-4">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h5 class="fw-bold text-brand-blue mb-0">Tickets Recientes</h5>
                                            <button class="btn btn-sm btn-outline-primary rounded-pill" data-bs-toggle="modal" data-bs-target="#reportModal">
                                                <i class="bi bi-file-earmark-bar-graph me-1"></i> Reportes
                                            </button>
                                        </div>
                                        <div class="table-responsive">
                                            <table class="table table-hover align-middle recent-tickets-table">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>ID</th>
                                                        <th>Asunto</th>
                                                        <th class="d-none d-md-table-cell">Usuario</th>
                                                        <th>Prioridad</th>
                                                        <th>Estado</th>
                                                        <th class="d-none d-md-table-cell"></th>
                                                    </tr>
                                                </thead>
                                                <tbody id="recent-tickets-tbody">
                                                    <tr>
                                                        <td class="fw-semibold text-brand-blue">#1001</td>
                                                        <td>
                                                            <div>Problema con acceso</div>
                                                            <small class="text-muted d-md-none">Juan Pérez</small>
                                                        </td>
                                                        <td class="d-none d-md-table-cell">Juan Pérez</td>
                                                        <td><span class="badge prioridad-alta">Alta</span></td>
                                                        <td><span class="badge bg-warning text-dark">Pendiente</span></td>
                                                        <td class="d-none d-md-table-cell">
                                                            <button class="btn btn-sm btn-outline-secondary" onclick="showAuditHistory('1001')">
                                                                <i class="bi bi-clock-history"></i>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="fw-semibold text-brand-blue">#1002</td>
                                                        <td>
                                                            <div>Ayuda con cuenta</div>
                                                            <small class="text-muted d-md-none">Ana García</small>
                                                        </td>
                                                        <td class="d-none d-md-table-cell">Ana García</td>
                                                        <td><span class="badge prioridad-media">Media</span></td>
                                                        <td><span class="badge bg-primary">Abierto</span></td>
                                                        <td class="d-none d-md-table-cell">
                                                            <button class="btn btn-sm btn-outline-secondary" onclick="showAuditHistory('1002')">
                                                                <i class="bi bi-clock-history"></i>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="fw-semibold text-brand-blue">#1003</td>
                                                        <td>
                                                            <div>Error en pagos</div>
                                                            <small class="text-muted d-md-none">Carlos López</small>
                                                        </td>
                                                        <td class="d-none d-md-table-cell">Carlos López</td>
                                                        <td><span class="badge prioridad-critica">Crítica</span></td>
                                                        <td><span class="badge bg-info">En Proceso</span></td>
                                                        <td class="d-none d-md-table-cell">
                                                            <button class="btn btn-sm btn-outline-secondary" onclick="showAuditHistory('1003')">
                                                                <i class="bi bi-clock-history"></i>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="fw-semibold text-brand-blue">#1004</td>
                                                        <td>
                                                            <div>Consulta membresía</div>
                                                            <small class="text-muted d-md-none">María Rodríguez</small>
                                                        </td>
                                                        <td class="d-none d-md-table-cell">María Rodríguez</td>
                                                        <td><span class="badge prioridad-baja">Baja</span></td>
                                                        <td><span class="badge bg-success">Resuelto</span></td>
                                                        <td class="d-none d-md-table-cell">
                                                            <button class="btn btn-sm btn-outline-secondary" onclick="showAuditHistory('1004')">
                                                                <i class="bi bi-clock-history"></i>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Métricas Detalladas -->
                            <div class="row g-4 mb-4">
                                <div class="col-md-3 col-6">
                                    <div class="metric-card">
                                        <div class="metric-card-header">
                                            <span class="text-muted small">Tiempo Promedio</span>
                                            <span class="metric-change positive"><i class="bi bi-arrow-down"></i> 12%</span>
                                        </div>
                                        <div class="metric-value">2.4h</div>
                                        <div class="mini-chart mt-2">
                                            <div class="chart-bar" style="height: 40%"></div>
                                            <div class="chart-bar" style="height: 60%"></div>
                                            <div class="chart-bar" style="height: 45%"></div>
                                            <div class="chart-bar" style="height: 80%"></div>
                                            <div class="chart-bar" style="height: 55%"></div>
                                            <div class="chart-bar" style="height: 35%"></div>
                                            <div class="chart-bar" style="height: 70%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="metric-card">
                                        <div class="metric-card-header">
                                            <span class="text-muted small">Resueltos Hoy</span>
                                            <span class="metric-change positive"><i class="bi bi-arrow-up"></i> 8%</span>
                                        </div>
                                        <div class="metric-value">18</div>
                                        <div class="mini-chart mt-2">
                                            <div class="chart-bar" style="height: 30%"></div>
                                            <div class="chart-bar" style="height: 50%"></div>
                                            <div class="chart-bar" style="height: 65%"></div>
                                            <div class="chart-bar" style="height: 45%"></div>
                                            <div class="chart-bar" style="height: 75%"></div>
                                            <div class="chart-bar" style="height: 60%"></div>
                                            <div class="chart-bar" style="height: 90%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="metric-card">
                                        <div class="metric-card-header">
                                            <span class="text-muted small">Satisfacción</span>
                                            <span class="metric-change positive"><i class="bi bi-arrow-up"></i> 3%</span>
                                        </div>
                                        <div class="metric-value">94%</div>
                                        <div class="progress mt-3" style="height: 8px;">
                                            <div class="progress-bar" role="progressbar" style="width: 94%; background: var(--brand-gradient)"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="metric-card">
                                        <div class="metric-card-header">
                                            <span class="text-muted small">Pendientes</span>
                                            <span class="metric-change negative"><i class="bi bi-arrow-up"></i> 2</span>
                                        </div>
                                        <div class="metric-value">7</div>
                                        <div class="metric-badges">
                                            <span class="badge prioridad-critica">2 Crít.</span>
                                            <span class="badge prioridad-alta">3 Alta</span>
                                            <span class="badge prioridad-media">2 Med.</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Dashboard de Métricas Avanzadas -->
                            <div class="row g-4 mb-4">
                                <div class="col-12">
                                    <div class="card border-0 shadow-sm rounded-4 p-4">
                                        <div class="d-flex justify-content-between align-items-center mb-4">
                                            <div>
                                                <h5 class="fw-bold text-brand-blue mb-1">
                                                    <i class="bi bi-graph-up me-2"></i>Métricas Avanzadas
                                                </h5>
                                                <small class="text-muted">Análisis detallado del rendimiento</small>
                                            </div>
                                            <select class="form-select" style="width: auto;" onchange="updateMetricsPeriod(this.value)">
                                                <option value="today">Hoy</option>
                                                <option value="week">Esta Semana</option>
                                                <option value="month" selected>Este Mes</option>
                                                <option value="year">Este Año</option>
                                            </select>
                                        </div>

                                        <div class="row g-3 mb-4">
                                            <!-- Tasa de Resolución -->
                                            <div class="col-md-3 col-6">
                                                <div class="advanced-metric-card">
                                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                                        <div class="metric-icon" style="background: rgba(25, 135, 84, 0.15); color: #198754;">
                                                            <i class="bi bi-check2-circle"></i>
                                                        </div>
                                                        <span class="badge bg-success-subtle text-success">+5.2%</span>
                                                    </div>
                                                    <h3 class="fw-bold mb-1">87%</h3>
                                                    <p class="text-muted small mb-0">Tasa Resolución</p>
                                                </div>
                                            </div>

                                            <!-- Tiempo Respuesta Promedio -->
                                            <div class="col-md-3 col-6">
                                                <div class="advanced-metric-card">
                                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                                        <div class="metric-icon" style="background: rgba(13, 202, 240, 0.15); color: #0dcaf0;">
                                                            <i class="bi bi-clock"></i>
                                                        </div>
                                                        <span class="badge bg-info-subtle text-info">-12%</span>
                                                    </div>
                                                    <h3 class="fw-bold mb-1">1.8h</h3>
                                                    <p class="text-muted small mb-0">Tiempo Respuesta</p>
                                                </div>
                                            </div>

                                            <!-- CSAT Score -->
                                            <div class="col-md-3 col-6">
                                                <div class="advanced-metric-card">
                                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                                        <div class="metric-icon" style="background: rgba(255, 193, 7, 0.15); color: #ffc107;">
                                                            <i class="bi bi-star-fill"></i>
                                                        </div>
                                                        <span class="badge bg-warning-subtle text-warning">+3.1%</span>
                                                    </div>
                                                    <h3 class="fw-bold mb-1">4.7</h3>
                                                    <p class="text-muted small mb-0">Calificación CSAT</p>
                                                </div>
                                            </div>

                                            <!-- Tickets por Agente -->
                                            <div class="col-md-3 col-6">
                                                <div class="advanced-metric-card">
                                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                                        <div class="metric-icon" style="background: rgba(111, 66, 193, 0.15); color: #6f42c1;">
                                                            <i class="bi bi-people"></i>
                                                        </div>
                                                        <span class="badge bg-secondary-subtle text-secondary">15.2</span>
                                                    </div>
                                                    <h3 class="fw-bold mb-1">76</h3>
                                                    <p class="text-muted small mb-0">Tickets/Agente</p>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Gráficos (placeholders para cuando se implemente) -->
                                        <div class="row g-3">
                                            <div class="col-md-8">
                                                <div class="chart-placeholder">
                                                    <i class="bi bi-bar-chart-line fs-1 text-muted mb-3"></i>
                                                    <p class="text-muted">Gráfico de tendencias de tickets</p>
                                                    <small class="text-muted">Se implementará con Chart.js cuando conectes el backend</small>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="chart-placeholder">
                                                    <i class="bi bi-pie-chart fs-1 text-muted mb-3"></i>
                                                    <p class="text-muted">Distribución por canal</p>
                                                    <small class="text-muted">WhatsApp, Email, Chat</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Base de Conocimiento -->
                            <div class="card border-0 shadow-sm rounded-4 p-4 mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="fw-bold text-brand-blue mb-0">
                                        <i class="bi bi-book me-2"></i>Base de Conocimiento
                                    </h5>
                                    <button class="btn btn-sm btn-outline-primary rounded-pill" data-bs-toggle="modal" data-bs-target="#knowledgeBaseModal">
                                        Ver todo <i class="bi bi-arrow-right ms-1"></i>
                                    </button>
                                </div>
                                <div class="row g-3">
                                    <div class="col-md-3 col-6">
                                        <div class="kb-card" onclick="openKBCategory('tech')">
                                            <div class="kb-icon tech">
                                                <i class="bi bi-gear-wide-connected"></i>
                                            </div>
                                            <div class="kb-title">Soporte Técnico</div>
                                            <div class="kb-count">15 artículos</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-6">
                                        <div class="kb-card" onclick="openKBCategory('account')">
                                            <div class="kb-icon account">
                                                <i class="bi bi-person-badge"></i>
                                            </div>
                                            <div class="kb-title">Cuenta y Acceso</div>
                                            <div class="kb-count">12 artículos</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-6">
                                        <div class="kb-card" onclick="openKBCategory('payments')">
                                            <div class="kb-icon payments">
                                                <i class="bi bi-credit-card"></i>
                                            </div>
                                            <div class="kb-title">Pagos y Facturación</div>
                                            <div class="kb-count">8 artículos</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-6">
                                        <div class="kb-card" onclick="openKBCategory('general')">
                                            <div class="kb-icon general">
                                                <i class="bi bi-question-circle"></i>
                                            </div>
                                            <div class="kb-title">Preguntas Frecuentes</div>
                                            <div class="kb-count">20 artículos</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <div class="tab-pane fade" id="ticket" role="tabpanel">
                            <!-- Mobile Header - Solo en Tickets (con búsqueda y filtros) -->
                            <div class="d-md-none mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-3 px-3 pt-3">
                                    <h4 class="fw-bold text-brand-blue mb-0">Tickets</h4>
                                    <button class="btn btn-outline-primary" onclick="showFiltersModal()">
                                        <i class="bi bi-funnel"></i>
                                    </button>
                                </div>
                                
                                <!-- Filtros rápidos móvil -->
                                <div class="px-3 mb-3">
                                    <div class="d-flex gap-2 overflow-auto pb-2" style="-webkit-overflow-scrolling: touch; scrollbar-width: none;">
                                        <button class="btn btn-sm btn-primary rounded-pill active" onclick="filterMobileTickets('all')" style="white-space: nowrap; flex-shrink: 0;">
                                            <i class="bi bi-grid-fill me-1"></i>Todos
                                        </button>
                                        <button class="btn btn-sm btn-outline-warning rounded-pill" onclick="filterMobileTickets('pendiente')" style="white-space: nowrap; flex-shrink: 0;">
                                            Pendiente
                                        </button>
                                        <button class="btn btn-sm btn-outline-info rounded-pill" onclick="filterMobileTickets('en-proceso')" style="white-space: nowrap; flex-shrink: 0;">
                                            En Proceso
                                        </button>
                                        <button class="btn btn-sm btn-outline-success rounded-pill" onclick="filterMobileTickets('resuelto')" style="white-space: nowrap; flex-shrink: 0;">
                                            Resuelto
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger rounded-pill" onclick="filterMobileTickets('sin-respuesta')" style="white-space: nowrap; flex-shrink: 0;">
                                            <i class="bi bi-exclamation-circle me-1"></i>Sin responder
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Barra de búsqueda móvil -->
                                <div class="px-3">
                                    <div class="input-group">
                                        <span class="input-group-text bg-white border-end-0">
                                            <i class="bi bi-search text-muted"></i>
                                        </span>
                                        <input type="text" class="form-control border-start-0 ps-0" id="mobileSearchInput" placeholder="Buscar tickets...">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Mobile Tickets List (WhatsApp style) -->
                            <div class="tickets-list d-md-none" id="mobileTicketsList">
                                <!-- Los tickets se cargan dinámicamente desde la API -->
                            </div>

                            <!-- ========== NUEVO LAYOUT DESKTOP - 3 COLUMNAS ========== -->
                            <div class="tickets-main-container d-none d-md-flex">
                                
                                <!-- Panel Izquierdo - Lista de Tickets -->
                                <div class="tickets-list-panel">
                                    <div class="tickets-list-header">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h4>Tickets</h4>
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-sm btn-outline-primary rounded-circle" data-bs-toggle="modal" data-bs-target="#filtersModal" title="Filtrar">
                                                    <i class="bi bi-funnel"></i>
                                                </button>
                                                <button class="btn btn-sm btn-primary rounded-circle" data-bs-toggle="modal" data-bs-target="#newTicketModal" title="Nuevo ticket" style="background: var(--brand-gradient); border: none;">
                                                    <i class="bi bi-plus-lg"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Filtros Rápidos de Estado -->
                                    <div class="tickets-quick-filters">
                                        <button class="quick-filter-btn filter-all" onclick="filterTicketsByStatus('all', this)">
                                            <i class="bi bi-grid-fill me-1"></i>Todos
                                        </button>
                                        <button class="quick-filter-btn filter-pending active" onclick="filterTicketsByStatus('pendiente', this)">
                                            Pendiente
                                        </button>
                                        <button class="quick-filter-btn filter-process active" onclick="filterTicketsByStatus('en proceso', this)">
                                            En Proceso
                                        </button>
                                        <button class="quick-filter-btn filter-resolved" onclick="filterTicketsByStatus('resuelto', this)">
                                            Resuelto
                                        </button>
                                        <button class="quick-filter-btn filter-closed" onclick="filterTicketsByStatus('cerrado', this)">
                                            Cerrado
                                        </button>
                                        <button class="quick-filter-btn filter-no-response" onclick="filterTicketsByStatus('sin-respuesta', this)">
                                            <i class="bi bi-exclamation-circle me-1"></i>Sin responder
                                        </button>
                                    </div>
                                    
                                    <!-- Nuevos Filtros - Operador y Remitente -->
                                    <div class="tickets-advanced-filters">
                                        <div class="filter-group">
                                            <label class="filter-label">
                                                <i class="bi bi-person-badge me-1"></i>Operador
                                            </label>
                                            <select class="form-select form-select-sm filter-select" id="operatorFilter" onchange="applyAdvancedFilters()">
                                                <option value="">Todos</option>
                                                <option value="santiago" selected>Santiago</option>
                                                <option value="maria">María García</option>
                                                <option value="carlos">Carlos López</option>
                                            </select>
                                        </div>
                                        <div class="filter-group">
                                            <label class="filter-label">
                                                <i class="bi bi-person-circle me-1"></i>Remitente
                                            </label>
                                            <select class="form-select form-select-sm filter-select" id="senderFilter" onchange="applyAdvancedFilters()">
                                                <option value="">Todos</option>
                                                <option value="juan">Juan Pérez</option>
                                                <option value="maria_lopez">María López</option>
                                                <option value="carlos">Carlos Rodríguez</option>
                                                <option value="ana">Ana Martínez</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="tickets-search-bar">
                                        <div class="input-group">
                                            <span class="input-group-text bg-transparent border-0">
                                                <i class="bi bi-search text-muted"></i>
                                            </span>
                                            <input type="text" class="form-control" id="desktopSearchInput" placeholder="Buscar tickets...">
                                        </div>
                                    </div>
                                    
                                    <div class="tickets-scroll-container" id="ticketsScrollContainer">
                                        <!-- Los tickets se cargarán dinámicamente desde la API -->
                                        <div class="text-center py-5">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Cargando tickets...</span>
                                            </div>
                                            <p class="mt-3 text-muted">Cargando tickets desde la base de datos...</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Panel Central - Chat -->
                                <div class="tickets-chat-panel" id="ticketsChatPanel">
                                    <!-- Chat Header Compacto -->
                                    <div class="chat-header">
                                        <div class="d-flex align-items-center">
                                            <button class="btn btn-sm btn-outline-primary rounded-circle me-2" onclick="closeTicketChat()" style="width: 36px; height: 36px;" title="Volver al listado">
                                                <i class="bi bi-arrow-left"></i>
                                            </button>
                                            <div class="chat-user-avatar me-3" style="width: 45px; height: 45px; font-size: 1.4rem;">
                                                <i class="bi bi-person-circle"></i>
                                            </div>
                                            <div class="flex-grow-1 min-width-0">
                                                <div class="d-flex align-items-center gap-2 flex-wrap">
                                                    <h5 class="mb-0 fw-bold text-brand-blue">Juan Pérez</h5>
                                                    <span class="badge bg-secondary" style="font-size: 0.7rem;">#1001</span>
                                                    <span class="badge bg-warning text-dark">Pendiente</span>
                                                    <span class="badge bg-danger">Alta</span>
                                                    <span class="last-agent-response">
                                                        <i class="bi bi-clock-history"></i> Última respuesta: <strong>hace 5 min</strong>
                                                    </span>
                                                </div>
                                                <small class="text-muted d-block text-truncate">Problema con acceso al sistema</small>
                                            </div>
                                            <div class="d-flex align-items-center gap-2">
                                                <button class="btn btn-sm btn-outline-secondary rounded-circle d-xl-none" style="width: 36px; height: 36px;" data-bs-toggle="offcanvas" data-bs-target="#ticketDetailsOffcanvas" title="Ver detalles">
                                                    <i class="bi bi-info-circle"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Barra de acciones del ticket -->
                                    <div class="ticket-actions-bar">
                                        <!-- Cambiar Estado -->
                                        <div class="position-relative">
                                            <button class="ticket-action-btn" onclick="toggleActionDropdown('statusDropdown', event)" data-bs-toggle="tooltip" title="Cambiar estado del ticket">
                                                <i class="bi bi-arrow-repeat"></i>
                                                <span class="d-none d-md-inline">Estado</span>
                                            </button>
                                            <div class="ticket-action-dropdown" id="statusDropdown">
                                                <div class="ticket-action-dropdown-item status-pending" onclick="changeTicketStatus('pendiente')">
                                                    <i class="bi bi-clock-fill"></i>
                                                    <span>Pendiente</span>
                                                </div>
                                                <div class="ticket-action-dropdown-item status-process" onclick="changeTicketStatus('en-proceso')">
                                                    <i class="bi bi-gear-fill"></i>
                                                    <span>En Proceso</span>
                                                </div>
                                                <div class="ticket-action-dropdown-item status-resolved" onclick="changeTicketStatus('resuelto')">
                                                    <i class="bi bi-check-circle-fill"></i>
                                                    <span>Resuelto</span>
                                                </div>
                                                <div class="ticket-action-dropdown-item status-closed" onclick="changeTicketStatus('cerrado')">
                                                    <i class="bi bi-x-circle-fill"></i>
                                                    <span>Cerrado</span>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Cambiar Prioridad -->
                                        <div class="position-relative">
                                            <button class="ticket-action-btn" onclick="toggleActionDropdown('priorityDropdown', event)" data-bs-toggle="tooltip" title="Cambiar prioridad">
                                                <i class="bi bi-flag-fill"></i>
                                                <span class="d-none d-md-inline">Prioridad</span>
                                            </button>
                                            <div class="ticket-action-dropdown" id="priorityDropdown">
                                                <div class="ticket-action-dropdown-item priority-low" onclick="changeTicketPriority('baja')">
                                                    <i class="bi bi-flag"></i>
                                                    <span>Baja</span>
                                                </div>
                                                <div class="ticket-action-dropdown-item priority-normal" onclick="changeTicketPriority('normal')">
                                                    <i class="bi bi-flag-fill"></i>
                                                    <span>Normal</span>
                                                </div>
                                                <div class="ticket-action-dropdown-item priority-high" onclick="changeTicketPriority('alta')">
                                                    <i class="bi bi-flag-fill"></i>
                                                    <span>Alta</span>
                                                </div>
                                                <div class="ticket-action-dropdown-item priority-critical" onclick="changeTicketPriority('critica')">
                                                    <i class="bi bi-exclamation-triangle-fill"></i>
                                                    <span>Crítica</span>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Asignar Agente -->
                                        <div class="position-relative">
                                            <button class="ticket-action-btn" onclick="toggleActionDropdown('assignDropdown', event)" data-bs-toggle="tooltip" title="Asignar o derivar a otro agente">
                                                <i class="bi bi-person-plus-fill"></i>
                                                <span class="d-none d-md-inline">Asignar</span>
                                            </button>
                                            <div class="ticket-action-dropdown" id="assignDropdown">
                                                <div class="ticket-action-dropdown-item" onclick="assignTicket('agente1')">
                                                    <i class="bi bi-person-circle"></i>
                                                    <span>Juan Martínez</span>
                                                </div>
                                                <div class="ticket-action-dropdown-item" onclick="assignTicket('agente2')">
                                                    <i class="bi bi-person-circle"></i>
                                                    <span>María García</span>
                                                </div>
                                                <div class="ticket-action-dropdown-item" onclick="assignTicket('agente3')">
                                                    <i class="bi bi-person-circle"></i>
                                                    <span>Carlos López</span>
                                                </div>
                                                <div class="ticket-action-dropdown-item" onclick="assignTicket('me')">
                                                    <i class="bi bi-person-check-fill"></i>
                                                    <span><strong>Asignarme a mí</strong></span>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Agregar Etiqueta -->
                                        <button class="ticket-action-btn" onclick="openTagModal()" data-bs-toggle="tooltip" title="Agregar etiquetas">
                                            <i class="bi bi-tag-fill"></i>
                                            <span class="d-none d-lg-inline">Etiquetas</span>
                                        </button>

                                        <!-- Nota Interna -->
                                        <button class="ticket-action-btn" onclick="toggleInternalNote()" data-bs-toggle="tooltip" title="Agregar nota interna (no visible para el cliente)">
                                            <i class="bi bi-pencil-square"></i>
                                            <span class="d-none d-lg-inline">Nota</span>
                                        </button>

                                        <!-- Más opciones -->
                                        <div class="position-relative ms-auto">
                                            <button class="ticket-action-btn btn-icon-only" onclick="toggleActionDropdown('moreOptionsDropdown', event)" data-bs-toggle="tooltip" title="Más opciones">
                                                <i class="bi bi-three-dots"></i>
                                            </button>
                                            <div class="ticket-action-dropdown" id="moreOptionsDropdown" style="right: 0; left: auto;">
                                                <div class="ticket-action-dropdown-item" onclick="mergeTickets()">
                                                    <i class="bi bi-link-45deg"></i>
                                                    <span>Fusionar tickets</span>
                                                </div>
                                                <div class="ticket-action-dropdown-item" onclick="exportTicket()">
                                                    <i class="bi bi-download"></i>
                                                    <span>Exportar conversación</span>
                                                </div>
                                                <div class="ticket-action-dropdown-item" onclick="printTicket()">
                                                    <i class="bi bi-printer"></i>
                                                    <span>Imprimir</span>
                                                </div>
                                                <div class="ticket-action-dropdown-item text-danger" onclick="deleteTicket()">
                                                    <i class="bi bi-trash-fill"></i>
                                                    <span>Eliminar ticket</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Chat Messages -->
                                    <div class="chat-messages" id="chatMessagesDesktop">
                                        <!-- Los mensajes se cargarán dinámicamente desde la API -->
                                    </div>

                                    <!-- Chat Input Compacto -->
                                    <div class="chat-input position-relative">
                                        <!-- Panel de Respuestas Rápidas Inline Desktop -->
                                        <div class="quick-replies-panel" id="quickRepliesInlineDesktop">
                                            <div class="p-3 border-bottom d-flex justify-content-between align-items-center bg-light">
                                                <span class="fw-bold text-brand-blue"><i class="bi bi-lightning-fill me-1"></i>Respuestas Rápidas</span>
                                                <button class="btn btn-sm btn-link p-0" onclick="toggleQuickRepliesDesktop()"><i class="bi bi-x-lg"></i></button>
                                            </div>
                                            <div class="quick-reply-item" onclick="insertQuickReplyDesktop('Hola, gracias por contactarnos. Mi nombre es María y estaré ayudándote con tu solicitud.')">
                                                <div class="quick-reply-title">Saludo Inicial</div>
                                                <div class="quick-reply-preview">Hola, gracias por contactarnos...</div>
                                            </div>
                                            <div class="quick-reply-item" onclick="insertQuickReplyDesktop('Para poder ayudarte mejor, necesito que me proporciones la siguiente información: tu nombre de usuario y una descripción detallada del problema.')">
                                                <div class="quick-reply-title">Solicitar Información</div>
                                                <div class="quick-reply-preview">Para poder ayudarte mejor...</div>
                                            </div>
                                            <div class="quick-reply-item" onclick="insertQuickReplyDesktop('Hemos enviado un enlace de recuperación a tu correo electrónico. Por favor revisa tu bandeja de entrada y la carpeta de spam.')">
                                                <div class="quick-reply-title">Reset de Contraseña</div>
                                                <div class="quick-reply-preview">Hemos enviado un enlace...</div>
                                            </div>
                                            <div class="quick-reply-item" onclick="insertQuickReplyDesktop('Me alegra que hayamos podido resolver tu problema. Si tienes alguna otra consulta, no dudes en contactarnos. ¡Que tengas un excelente día!')">
                                                <div class="quick-reply-title">Ticket Resuelto</div>
                                                <div class="quick-reply-preview">Me alegra que hayamos podido...</div>
                                            </div>
                                            <div class="p-2 border-top text-center">
                                                <a href="#" class="small text-brand-blue" data-bs-toggle="modal" data-bs-target="#quickRepliesModal" onclick="toggleQuickRepliesDesktop()">Ver todas las respuestas</a>
                                            </div>
                                        </div>
                                        <input type="file" id="fileAttachmentDesktop" multiple hidden>
                                        <button class="btn btn-link text-muted p-0 me-2" onclick="document.getElementById('fileAttachmentDesktop').click()" title="Adjuntar archivo">
                                            <i class="bi bi-paperclip fs-5"></i>
                                        </button>
                                        <button class="btn btn-link text-muted p-0 me-2" onclick="toggleQuickRepliesDesktop()" title="Respuestas rápidas">
                                            <i class="bi bi-lightning-fill fs-5"></i>
                                        </button>
                                        <input type="text" class="form-control border-0 flex-grow-1" id="chatMessageInputDesktop" placeholder="Escribe un mensaje...">
                                        <button class="btn btn-link p-0 ms-2" onclick="sendChatMessageDesktop()">
                                            <i class="bi bi-send-fill fs-5 text-brand-blue"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Panel Derecho - Detalles y Respuestas Rápidas -->
                                <div class="tickets-details-panel">
                                    <div class="tickets-details-header">
                                        <h5><i class="bi bi-info-circle me-2"></i>Detalles</h5>
                                    </div>
                                    
                                    <div class="tickets-details-content">
                                        <!-- Info del Ticket -->
                                        <div class="tickets-details-section">
                                            <h6>Información</h6>
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="text-muted small">ID:</span>
                                                <span class="fw-bold text-brand-blue">#1001</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="text-muted small">Canal:</span>
                                                <span class="d-flex align-items-center gap-1">
                                                    <i class="bi bi-envelope-fill text-primary"></i>
                                                    <span class="small">Email</span>
                                                </span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="text-muted small">Estado:</span>
                                                <span class="badge bg-warning text-dark">Pendiente</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="text-muted small">Prioridad:</span>
                                                <span class="badge bg-danger">Alta</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="text-muted small">Creado:</span>
                                                <span class="small">16/12/2025 10:30</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="text-muted small">Actualizado:</span>
                                                <span class="small">16/12/2025 10:37</span>
                                            </div>
                                        </div>
                                        
                                        <!-- Usuario -->
                                        <div class="tickets-details-section">
                                            <h6>Solicitante</h6>
                                            <div class="d-flex align-items-center gap-2">
                                                <div class="ticket-card-user-avatar" style="width: 36px; height: 36px; font-size: 0.85rem;">
                                                    <i class="bi bi-person-fill"></i>
                                                </div>
                                                <div>
                                                    <div class="fw-semibold">Juan Pérez</div>
                                                    <small class="text-muted">juan.perez@email.com</small>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Respuestas Rápidas -->
                                        <div class="tickets-details-section">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h6 class="mb-0"><i class="bi bi-lightning-fill me-1"></i>Respuestas Rápidas</h6>
                                                <a href="#" class="small text-brand-blue" data-bs-toggle="modal" data-bs-target="#quickRepliesModal">Ver más</a>
                                            </div>
                                            <!-- Respuestas rápidas unificadas (móvil y desktop) -->
                                            <div class="quick-reply-compact" onclick="insertQuickReplyDesktop('Hola, gracias por contactarnos. Mi nombre es María y estaré ayudándote con tu solicitud.')">
                                                <div class="quick-reply-compact-title">Saludo Inicial</div>
                                                <div class="quick-reply-compact-preview">Hola, gracias por contactarnos...</div>
                                            </div>
                                            <div class="quick-reply-compact" onclick="insertQuickReplyDesktop('Para poder ayudarte mejor, necesito que me proporciones la siguiente información: tu nombre de usuario y una descripción detallada del problema.')">
                                                <div class="quick-reply-compact-title">Solicitar Información</div>
                                                <div class="quick-reply-compact-preview">Para poder ayudarte mejor...</div>
                                            </div>
                                            <div class="quick-reply-compact" onclick="insertQuickReplyDesktop('Hemos enviado un enlace de recuperación a tu correo electrónico. Por favor revisa tu bandeja de entrada y la carpeta de spam.')">
                                                <div class="quick-reply-compact-title">Reset de Contraseña</div>
                                                <div class="quick-reply-compact-preview">Hemos enviado un enlace...</div>
                                            </div>
                                            <div class="quick-reply-compact" onclick="insertQuickReplyDesktop('Me alegra que hayamos podido resolver tu problema. Si tienes alguna otra consulta, no dudes en contactarnos. ¡Que tengas un excelente día!')">
                                                <div class="quick-reply-compact-title">Ticket Resuelto</div>
                                                <div class="quick-reply-compact-preview">Me alegra que hayamos podido...</div>
                                            </div>
                                        </div>
                                        
                                        <!-- Acciones -->
                                        <div class="tickets-details-section">
                                            <h6>Acciones</h6>
                                            <div class="d-grid gap-2">
                                                <button class="btn btn-outline-primary btn-sm">
                                                    <i class="bi bi-check-circle me-2"></i> Cambiar Estado
                                                </button>
                                                <button class="btn btn-outline-primary btn-sm">
                                                    <i class="bi bi-flag me-2"></i> Cambiar Prioridad
                                                </button>
                                                <button class="btn btn-outline-danger btn-sm">
                                                    <i class="bi bi-x-circle me-2"></i> Cerrar Ticket
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- ========== FIN NUEVO LAYOUT DESKTOP ========== -->

                            <!-- Chat Container Mobile (cuando se selecciona un ticket) -->
                            <div class="chat-container d-none" id="mobileChatContainer">
                                <!-- Chat Header -->
                                <div class="chat-header">
                                    <div class="d-flex align-items-center">
                                        <button class="btn btn-link text-brand-blue p-0 me-3" id="chatBackButton" type="button" onclick="closeMobileChat(); return false;">
                                            <i class="bi bi-arrow-left fs-4"></i>
                                        </button>
                                        <div class="chat-user-avatar me-3">
                                            <i class="bi bi-person-circle"></i>
                                        </div>
                                        <div class="flex-grow-1 cursor-pointer" data-bs-toggle="offcanvas" data-bs-target="#ticketDetailsOffcanvas" style="cursor: pointer;">
                                            <h5 class="mb-0 fw-bold text-brand-blue">Juan Pérez <span class="badge bg-secondary" style="font-size: 0.65rem;">#1001</span></h5>
                                            <small class="text-muted">Problema con acceso al sistema</small>
                                        </div>
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="badge bg-warning text-dark d-flex align-items-center justify-content-center px-3 py-2" style="min-width:80px;">Pendiente</span>
                                            <button class="btn btn-sm btn-outline-secondary rounded-circle d-flex align-items-center justify-content-center" style="width: 36px; height: 36px;" data-bs-toggle="offcanvas" data-bs-target="#ticketDetailsOffcanvas">
                                                <i class="bi bi-three-dots-vertical"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Barra de acciones del ticket (Mobile) -->
                                <div class="ticket-actions-bar">
                                    <!-- Cambiar Estado -->
                                    <div class="position-relative">
                                        <button class="ticket-action-btn btn-icon-only" onclick="toggleActionDropdown('statusDropdownMobile', event)" data-bs-toggle="tooltip" title="Estado">
                                            <i class="bi bi-arrow-repeat"></i>
                                        </button>
                                        <div class="ticket-action-dropdown" id="statusDropdownMobile">
                                            <div class="ticket-action-dropdown-item status-pending" onclick="changeTicketStatus('pendiente')">
                                                <i class="bi bi-clock-fill"></i>
                                                <span>Pendiente</span>
                                            </div>
                                            <div class="ticket-action-dropdown-item status-process" onclick="changeTicketStatus('en-proceso')">
                                                <i class="bi bi-gear-fill"></i>
                                                <span>En Proceso</span>
                                            </div>
                                            <div class="ticket-action-dropdown-item status-resolved" onclick="changeTicketStatus('resuelto')">
                                                <i class="bi bi-check-circle-fill"></i>
                                                <span>Resuelto</span>
                                            </div>
                                            <div class="ticket-action-dropdown-item status-closed" onclick="changeTicketStatus('cerrado')">
                                                <i class="bi bi-x-circle-fill"></i>
                                                <span>Cerrado</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Cambiar Prioridad -->
                                    <div class="position-relative">
                                        <button class="ticket-action-btn btn-icon-only" onclick="toggleActionDropdown('priorityDropdownMobile', event)" data-bs-toggle="tooltip" title="Prioridad">
                                            <i class="bi bi-flag-fill"></i>
                                        </button>
                                        <div class="ticket-action-dropdown" id="priorityDropdownMobile">
                                            <div class="ticket-action-dropdown-item priority-low" onclick="changeTicketPriority('baja')">
                                                <i class="bi bi-flag"></i>
                                                <span>Baja</span>
                                            </div>
                                            <div class="ticket-action-dropdown-item priority-normal" onclick="changeTicketPriority('normal')">
                                                <i class="bi bi-flag-fill"></i>
                                                <span>Normal</span>
                                            </div>
                                            <div class="ticket-action-dropdown-item priority-high" onclick="changeTicketPriority('alta')">
                                                <i class="bi bi-flag-fill"></i>
                                                <span>Alta</span>
                                            </div>
                                            <div class="ticket-action-dropdown-item priority-critical" onclick="changeTicketPriority('critica')">
                                                <i class="bi bi-exclamation-triangle-fill"></i>
                                                <span>Crítica</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Asignar Agente -->
                                    <div class="position-relative">
                                        <button class="ticket-action-btn btn-icon-only" onclick="toggleActionDropdown('assignDropdownMobile', event)" data-bs-toggle="tooltip" title="Asignar">
                                            <i class="bi bi-person-plus-fill"></i>
                                        </button>
                                        <div class="ticket-action-dropdown" id="assignDropdownMobile">
                                            <div class="ticket-action-dropdown-item" onclick="assignTicket('agente1')">
                                                <i class="bi bi-person-circle"></i>
                                                <span>Juan Martínez</span>
                                            </div>
                                            <div class="ticket-action-dropdown-item" onclick="assignTicket('agente2')">
                                                <i class="bi bi-person-circle"></i>
                                                <span>María García</span>
                                            </div>
                                            <div class="ticket-action-dropdown-item" onclick="assignTicket('agente3')">
                                                <i class="bi bi-person-circle"></i>
                                                <span>Carlos López</span>
                                            </div>
                                            <div class="ticket-action-dropdown-item" onclick="assignTicket('me')">
                                                <i class="bi bi-person-check-fill"></i>
                                                <span><strong>Asignarme a mí</strong></span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Etiquetas -->
                                    <button class="ticket-action-btn btn-icon-only" onclick="openTagModal()" data-bs-toggle="tooltip" title="Etiquetas">
                                        <i class="bi bi-tag-fill"></i>
                                    </button>

                                    <!-- Nota Interna -->
                                    <button class="ticket-action-btn btn-icon-only" onclick="toggleInternalNote()" data-bs-toggle="tooltip" title="Nota interna">
                                        <i class="bi bi-pencil-square"></i>
                                    </button>

                                    <!-- Más opciones -->
                                    <div class="position-relative ms-auto">
                                        <button class="ticket-action-btn btn-icon-only" onclick="toggleActionDropdown('moreOptionsDropdownMobile', event)" data-bs-toggle="tooltip" title="Más">
                                            <i class="bi bi-three-dots"></i>
                                        </button>
                                        <div class="ticket-action-dropdown" id="moreOptionsDropdownMobile" style="right: 0; left: auto;">
                                            <div class="ticket-action-dropdown-item" onclick="mergeTickets()">
                                                <i class="bi bi-link-45deg"></i>
                                                <span>Fusionar tickets</span>
                                            </div>
                                            <div class="ticket-action-dropdown-item" onclick="exportTicket()">
                                                <i class="bi bi-download"></i>
                                                <span>Exportar</span>
                                            </div>
                                            <div class="ticket-action-dropdown-item" onclick="printTicket()">
                                                <i class="bi bi-printer"></i>
                                                <span>Imprimir</span>
                                            </div>
                                            <div class="ticket-action-dropdown-item text-danger" onclick="deleteTicket()">
                                                <i class="bi bi-trash-fill"></i>
                                                <span>Eliminar</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Chat Messages -->
                                <div class="chat-messages" id="chatMessages">
                                    <!-- Los mensajes se cargarán dinámicamente desde la API -->
                                </div>

                                <!-- Chat Input -->
                                <div class="chat-input position-relative">
                                    <!-- Panel de Respuestas Rápidas Inline -->
                                    <div class="quick-replies-panel" id="quickRepliesInline">
                                        <div class="p-3 border-bottom d-flex justify-content-between align-items-center bg-light">
                                            <span class="fw-bold text-brand-blue"><i class="bi bi-lightning-fill me-1"></i>Respuestas Rápidas</span>
                                            <button class="btn btn-sm btn-link p-0" onclick="toggleQuickReplies()"><i class="bi bi-x-lg"></i></button>
                                        </div>
                                        <div class="quick-reply-item" onclick="insertQuickReply('Hola, gracias por contactarnos. Mi nombre es María y estaré ayudándote con tu solicitud.')">
                                            <div class="quick-reply-title">Saludo Inicial</div>
                                            <div class="quick-reply-preview">Hola, gracias por contactarnos...</div>
                                        </div>
                                        <div class="quick-reply-item" onclick="insertQuickReply('Para poder ayudarte mejor, necesito que me proporciones la siguiente información: tu nombre de usuario y una descripción detallada del problema.')">
                                            <div class="quick-reply-title">Solicitar Información</div>
                                            <div class="quick-reply-preview">Para poder ayudarte mejor...</div>
                                        </div>
                                        <div class="quick-reply-item" onclick="insertQuickReply('Hemos enviado un enlace de recuperación a tu correo electrónico. Por favor revisa tu bandeja de entrada y la carpeta de spam.')">
                                            <div class="quick-reply-title">Reset de Contraseña</div>
                                            <div class="quick-reply-preview">Hemos enviado un enlace...</div>
                                        </div>
                                        <div class="quick-reply-item" onclick="insertQuickReply('Me alegra que hayamos podido resolver tu problema. Si tienes alguna otra consulta, no dudes en contactarnos. ¡Que tengas un excelente día!')">
                                            <div class="quick-reply-title">Ticket Resuelto</div>
                                            <div class="quick-reply-preview">Me alegra que hayamos podido...</div>
                                        </div>
                                        <div class="p-2 border-top text-center">
                                            <a href="#" class="small text-brand-blue" data-bs-toggle="modal" data-bs-target="#quickRepliesModal" onclick="toggleQuickReplies()">Ver todas las respuestas</a>
                                        </div>
                                    </div>
                                    <input type="file" id="fileAttachment" multiple hidden>
                                    <button class="btn btn-link text-muted p-0 me-2" onclick="document.getElementById('fileAttachment').click()" title="Adjuntar archivo">
                                        <i class="bi bi-paperclip fs-5"></i>
                                    </button>
                                    <button class="btn btn-link text-muted p-0 me-2" onclick="toggleQuickReplies()" title="Respuestas rápidas">
                                        <i class="bi bi-lightning-fill fs-5"></i>
                                    </button>
                                    <input type="text" class="form-control border-0 flex-grow-1" id="chatMessageInput" placeholder="Escribe un mensaje...">
                                    <button class="btn btn-link p-0 ms-2" onclick="sendChatMessage()">
                                        <i class="bi bi-send-fill fs-5 text-brand-blue"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Offcanvas - Detalles del Ticket -->
                            <div class="offcanvas offcanvas-end" tabindex="-1" id="ticketDetailsOffcanvas" aria-labelledby="ticketDetailsLabel" style="width: 400px;">
                                <div class="offcanvas-header border-bottom" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.05), rgba(0, 156, 180, 0.05));">
                                    <h5 class="offcanvas-title fw-bold title-gradient" id="ticketDetailsLabel">Información del Ticket</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                                </div>
                                <div class="offcanvas-body p-0">
                                    
                                    <!-- Información General -->
                                    <div class="p-4 border-bottom">
                                        <h6 class="text-muted text-uppercase small fw-bold mb-3">Detalles</h6>
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="text-muted small">Ticket ID:</span>
                                                <span class="fw-bold text-brand-blue">#1001</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="text-muted small">Canal:</span>
                                                <span class="d-flex align-items-center gap-1">
                                                    <i class="bi bi-envelope-fill text-primary"></i>
                                                    <span class="small">Email</span>
                                                </span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="text-muted small">Estado:</span>
                                                <span class="badge bg-warning text-dark">Pendiente</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="text-muted small">Prioridad:</span>
                                                <span class="badge bg-danger">Alta</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="text-muted small">Creado:</span>
                                                <span class="small">11/12/2025 10:30</span>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="text-muted small fw-bold mb-2">Asunto</label>
                                            <p class="mb-0">Problema con acceso al sistema</p>
                                        </div>
                                    </div>

                                    <!-- Operadores de Soporte -->
                                    <div class="p-4 border-bottom">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h6 class="text-muted text-uppercase small fw-bold mb-0">Equipo de Soporte</h6>
                                            <button class="btn btn-sm rounded-pill" style="background: var(--brand-gradient); color: white; border: none;">
                                                <i class="bi bi-plus-circle me-1"></i> Agregar
                                            </button>
                                        </div>
                                        <div class="participant-list">
                                            <div class="participant-item">
                                                <div class="participant-avatar bg-primary">
                                                    <i class="bi bi-person-fill"></i>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <div class="fw-semibold">María González</div>
                                                    <small class="text-muted">Operador Principal</small>
                                                </div>
                                                <span class="badge bg-success-subtle text-success">Activo</span>
                                            </div>
                                            <div class="participant-item">
                                                <div class="participant-avatar bg-info">
                                                    <i class="bi bi-person-fill"></i>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <div class="fw-semibold">Carlos Ruiz</div>
                                                    <small class="text-muted">Supervisor</small>
                                                </div>
                                                <span class="badge bg-secondary-subtle text-secondary">Observador</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Usuarios Involucrados -->
                                    <div class="p-4 border-bottom">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h6 class="text-muted text-uppercase small fw-bold mb-0">Usuarios</h6>
                                            <button class="btn btn-sm rounded-pill" style="background: var(--brand-gradient); color: white; border: none;">
                                                <i class="bi bi-plus-circle me-1"></i> Agregar
                                            </button>
                                        </div>
                                        <div class="participant-list">
                                            <div class="participant-item">
                                                <div class="participant-avatar bg-success">
                                                    <i class="bi bi-person-circle"></i>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <div class="fw-semibold">Juan Pérez</div>
                                                    <small class="text-muted">Solicitante Principal</small>
                                                </div>
                                            </div>
                                            <div class="participant-item">
                                                <div class="participant-avatar bg-warning">
                                                    <i class="bi bi-person-circle"></i>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <div class="fw-semibold">Ana Martínez</div>
                                                    <small class="text-muted">En copia</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Archivos Adjuntos -->
                                    <div class="p-4 border-bottom">
                                        <h6 class="text-muted text-uppercase small fw-bold mb-3">Archivos Adjuntos</h6>
                                        <div class="row g-2">
                                            <div class="col-4">
                                                <div class="attachment-item">
                                                    <i class="bi bi-file-earmark-image text-primary"></i>
                                                    <small class="d-block text-truncate">captura.png</small>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div class="attachment-item">
                                                    <i class="bi bi-file-earmark-pdf text-danger"></i>
                                                    <small class="d-block text-truncate">reporte.pdf</small>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div class="attachment-item">
                                                    <i class="bi bi-file-earmark-text text-info"></i>
                                                    <small class="d-block text-truncate">logs.txt</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Actividad del Ticket -->
                                    <div class="p-4">
                                        <h6 class="text-muted text-uppercase small fw-bold mb-3">
                                            <i class="bi bi-clock-history me-2"></i>Actividad del Ticket
                                        </h6>
                                        <div class="ticket-activity-timeline">
                                            <!-- Actividad más reciente -->
                                            <div class="activity-item">
                                                <div class="activity-icon bg-success">
                                                    <i class="bi bi-reply-fill"></i>
                                                </div>
                                                <div class="activity-content">
                                                    <div class="activity-header">
                                                        <strong>María González</strong> respondió al ticket
                                                    </div>
                                                    <div class="activity-time">Hace 5 minutos</div>
                                                </div>
                                            </div>

                                            <!-- Cambio de estado -->
                                            <div class="activity-item">
                                                <div class="activity-icon bg-info">
                                                    <i class="bi bi-arrow-repeat"></i>
                                                </div>
                                                <div class="activity-content">
                                                    <div class="activity-header">
                                                        <strong>Sistema</strong> cambió el estado a <span class="badge bg-info text-white">En Proceso</span>
                                                    </div>
                                                    <div class="activity-time">Hace 15 minutos</div>
                                                </div>
                                            </div>

                                            <!-- Asignación -->
                                            <div class="activity-item">
                                                <div class="activity-icon bg-primary">
                                                    <i class="bi bi-person-plus-fill"></i>
                                                </div>
                                                <div class="activity-content">
                                                    <div class="activity-header">
                                                        <strong>Carlos Ruiz</strong> asignó el ticket a <strong>María González</strong>
                                                    </div>
                                                    <div class="activity-time">Hace 1 hora</div>
                                                </div>
                                            </div>

                                            <!-- Cambio de prioridad -->
                                            <div class="activity-item">
                                                <div class="activity-icon bg-warning">
                                                    <i class="bi bi-flag-fill"></i>
                                                </div>
                                                <div class="activity-content">
                                                    <div class="activity-header">
                                                        <strong>Carlos Ruiz</strong> cambió la prioridad a <span class="badge bg-danger">Alta</span>
                                                    </div>
                                                    <div class="activity-time">Hace 2 horas</div>
                                                </div>
                                            </div>

                                            <!-- Mensaje del cliente -->
                                            <div class="activity-item">
                                                <div class="activity-icon bg-secondary">
                                                    <i class="bi bi-chat-dots-fill"></i>
                                                </div>
                                                <div class="activity-content">
                                                    <div class="activity-header">
                                                        <strong>Juan Pérez</strong> envió un mensaje
                                                    </div>
                                                    <div class="activity-time">Hace 3 horas</div>
                                                </div>
                                            </div>

                                            <!-- Archivo adjunto -->
                                            <div class="activity-item">
                                                <div class="activity-icon bg-info">
                                                    <i class="bi bi-paperclip"></i>
                                                </div>
                                                <div class="activity-content">
                                                    <div class="activity-header">
                                                        <strong>Juan Pérez</strong> adjuntó <span class="text-muted">captura.png</span>
                                                    </div>
                                                    <div class="activity-time">Hace 3 horas</div>
                                                </div>
                                            </div>

                                            <!-- Creación del ticket -->
                                            <div class="activity-item">
                                                <div class="activity-icon bg-success">
                                                    <i class="bi bi-plus-circle-fill"></i>
                                                </div>
                                                <div class="activity-content">
                                                    <div class="activity-header">
                                                        <strong>Juan Pérez</strong> creó el ticket
                                                    </div>
                                                    <div class="activity-time">11 Dic, 10:30 AM</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="admin" role="tabpanel">
                            <!-- Mobile Header -->
                            <div class="d-md-none d-flex justify-content-between align-items-center mb-3 px-3 pt-3">
                                <h4 class="fw-bold text-brand-blue mb-0">Administración</h4>
                            </div>
                            
                            <h2 class="fw-bold mb-4 title-gradient d-none d-md-block">
                                <i class="bi bi-shield-lock-fill me-2"></i>Administración del Sistema
                            </h2>

                            <!-- Tabs de Administración -->
                            <ul class="nav nav-pills mb-4 flex-nowrap overflow-auto" id="adminTabs" role="tablist" style="-webkit-overflow-scrolling: touch;">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active rounded-pill text-nowrap m-2" id="users-tab" data-bs-toggle="pill" data-bs-target="#users-content" type="button" role="tab">
                                        <i class="bi bi-people-fill me-2"></i><span class="d-none d-sm-inline">Usuarios</span><span class="d-sm-none">Usuarios</span>
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link rounded-pill text-nowrap m-2" id="permissions-tab" data-bs-toggle="pill" data-bs-target="#permissions-content" type="button" role="tab">
                                        <i class="bi bi-key-fill me-2"></i><span class="d-none d-sm-inline">Permisos</span><span class="d-sm-none">Permisos</span>
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link rounded-pill text-nowrap m-2" id="audit-tab" data-bs-toggle="pill" data-bs-target="#audit-content" type="button" role="tab">
                                        <i class="bi bi-clock-history me-2"></i><span class="d-none d-sm-inline">Auditoría</span><span class="d-sm-none">Auditoría</span>
                                    </button>
                                </li>
                            </ul>

                            <div class="tab-content" id="adminTabContent">
                                
                                <!-- Gestión de Usuarios -->
                                <div class="tab-pane fade show active" id="users-content" role="tabpanel">
                                    <div class="card border-0 shadow-sm rounded-4 mb-4">
                                        <div class="card-body p-3 p-md-4">
                                            <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mb-3 mb-md-4 gap-2">
                                                <h5 class="fw-bold text-brand-blue mb-0">
                                                    <i class="bi bi-people-fill me-2 d-none d-sm-inline"></i>Gestión de Usuarios
                                                </h5>
                                                <button class="btn btn-primary rounded-pill btn-sm btn-md-normal" style="background: var(--brand-gradient); border: none;" data-bs-toggle="modal" data-bs-target="#newUserModal">
                                                    <i class="bi bi-plus-lg me-1 me-md-2"></i><span class="d-none d-sm-inline">Nuevo Usuario</span><span class="d-sm-none">Nuevo</span>
                                                </button>
                                            </div>
                                            
                                            <!-- Barra de búsqueda -->
                                            <div class="input-group mb-4">
                                                <span class="input-group-text bg-light border-end-0">
                                                    <i class="bi bi-search text-muted"></i>
                                                </span>
                                                <input type="text" class="form-control border-start-0 ps-0" placeholder="Buscar usuarios..." id="searchUsers" onkeyup="searchUsers()">
                                            </div>

                                            <!-- Tabla de Usuarios - Desktop -->
                                            <div class="table-responsive d-none d-md-block">
                                                <table class="table table-hover align-middle admin-users-table">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th>Usuario</th>
                                                            <th>Rol</th>
                                                            <th class="d-none d-lg-table-cell">Email</th>
                                                            <th>Estado</th>
                                                            <th class="d-none d-xl-table-cell">Último acceso</th>
                                                            <th class="text-center">Acciones</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td>
                                                                <div class="d-flex align-items-center">
                                                                    <div class="user-avatar me-2" style="width: 35px; height: 35px; background: linear-gradient(135deg, #0065B7, #009CB4); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">
                                                                        <i class="bi bi-person-fill"></i>
                                                                    </div>
                                                                    <div>
                                                                        <div class="fw-semibold">María González</div>
                                                                        <small class="text-muted">@mgonzalez</small>
                                                                    </div>
                                                                </div>
                                                            </td>
                                                            <td><span class="badge bg-primary">Administrador</span></td>
                                                            <td class="d-none d-lg-table-cell">maria.gonzalez@clubrecrear.com</td>
                                                            <td><span class="badge bg-success"><i class="bi bi-circle-fill me-1" style="font-size: 6px;"></i>Activo</span></td>
                                                            <td class="d-none d-xl-table-cell">Hace 5 min</td>
                                                            <td class="text-center">
                                                                <div class="dropdown">
                                                                    <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                                        <i class="bi bi-three-dots-vertical"></i>
                                                                    </button>
                                                                    <ul class="dropdown-menu dropdown-menu-end">
                                                                        <li><a class="dropdown-item" href="#" onclick="editUser(1)"><i class="bi bi-pencil me-2"></i>Editar</a></li>
                                                                        <li><a class="dropdown-item" href="#" onclick="viewUserActivity('María González')"><i class="bi bi-clock-history me-2"></i>Ver actividad</a></li>
                                                                        <li><hr class="dropdown-divider"></li>
                                                                        <li><a class="dropdown-item text-danger" href="#" onclick="toggleUserStatus(1, 'active')"><i class="bi bi-x-circle me-2"></i>Desactivar</a></li>
                                                                    </ul>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>
                                                                <div class="d-flex align-items-center">
                                                                    <div class="user-avatar me-2" style="width: 35px; height: 35px; background: linear-gradient(135deg, #6c757d, #495057); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">
                                                                        <i class="bi bi-person-fill"></i>
                                                                    </div>
                                                                    <div>
                                                                        <div class="fw-semibold">Carlos Ruiz</div>
                                                                        <small class="text-muted">@cruiz</small>
                                                                    </div>
                                                                </div>
                                                            </td>
                                                            <td><span class="badge bg-info">Supervisor</span></td>
                                                            <td class="d-none d-lg-table-cell">carlos.ruiz@clubrecrear.com</td>
                                                            <td><span class="badge bg-success"><i class="bi bi-circle-fill me-1" style="font-size: 6px;"></i>Activo</span></td>
                                                            <td class="d-none d-xl-table-cell">Hace 2 horas</td>
                                                            <td class="text-center">
                                                                <div class="dropdown">
                                                                    <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                                        <i class="bi bi-three-dots-vertical"></i>
                                                                    </button>
                                                                    <ul class="dropdown-menu dropdown-menu-end">
                                                                        <li><a class="dropdown-item" href="#" onclick="editUser(2)"><i class="bi bi-pencil me-2"></i>Editar</a></li>
                                                                        <li><a class="dropdown-item" href="#" onclick="viewUserActivity('Carlos Ruiz')"><i class="bi bi-clock-history me-2"></i>Ver actividad</a></li>
                                                                        <li><hr class="dropdown-divider"></li>
                                                                        <li><a class="dropdown-item text-danger" href="#" onclick="toggleUserStatus(2, 'active')"><i class="bi bi-x-circle me-2"></i>Desactivar</a></li>
                                                                    </ul>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>
                                                                <div class="d-flex align-items-center">
                                                                    <div class="user-avatar me-2" style="width: 35px; height: 35px; background: linear-gradient(135deg, #198754, #20c997); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">
                                                                        <i class="bi bi-person-fill"></i>
                                                                    </div>
                                                                    <div>
                                                                        <div class="fw-semibold">Ana Martínez</div>
                                                                        <small class="text-muted">@amartinez</small>
                                                                    </div>
                                                                </div>
                                                            </td>
                                                            <td><span class="badge bg-success">Operador</span></td>
                                                            <td class="d-none d-lg-table-cell">ana.martinez@clubrecrear.com</td>
                                                            <td><span class="badge bg-success"><i class="bi bi-circle-fill me-1" style="font-size: 6px;"></i>Activo</span></td>
                                                            <td class="d-none d-xl-table-cell">Ayer 18:30</td>
                                                            <td class="text-center">
                                                                <div class="dropdown">
                                                                    <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                                        <i class="bi bi-three-dots-vertical"></i>
                                                                    </button>
                                                                    <ul class="dropdown-menu dropdown-menu-end">
                                                                        <li><a class="dropdown-item" href="#" onclick="editUser(3)"><i class="bi bi-pencil me-2"></i>Editar</a></li>
                                                                        <li><a class="dropdown-item" href="#" onclick="viewUserActivity('Ana Martínez')"><i class="bi bi-clock-history me-2"></i>Ver actividad</a></li>
                                                                        <li><hr class="dropdown-divider"></li>
                                                                        <li><a class="dropdown-item text-danger" href="#" onclick="toggleUserStatus(3, 'active')"><i class="bi bi-x-circle me-2"></i>Desactivar</a></li>
                                                                    </ul>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>
                                                                <div class="d-flex align-items-center">
                                                                    <div class="user-avatar me-2" style="width: 35px; height: 35px; background: linear-gradient(135deg, #dc3545, #fd7e14); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">
                                                                        <i class="bi bi-person-fill"></i>
                                                                    </div>
                                                                    <div>
                                                                        <div class="fw-semibold">Pedro García</div>
                                                                        <small class="text-muted">@pgarcia</small>
                                                                    </div>
                                                                </div>
                                                            </td>
                                                            <td><span class="badge bg-success">Operador</span></td>
                                                            <td class="d-none d-lg-table-cell">pedro.garcia@clubrecrear.com</td>
                                                            <td><span class="badge bg-secondary"><i class="bi bi-circle-fill me-1" style="font-size: 6px;"></i>Inactivo</span></td>
                                                            <td class="d-none d-xl-table-cell">15/11/2025 14:22</td>
                                                            <td class="text-center">
                                                                <div class="dropdown">
                                                                    <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                                        <i class="bi bi-three-dots-vertical"></i>
                                                                    </button>
                                                                    <ul class="dropdown-menu dropdown-menu-end">
                                                                        <li><a class="dropdown-item" href="#" onclick="editUser(4)"><i class="bi bi-pencil me-2"></i>Editar</a></li>
                                                                        <li><a class="dropdown-item" href="#" onclick="viewUserActivity('Pedro García')"><i class="bi bi-clock-history me-2"></i>Ver actividad</a></li>
                                                                        <li><hr class="dropdown-divider"></li>
                                                                        <li><a class="dropdown-item text-success" href="#" onclick="toggleUserStatus(4, 'inactive')"><i class="bi bi-check-circle me-2"></i>Activar</a></li>
                                                                    </ul>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>

                                            <!-- Cards de Usuarios - Mobile -->
                                            <div class="d-md-none" id="usersCardsMobile">
                                                <!-- User Card 1 -->
                                                <div class="card mb-3 border-0 shadow-sm">
                                                    <div class="card-body">
                                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                                            <div class="d-flex align-items-center">
                                                                <div class="user-avatar me-2" style="width: 45px; height: 45px; background: linear-gradient(135deg, #0065B7, #009CB4); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">
                                                                    <i class="bi bi-person-fill"></i>
                                                                </div>
                                                                <div>
                                                                    <div class="fw-semibold">María González</div>
                                                                    <small class="text-muted">@mgonzalez</small>
                                                                </div>
                                                            </div>
                                                            <div class="dropdown">
                                                                <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                                    <i class="bi bi-three-dots-vertical"></i>
                                                                </button>
                                                                <ul class="dropdown-menu dropdown-menu-end">
                                                                    <li><a class="dropdown-item" href="#" onclick="editUser(1)"><i class="bi bi-pencil me-2"></i>Editar</a></li>
                                                                    <li><a class="dropdown-item" href="#" onclick="viewUserActivity('María González')"><i class="bi bi-clock-history me-2"></i>Ver actividad</a></li>
                                                                    <li><hr class="dropdown-divider"></li>
                                                                    <li><a class="dropdown-item text-danger" href="#" onclick="toggleUserStatus(1, 'active')"><i class="bi bi-x-circle me-2"></i>Desactivar</a></li>
                                                                </ul>
                                                            </div>
                                                        </div>
                                                        <div class="row g-2 small">
                                                            <div class="col-6">
                                                                <div class="text-muted mb-1">Rol</div>
                                                                <span class="badge bg-primary">Administrador</span>
                                                            </div>
                                                            <div class="col-6">
                                                                <div class="text-muted mb-1">Estado</div>
                                                                <span class="badge bg-success"><i class="bi bi-circle-fill me-1" style="font-size: 6px;"></i>Activo</span>
                                                            </div>
                                                            <div class="col-12 mt-2">
                                                                <div class="text-muted mb-1">Email</div>
                                                                <div class="text-truncate">maria.gonzalez@clubrecrear.com</div>
                                                            </div>
                                                            <div class="col-12">
                                                                <div class="text-muted mb-1">Último acceso</div>
                                                                <div>Hace 5 min</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- User Card 2 -->
                                                <div class="card mb-3 border-0 shadow-sm">
                                                    <div class="card-body">
                                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                                            <div class="d-flex align-items-center">
                                                                <div class="user-avatar me-2" style="width: 45px; height: 45px; background: linear-gradient(135deg, #6c757d, #495057); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">
                                                                    <i class="bi bi-person-fill"></i>
                                                                </div>
                                                                <div>
                                                                    <div class="fw-semibold">Carlos Ruiz</div>
                                                                    <small class="text-muted">@cruiz</small>
                                                                </div>
                                                            </div>
                                                            <div class="dropdown">
                                                                <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                                    <i class="bi bi-three-dots-vertical"></i>
                                                                </button>
                                                                <ul class="dropdown-menu dropdown-menu-end">
                                                                    <li><a class="dropdown-item" href="#" onclick="editUser(2)"><i class="bi bi-pencil me-2"></i>Editar</a></li>
                                                                    <li><a class="dropdown-item" href="#" onclick="viewUserActivity('Carlos Ruiz')"><i class="bi bi-clock-history me-2"></i>Ver actividad</a></li>
                                                                    <li><hr class="dropdown-divider"></li>
                                                                    <li><a class="dropdown-item text-danger" href="#" onclick="toggleUserStatus(2, 'active')"><i class="bi bi-x-circle me-2"></i>Desactivar</a></li>
                                                                </ul>
                                                            </div>
                                                        </div>
                                                        <div class="row g-2 small">
                                                            <div class="col-6">
                                                                <div class="text-muted mb-1">Rol</div>
                                                                <span class="badge bg-info">Supervisor</span>
                                                            </div>
                                                            <div class="col-6">
                                                                <div class="text-muted mb-1">Estado</div>
                                                                <span class="badge bg-success"><i class="bi bi-circle-fill me-1" style="font-size: 6px;"></i>Activo</span>
                                                            </div>
                                                            <div class="col-12 mt-2">
                                                                <div class="text-muted mb-1">Email</div>
                                                                <div class="text-truncate">carlos.ruiz@clubrecrear.com</div>
                                                            </div>
                                                            <div class="col-12">
                                                                <div class="text-muted mb-1">Último acceso</div>
                                                                <div>Hace 2 horas</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- User Card 3 -->
                                                <div class="card mb-3 border-0 shadow-sm">
                                                    <div class="card-body">
                                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                                            <div class="d-flex align-items-center">
                                                                <div class="user-avatar me-2" style="width: 45px; height: 45px; background: linear-gradient(135deg, #198754, #20c997); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">
                                                                    <i class="bi bi-person-fill"></i>
                                                                </div>
                                                                <div>
                                                                    <div class="fw-semibold">Ana Martínez</div>
                                                                    <small class="text-muted">@amartinez</small>
                                                                </div>
                                                            </div>
                                                            <div class="dropdown">
                                                                <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                                    <i class="bi bi-three-dots-vertical"></i>
                                                                </button>
                                                                <ul class="dropdown-menu dropdown-menu-end">
                                                                    <li><a class="dropdown-item" href="#" onclick="editUser(3)"><i class="bi bi-pencil me-2"></i>Editar</a></li>
                                                                    <li><a class="dropdown-item" href="#" onclick="viewUserActivity('Ana Martínez')"><i class="bi bi-clock-history me-2"></i>Ver actividad</a></li>
                                                                    <li><hr class="dropdown-divider"></li>
                                                                    <li><a class="dropdown-item text-danger" href="#" onclick="toggleUserStatus(3, 'active')"><i class="bi bi-x-circle me-2"></i>Desactivar</a></li>
                                                                </ul>
                                                            </div>
                                                        </div>
                                                        <div class="row g-2 small">
                                                            <div class="col-6">
                                                                <div class="text-muted mb-1">Rol</div>
                                                                <span class="badge bg-success">Operador</span>
                                                            </div>
                                                            <div class="col-6">
                                                                <div class="text-muted mb-1">Estado</div>
                                                                <span class="badge bg-success"><i class="bi bi-circle-fill me-1" style="font-size: 6px;"></i>Activo</span>
                                                            </div>
                                                            <div class="col-12 mt-2">
                                                                <div class="text-muted mb-1">Email</div>
                                                                <div class="text-truncate">ana.martinez@clubrecrear.com</div>
                                                            </div>
                                                            <div class="col-12">
                                                                <div class="text-muted mb-1">Último acceso</div>
                                                                <div>Ayer 18:30</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- User Card 4 -->
                                                <div class="card mb-3 border-0 shadow-sm">
                                                    <div class="card-body">
                                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                                            <div class="d-flex align-items-center">
                                                                <div class="user-avatar me-2" style="width: 45px; height: 45px; background: linear-gradient(135deg, #dc3545, #fd7e14); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">
                                                                    <i class="bi bi-person-fill"></i>
                                                                </div>
                                                                <div>
                                                                    <div class="fw-semibold">Pedro García</div>
                                                                    <small class="text-muted">@pgarcia</small>
                                                                </div>
                                                            </div>
                                                            <div class="dropdown">
                                                                <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                                    <i class="bi bi-three-dots-vertical"></i>
                                                                </button>
                                                                <ul class="dropdown-menu dropdown-menu-end">
                                                                    <li><a class="dropdown-item" href="#" onclick="editUser(4)"><i class="bi bi-pencil me-2"></i>Editar</a></li>
                                                                    <li><a class="dropdown-item" href="#" onclick="viewUserActivity('Pedro García')"><i class="bi bi-clock-history me-2"></i>Ver actividad</a></li>
                                                                    <li><hr class="dropdown-divider"></li>
                                                                    <li><a class="dropdown-item text-success" href="#" onclick="toggleUserStatus(4, 'inactive')"><i class="bi bi-check-circle me-2"></i>Activar</a></li>
                                                                </ul>
                                                            </div>
                                                        </div>
                                                        <div class="row g-2 small">
                                                            <div class="col-6">
                                                                <div class="text-muted mb-1">Rol</div>
                                                                <span class="badge bg-success">Operador</span>
                                                            </div>
                                                            <div class="col-6">
                                                                <div class="text-muted mb-1">Estado</div>
                                                                <span class="badge bg-secondary"><i class="bi bi-circle-fill me-1" style="font-size: 6px;"></i>Inactivo</span>
                                                            </div>
                                                            <div class="col-12 mt-2">
                                                                <div class="text-muted mb-1">Email</div>
                                                                <div class="text-truncate">pedro.garcia@clubrecrear.com</div>
                                                            </div>
                                                            <div class="col-12">
                                                                <div class="text-muted mb-1">Último acceso</div>
                                                                <div>15/11/2025 14:22</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Gestión de Permisos -->
                                <div class="tab-pane fade" id="permissions-content" role="tabpanel">
                                    <div class="card border-0 shadow-sm rounded-4 mb-4">
                                        <div class="card-body p-3 p-md-4">
                                            <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mb-3 mb-md-4 gap-2">
                                                <div>
                                                    <h5 class="fw-bold text-brand-blue mb-1">
                                                        <i class="bi bi-key-fill me-2 d-none d-sm-inline"></i>Roles y Permisos
                                                    </h5>
                                                    <small class="text-muted">Gestiona los roles y sus permisos en el sistema</small>
                                                </div>
                                                <button class="btn btn-primary rounded-pill btn-sm btn-md-normal" style="background: var(--brand-gradient); border: none;" data-bs-toggle="modal" data-bs-target="#newRoleModal">
                                                    <i class="bi bi-plus-lg me-1 me-md-2"></i><span class="d-none d-sm-inline">Nuevo Rol</span><span class="d-sm-none">Nuevo</span>
                                                </button>
                                            </div>
                                            
                                            <!-- Contenedor dinámico de roles -->
                                            <div id="rolesList" class="row g-3 g-md-4"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Auditoría -->
                                <div class="tab-pane fade" id="audit-content" role="tabpanel">
                                    <div class="card border-0 shadow-sm rounded-4 mb-4">
                                        <div class="card-body p-3 p-md-4">
                                            <h5 class="fw-bold text-brand-blue mb-3 mb-md-4">
                                                <i class="bi bi-clock-history me-2 d-none d-sm-inline"></i>Auditoría de Actividades
                                            </h5>
                                            
                                            <!-- Filtros -->
                                            <div class="row g-2 g-md-3 mb-3 mb-md-4">
                                                <div class="col-12 col-md-4">
                                                    <label class="form-label small text-muted">Usuario</label>
                                                    <select class="form-select" id="auditUserFilter" onchange="filterAuditLog()">
                                                        <option value="">Todos los usuarios</option>
                                                        <option value="maría gonzález">María González</option>
                                                        <option value="carlos ruiz">Carlos Ruiz</option>
                                                        <option value="ana martínez">Ana Martínez</option>
                                                        <option value="pedro garcía">Pedro García</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label small text-muted">Tipo de acción</label>
                                                    <select class="form-select" id="auditActionFilter" onchange="filterAuditLog()">
                                                        <option value="all">Todas las acciones</option>
                                                        <option value="inició sesión">Inicio de sesión</option>
                                                        <option value="cerró sesión">Cierre de sesión</option>
                                                        <option value="ticket">Tickets</option>
                                                        <option value="usuario">Gestión de usuarios</option>
                                                        <option value="configuración">Configuración</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label small text-muted">Fecha</label>
                                                    <input type="date" class="form-control" id="auditDateFilter" onchange="filterAuditLog()">
                                                </div>
                                            </div>

                                            <!-- Timeline de Auditoría -->
                                            <div class="audit-timeline">
                                                <div class="audit-item">
                                                    <div class="audit-icon bg-success">
                                                        <i class="bi bi-box-arrow-in-right"></i>
                                                    </div>
                                                    <div class="audit-content">
                                                        <div class="audit-header">
                                                            <strong>María González</strong> inició sesión
                                                        </div>
                                                        <div class="audit-details text-muted small">
                                                            IP: 192.168.1.105 | Navegador: Chrome 120
                                                        </div>
                                                        <div class="audit-time">16/12/2025 - 14:35:22</div>
                                                    </div>
                                                </div>

                                                <div class="audit-item">
                                                    <div class="audit-icon bg-primary">
                                                        <i class="bi bi-ticket-perforated"></i>
                                                    </div>
                                                    <div class="audit-content">
                                                        <div class="audit-header">
                                                            <strong>María González</strong> respondió al ticket <span class="text-brand-blue">#1001</span>
                                                        </div>
                                                        <div class="audit-details text-muted small">
                                                            Usuario cliente: Juan Pérez
                                                        </div>
                                                        <div class="audit-time">16/12/2025 - 14:32:15</div>
                                                    </div>
                                                </div>

                                                <div class="audit-item">
                                                    <div class="audit-icon bg-info">
                                                        <i class="bi bi-arrow-repeat"></i>
                                                    </div>
                                                    <div class="audit-content">
                                                        <div class="audit-header">
                                                            <strong>Carlos Ruiz</strong> cambió el estado del ticket <span class="text-brand-blue">#1003</span> a <span class="badge bg-info">En Proceso</span>
                                                        </div>
                                                        <div class="audit-time">16/12/2025 - 13:15:42</div>
                                                    </div>
                                                </div>

                                                <div class="audit-item">
                                                    <div class="audit-icon bg-warning">
                                                        <i class="bi bi-person-plus"></i>
                                                    </div>
                                                    <div class="audit-content">
                                                        <div class="audit-header">
                                                            <strong>María González</strong> asignó el ticket <span class="text-brand-blue">#1002</span> a <strong>Ana Martínez</strong>
                                                        </div>
                                                        <div class="audit-time">16/12/2025 - 12:48:30</div>
                                                    </div>
                                                </div>

                                                <div class="audit-item">
                                                    <div class="audit-icon bg-success">
                                                        <i class="bi bi-person-check"></i>
                                                    </div>
                                                    <div class="audit-content">
                                                        <div class="audit-header">
                                                            <strong>María González</strong> activó el usuario <strong>Ana Martínez</strong>
                                                        </div>
                                                        <div class="audit-details text-muted small">
                                                            Rol: Operador
                                                        </div>
                                                        <div class="audit-time">16/12/2025 - 09:20:15</div>
                                                    </div>
                                                </div>

                                                <div class="audit-item">
                                                    <div class="audit-icon bg-danger">
                                                        <i class="bi bi-box-arrow-right"></i>
                                                    </div>
                                                    <div class="audit-content">
                                                        <div class="audit-header">
                                                            <strong>Pedro García</strong> cerró sesión
                                                        </div>
                                                        <div class="audit-time">15/12/2025 - 18:45:10</div>
                                                    </div>
                                                </div>

                                                <div class="audit-item">
                                                    <div class="audit-icon bg-secondary">
                                                        <i class="bi bi-gear"></i>
                                                    </div>
                                                    <div class="audit-content">
                                                        <div class="audit-header">
                                                            <strong>María González</strong> modificó la configuración del sistema
                                                        </div>
                                                        <div class="audit-details text-muted small">
                                                            Cambio: Tema automático habilitado
                                                        </div>
                                                        <div class="audit-time">15/12/2025 - 16:30:22</div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Paginación y acciones -->
                                            <div class="d-flex justify-content-between align-items-center mt-4">
                                                <button class="btn btn-outline-primary rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#auditLogModal" onclick="loadAuditLog()">
                                                    <i class="bi bi-eye me-2"></i>Ver detalles completos
                                                </button>
                                                <nav>
                                                    <ul class="pagination mb-0">
                                                        <li class="page-item disabled">
                                                            <a class="page-link" href="#"><i class="bi bi-chevron-left"></i></a>
                                                        </li>
                                                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                                                        <li class="page-item"><a class="page-link" href="#">3</a></li>
                                                        <li class="page-item">
                                                            <a class="page-link" href="#"><i class="bi bi-chevron-right"></i></a>
                                                        </li>
                                                    </ul>
                                                </nav>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <div class="tab-pane fade" id="config" role="tabpanel">
                            <!-- Mobile Header - Solo en Config (sin botones) -->
                            <div class="d-md-none d-flex justify-content-between align-items-center mb-3 px-3 pt-3">
                                <h4 class="fw-bold text-brand-blue mb-0">Configuración</h4>
                            </div>
                            
                            <h2 class="fw-bold mb-4 title-gradient d-none d-md-block">Configuración</h2>
                            
                            <!-- Perfil de Usuario -->
                            <div class="card border-0 shadow-sm rounded-4 mb-4 card-hover">
                                <div class="card-body p-4">
                                    <div class="d-flex align-items-center mb-4">
                                        <div class="user-avatar-container me-3">
                                            <div class="user-avatar">
                                                <i class="bi bi-person-fill"></i>
                                            </div>
                                            <span class="user-status online" title="En línea"></span>
                                        </div>
                                        <div>
                                            <h5 class="mb-0 fw-bold text-brand-blue" id="userProfileName">Cargando...</h5>
                                            <p class="text-muted mb-0 small" id="userProfileRole">...</p>
                                            <span class="badge bg-success rounded-pill mt-1" style="font-size: 0.65rem;">
                                                <i class="bi bi-circle-fill me-1" style="font-size: 6px;"></i>En línea
                                            </span>
                                        </div>
                                    </div>
                                    <button class="btn btn-primary btn-ripple w-100 rounded-pill mb-2" style="background: var(--brand-gradient); border: none;" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                                        <i class="bi bi-pencil-square me-2"></i> Editar Perfil
                                    </button>
                                    <button class="btn btn-outline-secondary btn-ripple w-100 rounded-pill btn-change-password" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                                        <i class="bi bi-shield-lock me-2"></i> Cambiar Contraseña
                                    </button>
                                </div>
                            </div>

                            <!-- Preferencias -->
                            <div class="card border-0 shadow-sm rounded-4 mb-4 card-hover">
                                <div class="card-body p-4">
                                    <h6 class="fw-bold text-brand-blue mb-3">
                                        <i class="bi bi-sliders me-2"></i> Preferencias
                                    </h6>
                                    <div class="mb-3">
                                        <label class="form-label small text-muted mb-2">Notificaciones</label>
                                        <div class="form-check form-switch d-flex align-items-center mb-2">
                                            <input class="form-check-input me-3" type="checkbox" role="switch" id="notifEmail" checked>
                                            <label class="form-check-label" for="notifEmail">Notificaciones por email</label>
                                        </div>
                                        <div class="form-check form-switch d-flex align-items-center">
                                            <input class="form-check-input me-3" type="checkbox" role="switch" id="notifSound" checked>
                                            <label class="form-check-label" for="notifSound">Sonido de notificaciones</label>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="form-label small text-muted">Tema</label>
                                        <select class="form-select" id="themeSelector" onchange="changeTheme(this.value)">
                                            <option value="light" selected>Claro</option>
                                            <option value="dark">Oscuro</option>
                                            <option value="auto">Automático</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Información del Sistema -->
                            <div class="card border-0 shadow-sm rounded-4 mb-4 card-hover">
                                <div class="card-body p-4">
                                    <h6 class="fw-bold text-brand-blue mb-3">
                                        <i class="bi bi-info-circle me-2"></i> Información
                                    </h6>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="text-muted small">Versión:</span>
                                        <span class="fw-semibold small">4.2</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="text-muted small">Última actualización:</span>
                                        <span class="fw-semibold small">12/12/2025</span>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Logout -->
    <div class="modal fade" id="logoutModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold text-brand-blue">Confirmar salida</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <i class="bi bi-exclamation-circle text-danger display-1 mb-3"></i>
                    <p class="mb-0 fs-5">¿Estás seguro que quieres cerrar tu sesión?</p>
                </div>
                <div class="modal-footer border-0 justify-content-center pb-4">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancelar</button>
                    <a href="{{ url_for('login_bp.root') }}" class="btn btn-danger rounded-pill px-4">Sí, salir</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Calificación/Rating -->
    <div class="modal fade" id="ratingModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.05), rgba(0, 156, 180, 0.05));">
                    <h5 class="modal-title fw-bold title-gradient">
                        <i class="bi bi-star-fill me-2"></i>Califica tu experiencia
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-4 text-center">
                    <p class="mb-4">¿Cómo fue tu experiencia con nuestro soporte?</p>
                    <div class="rating-stars mb-4">
                        <i class="bi bi-star-fill rating-star" id="star1" onclick="setRating(1)"></i>
                        <i class="bi bi-star-fill rating-star" id="star2" onclick="setRating(2)"></i>
                        <i class="bi bi-star-fill rating-star" id="star3" onclick="setRating(3)"></i>
                        <i class="bi bi-star-fill rating-star" id="star4" onclick="setRating(4)"></i>
                        <i class="bi bi-star-fill rating-star" id="star5" onclick="setRating(5)"></i>
                    </div>
                    <div class="mb-3">
                        <label for="feedbackText" class="form-label fw-semibold text-brand-blue">
                            Comentarios (opcional)
                        </label>
                        <textarea class="form-control" id="feedbackText" rows="3" 
                                  placeholder="Cuéntanos tu experiencia..."></textarea>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary rounded-pill px-4" 
                            style="background: var(--brand-gradient); border:none;" onclick="submitRating()">
                        <i class="bi bi-send-fill me-1"></i> Enviar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Registro de Auditoría -->
    <div class="modal fade" id="auditLogModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.05), rgba(0, 156, 180, 0.05));">
                    <div>
                        <h5 class="modal-title fw-bold title-gradient mb-1">
                            <i class="bi bi-clock-history me-2"></i>Registro de Auditoría
                        </h5>
                        <small class="text-muted">Historial completo de actividades</small>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-4">
                    <!-- Filtros -->
                    <div class="audit-filters mb-4">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <select class="form-select" onchange="filterAuditLog(this.value)">
                                    <option value="">Todas las acciones</option>
                                    <option value="create">Creación</option>
                                    <option value="update">Actualización</option>
                                    <option value="assign">Asignación</option>
                                    <option value="close">Cierre</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select">
                                    <option value="">Todos los usuarios</option>
                                    <option value="admin">Admin</option>
                                    <option value="agent1">Agente1</option>
                                    <option value="agent2">Agente2</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <input type="date" class="form-control">
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-primary w-100">
                                    <i class="bi bi-search"></i> Buscar
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Lista de logs -->
                    <div id="auditLogList" class="audit-log-container"></div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-outline-primary rounded-pill px-4">
                        <i class="bi bi-download"></i> Exportar
                    </button>
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Editar Perfil -->
    <div class="modal fade" id="editProfileModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.05), rgba(0, 156, 180, 0.05));">
                    <h5 class="modal-title fw-bold title-gradient">
                        <i class="bi bi-pencil-square me-2"></i>Editar Perfil
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label class="form-label fw-semibold text-brand-blue">Nombre Completo</label>
                        <input type="text" class="form-control" value="María González">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold text-brand-blue">Email</label>
                        <input type="email" class="form-control" value="maria.gonzalez@clubrecrear.com">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold text-brand-blue">Teléfono</label>
                        <input type="tel" class="form-control" value="+57 300 123 4567">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold text-brand-blue">Cargo</label>
                        <input type="text" class="form-control" value="Operador de Soporte">
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary rounded-pill px-4" style="background: var(--brand-gradient); border:none;">
                        <i class="bi bi-check-lg me-1"></i> Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Cambiar Contraseña -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.05), rgba(0, 156, 180, 0.05));">
                    <h5 class="modal-title fw-bold title-gradient">
                        <i class="bi bi-shield-lock me-2"></i>Cambiar Contraseña
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label class="form-label fw-semibold text-brand-blue">Contraseña Actual</label>
                        <input type="password" class="form-control" placeholder="Ingresa tu contraseña actual">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold text-brand-blue">Nueva Contraseña</label>
                        <input type="password" class="form-control" placeholder="Ingresa tu nueva contraseña">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold text-brand-blue">Confirmar Nueva Contraseña</label>
                        <input type="password" class="form-control" placeholder="Confirma tu nueva contraseña">
                    </div>
                    <div class="alert alert-info d-flex align-items-center" role="alert">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        <small>La contraseña debe tener al menos 8 caracteres</small>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary rounded-pill px-4" style="background: var(--brand-gradient); border:none;">
                        <i class="bi bi-check-lg me-1"></i> Cambiar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Nuevo Ticket -->
    <div class="modal fade" id="newTicketModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.05), rgba(0, 156, 180, 0.05));">
                    <h5 class="modal-title fw-bold title-gradient">
                        <i class="bi bi-plus-circle-fill me-2"></i>Crear Nuevo Ticket
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="newTicketForm">
                        <!-- Asunto -->
                        <div class="mb-3">
                            <label for="ticketSubject" class="form-label fw-semibold text-brand-blue">
                                Asunto <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="ticketSubject" placeholder="Describe brevemente el problema" required>
                        </div>

                        <!-- Descripción -->
                        <div class="mb-3">
                            <label for="ticketDescription" class="form-label fw-semibold text-brand-blue">
                                Descripción <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control" id="ticketDescription" rows="4" placeholder="Proporciona detalles sobre el problema o solicitud..." required></textarea>
                        </div>

                        <div class="row">
                            <!-- Prioridad -->
                            <div class="col-md-6 mb-3">
                                <label for="ticketPriority" class="form-label fw-semibold text-brand-blue">
                                    Prioridad <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="ticketPriority" required>
                                    <option value="">Seleccionar...</option>
                                    <option value="baja">Baja</option>
                                    <option value="media" selected>Media</option>
                                    <option value="alta">Alta</option>
                                    <option value="critica">Crítica</option>
                                </select>
                            </div>

                            <!-- Categoría -->
                            <div class="col-md-6 mb-3">
                                <label for="ticketCategory" class="form-label fw-semibold text-brand-blue">
                                    Categoría <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="ticketCategory" required>
                                    <option value="">Seleccionar...</option>
                                    <option value="tecnico">Soporte Técnico</option>
                                    <option value="cuenta">Cuenta y Acceso</option>
                                    <option value="pagos">Pagos y Facturación</option>
                                    <option value="membresia">Membresía</option>
                                    <option value="general">Consulta General</option>
                                    <option value="otro">Otro</option>
                                </select>
                            </div>
                        </div>

                        <!-- Usuario afectado (solo si es operador) -->
                        <div class="mb-3">
                            <label for="ticketUser" class="form-label fw-semibold text-brand-blue">
                                Usuario afectado
                            </label>
                            <input type="text" class="form-control" id="ticketUser" placeholder="Nombre del usuario (opcional)">
                            <small class="text-muted">Si creas el ticket para otro usuario, indica su nombre o email</small>
                        </div>

                            <!-- Operador Asignado -->
                            <div class="mb-3">
                                <label for="ticketOperadorAsignado" class="form-label fw-semibold text-brand-blue">
                                    <i class="bi bi-person-check-fill me-1"></i>Asignar a Operador
                                </label>
                                <select class="form-select" id="ticketOperadorAsignado">
                                    <option value="">-- Seleccionar operador --</option>
                                    <!-- Se llena dinámicamente con JavaScript -->
                                </select>
                                <small class="text-muted">Operador responsable de resolver el ticket</small>
                            </div>

                        <!-- Etiquetas/Tags -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold text-brand-blue">
                                <i class="bi bi-tags-fill me-1"></i>Etiquetas
                            </label>
                            <div id="selectedTagsDisplay" class="mb-2 d-flex flex-wrap gap-2">
                                <span class="text-muted">Sin etiquetas</span>
                            </div>
                            <div id="tagSelector" class="tag-selector"></div>
                            <small class="text-muted">Agrega etiquetas para categorizar mejor el ticket</small>
                        </div>

                        <!-- Archivos adjuntos -->
                        <div class="mb-3">
                            <label for="ticketAttachments" class="form-label fw-semibold text-brand-blue">
                                <i class="bi bi-paperclip me-1"></i>Archivos adjuntos
                                <span class="badge bg-secondary ms-2" id="attachmentCount">0</span>
                            </label>
                            <div class="attachment-dropzone" onclick="document.getElementById('ticketAttachments').click()">
                                <i class="bi bi-cloud-arrow-up fs-1 text-brand-blue mb-2"></i>
                                <p class="mb-1 fw-semibold">Haz clic o arrastra archivos aquí</p>
                                <small class="text-muted">PDF, imágenes, documentos (máx. 10MB)</small>
                            </div>
                            <input type="file" class="form-control d-none" id="ticketAttachments" multiple onchange="handleFileSelect(event)" 
                                   accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,.jpg,.jpeg,.png,.gif,.zip">
                        </div>

                        <!-- Lista de archivos adjuntos -->
                        <div id="attachmentList" class="attachments-container mb-3"></div>

                        <div class="alert alert-info d-flex align-items-start" role="alert">
                            <i class="bi bi-info-circle-fill me-2 mt-1"></i>
                            <small>Los campos marcados con <span class="text-danger">*</span> son obligatorios. Un operador de soporte te responderá lo antes posible.</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary rounded-pill px-4" style="background: var(--brand-gradient); border:none;" onclick="createTicket()">
                        <i class="bi bi-send-fill me-1"></i> Crear Ticket
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Búsqueda de Tickets -->
    <div class="modal fade" id="searchTicketsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header border-0 pb-2" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.05), rgba(0, 156, 180, 0.05));">
                    <div class="w-100">
                        <div class="input-group">
                            <span class="input-group-text bg-transparent border-0">
                                <i class="bi bi-search text-brand-blue"></i>
                            </span>
                            <input type="text" class="form-control border-0 shadow-none" id="searchTicketInput" placeholder="Buscar tickets por ID, asunto, usuario..." autofocus>
                            <button type="button" class="btn-close ms-2" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                        </div>
                    </div>
                </div>
                <div class="modal-body p-0" style="max-height: 60vh; overflow-y: auto;">
                    <div id="searchResults">
                        <!-- Resultados de búsqueda aparecerán aquí -->
                        <div class="text-center py-5 text-muted">
                            <i class="bi bi-search display-4 d-block mb-3 opacity-25"></i>
                            <p>Comienza a escribir para buscar tickets...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Filtros -->
    <div class="modal fade" id="filtersModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.05), rgba(0, 156, 180, 0.05));">
                    <h5 class="modal-title fw-bold title-gradient">
                        <i class="bi bi-funnel-fill me-2"></i>Filtrar Tickets
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-4">
                    <!-- Estado -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold text-brand-blue">Estado</label>
                        <div class="d-flex flex-wrap gap-2">
                            <input type="checkbox" class="btn-check" id="filter-all" checked>
                            <label class="btn btn-outline-primary btn-sm rounded-pill" for="filter-all">Todos</label>
                            
                            <input type="checkbox" class="btn-check" id="filter-open">
                            <label class="btn btn-outline-primary btn-sm rounded-pill" for="filter-open">Abiertos</label>
                            
                            <input type="checkbox" class="btn-check" id="filter-pending">
                            <label class="btn btn-outline-warning btn-sm rounded-pill" for="filter-pending">Pendientes</label>
                            
                            <input type="checkbox" class="btn-check" id="filter-closed">
                            <label class="btn btn-outline-success btn-sm rounded-pill" for="filter-closed">Cerrados</label>
                        </div>
                    </div>

                    <!-- Prioridad -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold text-brand-blue">Prioridad</label>
                        <div class="d-flex flex-wrap gap-2">
                            <input type="checkbox" class="btn-check" id="priority-high">
                            <label class="btn btn-outline-danger btn-sm rounded-pill" for="priority-high">Alta</label>
                            
                            <input type="checkbox" class="btn-check" id="priority-medium">
                            <label class="btn btn-outline-warning btn-sm rounded-pill" for="priority-medium">Media</label>
                            
                            <input type="checkbox" class="btn-check" id="priority-low">
                            <label class="btn btn-outline-info btn-sm rounded-pill" for="priority-low">Baja</label>
                        </div>
                    </div>

                    <!-- Rango de fechas -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold text-brand-blue">Fecha de creación</label>
                        <div class="row g-2">
                            <div class="col-6">
                                <input type="date" class="form-control" placeholder="Desde">
                            </div>
                            <div class="col-6">
                                <input type="date" class="form-control" placeholder="Hasta">
                            </div>
                        </div>
                    </div>

                    <!-- Canal -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold text-brand-blue">Canal de Origen</label>
                        <div class="d-flex flex-wrap gap-2">
                            <input type="checkbox" class="btn-check" id="channel-email">
                            <label class="btn btn-outline-primary btn-sm rounded-pill" for="channel-email">
                                <i class="bi bi-envelope-fill me-1"></i>Email
                            </label>
                            
                            <input type="checkbox" class="btn-check" id="channel-whatsapp">
                            <label class="btn btn-outline-success btn-sm rounded-pill" for="channel-whatsapp">
                                <i class="bi bi-whatsapp me-1"></i>WhatsApp
                            </label>
                            
                            <input type="checkbox" class="btn-check" id="channel-chat">
                            <label class="btn btn-outline-info btn-sm rounded-pill" for="channel-chat">
                                <i class="bi bi-chat-dots-fill me-1"></i>Chat Web
                            </label>
                            
                            <input type="checkbox" class="btn-check" id="channel-phone">
                            <label class="btn btn-outline-warning btn-sm rounded-pill" for="channel-phone">
                                <i class="bi bi-telephone-fill me-1"></i>Teléfono
                            </label>
                            
                            <input type="checkbox" class="btn-check" id="channel-form">
                            <label class="btn btn-outline-secondary btn-sm rounded-pill" for="channel-form">
                                <i class="bi bi-file-text-fill me-1"></i>Formulario
                            </label>
                            
                            <input type="checkbox" class="btn-check" id="channel-app">
                            <label class="btn btn-outline-dark btn-sm rounded-pill" for="channel-app">
                                <i class="bi bi-phone-fill me-1"></i>App Móvil
                            </label>
                        </div>
                    </div>

                    <!-- Asignado a -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold text-brand-blue">Asignado a</label>
                        <select class="form-select">
                            <option value="">Todos los operadores</option>
                            <option value="1">María González</option>
                            <option value="2">Carlos Ruiz</option>
                            <option value="3">Ana Martínez</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer border-0 justify-content-between">
                    <button type="button" class="btn btn-link text-muted" onclick="resetFilters()">
                        <i class="bi bi-arrow-counterclockwise me-1"></i> Limpiar filtros
                    </button>
                    <div>
                        <button type="button" class="btn btn-light rounded-pill px-4 me-2" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary rounded-pill px-4" style="background: var(--brand-gradient); border:none;" onclick="applyFilters()">
                            <i class="bi bi-check-lg me-1"></i> Aplicar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Offcanvas de Solicitudes Pendientes -->
    <div class="offcanvas offcanvas-end offcanvas-solicitudes" tabindex="-1" id="solicitudesOffcanvas" aria-labelledby="solicitudesOffcanvasLabel">
        <div class="offcanvas-header" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.08), rgba(0, 156, 180, 0.08));">
            <div>
                <h5 class="offcanvas-title fw-bold title-gradient" id="solicitudesOffcanvasLabel">
                    <i class="bi bi-inbox-fill me-2"></i>Solicitudes Pendientes
                </h5>
                <small class="text-muted">Tickets que esperan tu aprobación</small>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
        </div>
        <div class="offcanvas-body p-3" style="background: #f8f9fa;">
            <!-- Filtros rápidos -->
            <div class="d-flex gap-2 mb-3 flex-wrap">
                <button class="btn btn-sm btn-primary rounded-pill active" onclick="filterSolicitudes('todas')">Todas</button>
                <button class="btn btn-sm btn-outline-danger rounded-pill" onclick="filterSolicitudes('critica')">Críticas</button>
                <button class="btn btn-sm btn-outline-warning rounded-pill" onclick="filterSolicitudes('alta')">Alta</button>
                <button class="btn btn-sm btn-outline-secondary rounded-pill" onclick="filterSolicitudes('media')">Media</button>
            </div>

            <!-- Lista de solicitudes -->
            <div id="solicitudesList">
                <!-- Solicitud 1 - Crítica -->
                <div class="solicitud-card" data-prioridad="critica" data-id="2001">
                    <div class="solicitud-header">
                        <div class="solicitud-avatar">
                            <i class="bi bi-person"></i>
                        </div>
                        <div class="solicitud-info">
                            <h6 class="solicitud-titulo">Sistema caído completamente</h6>
                            <p class="solicitud-usuario"><i class="bi bi-person me-1"></i>Roberto Méndez</p>
                        </div>
                    </div>
                    <div class="solicitud-meta">
                        <span class="badge prioridad-critica">Crítica</span>
                        <span class="badge bg-secondary">Soporte Técnico</span>
                        <small class="text-muted"><i class="bi bi-clock me-1"></i>Hace 5 min</small>
                    </div>
                    <p class="solicitud-descripcion">
                        El sistema principal no está funcionando desde esta mañana. Ningún usuario puede acceder y estamos perdiendo operaciones importantes...
                    </p>
                    <div class="solicitud-acciones">
                        <button class="btn-aceptar" onclick="verTicket('2001')">
                            <i class="bi bi-eye me-1"></i>Ver Ticket
                        </button>
                        <button class="btn-rechazar" onclick="abrirModalDerivar('2001')">
                            <i class="bi bi-arrow-left-right me-1"></i>Derivar/Rechazar
                        </button>
                        <button class="btn-ver-detalle" onclick="verDetalleSolicitud('2001')" title="Ver detalles">
                            <i class="bi bi-list-ul"></i>
                        </button>
                    </div>
                </div>

                <!-- Solicitud 2 - Alta -->
                <div class="solicitud-card" data-prioridad="alta" data-id="2002">
                    <div class="solicitud-header">
                        <div class="solicitud-avatar">
                            <i class="bi bi-person"></i>
                        </div>
                        <div class="solicitud-info">
                            <h6 class="solicitud-titulo">No puedo procesar pagos</h6>
                            <p class="solicitud-usuario"><i class="bi bi-person me-1"></i>Carolina Vega</p>
                        </div>
                    </div>
                    <div class="solicitud-meta">
                        <span class="badge prioridad-alta">Alta</span>
                        <span class="badge bg-secondary">Pagos</span>
                        <small class="text-muted"><i class="bi bi-clock me-1"></i>Hace 15 min</small>
                    </div>
                    <p class="solicitud-descripcion">
                        Cuando intento realizar un pago el sistema muestra error 500. Adjunto captura de pantalla del problema.
                    </p>
                    <div class="solicitud-acciones">
                        <button class="btn-aceptar" onclick="verTicket('2002')">
                            <i class="bi bi-eye me-1"></i>Ver Ticket
                        </button>
                        <button class="btn-rechazar" onclick="abrirModalDerivar('2002')">
                            <i class="bi bi-arrow-left-right me-1"></i>Derivar/Rechazar
                        </button>
                        <button class="btn-ver-detalle" onclick="verDetalleSolicitud('2002')" title="Ver detalles">
                            <i class="bi bi-list-ul"></i>
                        </button>
                    </div>
                </div>

                <!-- Solicitud 3 - Media -->
                <div class="solicitud-card" data-prioridad="media" data-id="2003">
                    <div class="solicitud-header">
                        <div class="solicitud-avatar">
                            <i class="bi bi-person"></i>
                        </div>
                        <div class="solicitud-info">
                            <h6 class="solicitud-titulo">Actualizar datos de membresía</h6>
                            <p class="solicitud-usuario"><i class="bi bi-person me-1"></i>Luis Fernández</p>
                        </div>
                    </div>
                    <div class="solicitud-meta">
                        <span class="badge prioridad-media">Media</span>
                        <span class="badge bg-secondary">Membresía</span>
                        <small class="text-muted"><i class="bi bi-clock me-1"></i>Hace 1 hora</small>
                    </div>
                    <p class="solicitud-descripcion">
                        Necesito cambiar mi dirección de correo electrónico asociada a mi cuenta de membresía premium.
                    </p>
                    <div class="solicitud-acciones">
                        <button class="btn-aceptar" onclick="verTicket('2003')">
                            <i class="bi bi-eye me-1"></i>Ver Ticket
                        </button>
                        <button class="btn-rechazar" onclick="abrirModalDerivar('2003')">
                            <i class="bi bi-arrow-left-right me-1"></i>Derivar/Rechazar
                        </button>
                        <button class="btn-ver-detalle" onclick="verDetalleSolicitud('2003')" title="Ver detalles">
                            <i class="bi bi-list-ul"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Estado vacío -->
            <div class="solicitudes-empty d-none" id="solicitudesEmpty">
                <i class="bi bi-inbox"></i>
                <h6 class="fw-bold">No hay solicitudes pendientes</h6>
                <p class="small text-muted">Cuando lleguen nuevas solicitudes de tickets, aparecerán aquí.</p>
            </div>
        </div>
        
        <!-- Footer del offcanvas -->
        <div class="offcanvas-footer p-3 border-top bg-white">
            <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">
                    <span id="solicitudesCount">3</span> solicitudes pendientes
                </small>
                <button class="btn btn-sm btn-outline-primary rounded-pill" onclick="actualizarSolicitudes()">
                    <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Detalle de Solicitud -->
    <div class="modal fade" id="detalleSolicitudModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.05), rgba(0, 156, 180, 0.05));">
                    <h5 class="modal-title fw-bold title-gradient">
                        <i class="bi bi-ticket-detailed me-2"></i>Detalle de Solicitud
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="row">
                        <div class="col-md-8">
                            <h5 class="fw-bold text-brand-blue mb-3" id="detalleSolicitudTitulo">Sistema caído completamente</h5>
                            <div class="mb-3" id="detalleSolicitudDescripcion">
                                <p>El sistema principal no está funcionando desde esta mañana. Ningún usuario puede acceder y estamos perdiendo operaciones importantes.</p>
                                <p>Ya intentamos reiniciar los servidores pero el problema persiste. Necesitamos asistencia urgente.</p>
                            </div>
                            
                            <!-- Archivos adjuntos de la solicitud -->
                            <div class="mb-3" id="detalleSolicitudAdjuntos">
                                <h6 class="text-muted small fw-bold mb-2">Archivos Adjuntos</h6>
                                <div class="d-flex flex-wrap gap-2">
                                    <div class="badge bg-light text-dark border p-2 d-flex align-items-center gap-2">
                                        <i class="bi bi-file-earmark-image text-primary"></i>
                                        <span>error_screenshot.png</span>
                                    </div>
                                    <div class="badge bg-light text-dark border p-2 d-flex align-items-center gap-2">
                                        <i class="bi bi-file-earmark-text text-info"></i>
                                        <span>logs.txt</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-0 bg-light rounded-3 p-3">
                                <h6 class="text-muted small fw-bold mb-3">Información</h6>
                                <div class="mb-2">
                                    <small class="text-muted d-block">Solicitante</small>
                                    <span class="fw-semibold" id="detalleSolicitudUsuario">Roberto Méndez</span>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted d-block">Email</small>
                                    <span class="fw-semibold" id="detalleSolicitudEmail">roberto@email.com</span>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted d-block">Prioridad</small>
                                    <span class="badge prioridad-critica" id="detalleSolicitudPrioridad">Crítica</span>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted d-block">Categoría</small>
                                    <span id="detalleSolicitudCategoria">Soporte Técnico</span>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted d-block">Fecha de solicitud</small>
                                    <span id="detalleSolicitudFecha">12/12/2025, 10:30</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 justify-content-between">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cerrar</button>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn-rechazar px-4" onclick="abrirModalDerivarDesdeDetalle()">
                            <i class="bi bi-arrow-left-right me-1"></i>Derivar/Rechazar
                        </button>
                        <button type="button" class="btn-aceptar px-4" onclick="verTicketDesdeDetalle()">
                            <i class="bi bi-eye me-1"></i>Ver Ticket
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Derivar/Rechazar Solicitud -->
    <div class="modal fade" id="rechazarSolicitudModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.05), rgba(0, 156, 180, 0.05));">
                    <h5 class="modal-title fw-bold text-brand-blue">
                        <i class="bi bi-arrow-left-right me-2"></i>Derivar o Rechazar Ticket
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-4">
                    <p class="text-muted mb-3">Selecciona la acción que deseas realizar con este ticket.</p>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Acción <span class="text-danger">*</span></label>
                        <select class="form-select mb-2" id="accionTicketSelect" onchange="toggleDerivarSection()">
                            <option value="">Seleccionar acción...</option>
                            <option value="derivar">Derivar a otro agente</option>
                            <option value="duplicado">Rechazar - Ticket duplicado</option>
                            <option value="informacion">Rechazar - Información insuficiente</option>
                            <option value="fuera-alcance">Rechazar - Fuera del alcance de soporte</option>
                            <option value="resuelto">Rechazar - Ya fue resuelto</option>
                            <option value="otro">Rechazar - Otro motivo</option>
                        </select>
                    </div>
                    
                    <!-- Sección de Derivar (oculta inicialmente) -->
                    <div id="derivarSection" class="mb-3" style="display: none;">
                        <label class="form-label fw-semibold">Derivar a <span class="text-danger">*</span></label>
                        <select class="form-select mb-2" id="agenteDerivadoSelect">
                            <option value="">Seleccionar agente...</option>
                            <option value="maria">María González - Administrador</option>
                            <option value="carlos">Carlos Ruiz - Supervisor</option>
                            <option value="ana">Ana Martínez - Operador</option>
                            <option value="pedro">Pedro García - Operador</option>
                        </select>
                        <small class="text-muted">El ticket será reasignado al agente seleccionado</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Comentario</label>
                        <textarea class="form-control" id="comentarioRechazo" rows="3" placeholder="Agrega un comentario o instrucciones..."></textarea>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary rounded-pill px-4" onclick="confirmarAccion()" style="background: var(--brand-gradient); border: none;">
                        <i class="bi bi-check-lg me-1"></i>Confirmar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Reportes -->
    <div class="modal fade" id="reportModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.05), rgba(0, 156, 180, 0.05));">
                    <h5 class="modal-title fw-bold title-gradient">
                        <i class="bi bi-file-earmark-bar-graph me-2"></i>Reportes y Estadísticas
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-4">
                    <!-- Filtros de reporte -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <label class="form-label small text-muted">Rango de fechas</label>
                            <select class="form-select" id="reportDateRange">
                                <option value="today">Hoy</option>
                                <option value="week" selected>Última semana</option>
                                <option value="month">Último mes</option>
                                <option value="quarter">Último trimestre</option>
                                <option value="custom">Personalizado</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small text-muted">Categoría</label>
                            <select class="form-select">
                                <option value="">Todas</option>
                                <option value="tech">Soporte Técnico</option>
                                <option value="account">Cuenta y Acceso</option>
                                <option value="payments">Pagos</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small text-muted">Operador</label>
                            <select class="form-select">
                                <option value="">Todos</option>
                                <option value="1">María González</option>
                                <option value="2">Carlos Ruiz</option>
                                <option value="3">Ana Martínez</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button class="btn btn-primary w-100" style="background: var(--brand-gradient); border: none;">
                                <i class="bi bi-funnel me-1"></i> Aplicar Filtros
                            </button>
                        </div>
                    </div>

                    <!-- Resumen de estadísticas -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <div class="p-3 rounded-3 bg-light text-center">
                                <div class="fs-3 fw-bold text-brand-blue">156</div>
                                <div class="small text-muted">Total Tickets</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 rounded-3 bg-light text-center">
                                <div class="fs-3 fw-bold text-success">142</div>
                                <div class="small text-muted">Resueltos</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 rounded-3 bg-light text-center">
                                <div class="fs-3 fw-bold text-warning">2.8h</div>
                                <div class="small text-muted">Tiempo Promedio</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 rounded-3 bg-light text-center">
                                <div class="fs-3 fw-bold text-info">91%</div>
                                <div class="small text-muted">Satisfacción</div>
                            </div>
                        </div>
                    </div>

                    <!-- Gráficos simulados -->
                    <div class="row g-4">
                        <div class="col-md-8">
                            <div class="p-3 rounded-3 border">
                                <h6 class="fw-bold mb-3">Tickets por Día</h6>
                                <div class="d-flex align-items-end justify-content-between" style="height: 150px;">
                                    <div class="text-center flex-fill">
                                        <div class="mx-1 rounded-top" style="height: 80px; background: var(--brand-gradient);"></div>
                                        <small class="text-muted">Lun</small>
                                    </div>
                                    <div class="text-center flex-fill">
                                        <div class="mx-1 rounded-top" style="height: 120px; background: var(--brand-gradient);"></div>
                                        <small class="text-muted">Mar</small>
                                    </div>
                                    <div class="text-center flex-fill">
                                        <div class="mx-1 rounded-top" style="height: 95px; background: var(--brand-gradient);"></div>
                                        <small class="text-muted">Mié</small>
                                    </div>
                                    <div class="text-center flex-fill">
                                        <div class="mx-1 rounded-top" style="height: 140px; background: var(--brand-gradient);"></div>
                                        <small class="text-muted">Jue</small>
                                    </div>
                                    <div class="text-center flex-fill">
                                        <div class="mx-1 rounded-top" style="height: 110px; background: var(--brand-gradient);"></div>
                                        <small class="text-muted">Vie</small>
                                    </div>
                                    <div class="text-center flex-fill">
                                        <div class="mx-1 rounded-top" style="height: 60px; background: rgba(0,156,180,0.5);"></div>
                                        <small class="text-muted">Sáb</small>
                                    </div>
                                    <div class="text-center flex-fill">
                                        <div class="mx-1 rounded-top" style="height: 40px; background: rgba(0,156,180,0.5);"></div>
                                        <small class="text-muted">Dom</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3 rounded-3 border h-100">
                                <h6 class="fw-bold mb-3">Por Categoría</h6>
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between small mb-1">
                                        <span>Soporte Técnico</span>
                                        <span class="fw-bold">45%</span>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar" style="width: 45%; background: #007bff;"></div>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between small mb-1">
                                        <span>Cuenta y Acceso</span>
                                        <span class="fw-bold">25%</span>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar" style="width: 25%; background: #6f42c1;"></div>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between small mb-1">
                                        <span>Pagos</span>
                                        <span class="fw-bold">20%</span>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar" style="width: 20%; background: #28a745;"></div>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between small mb-1">
                                        <span>Otros</span>
                                        <span class="fw-bold">10%</span>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar" style="width: 10%; background: #fd7e14;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-outline-primary rounded-pill px-4">
                        <i class="bi bi-file-earmark-pdf me-1"></i> Exportar PDF
                    </button>
                    <button type="button" class="btn btn-outline-success rounded-pill px-4">
                        <i class="bi bi-file-earmark-excel me-1"></i> Exportar Excel
                    </button>
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Base de Conocimiento -->
    <div class="modal fade" id="knowledgeBaseModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.05), rgba(0, 156, 180, 0.05));">
                    <h5 class="modal-title fw-bold title-gradient">
                        <i class="bi bi-book me-2"></i>Base de Conocimiento
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-4">
                    <!-- Buscador -->
                    <div class="input-group mb-4">
                        <span class="input-group-text bg-white"><i class="bi bi-search text-muted"></i></span>
                        <input type="text" class="form-control" id="kbSearchInput" placeholder="Buscar artículos...">
                    </div>

                    <!-- Categorías -->
                    <div class="row g-4" id="kbCategories">
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm rounded-3 h-100">
                                <div class="card-header bg-transparent d-flex align-items-center gap-2 py-3">
                                    <div class="kb-icon tech" style="width: 35px; height: 35px; font-size: 1rem; margin: 0;">
                                        <i class="bi bi-gear-wide-connected"></i>
                                    </div>
                                    <h6 class="mb-0 fw-bold">Soporte Técnico</h6>
                                </div>
                                <div class="card-body p-0">
                                    <div class="list-group list-group-flush">
                                        <a href="#" class="list-group-item list-group-item-action py-3" onclick="openKBArticle('kb-1')">
                                            <div class="fw-semibold">¿Cómo restablecer mi contraseña?</div>
                                            <small class="text-muted">Pasos para recuperar el acceso a tu cuenta</small>
                                        </a>
                                        <a href="#" class="list-group-item list-group-item-action py-3" onclick="openKBArticle('kb-2')">
                                            <div class="fw-semibold">Problemas con el inicio de sesión</div>
                                            <small class="text-muted">Soluciones comunes para errores de acceso</small>
                                        </a>
                                        <a href="#" class="list-group-item list-group-item-action py-3" onclick="openKBArticle('kb-3')">
                                            <div class="fw-semibold">Error de conexión al servidor</div>
                                            <small class="text-muted">Qué hacer cuando no puedes conectarte</small>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm rounded-3 h-100">
                                <div class="card-header bg-transparent d-flex align-items-center gap-2 py-3">
                                    <div class="kb-icon payments" style="width: 35px; height: 35px; font-size: 1rem; margin: 0;">
                                        <i class="bi bi-credit-card"></i>
                                    </div>
                                    <h6 class="mb-0 fw-bold">Pagos y Facturación</h6>
                                </div>
                                <div class="card-body p-0">
                                    <div class="list-group list-group-flush">
                                        <a href="#" class="list-group-item list-group-item-action py-3" onclick="openKBArticle('kb-4')">
                                            <div class="fw-semibold">Métodos de pago aceptados</div>
                                            <small class="text-muted">Tarjetas, transferencias y otros métodos</small>
                                        </a>
                                        <a href="#" class="list-group-item list-group-item-action py-3" onclick="openKBArticle('kb-5')">
                                            <div class="fw-semibold">¿Cómo solicitar un reembolso?</div>
                                            <small class="text-muted">Proceso y tiempos de devolución</small>
                                        </a>
                                        <a href="#" class="list-group-item list-group-item-action py-3" onclick="openKBArticle('kb-6')">
                                            <div class="fw-semibold">Descargar facturas</div>
                                            <small class="text-muted">Accede a tu historial de facturación</small>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm rounded-3 h-100">
                                <div class="card-header bg-transparent d-flex align-items-center gap-2 py-3">
                                    <div class="kb-icon account" style="width: 35px; height: 35px; font-size: 1rem; margin: 0;">
                                        <i class="bi bi-person-badge"></i>
                                    </div>
                                    <h6 class="mb-0 fw-bold">Cuenta y Acceso</h6>
                                </div>
                                <div class="card-body p-0">
                                    <div class="list-group list-group-flush">
                                        <a href="#" class="list-group-item list-group-item-action py-3" onclick="openKBArticle('kb-7')">
                                            <div class="fw-semibold">Actualizar datos personales</div>
                                            <small class="text-muted">Cómo modificar tu información de perfil</small>
                                        </a>
                                        <a href="#" class="list-group-item list-group-item-action py-3" onclick="openKBArticle('kb-8')">
                                            <div class="fw-semibold">Cambiar mi correo electrónico</div>
                                            <small class="text-muted">Pasos para actualizar tu email</small>
                                        </a>
                                        <a href="#" class="list-group-item list-group-item-action py-3" onclick="openKBArticle('kb-9')">
                                            <div class="fw-semibold">Eliminar mi cuenta</div>
                                            <small class="text-muted">Proceso de baja definitiva</small>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm rounded-3 h-100">
                                <div class="card-header bg-transparent d-flex align-items-center gap-2 py-3">
                                    <div class="kb-icon general" style="width: 35px; height: 35px; font-size: 1rem; margin: 0;">
                                        <i class="bi bi-question-circle"></i>
                                    </div>
                                    <h6 class="mb-0 fw-bold">Preguntas Frecuentes</h6>
                                </div>
                                <div class="card-body p-0">
                                    <div class="list-group list-group-flush">
                                        <a href="#" class="list-group-item list-group-item-action py-3" onclick="openKBArticle('kb-10')">
                                            <div class="fw-semibold">Horarios de atención</div>
                                            <small class="text-muted">Cuándo estamos disponibles para ayudarte</small>
                                        </a>
                                        <a href="#" class="list-group-item list-group-item-action py-3" onclick="openKBArticle('kb-11')">
                                            <div class="fw-semibold">Tiempos de respuesta</div>
                                            <small class="text-muted">Cuánto tardamos en responder tu ticket</small>
                                        </a>
                                        <a href="#" class="list-group-item list-group-item-action py-3" onclick="openKBArticle('kb-12')">
                                            <div class="fw-semibold">Política de privacidad</div>
                                            <small class="text-muted">Cómo protegemos tus datos</small>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-outline-primary rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#newArticleModal">
                        <i class="bi bi-plus-lg me-1"></i> Nuevo Artículo
                    </button>
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Historial de Auditoría -->
    <div class="modal fade" id="auditHistoryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.05), rgba(0, 156, 180, 0.05));">
                    <h5 class="modal-title fw-bold title-gradient">
                        <i class="bi bi-clock-history me-2"></i>Historial del Ticket <span id="auditTicketId">#1001</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="audit-timeline" id="auditTimelineContent">
                        <div class="audit-item action-create">
                            <div class="audit-time">12/12/2025, 10:30</div>
                            <div class="audit-action">Ticket creado</div>
                            <div class="audit-user">por Juan Pérez</div>
                            <div class="audit-details">
                                <strong>Asunto:</strong> Problema con acceso al sistema<br>
                                <strong>Prioridad:</strong> Alta<br>
                                <strong>Categoría:</strong> Soporte Técnico
                            </div>
                        </div>
                        <div class="audit-item action-assign">
                            <div class="audit-time">12/12/2025, 10:35</div>
                            <div class="audit-action">Ticket asignado</div>
                            <div class="audit-user">a María González</div>
                            <div class="audit-details">
                                Asignación automática basada en disponibilidad
                            </div>
                        </div>
                        <div class="audit-item action-update">
                            <div class="audit-time">12/12/2025, 10:45</div>
                            <div class="audit-action">Estado cambiado a "En Proceso"</div>
                            <div class="audit-user">por María González</div>
                        </div>
                        <div class="audit-item action-update">
                            <div class="audit-time">12/12/2025, 11:00</div>
                            <div class="audit-action">Respuesta enviada</div>
                            <div class="audit-user">por María González</div>
                            <div class="audit-details">
                                "Hola Juan, estamos revisando el problema..."
                            </div>
                        </div>
                        <div class="audit-item action-update">
                            <div class="audit-time">12/12/2025, 11:30</div>
                            <div class="audit-action">Archivo adjuntado</div>
                            <div class="audit-user">por Juan Pérez</div>
                            <div class="audit-details">
                                screenshot_error.png (245 KB)
                            </div>
                        </div>
                        <div class="audit-item action-update">
                            <div class="audit-time">12/12/2025, 12:00</div>
                            <div class="audit-action">Prioridad cambiada</div>
                            <div class="audit-user">por María González</div>
                            <div class="audit-details">
                                De "Alta" a "Crítica" - Afecta a múltiples usuarios
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-outline-primary rounded-pill px-4" onclick="exportAuditHistory()">
                        <i class="bi bi-download me-1"></i> Exportar
                    </button>
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Respuestas Predefinidas -->
    <div class="modal fade" id="quickRepliesModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.05), rgba(0, 156, 180, 0.05));">
                    <h5 class="modal-title fw-bold title-gradient">
                        <i class="bi bi-lightning-fill me-2"></i>Respuestas Predefinidas
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-4">
                    <!-- Buscador -->
                    <div class="input-group mb-4">
                        <span class="input-group-text bg-white"><i class="bi bi-search text-muted"></i></span>
                        <input type="text" class="form-control" id="quickReplySearch" placeholder="Buscar respuestas...">
                    </div>

                    <!-- Lista de respuestas -->
                    <div class="list-group" id="quickRepliesList">
                        <div class="list-group-item list-group-item-action p-3" onclick="selectQuickReply('saludo')">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1 fw-bold text-brand-blue">Saludo Inicial</h6>
                                    <p class="mb-1 text-muted small">Hola $nombre, gracias por contactarnos. Mi nombre es $operador y estaré ayudándote con tu solicitud...</p>
                                </div>
                                <span class="badge bg-light text-dark">General</span>
                            </div>
                        </div>
                        <div class="list-group-item list-group-item-action p-3" onclick="selectQuickReply('seguimiento')">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1 fw-bold text-brand-blue">Solicitar Información</h6>
                                    <p class="mb-1 text-muted small">Para poder ayudarte mejor, necesito que me proporciones la siguiente información...</p>
                                </div>
                                <span class="badge bg-light text-dark">Seguimiento</span>
                            </div>
                        </div>
                        <div class="list-group-item list-group-item-action p-3" onclick="selectQuickReply('password')">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1 fw-bold text-brand-blue">Reset de Contraseña</h6>
                                    <p class="mb-1 text-muted small">Hemos enviado un enlace de recuperación a tu correo electrónico. Por favor revisa tu bandeja de entrada...</p>
                                </div>
                                <span class="badge bg-info text-white">Técnico</span>
                            </div>
                        </div>
                        <div class="list-group-item list-group-item-action p-3" onclick="selectQuickReply('escalado')">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1 fw-bold text-brand-blue">Escalado a Soporte</h6>
                                    <p class="mb-1 text-muted small">Tu caso ha sido escalado a nuestro equipo de soporte técnico especializado. Te contactarán en breve...</p>
                                </div>
                                <span class="badge bg-warning text-dark">Escalado</span>
                            </div>
                        </div>
                        <div class="list-group-item list-group-item-action p-3" onclick="selectQuickReply('resuelto')">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1 fw-bold text-brand-blue">Ticket Resuelto</h6>
                                    <p class="mb-1 text-muted small">Me alegra que hayamos podido resolver tu problema. Si tienes alguna otra consulta, no dudes en contactarnos...</p>
                                </div>
                                <span class="badge bg-success text-white">Cierre</span>
                            </div>
                        </div>
                        <div class="list-group-item list-group-item-action p-3" onclick="selectQuickReply('pago')">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1 fw-bold text-brand-blue">Problema de Pago</h6>
                                    <p class="mb-1 text-muted small">Entendemos tu preocupación respecto al pago. Hemos verificado en nuestro sistema y...</p>
                                </div>
                                <span class="badge bg-success text-white">Pagos</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 justify-content-between">
                    <button type="button" class="btn btn-outline-primary rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#newQuickReplyModal">
                        <i class="bi bi-plus-lg me-1"></i> Nueva Respuesta
                    </button>
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Crear Nueva Respuesta Predefinida -->
    <div class="modal fade" id="newQuickReplyModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.05), rgba(0, 156, 180, 0.05));">
                    <h5 class="modal-title fw-bold title-gradient">
                        <i class="bi bi-plus-circle me-2"></i>Nueva Respuesta Predefinida
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label class="form-label fw-semibold text-brand-blue">Título <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="newReplyTitle" placeholder="Ej: Saludo inicial">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold text-brand-blue">Categoría</label>
                        <select class="form-select" id="newReplyCategory">
                            <option value="general">General</option>
                            <option value="tecnico">Técnico</option>
                            <option value="pagos">Pagos</option>
                            <option value="seguimiento">Seguimiento</option>
                            <option value="cierre">Cierre</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold text-brand-blue">Contenido <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="newReplyContent" rows="5" placeholder="Escribe el contenido de la respuesta..."></textarea>
                        <small class="text-muted">Variables disponibles: $nombre, $operador, $ticket_id, $fecha</small>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary rounded-pill px-4" style="background: var(--brand-gradient); border: none;" onclick="saveQuickReply()">
                        <i class="bi bi-check-lg me-1"></i> Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Todas las Notificaciones -->
    <div class="modal fade" id="allNotificationsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.05), rgba(0, 156, 180, 0.05));">
                    <h5 class="modal-title fw-bold title-gradient">
                        <i class="bi bi-bell-fill me-2"></i>Centro de Notificaciones
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-0">
                    <!-- Filtros -->
                    <div class="p-3 border-bottom bg-light">
                        <div class="d-flex flex-wrap gap-2 align-items-center">
                            <span class="fw-semibold text-brand-dark me-2">Filtrar:</span>
                            <button class="btn btn-sm btn-primary rounded-pill active" data-filter="all" onclick="filterAllNotifications('all')">
                                Todas
                            </button>
                            <button class="btn btn-sm btn-outline-secondary rounded-pill" data-filter="unread" onclick="filterAllNotifications('unread')">
                                <i class="bi bi-circle-fill text-danger me-1" style="font-size: 6px; vertical-align: middle;"></i>No leídas
                            </button>
                            <button class="btn btn-sm btn-outline-secondary rounded-pill" data-filter="ticket" onclick="filterAllNotifications('ticket')">
                                <i class="bi bi-ticket-perforated me-1"></i>Tickets
                            </button>
                            <button class="btn btn-sm btn-outline-secondary rounded-pill" data-filter="system" onclick="filterAllNotifications('system')">
                                <i class="bi bi-gear me-1"></i>Sistema
                            </button>
                            <button class="btn btn-sm btn-outline-secondary rounded-pill" data-filter="alert" onclick="filterAllNotifications('alert')">
                                <i class="bi bi-exclamation-triangle me-1"></i>Alertas
                            </button>
                        </div>
                    </div>
                    
                    <!-- Lista de notificaciones -->
                    <div class="all-notifications-list" id="allNotificationsList" style="max-height: 400px; overflow-y: auto;">
                        <!-- Se llena dinámicamente -->
                    </div>
                    
                    <!-- Paginación -->
                    <div class="p-3 border-top d-flex justify-content-between align-items-center">
                        <span class="text-muted small" id="notificationsPagination">Mostrando 1-10 de 25</span>
                        <nav aria-label="Paginación de notificaciones">
                            <ul class="pagination pagination-sm mb-0">
                                <li class="page-item disabled">
                                    <a class="page-link" href="#" onclick="changeNotificationPage(-1)">
                                        <i class="bi bi-chevron-left"></i>
                                    </a>
                                </li>
                                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                <li class="page-item"><a class="page-link" href="#">2</a></li>
                                <li class="page-item"><a class="page-link" href="#">3</a></li>
                                <li class="page-item">
                                    <a class="page-link" href="#" onclick="changeNotificationPage(1)">
                                        <i class="bi bi-chevron-right"></i>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
                <div class="modal-footer border-0 justify-content-between">
                    <button type="button" class="btn btn-outline-danger rounded-pill px-4" onclick="clearAllNotifications()">
                        <i class="bi bi-trash me-1"></i> Limpiar todas
                    </button>
                    <button type="button" class="btn btn-outline-primary rounded-pill px-4" onclick="markAllAsRead()">
                        <i class="bi bi-check-all me-1"></i> Marcar todas como leídas
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nuevo Usuario -->
    <div class="modal fade" id="newUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.05), rgba(0, 156, 180, 0.05));">
                    <h5 class="modal-title fw-bold title-gradient">
                        <i class="bi bi-person-plus-fill me-2"></i>Nuevo Usuario
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="newUserForm">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Nombre completo <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" placeholder="Ej: Juan Pérez" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Nombre de usuario <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">@</span>
                                <input type="text" class="form-control" placeholder="jperez" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" placeholder="juan.perez@clubrecrear.com" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Contraseña temporal <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" placeholder="Mínimo 8 caracteres" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Rol <span class="text-danger">*</span></label>
                            <select class="form-select" required>
                                <option value="">Seleccionar rol...</option>
                                <option value="admin">Administrador</option>
                                <option value="supervisor">Supervisor</option>
                                <option value="operator">Operador</option>
                            </select>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="sendWelcomeEmail" checked>
                            <label class="form-check-label" for="sendWelcomeEmail">
                                Enviar email de bienvenida con credenciales
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary rounded-pill px-4" style="background: var(--brand-gradient); border: none;" onclick="saveNewUser()">
                        <i class="bi bi-check-lg me-1"></i>Crear Usuario
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Editar Usuario -->
    <div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.05), rgba(0, 156, 180, 0.05));">
                    <h5 class="modal-title fw-bold title-gradient">
                        <i class="bi bi-pencil-fill me-2"></i>Editar Usuario
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="editUserForm">
                        <div class="text-center mb-4">
                            <div class="user-avatar mx-auto" style="width: 70px; height: 70px; background: linear-gradient(135deg, #0065B7, #009CB4); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">
                                <i class="bi bi-person-fill"></i>
                            </div>
                            <h6 class="mt-2 fw-semibold" id="editUserName">María González</h6>
                            <small class="text-muted" id="editUserUsername">@mgonzalez</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Nombre completo</label>
                            <input type="text" class="form-control" id="editUserFullName" value="María González">
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Email</label>
                            <input type="email" class="form-control" id="editUserEmail" value="maria.gonzalez@clubrecrear.com">
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Rol</label>
                            <select class="form-select" id="editUserRole">
                                <option value="admin" selected>Administrador</option>
                                <option value="supervisor">Supervisor</option>
                                <option value="operator">Operador</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Estado</label>
                            <select class="form-select" id="editUserStatus">
                                <option value="active" selected>Activo</option>
                                <option value="inactive">Inactivo</option>
                            </select>
                        </div>
                        <div class="border-top pt-3 mt-3">
                            <button type="button" class="btn btn-outline-warning w-100 rounded-pill mb-2" onclick="resetUserPassword()">
                                <i class="bi bi-key-fill me-2"></i>Restablecer contraseña
                            </button>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary rounded-pill px-4" style="background: var(--brand-gradient); border: none;" onclick="saveUserChanges()">
                        <i class="bi bi-check-lg me-1"></i>Guardar Cambios
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ver Actividad Usuario -->
    <div class="modal fade" id="userActivityModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.05), rgba(0, 156, 180, 0.05));">
                    <h5 class="modal-title fw-bold title-gradient">
                        <i class="bi bi-clock-history me-2"></i>Actividad del Usuario
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="d-flex align-items-center mb-4 pb-3 border-bottom">
                        <div class="user-avatar me-3" style="width: 50px; height: 50px; background: linear-gradient(135deg, #0065B7, #009CB4); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem;">
                            <i class="bi bi-person-fill"></i>
                        </div>
                        <div>
                            <h6 class="mb-1 fw-semibold" id="activityUserName">María González</h6>
                            <small class="text-muted" id="activityUserEmail">maria.gonzalez@clubrecrear.com</small>
                        </div>
                    </div>

                    <!-- Filtros de actividad -->
                    <div class="d-flex gap-2 mb-4">
                        <select class="form-select form-select-sm" style="max-width: 200px;">
                            <option value="all">Todas las actividades</option>
                            <option value="login">Inicios de sesión</option>
                            <option value="ticket">Acciones en tickets</option>
                            <option value="config">Cambios de configuración</option>
                        </select>
                        <input type="date" class="form-control form-control-sm" style="max-width: 180px;">
                    </div>

                    <!-- Timeline de actividad -->
                    <div class="activity-timeline" style="max-height: 400px; overflow-y: auto;">
                        <div class="activity-item">
                            <div class="activity-icon bg-success">
                                <i class="bi bi-box-arrow-in-right"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-header">
                                    Inició sesión en el sistema
                                </div>
                                <div class="activity-time">16/12/2025 - 14:35:22</div>
                            </div>
                        </div>

                        <div class="activity-item">
                            <div class="activity-icon bg-primary">
                                <i class="bi bi-ticket-perforated"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-header">
                                    Respondió al ticket <strong>#1001</strong>
                                </div>
                                <div class="activity-time">16/12/2025 - 14:20:15</div>
                            </div>
                        </div>

                        <div class="activity-item">
                            <div class="activity-icon bg-info">
                                <i class="bi bi-arrow-repeat"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-header">
                                    Cambió el estado del ticket <strong>#1002</strong> a <span class="badge bg-warning">En progreso</span>
                                </div>
                                <div class="activity-time">16/12/2025 - 13:45:30</div>
                            </div>
                        </div>

                        <div class="activity-item">
                            <div class="activity-icon bg-warning">
                                <i class="bi bi-person-add"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-header">
                                    Se asignó el ticket <strong>#1005</strong>
                                </div>
                                <div class="activity-time">16/12/2025 - 12:30:00</div>
                            </div>
                        </div>

                        <div class="activity-item">
                            <div class="activity-icon bg-success">
                                <i class="bi bi-box-arrow-in-right"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-header">
                                    Inició sesión en el sistema
                                </div>
                                <div class="activity-time">16/12/2025 - 08:15:00</div>
                            </div>
                        </div>

                        <div class="activity-item">
                            <div class="activity-icon bg-danger">
                                <i class="bi bi-box-arrow-right"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-header">
                                    Cerró sesión
                                </div>
                                <div class="activity-time">15/12/2025 - 18:00:00</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-outline-primary rounded-pill px-4" onclick="exportUserActivity()">
                        <i class="bi bi-download me-2"></i>Exportar actividad
                    </button>
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nuevo Rol -->
    <div class="modal fade" id="newRoleModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header" style="background: linear-gradient(135deg, rgba(0, 101, 183, 0.05), rgba(0, 156, 180, 0.05));">
                    <h5 class="modal-title fw-bold title-gradient">
                        <i class="bi bi-key-fill me-2"></i>Nuevo Rol
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="newRoleForm">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Nombre del rol <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" placeholder="Ej: Gerente de Soporte" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Descripción</label>
                            <textarea class="form-control" rows="2" placeholder="Breve descripción del rol y sus responsabilidades"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold mb-3">Permisos</label>
                            <div class="border rounded-3 p-3">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="permGestionUsuarios">
                                    <label class="form-check-label" for="permGestionUsuarios">
                                        Gestión de usuarios
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="permGestionTickets" checked>
                                    <label class="form-check-label" for="permGestionTickets">
                                        Gestión de tickets
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="permVerAuditoria">
                                    <label class="form-check-label" for="permVerAuditoria">
                                        Ver auditoría
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="permConfigSistema">
                                    <label class="form-check-label" for="permConfigSistema">
                                        Configuración del sistema
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="permReportes" checked>
                                    <label class="form-check-label" for="permReportes">
                                        Generar reportes
                                    </label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary rounded-pill px-4" style="background: var(--brand-gradient); border: none;" onclick="saveNewRole()">
                        <i class="bi bi-check-lg me-1"></i>Crear Rol
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-bottom-nav d-md-none">
        <button class="mobile-nav-item active" type="button" onclick="switchTab('home', this)">
            <i class="bi bi-house-door-fill"></i>
            <span>Home</span>
        </button>
        <button class="mobile-nav-item" type="button" onclick="switchTab('ticket', this)">
            <i class="bi bi-ticket-perforated-fill"></i>
            <span>Tickets</span>
        </button>
        <button class="mobile-nav-item position-relative" type="button" data-bs-toggle="offcanvas" data-bs-target="#solicitudesOffcanvas" aria-controls="solicitudesOffcanvas">
            <i class="bi bi-inbox-fill"></i>
            <span>Solicitudes</span>
            <span class="mobile-nav-badge" id="solicitudesCounterMobile">3</span>
        </button>
        <button class="mobile-nav-item" type="button" onclick="switchTab('admin', this)">
            <i class="bi bi-shield-lock-fill"></i>
            <span>Admin</span>
        </button>
        <button class="mobile-nav-item" type="button" onclick="switchTab('config', this)">
            <i class="bi bi-gear-fill"></i>
            <span>Config</span>
        </button>
        <button class="mobile-nav-item mobile-nav-logout" type="button" data-bs-toggle="modal" data-bs-target="#logoutModal">
            <i class="bi bi-box-arrow-left"></i>
            <span>Salir</span>
        </button>
    </nav>

    <!-- Floating Action Button (Mobile) -->
    <button class="fab d-md-none" id="fabButton">
        <i class="bi bi-plus-lg"></i>
    </button>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/auth.js') }}"></script>
    <script src="{{ url_for('static', filename='js/dashboard-api.js') }}"></script>
    <script src="{{ url_for('static', filename='js/tickets-reales.js') }}"></script>
    <script src="{{ url_for('static', filename='js/ticket-chat.js') }}"></script>
    <script>
        // Variables globales
        let isMobile = window.innerWidth < 768;
        let selectedFiles = [];

        // Detectar cambios de tamaño
        window.addEventListener('resize', function() {
            isMobile = window.innerWidth < 768;
        });

        // Initialize mobile navigation
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Mobile navigation initialized');
        });



        // Función para cambiar de pestaña
        function switchTab(tabName, clickedElement = null) {
            console.log('switchTab llamado con:', tabName);
            const mobileNavItems = document.querySelectorAll('.mobile-nav-item');
            const fab = document.querySelector('.fab');
            
            // Actualizar estado visual de los botones
            mobileNavItems.forEach(nav => nav.classList.remove('active'));
            if (clickedElement) clickedElement.classList.add('active');
            
            // Activar el tab de Bootstrap
            const tabElement = document.querySelector('#' + tabName + '-tab');
            console.log('Buscando tab:', '#' + tabName + '-tab', 'Encontrado:', tabElement);
            if (tabElement) {
                const tab = new bootstrap.Tab(tabElement);
                tab.show();
                console.log('Tab activado:', tabName);
            } else {
                console.error('No se encontró el tab:', tabName);
            }
            
            // Mostrar FAB en Home y Tickets, ocultar en Config
            const fabButton = document.getElementById('fabButton');
            if (isMobile && fabButton) {
                if (tabName === 'home' || tabName === 'ticket') {
                    fabButton.style.display = 'flex';
                } else {
                    fabButton.style.display = 'none';
                }
            }
            
            // Si está en la pestaña de tickets en móvil, asegurar que se muestra la lista
            if (tabName === 'ticket' && isMobile) {
                const ticketsList = document.getElementById('mobileTicketsList');
                const chatContainer = document.getElementById('mobileChatContainer');
                const bottomNav = document.querySelector('.mobile-bottom-nav');
                
                if (ticketsList && chatContainer) {
                    ticketsList.classList.remove('d-none');
                    chatContainer.classList.add('d-none');
                    chatContainer.classList.remove('d-flex');
                }
                if (bottomNav) bottomNav.style.display = 'flex';
            }
            
            // Colapsar/expandir sidebar según la pestaña (Desktop)
            handleSidebarCollapse(tabName);
        }
        
        // ========================================
        // NUEVO LAYOUT DE TICKETS - FUNCIONES
        // ========================================
        
        // Manejar el colapso del sidebar
        function handleSidebarCollapse(tabName) {
            const sidebar = document.querySelector('.sidebar');
            const mainWrapper = document.querySelector('.main-wrapper');
            
            if (!sidebar) return;
            
            if (tabName === 'ticket' && !isMobile) {
                sidebar.classList.add('collapsed');
                if (mainWrapper) {
                    mainWrapper.style.borderRadius = '20px';
                }
            } else {
                sidebar.classList.remove('collapsed');
                if (mainWrapper) {
                    mainWrapper.style.borderRadius = '30px 0 0 30px';
                }
            }
        }
        
        // Cerrar el chat y volver al listado expandido
        function closeTicketChat() {
            const mainContainer = document.querySelector('.tickets-main-container');
            if (mainContainer) {
                mainContainer.classList.remove('ticket-selected');
            }
            
            // Quitar la clase active de todos los tickets
            document.querySelectorAll('.ticket-card').forEach(card => {
                card.classList.remove('active');
            });
        }
        
        // Seleccionar ticket en desktop
        function selectTicketDesktop(ticketId, element) {
            // Remover clase active de todos los ticket cards
            document.querySelectorAll('.ticket-card').forEach(card => {
                card.classList.remove('active');
            });
            
            // Agregar clase active al card seleccionado
            if (element) {
                element.classList.add('active');
            }
            
            // Actualizar también el sidebar mini si existe
            document.querySelectorAll('.ticket-history-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Activar el layout reducido (mostrar chat y detalles)
            const mainContainer = document.querySelector('.tickets-main-container');
            if (mainContainer) {
                mainContainer.classList.add('ticket-selected');
            }
            
            // Aquí se cargaría dinámicamente el contenido del ticket
            console.log('Ticket seleccionado:', ticketId);
            
            // Actualizar el header del chat con la info del ticket
            updateChatHeader(ticketId, element);
            
            // Scroll to top del chat
            const chatMessages = document.getElementById('chatMessagesDesktop');
            if (chatMessages) {
                chatMessages.scrollTop = 0;
            }
        }
        
        // Actualizar header del chat con datos del ticket seleccionado
        function updateChatHeader(ticketId, ticketCard) {
            const chatPanel = document.getElementById('ticketsChatPanel');
            if (!chatPanel) return;
            
            // Obtener datos del ticket card
            const subject = ticketCard?.querySelector('.ticket-card-subject')?.textContent || 'Sin asunto';
            const badges = ticketCard?.querySelector('.ticket-card-badges')?.innerHTML || '';
            
            const header = chatPanel.querySelector('.chat-header');
            if (header) {
                const headerContent = header.querySelector('.flex-grow-1');
                if (headerContent) {
                    headerContent.innerHTML = `
                        <div class="d-flex align-items-center gap-2">
                            <h5 class="mb-0 fw-bold text-brand-blue">#${ticketId}</h5>
                            ${badges}
                        </div>
                        <small class="text-muted d-block text-truncate">${subject}</small>
                    `;
                }
            }
        }
        
        // Enviar mensaje en chat desktop
        function sendChatMessageDesktop() {
            // Llamar a la función enviarMensaje() de ticket-chat.js
            // que guarda el mensaje en la base de datos
            if (typeof enviarMensaje === 'function') {
                enviarMensaje();
            } else {
                console.error('Función enviarMensaje() no está disponible');
            }
        }
        
        // Insertar respuesta rápida en chat desktop
        function insertQuickReplyDesktop(text) {
            const input = document.getElementById('chatMessageInputDesktop');
            if (input) {
                input.value = text;
                input.focus();
            }
            // Cerrar el panel de respuestas rápidas después de seleccionar una
            const panel = document.getElementById('quickRepliesInlineDesktop');
            if (panel && panel.classList.contains('show')) {
                panel.classList.remove('show');
            }
        }
        
        // Variable para almacenar el filtro de estado actual
        let currentStatusFilter = 'all';
        
        // Filtrar tickets por estado
        // Variable para almacenar filtros activos
        let activeStatusFilters = ['pendiente', 'en proceso'];
        
        function filterTicketsByStatus(status, element) {
            // Si se hace clic en "Todos", desactivar todos los demás
            if (status === 'all') {
                activeStatusFilters = [];
                document.querySelectorAll('.quick-filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                if (element) {
                    element.classList.add('active');
                }
            } else {
                // Remover "Todos" si está activo
                document.querySelector('.quick-filter-btn.filter-all')?.classList.remove('active');
                
                // Toggle del filtro seleccionado
                if (activeStatusFilters.includes(status)) {
                    activeStatusFilters = activeStatusFilters.filter(f => f !== status);
                    element?.classList.remove('active');
                } else {
                    activeStatusFilters.push(status);
                    element?.classList.add('active');
                }
                
                // Si no hay filtros activos, activar "Todos"
                if (activeStatusFilters.length === 0) {
                    document.querySelector('.quick-filter-btn.filter-all')?.classList.add('active');
                }
            }
            
            applyAllFilters();
        }
        
        // Función para aplicar todos los filtros
        function applyAllFilters() {
            const ticketCards = document.querySelectorAll('#ticketsScrollContainer .ticket-card');
            const searchInput = document.getElementById('desktopSearchInput');
            const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
            const operatorFilter = document.getElementById('operatorFilter')?.value || '';
            const senderFilter = document.getElementById('senderFilter')?.value || '';
            
            ticketCards.forEach(card => {
                let show = true;
                
                // Filtro de estado
                if (activeStatusFilters.length > 0) {
                    const badges = card.querySelectorAll('.ticket-card-badges .badge');
                    let statusMatch = false;
                    badges.forEach(badge => {
                        const badgeText = badge.textContent.toLowerCase().trim();
                        activeStatusFilters.forEach(filter => {
                            if (badgeText.includes(filter.toLowerCase())) {
                                statusMatch = true;
                            }
                        });
                    });
                    if (!statusMatch) show = false;
                }
                
                // Filtro de búsqueda
                if (show && searchTerm) {
                    const id = card.querySelector('.ticket-card-id')?.textContent.toLowerCase() || '';
                    const subject = card.querySelector('.ticket-card-subject')?.textContent.toLowerCase() || '';
                    const preview = card.querySelector('.ticket-card-preview')?.textContent.toLowerCase() || '';
                    const user = card.querySelector('.ticket-card-user-name')?.textContent.toLowerCase() || '';
                    
                    const searchMatch = id.includes(searchTerm) || subject.includes(searchTerm) || 
                                      preview.includes(searchTerm) || user.includes(searchTerm);
                    if (!searchMatch) show = false;
                }
                
                // Filtro de operador (placeholder - en producción compararía con data attribute)
                if (show && operatorFilter) {
                    // Aquí se implementaría la lógica real según los datos del ticket
                    // Por ahora solo es un placeholder
                }
                
                // Filtro de remitente
                if (show && senderFilter) {
                    const userName = card.querySelector('.ticket-card-user-name')?.textContent.toLowerCase() || '';
                    if (!userName.includes(senderFilter.toLowerCase())) {
                        show = false;
                    }
                }
                
                card.style.display = show ? '' : 'none';
            });
        }
        
        // Función para aplicar filtros avanzados
        function applyAdvancedFilters() {
            applyAllFilters();
        }
        
        // Búsqueda de tickets desktop
        function setupDesktopTicketSearch() {
            const searchInput = document.getElementById('desktopSearchInput');
            if (!searchInput) return;
            
            searchInput.addEventListener('input', function(e) {
                applyAllFilters();
            });
        }
        
        // Filtrar tickets móviles
        function filterMobileTickets(status) {
            // Actualizar botones activos en móvil
            const mobileFilters = document.querySelectorAll('#ticket .d-md-none .btn-sm');
            mobileFilters.forEach(btn => {
                btn.classList.remove('active', 'btn-primary');
                btn.classList.add('btn-outline-warning', 'btn-outline-info', 'btn-outline-success', 'btn-outline-danger');
            });
            
            event.target.classList.add('active');
            if (status === 'all') {
                event.target.classList.remove('btn-outline-primary');
                event.target.classList.add('btn-primary');
            }
            
            // Aplicar filtro a tickets móviles
            const mobileTickets = document.querySelectorAll('#mobileTicketsList .tickets-list-item');
            
            mobileTickets.forEach(ticket => {
                const ticketStatus = ticket.getAttribute('data-status');
                
                if (status === 'all') {
                    ticket.style.display = '';
                } else if (status === 'sin-respuesta') {
                    if (ticketStatus === 'sin-respuesta') {
                        ticket.style.display = '';
                    } else {
                        ticket.style.display = 'none';
                    }
                } else {
                    if (ticketStatus === status) {
                        ticket.style.display = '';
                    } else {
                        ticket.style.display = 'none';
                    }
                }
            });
        }
        
        // Escape HTML para prevenir XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Sincronizar tabs móviles con tabs de escritorio
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar búsqueda de tickets desktop
            setupDesktopTicketSearch();
            
            // Aplicar filtros predeterminados (Pendiente y En Proceso)
            applyAllFilters();
            
            // Verificar sidebar colapsado al cargar según tab activo
            const activeTab = document.querySelector('.nav-link.active');
            if (activeTab) {
                const tabTarget = activeTab.getAttribute('data-bs-target');
                if (tabTarget === '#ticket') {
                    handleSidebarCollapse('ticket');
                }
            }
            
            // Estado inicial: móvil muestra lista, desktop usa el nuevo layout
            const initialIsMobile = window.innerWidth < 768;
            const ticketsList = document.getElementById('mobileTicketsList');
            const chatContainer = document.getElementById('mobileChatContainer');
            const bottomNav = document.querySelector('.mobile-bottom-nav');

            // En desktop, el mobileChatContainer siempre debe estar oculto
            // El nuevo layout de tickets usa tickets-main-container
            if (!initialIsMobile) {
                if (chatContainer) {
                    chatContainer.classList.add('d-none');
                    chatContainer.classList.remove('d-flex');
                }
                if (ticketsList) ticketsList.classList.add('d-none');
                if (bottomNav) bottomNav.style.display = 'none';
            } else {
                if (chatContainer) {
                    chatContainer.classList.add('d-none');
                    chatContainer.classList.remove('d-flex');
                }
                if (ticketsList) ticketsList.classList.remove('d-none');
            }

            // Configurar event listeners para los botones de navegación móvil
            const mobileNavButtons = document.querySelectorAll('.mobile-nav-item');
            mobileNavButtons.forEach((button, index) => {
                // El botón índice 2 es Solicitudes (offcanvas), no necesita handler especial aquí
                // ya que usa data-bs-toggle="offcanvas"
                if (index === 2) return; // Solicitudes - manejado por Bootstrap
                
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Mapeo: 0=home, 1=ticket, 2=solicitudes(skip), 3=admin, 4=config
                    const tabs = ['home', 'ticket', null, 'admin', 'config'];
                    const tabName = tabs[index];
                    
                    if (!tabName) return; // Si es null, no hacer nada
                    
                    // Actualizar estado visual (excepto el botón de solicitudes)
                    mobileNavButtons.forEach((btn, i) => {
                        if (i !== 2) btn.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // Activar el tab de Bootstrap
                    const tabElement = document.querySelector('#' + tabName + '-tab');
                    if (tabElement) {
                        const tab = new bootstrap.Tab(tabElement);
                        tab.show();
                    }
                    
                    // Mostrar FAB en Home y Tickets, ocultar en Config
                    const fabButton = document.getElementById('fabButton');
                    if (fabButton) {
                        if (tabName === 'home' || tabName === 'ticket') {
                            fabButton.style.display = 'flex';
                        } else {
                            fabButton.style.display = 'none';
                        }
                    }
                    
                    // Si está en la pestaña de tickets en móvil, asegurar que se muestra la lista
                    if (tabName === 'ticket' && window.innerWidth < 768) {
                        const ticketsList = document.getElementById('mobileTicketsList');
                        const chatContainer = document.getElementById('mobileChatContainer');
                        const bottomNav = document.querySelector('.mobile-bottom-nav');
                        
                        if (ticketsList && chatContainer) {
                            ticketsList.classList.remove('d-none');
                            chatContainer.classList.add('d-none');
                            chatContainer.classList.remove('d-flex');
                        }
                        if (bottomNav) bottomNav.style.display = 'flex';
                    }
                }, { passive: false });
            });
            
            // Sincronizar cuando se cambia de tab desde desktop
            const tabElements = document.querySelectorAll('button[data-bs-toggle="tab"]');
            tabElements.forEach(tab => {
                tab.addEventListener('shown.bs.tab', function (event) {
                    const target = event.target.getAttribute('data-bs-target');
                    const mobileNavItems = document.querySelectorAll('.mobile-nav-item');
                    // Mapeo: 0=home, 1=ticket, 2=solicitudes(skip), 3=config
                    const navTargets = { '#home': 0, '#ticket': 1, '#config': 3 };
                    
                    if (navTargets[target] !== undefined) {
                        mobileNavItems.forEach((nav, i) => {
                            if (i !== 2) nav.classList.remove('active'); // No tocar solicitudes
                        });
                        if (mobileNavItems[navTargets[target]]) {
                            mobileNavItems[navTargets[target]].classList.add('active');
                        }
                    }
                    
                    // Colapsar/expandir sidebar según la pestaña
                    const tabName = target.replace('#', '');
                    handleSidebarCollapse(tabName);
                });
            });

            // Botón FAB para nuevo ticket
            const fabButton = document.getElementById('fabButton');
            if (fabButton) {
                fabButton.addEventListener('click', function() {
                    const newTicketModal = new bootstrap.Modal(document.getElementById('newTicketModal'));
                    newTicketModal.show();
                });
            }

            // Preview de archivos adjuntos con DataTransfer para poder eliminar
            const ticketAttachments = document.getElementById('ticketAttachments');
            if (ticketAttachments) {
                ticketAttachments.addEventListener('change', function(e) {
                    const files = Array.from(e.target.files);
                    selectedFiles = files;
                    updateAttachmentPreview();
                });
            }

            function updateAttachmentPreview() {
                const preview = document.getElementById('attachmentPreview');
                const list = document.getElementById('attachmentList');
                
                if (selectedFiles.length > 0) {
                    preview.style.display = 'block';
                    list.innerHTML = '';
                    
                    selectedFiles.forEach((file, index) => {
                        const fileSize = (file.size / 1024 / 1024).toFixed(2);
                        const fileIcon = getFileIcon(file.type);
                        
                        const container = document.createElement('div');
                        container.className = 'position-relative';
                        container.style.display = 'inline-block';
                        
                        const badge = document.createElement('div');
                        badge.className = 'badge bg-light text-dark border d-flex align-items-center gap-2 py-2 px-3 pe-4';
                        badge.innerHTML = `
                            <i class="bi ${fileIcon} text-primary"></i>
                            <div class="d-flex flex-column align-items-start">
                                <span class="text-truncate" style="max-width: 180px; font-weight: 500;">${file.name}</span>
                                <small class="text-muted" style="font-size: 0.7rem;">${fileSize} MB</small>
                            </div>
                        `;
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.type = 'button';
                        deleteBtn.className = 'btn btn-sm p-0 position-absolute';
                        deleteBtn.style.cssText = 'right: 4px; top: 4px; width: 20px; height: 20px; border-radius: 50%; background: #dc3545; border: 2px solid white; color: white; display: flex; align-items: center; justify-content: center; line-height: 1; font-size: 12px;';
                        deleteBtn.innerHTML = '<i class="bi bi-x"></i>';
                        deleteBtn.title = 'Eliminar archivo';
                        deleteBtn.onclick = function() { removeAttachment(index); };
                        
                        container.appendChild(badge);
                        container.appendChild(deleteBtn);
                        list.appendChild(container);
                    });
                } else {
                    preview.style.display = 'none';
                }
            }

            function removeAttachment(index) {
                selectedFiles.splice(index, 1);
                
                // Actualizar el input file con los archivos restantes
                const dataTransfer = new DataTransfer();
                selectedFiles.forEach(file => {
                    dataTransfer.items.add(file);
                });
                document.getElementById('ticketAttachments').files = dataTransfer.files;
                
                updateAttachmentPreview();
            }
        });

        // Función auxiliar para obtener el icono según el tipo de archivo
        function getFileIcon(fileType) {
            if (fileType.startsWith('image/')) return 'bi-file-earmark-image';
            if (fileType.includes('pdf')) return 'bi-file-earmark-pdf';
            if (fileType.includes('word')) return 'bi-file-earmark-word';
            if (fileType.includes('excel') || fileType.includes('spreadsheet')) return 'bi-file-earmark-excel';
            if (fileType.includes('zip') || fileType.includes('rar')) return 'bi-file-earmark-zip';
            return 'bi-file-earmark';
        }

        // Función para crear el ticket
        // La función createTicket está en ticket-chat.js
        // No duplicar aquí

        // Mostrar modal de filtros
        function showFiltersModal() {
            const filtersModal = new bootstrap.Modal(document.getElementById('filtersModal'));
            filtersModal.show();
        }

        // Aplicar filtros
        function applyFilters() {
            console.log('Aplicando filtros...');
            const filtersModal = bootstrap.Modal.getInstance(document.getElementById('filtersModal'));
            if (filtersModal) filtersModal.hide();
        }

        // Limpiar filtros
        function resetFilters() {
            document.querySelectorAll('.btn-check').forEach(check => {
                if (check.id !== 'filter-all') {
                    check.checked = false;
                }
            });
            const filterAll = document.getElementById('filter-all');
            if (filterAll) filterAll.checked = true;

            document.querySelectorAll('input[type="date"]').forEach(input => {
                input.value = '';
            });

            document.querySelectorAll('select').forEach(select => {
                select.selectedIndex = 0;
            });

            console.log('Filtros limpiados');
        }

        // Abrir chat individual en móvil
        function openMobileChat(ticketId) {
            if (!isMobile) return;
            
            const ticketsList = document.getElementById('mobileTicketsList');
            const chatContainer = document.getElementById('mobileChatContainer');
            const bottomNav = document.querySelector('.mobile-bottom-nav');
            const fab = document.querySelector('.fab');
            
            // Ocultar lista y mostrar chat
            ticketsList.classList.add('d-none');
            chatContainer.classList.remove('d-none');
            chatContainer.classList.add('d-flex');
            
            // Ocultar bottom nav y FAB cuando está en chat
            const fabButton = document.getElementById('fabButton');
            if (bottomNav) bottomNav.style.display = 'none';
            if (fabButton) fabButton.style.display = 'none';
            
            // Aquí se cargaría dinámicamente el contenido del ticket
            console.log('Abriendo chat móvil ticket:', ticketId);
        }

        // Cerrar chat y volver a lista en móvil
        function closeMobileChat() {
            const mobileNow = window.innerWidth < 768;
            if (!mobileNow) return;

            const ticketsList = document.getElementById('mobileTicketsList');
            const chatContainer = document.getElementById('mobileChatContainer');
            const bottomNav = document.querySelector('.mobile-bottom-nav');

            if (ticketsList) ticketsList.classList.remove('d-none');
            if (chatContainer) {
                chatContainer.classList.add('d-none');
                chatContainer.classList.remove('d-flex');
            }

            if (bottomNav) bottomNav.style.display = '';

            const fabButton = document.getElementById('fabButton');
            const activePane = document.querySelector('.tab-pane.show.active');
            const activeId = activePane ? activePane.id : null;
            if (fabButton) {
                fabButton.style.display = (activeId === 'home' || activeId === 'ticket') ? 'flex' : 'none';
            }
        }

        // ===== FUNCIONES DE ACCIONES DE TICKETS =====
        
        // Toggle dropdown de acciones
        function toggleActionDropdown(dropdownId, event) {
            event.stopPropagation();
            const dropdown = document.getElementById(dropdownId);
            const allDropdowns = document.querySelectorAll('.ticket-action-dropdown');
            
            // Cerrar todos los demás dropdowns
            allDropdowns.forEach(dd => {
                if (dd.id !== dropdownId) {
                    dd.classList.remove('show');
                }
            });
            
            // Toggle el dropdown actual
            dropdown.classList.toggle('show');
        }

        // Cerrar dropdowns al hacer click fuera
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.ticket-action-btn')) {
                const allDropdowns = document.querySelectorAll('.ticket-action-dropdown');
                allDropdowns.forEach(dd => dd.classList.remove('show'));
            }
        });

        // Cambiar estado del ticket
        function changeTicketStatus(status) {
            console.log('Cambiando estado a:', status);
            // Cerrar dropdown
            const allDropdowns = document.querySelectorAll('.ticket-action-dropdown');
            allDropdowns.forEach(dd => dd.classList.remove('show'));
            
            // Aquí irá la lógica para actualizar el estado en el backend
            // Por ahora solo mostramos un toast
            showToast(`Estado cambiado a: ${status}`, 'success');
        }

        // Cambiar prioridad del ticket
        function changeTicketPriority(priority) {
            console.log('Cambiando prioridad a:', priority);
            const allDropdowns = document.querySelectorAll('.ticket-action-dropdown');
            allDropdowns.forEach(dd => dd.classList.remove('show'));
            
            showToast(`Prioridad cambiada a: ${priority}`, 'success');
        }

        // Asignar ticket a agente
        function assignTicket(agentId) {
            console.log('Asignando ticket a:', agentId);
            const allDropdowns = document.querySelectorAll('.ticket-action-dropdown');
            allDropdowns.forEach(dd => dd.classList.remove('show'));
            
            const agentName = agentId === 'me' ? 'ti mismo' : 'otro agente';
            showToast(`Ticket asignado a ${agentName}`, 'success');
        }

        // Abrir modal de etiquetas
        function openTagModal() {
            console.log('Abriendo modal de etiquetas');
            showToast('Funcionalidad de etiquetas próximamente', 'info');
        }

        // Toggle nota interna
        function toggleInternalNote() {
            console.log('Toggle nota interna');
            showToast('Agregando nota interna...', 'info');
        }

        // Fusionar tickets
        function mergeTickets() {
            console.log('Fusionar tickets');
            const allDropdowns = document.querySelectorAll('.ticket-action-dropdown');
            allDropdowns.forEach(dd => dd.classList.remove('show'));
            showToast('Funcionalidad de fusión próximamente', 'info');
        }

        // Exportar ticket
        function exportTicket() {
            console.log('Exportar ticket');
            const allDropdowns = document.querySelectorAll('.ticket-action-dropdown');
            allDropdowns.forEach(dd => dd.classList.remove('show'));
            showToast('Exportando conversación...', 'info');
        }

        // Imprimir ticket
        function printTicket() {
            console.log('Imprimir ticket');
            const allDropdowns = document.querySelectorAll('.ticket-action-dropdown');
            allDropdowns.forEach(dd => dd.classList.remove('show'));
            window.print();
        }

        // Eliminar ticket
        function deleteTicket() {
            const allDropdowns = document.querySelectorAll('.ticket-action-dropdown');
            allDropdowns.forEach(dd => dd.classList.remove('show'));
            
            if (confirm('¿Estás seguro de que deseas eliminar este ticket? Esta acción no se puede deshacer.')) {
                console.log('Eliminando ticket');
                showToast('Ticket eliminado', 'warning');
            }
        }

        // Función helper para mostrar toast
        function showToast(message, type = 'info') {
            // Crear toast container si no existe
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
                document.body.appendChild(toastContainer);
            }
            
            // Crear toast
            const toast = document.createElement('div');
            toast.className = `alert alert-${type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info'} alert-dismissible fade show`;
            toast.style.cssText = 'min-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
            toast.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            toastContainer.appendChild(toast);
            
            // Auto-remover después de 3 segundos
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Abrir ticket desde el sidebar
        function openTicketFromSidebar(ticketId, element = null) {
            // Activar la pestaña de tickets
            const ticketTab = document.getElementById('ticket-tab');
            if (ticketTab) {
                const tab = new bootstrap.Tab(ticketTab);
                tab.show();
            }

            // Remover clase active de todos los items del historial
            document.querySelectorAll('.ticket-history-item').forEach(item => {
                item.classList.remove('active');
            });

            // Agregar clase active al item clickeado
            if (element) {
                element.classList.add('active');
            }

            // En móvil, abrir el chat
            if (isMobile) {
                openMobileChat(ticketId);
            } else {
                const chatContainer = document.getElementById('mobileChatContainer');
                if (chatContainer) {
                    chatContainer.classList.remove('d-none');
                    chatContainer.classList.add('d-flex');
                }
            }

            console.log('Abriendo ticket desde sidebar:', ticketId);

            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                chatMessages.scrollTop = 0;
            }
        }

        // Búsqueda de tickets en tiempo real
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchTicketInput');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase().trim();
                    const searchResults = document.getElementById('searchResults');
                    
                    if (searchTerm === '') {
                        searchResults.innerHTML = `
                            <div class="text-center py-5 text-muted">
                                <i class="bi bi-search display-4 d-block mb-3 opacity-25"></i>
                                <p>Comienza a escribir para buscar tickets...</p>
                            </div>
                        `;
                        return;
                    }

                    // Simular búsqueda (aquí se haría una llamada AJAX al backend)
                    const allTickets = [
                        { id: '1001', subject: 'Problema con acceso', user: 'Juan Pérez', status: 'Pendiente', date: '11/12/2025' },
                        { id: '1002', subject: 'Ayuda con cuenta', user: 'Ana García', status: 'Abierto', date: '10/12/2025' },
                        { id: '1003', subject: 'Error en pagos', user: 'Carlos López', status: 'Cerrado', date: '09/12/2025' },
                        { id: '1004', subject: 'Consulta membresía', user: 'María Rodríguez', status: 'Pendiente', date: '08/12/2025' },
                        { id: '1005', subject: 'Reset password', user: 'Pedro Martínez', status: 'Abierto', date: '07/12/2025' },
                        { id: '1006', subject: 'Actualizar datos', user: 'Laura Sánchez', status: 'Pendiente', date: '06/12/2025' }
                    ];

                    const filteredTickets = allTickets.filter(ticket => 
                        ticket.id.toLowerCase().includes(searchTerm) ||
                        ticket.subject.toLowerCase().includes(searchTerm) ||
                        ticket.user.toLowerCase().includes(searchTerm) ||
                        ticket.status.toLowerCase().includes(searchTerm)
                    );

                    if (filteredTickets.length === 0) {
                        searchResults.innerHTML = `
                            <div class="text-center py-5 text-muted">
                                <i class="bi bi-inbox display-4 d-block mb-3 opacity-25"></i>
                                <p>No se encontraron tickets con "${searchTerm}"</p>
                            </div>
                        `;
                        return;
                    }

                    let resultsHTML = '<div class="list-group list-group-flush">';
                    filteredTickets.forEach(ticket => {
                        const statusBadge = ticket.status === 'Pendiente' ? 'bg-warning text-dark' : 
                                          ticket.status === 'Abierto' ? 'bg-primary' : 'bg-success';
                        
                        resultsHTML += `
                            <a href="#" class="list-group-item list-group-item-action" onclick="openTicketFromSearch('${ticket.id}'); return false;">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1 fw-bold text-brand-blue">#${ticket.id}</h6>
                                        <p class="mb-1">${ticket.subject}</p>
                                        <small class="text-muted">
                                            <i class="bi bi-person me-1"></i>${ticket.user}
                                            <i class="bi bi-calendar ms-2 me-1"></i>${ticket.date}
                                        </small>
                                    </div>
                                    <span class="badge ${statusBadge} ms-2">${ticket.status}</span>
                                </div>
                            </a>
                        `;
                    });
                    resultsHTML += '</div>';
                    
                    searchResults.innerHTML = resultsHTML;
                });
            }
        });

        // Abrir ticket desde búsqueda
        function openTicketFromSearch(ticketId) {
            // Cerrar el modal de búsqueda
            const searchModal = bootstrap.Modal.getInstance(document.getElementById('searchTicketsModal'));
            if (searchModal) {
                searchModal.hide();
            }

            // Abrir el ticket
            openTicketFromSidebar(ticketId);
            
            // Actualizar el estado active en el sidebar
            document.querySelectorAll('.ticket-history-item').forEach(item => {
                item.classList.remove('active');
                if (item.onclick && item.onclick.toString().includes(ticketId)) {
                    item.classList.add('active');
                }
            });
        }

        // Búsqueda en tiempo real para móvil
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar datos del usuario actual
            cargarDatosUsuario();
            
            const mobileSearchInput = document.getElementById('mobileSearchInput');
            if (mobileSearchInput) {
                mobileSearchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase().trim();
                    const ticketItems = document.querySelectorAll('#mobileTicketsList .tickets-list-item');
                    
                    ticketItems.forEach(item => {
                        const ticketTitle = item.querySelector('.ticket-title')?.textContent.toLowerCase() || '';
                        const ticketPreview = item.querySelector('.ticket-preview')?.textContent.toLowerCase() || '';
                        
                        if (ticketTitle.includes(searchTerm) || ticketPreview.includes(searchTerm)) {
                            item.style.display = '';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                });
            }
        });

        // ========================================
        // CARGAR DATOS DEL USUARIO
        // ========================================
        
        async function cargarDatosUsuario() {
            try {
                // Obtener usuario desde localStorage (guardado en login)
                const currentUser = AuthService.getCurrentUser();
                
                if (currentUser) {
                    // Actualizar nombre en configuración
                    const profileName = document.getElementById('userProfileName');
                    const profileRole = document.getElementById('userProfileRole');
                    
                    if (profileName) {
                        profileName.textContent = currentUser.nombre || 'Usuario';
                    }
                    
                    if (profileRole) {
                        const roleMap = {
                            'Admin': 'Administrador',
                            'Supervisor': 'Supervisor',
                            'Agente': 'Operador de Soporte'
                        };
                        profileRole.textContent = roleMap[currentUser.rol] || currentUser.rol || 'Operador';
                    }
                    
                    console.log('✅ Datos de usuario cargados:', currentUser.nombre);
                } else {
                    console.warn('⚠️ No se encontraron datos de usuario');
                }
            } catch (error) {
                console.error('❌ Error al cargar datos del usuario:', error);
            }
        }

        // ========================================
        // GESTIÓN DE SOLICITUDES PENDIENTES
        // ========================================
        
        let solicitudActual = null; // Almacena el ID de la solicitud actual para modales

        // Datos de solicitudes (se cargan desde la API)
        const solicitudesData = {};

        // TODO: Implementar carga de solicitudes desde API
        // function cargarSolicitudesDesdeAPI() { ... }

        // Filtrar solicitudes por prioridad
        function filterSolicitudes(prioridad) {
            const cards = document.querySelectorAll('.solicitud-card');
            const buttons = document.querySelectorAll('#solicitudesOffcanvas .btn-sm');
            
            // Actualizar botones activos
            buttons.forEach(btn => btn.classList.remove('active', 'btn-primary'));
            event.target.classList.add('active', 'btn-primary');
            
            cards.forEach(card => {
                if (prioridad === 'todas' || card.dataset.prioridad === prioridad) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Ver ticket (todos los tickets ya están aprobados automáticamente)
        function verTicket(solicitudId) {
            // Aquí se haría la navegación al ticket específico
            console.log('Viendo ticket:', solicitudId);
            
            // Cerrar offcanvas de solicitudes
            const offcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('solicitudesOffcanvas'));
            if (offcanvas) offcanvas.hide();
            
            // Cambiar a la pestaña de tickets
            const ticketTab = document.querySelector('[data-bs-target="#ticket"]');
            if (ticketTab) {
                ticketTab.click();
            }
            
            // Mostrar toast
            mostrarToast('info', 'Navegando al ticket', `Mostrando detalles del ticket #${solicitudId}`);
        }

        // Abrir modal de derivar/rechazar
        function abrirModalDerivar(solicitudId) {
            solicitudActual = solicitudId;
            // Limpiar formulario
            document.getElementById('accionTicketSelect').value = '';
            document.getElementById('agenteDerivadoSelect').value = '';
            document.getElementById('comentarioRechazo').value = '';
            document.getElementById('derivarSection').style.display = 'none';
            
            const modal = new bootstrap.Modal(document.getElementById('rechazarSolicitudModal'));
            modal.show();
        }

        // Toggle sección de derivar
        function toggleDerivarSection() {
            const accion = document.getElementById('accionTicketSelect').value;
            const derivarSection = document.getElementById('derivarSection');
            
            if (accion === 'derivar') {
                derivarSection.style.display = 'block';
            } else {
                derivarSection.style.display = 'none';
            }
        }

        // Confirmar acción (derivar o rechazar)
        function confirmarAccion() {
            const accion = document.getElementById('accionTicketSelect').value;
            const comentario = document.getElementById('comentarioRechazo').value;
            
            if (!accion) {
                alert('Por favor selecciona una acción.');
                return;
            }
            
            let mensaje = '';
            let tipoMensaje = 'info';
            
            if (accion === 'derivar') {
                const agente = document.getElementById('agenteDerivadoSelect').value;
                if (!agente) {
                    alert('Por favor selecciona un agente para derivar.');
                    return;
                }
                
                // Aquí se haría la llamada AJAX para derivar
                console.log('Derivando ticket:', solicitudActual, { agente, comentario });
                mensaje = 'Ticket derivado correctamente al agente seleccionado.';
                tipoMensaje = 'success';
            } else {
                // Es un rechazo
                console.log('Rechazando ticket:', solicitudActual, { motivo: accion, comentario });
                mensaje = 'Ticket rechazado. Se ha notificado al usuario.';
                tipoMensaje = 'info';
            }
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('rechazarSolicitudModal'));
            modal.hide();
            
            // Remover la card con animación
            const card = document.querySelector(`.solicitud-card[data-id="${solicitudActual}"]`);
            if (card) {
                card.style.transition = 'all 0.3s ease';
                card.style.opacity = '0';
                card.style.transform = 'translateX(-100%)';
                
                setTimeout(() => {
                    card.remove();
                    actualizarContadorSolicitudes();
                    solicitudActual = null;
                    
                    mostrarToast(tipoMensaje, accion === 'derivar' ? 'Ticket derivado' : 'Ticket rechazado', mensaje);
                }, 300);
            }
            
            // Cerrar modal de detalle si está abierto
            const detalleModal = bootstrap.Modal.getInstance(document.getElementById('detalleSolicitudModal'));
            if (detalleModal) detalleModal.hide();
        }

        // Ver detalle de solicitud
        function verDetalleSolicitud(solicitudId) {
            solicitudActual = solicitudId;
            const data = solicitudesData[solicitudId];
            
            if (!data) {
                console.error('Solicitud no encontrada:', solicitudId);
                return;
            }
            
            // Llenar modal con datos
            document.getElementById('detalleSolicitudTitulo').textContent = data.titulo;
            document.getElementById('detalleSolicitudDescripcion').innerHTML = data.descripcion.replace(/\n/g, '<br>');
            document.getElementById('detalleSolicitudUsuario').textContent = data.usuario;
            document.getElementById('detalleSolicitudEmail').textContent = data.email;
            document.getElementById('detalleSolicitudCategoria').textContent = data.categoria;
            document.getElementById('detalleSolicitudFecha').textContent = data.fecha;
            
            // Prioridad con badge
            const prioridadBadge = document.getElementById('detalleSolicitudPrioridad');
            prioridadBadge.textContent = data.prioridad.charAt(0).toUpperCase() + data.prioridad.slice(1);
            prioridadBadge.className = 'badge prioridad-' + data.prioridad;
            
            // Adjuntos
            const adjuntosContainer = document.getElementById('detalleSolicitudAdjuntos');
            if (data.adjuntos && data.adjuntos.length > 0) {
                adjuntosContainer.style.display = '';
                const adjuntosHTML = data.adjuntos.map(adj => {
                    const icon = getFileIconByName(adj);
                    return `<div class="badge bg-light text-dark border p-2 d-flex align-items-center gap-2">
                        <i class="bi ${icon} text-primary"></i>
                        <span>${adj}</span>
                    </div>`;
                }).join('');
                adjuntosContainer.querySelector('.d-flex').innerHTML = adjuntosHTML;
            } else {
                adjuntosContainer.style.display = 'none';
            }
            
            // Mostrar modal
            const detalleModal = new bootstrap.Modal(document.getElementById('detalleSolicitudModal'));
            detalleModal.show();
        }

        // Funciones para acciones desde el modal de detalle
        function verTicketDesdeDetalle() {
            if (solicitudActual) {
                verTicket(solicitudActual);
            }
        }

        function abrirModalDerivarDesdeDetalle() {
            // Cerrar modal de detalle primero
            const detalleModal = bootstrap.Modal.getInstance(document.getElementById('detalleSolicitudModal'));
            if (detalleModal) detalleModal.hide();
            
            // Abrir modal de derivar/rechazar
            setTimeout(() => {
                abrirModalDerivar(solicitudActual);
            }, 300);
        }

        // Actualizar contador de solicitudes
        function actualizarContadorSolicitudes() {
            const cards = document.querySelectorAll('.solicitud-card');
            const count = cards.length;
            
            // Actualizar todos los contadores
            document.getElementById('solicitudesCounterDesktop').textContent = count;
            document.getElementById('solicitudesCounterMobile').textContent = count;
            document.getElementById('solicitudesCount').textContent = count;
            
            // Mostrar/ocultar badges si es 0
            const desktopBadge = document.getElementById('solicitudesCounterDesktop');
            const mobileBadge = document.getElementById('solicitudesCounterMobile');
            
            if (count === 0) {
                desktopBadge.style.display = 'none';
                mobileBadge.style.display = 'none';
                document.getElementById('solicitudesEmpty').classList.remove('d-none');
                document.getElementById('solicitudesList').style.display = 'none';
            } else {
                desktopBadge.style.display = '';
                mobileBadge.style.display = '';
                document.getElementById('solicitudesEmpty').classList.add('d-none');
                document.getElementById('solicitudesList').style.display = '';
            }
        }

        // Actualizar lista de solicitudes (simular refresh)
        function actualizarSolicitudes() {
            const btn = event.target.closest('button');
            const icon = btn.querySelector('i');
            
            // Animar icono
            icon.classList.add('spin-animation');
            btn.disabled = true;
            
            // Simular carga
            setTimeout(() => {
                icon.classList.remove('spin-animation');
                btn.disabled = false;
                mostrarToast('info', 'Actualizado', 'Lista de solicitudes actualizada.');
            }, 1000);
            
            // Aquí se haría la llamada AJAX al backend para obtener nuevas solicitudes
            console.log('Actualizando solicitudes...');
        }

        // Helper para obtener icono por nombre de archivo
        function getFileIconByName(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const iconMap = {
                'png': 'bi-file-earmark-image',
                'jpg': 'bi-file-earmark-image',
                'jpeg': 'bi-file-earmark-image',
                'gif': 'bi-file-earmark-image',
                'pdf': 'bi-file-earmark-pdf',
                'doc': 'bi-file-earmark-word',
                'docx': 'bi-file-earmark-word',
                'xls': 'bi-file-earmark-excel',
                'xlsx': 'bi-file-earmark-excel',
                'txt': 'bi-file-earmark-text',
                'zip': 'bi-file-earmark-zip',
                'rar': 'bi-file-earmark-zip'
            };
            return iconMap[ext] || 'bi-file-earmark';
        }

        // Mostrar toast de notificación mejorado
        function mostrarToast(tipo, titulo, mensaje) {
            const toastContainer = document.getElementById('toastContainer');
            
            const icons = {
                success: 'bi-check-circle-fill',
                error: 'bi-x-circle-fill',
                warning: 'bi-exclamation-triangle-fill',
                info: 'bi-info-circle-fill'
            };
            
            const toastId = 'toast-' + Date.now();
            
            const toastHTML = `
                <div class="toast-custom ${tipo}" id="${toastId}" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-icon">
                        <i class="bi ${icons[tipo] || icons.info}"></i>
                    </div>
                    <div class="toast-content">
                        <div class="toast-title">${titulo}</div>
                        <div class="toast-message">${mensaje}</div>
                    </div>
                    <button class="toast-close" onclick="closeToast('${toastId}')" aria-label="Cerrar">
                        <i class="bi bi-x-lg"></i>
                    </button>
                    <div class="toast-progress"></div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHTML);
            
            // Auto-remover después de 4 segundos
            setTimeout(() => {
                closeToast(toastId);
            }, 4000);
        }
        
        // Cerrar toast con animación
        function closeToast(toastId) {
            const toast = document.getElementById(toastId);
            if (toast) {
                toast.classList.add('toast-exit');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }
        }

        // Agregar estilos de animación para el spinner
        document.head.insertAdjacentHTML('beforeend', `
            <style>
                .spin-animation {
                    animation: spin 1s linear infinite;
                }
                @keyframes spin {
                    from { transform: rotate(0deg); }
                    to { transform: rotate(360deg); }
                }
            </style>
        `);

        // ========================================
        // SISTEMA DE NOTIFICACIONES EN TIEMPO REAL
        // ========================================

        // Datos de notificaciones (se cargan desde la API)
        let notificationsData = [];

        // Inicializar notificaciones
        document.addEventListener('DOMContentLoaded', function() {
            renderNotifications();
            
            // TODO: Implementar carga de notificaciones desde API
            // cargarNotificacionesDesdeAPI();
        });

        // Renderizar notificaciones
        function renderNotifications() {
            const list = document.getElementById('notificationsList');
            const unreadCount = notificationsData.filter(n => n.unread).length;
            
            // Actualizar contadores
            document.getElementById('unreadCount').textContent = unreadCount;
            const desktopBadge = document.getElementById('notifBadgeDesktop');
            const mobileBadge = document.getElementById('notifBadgeMobile');
            
            if (desktopBadge) desktopBadge.textContent = unreadCount;
            if (mobileBadge) mobileBadge.textContent = unreadCount;
            
            // Ocultar badges si no hay notificaciones
            if (unreadCount === 0) {
                if (desktopBadge) desktopBadge.style.display = 'none';
                if (mobileBadge) mobileBadge.style.display = 'none';
            } else {
                if (desktopBadge) desktopBadge.style.display = 'flex';
                if (mobileBadge) mobileBadge.style.display = 'flex';
            }
            
            // Renderizar lista
            list.innerHTML = notificationsData.map(n => `
                <div class="notification-item ${n.unread ? 'unread' : ''}" onclick="handleNotificationClick(${n.id})">
                    <div class="notification-icon ${n.type}">
                        <i class="bi ${getNotificationIcon(n.type)}"></i>
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">${n.title}</div>
                        <div class="notification-text">${n.text}</div>
                        <div class="notification-time">${n.time}</div>
                    </div>
                </div>
            `).join('');
        }

        // Obtener icono según tipo de notificación
        function getNotificationIcon(type) {
            const icons = {
                'new-ticket': 'bi-ticket-fill',
                'response': 'bi-chat-dots-fill',
                'urgent': 'bi-exclamation-triangle-fill',
                'assigned': 'bi-person-fill-add',
                'closed': 'bi-check-circle-fill'
            };
            return icons[type] || 'bi-bell-fill';
        }

        // Toggle panel de notificaciones
        function toggleNotifications() {
            const panel = document.getElementById('notificationsPanel');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        }

        // Click en notificación
        function handleNotificationClick(id) {
            const notif = notificationsData.find(n => n.id === id);
            if (notif) {
                notif.unread = false;
                renderNotifications();
                // Aquí se navegaría al ticket correspondiente
                console.log('Navegando a notificación:', id);
            }
            toggleNotifications();
        }

        // Marcar todas como leídas
        function markAllAsRead() {
            notificationsData.forEach(n => n.unread = false);
            renderNotifications();
            // Si el modal está abierto, actualizar también
            const allNotificationsList = document.getElementById('allNotificationsList');
            if (allNotificationsList && allNotificationsList.innerHTML !== '') {
                renderAllNotifications();
            }
            mostrarToast('success', 'Notificaciones', 'Todas las notificaciones marcadas como leídas');
        }

        // Reproducir sonido de notificación
        function playNotificationSound() {
            // Se puede agregar un sonido aquí si el usuario lo tiene habilitado
            console.log('🔔 Nueva notificación');
        }

        // Ver todas las notificaciones
        function showAllNotifications() {
            toggleNotifications();
            renderAllNotifications();
            const modal = new bootstrap.Modal(document.getElementById('allNotificationsModal'));
            modal.show();
        }

        // Renderizar todas las notificaciones en el modal
        function renderAllNotifications(filter = 'all') {
            const list = document.getElementById('allNotificationsList');
            let filteredNotifications = [...notificationsData];
            
            // Aplicar filtro
            if (filter === 'unread') {
                filteredNotifications = filteredNotifications.filter(n => n.unread);
            } else if (filter === 'ticket') {
                filteredNotifications = filteredNotifications.filter(n => ['new-ticket', 'assigned', 'closed'].includes(n.type));
            } else if (filter === 'system') {
                filteredNotifications = filteredNotifications.filter(n => n.type === 'assigned');
            } else if (filter === 'alert') {
                filteredNotifications = filteredNotifications.filter(n => n.type === 'urgent');
            }
            
            if (filteredNotifications.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-bell-slash fs-1 mb-3 d-block"></i>
                        <p class="mb-0">No hay notificaciones para mostrar</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = filteredNotifications.map(n => `
                <div class="notification-item ${n.unread ? 'unread' : ''}" onclick="handleNotificationClickFromModal(${n.id})" style="cursor: pointer; padding: 1rem; border-bottom: 1px solid rgba(0,0,0,0.05);">
                    <div class="d-flex align-items-start gap-3">
                        <div class="notification-icon ${n.type}" style="width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <i class="bi ${getNotificationIcon(n.type)}"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="fw-semibold ${n.unread ? 'text-brand-dark' : 'text-muted'}">${n.title}</div>
                                    <div class="small ${n.unread ? 'text-dark' : 'text-muted'}">${n.text}</div>
                                </div>
                                ${n.unread ? '<span class="badge bg-danger rounded-pill" style="font-size: 0.65rem;">Nueva</span>' : ''}
                            </div>
                            <div class="text-muted small mt-1">
                                <i class="bi bi-clock me-1"></i>${n.time}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Actualizar paginación
            document.getElementById('notificationsPagination').textContent = 
                `Mostrando ${filteredNotifications.length} de ${notificationsData.length}`;
        }

        // Filtrar notificaciones en el modal
        function filterAllNotifications(filter) {
            // Actualizar botones activos
            document.querySelectorAll('#allNotificationsModal [data-filter]').forEach(btn => {
                btn.classList.remove('active', 'btn-primary');
                btn.classList.add('btn-outline-secondary');
            });
            const activeBtn = document.querySelector(`#allNotificationsModal [data-filter="${filter}"]`);
            if (activeBtn) {
                activeBtn.classList.remove('btn-outline-secondary');
                activeBtn.classList.add('active', 'btn-primary');
            }
            
            renderAllNotifications(filter);
        }

        // Click en notificación desde el modal
        function handleNotificationClickFromModal(id) {
            const notif = notificationsData.find(n => n.id === id);
            if (notif) {
                notif.unread = false;
                renderNotifications();
                renderAllNotifications();
            }
            mostrarToast('info', 'Notificación', `Abriendo: ${notif.title}`);
        }

        // Limpiar todas las notificaciones
        function clearAllNotifications() {
            if (confirm('¿Estás seguro de que deseas eliminar todas las notificaciones?')) {
                notificationsData = [];
                renderNotifications();
                renderAllNotifications();
                mostrarToast('success', 'Notificaciones', 'Todas las notificaciones han sido eliminadas');
            }
        }

        // Cambiar página de notificaciones
        function changeNotificationPage(direction) {
            // Implementación de paginación si es necesaria
            console.log('Cambiar página:', direction);
        }

        // Cerrar panel al hacer click fuera
        document.addEventListener('click', function(e) {
            const panel = document.getElementById('notificationsPanel');
            const isClickInside = panel.contains(e.target) || 
                                  e.target.closest('.notification-badge-btn');
            if (!isClickInside && panel.style.display === 'block') {
                panel.style.display = 'none';
            }
        });

        // ========================================
        // BASE DE CONOCIMIENTO
        // ========================================

        function openKBCategory(category) {
            const modal = new bootstrap.Modal(document.getElementById('knowledgeBaseModal'));
            modal.show();
            // Aquí se podría filtrar por categoría
            console.log('Abriendo categoría KB:', category);
        }

        function openKBArticle(articleId) {
            // Aquí se cargaría el artículo completo
            console.log('Abriendo artículo:', articleId);
            mostrarToast('info', 'Base de Conocimiento', 'Cargando artículo...');
        }

        // ========================================
        // HISTORIAL Y AUDITORÍA
        // ========================================

        // Datos de auditoría (se cargan desde la API)
        const auditData = {};

        // TODO: Implementar carga de auditoría desde API
        // function cargarAuditoriaDesdeAPI(ticketId) { ... }

        function showAuditHistory(ticketId) {
            document.getElementById('auditTicketId').textContent = '#' + ticketId;
            
            const timeline = document.getElementById('auditTimelineContent');
            const data = auditData[ticketId] || [];
            
            timeline.innerHTML = data.map(item => `
                <div class="audit-item action-${item.type}">
                    <div class="audit-time">${item.time}</div>
                    <div class="audit-action">${item.action}</div>
                    <div class="audit-user">por ${item.user}</div>
                    ${item.details ? `<div class="audit-details">${item.details}</div>` : ''}
                </div>
            `).join('');
            
            const modal = new bootstrap.Modal(document.getElementById('auditHistoryModal'));
            modal.show();
        }

        function exportAuditHistory() {
            mostrarToast('info', 'Exportando', 'El historial se descargará en breve...');
            console.log('Exportando historial de auditoría');
        }

        // ========================================
        // RESPUESTAS PREDEFINIDAS
        // ========================================

        // Datos de respuestas predefinidas
        const quickRepliesData = {
            'saludo': 'Hola $nombre, gracias por contactarnos. Mi nombre es $operador y estaré ayudándote con tu solicitud. ¿En qué puedo asistirte?',
            'seguimiento': 'Para poder ayudarte mejor, necesito que me proporciones la siguiente información:\n\n1. Tu nombre de usuario\n2. Una descripción detallada del problema\n3. Cualquier mensaje de error que hayas recibido',
            'password': 'Hemos enviado un enlace de recuperación a tu correo electrónico registrado. Por favor revisa tu bandeja de entrada y también la carpeta de spam. El enlace es válido por 24 horas.',
            'escalado': 'Tu caso ha sido escalado a nuestro equipo de soporte técnico especializado. Un experto se pondrá en contacto contigo en las próximas 2 horas.',
            'resuelto': 'Me alegra que hayamos podido resolver tu problema. Si tienes alguna otra consulta, no dudes en contactarnos. ¡Que tengas un excelente día! 😊',
            'pago': 'Entendemos tu preocupación respecto al pago. Hemos verificado en nuestro sistema y encontramos que la transacción fue procesada correctamente. Si tienes alguna duda adicional, con gusto te ayudamos.'
        };

        function toggleQuickReplies() {
            const panel = document.getElementById('quickRepliesInline');
            panel.classList.toggle('show');
        }
        
        function toggleQuickRepliesDesktop() {
            const panel = document.getElementById('quickRepliesInlineDesktop');
            panel.classList.toggle('show');
        }

        function insertQuickReply(text) {
            const input = document.getElementById('chatMessageInput');
            input.value = text;
            input.focus();
            toggleQuickReplies();
        }

        function selectQuickReply(key) {
            const text = quickRepliesData[key] || '';
            // Reemplazar variables
            const finalText = text
                .replace('$nombre', 'Usuario')
                .replace('$operador', 'María')
                .replace('$ticket_id', '#1001')
                .replace('$fecha', new Date().toLocaleDateString());
            
            insertQuickReply(finalText);
            
            // Cerrar modal si está abierto
            const modal = bootstrap.Modal.getInstance(document.getElementById('quickRepliesModal'));
            if (modal) modal.hide();
        }

        function saveQuickReply() {
            const title = document.getElementById('newReplyTitle').value;
            const content = document.getElementById('newReplyContent').value;
            const category = document.getElementById('newReplyCategory').value;
            
            if (!title || !content) {
                alert('Por favor completa todos los campos requeridos.');
                return;
            }
            
            // Aquí se guardaría en el backend
            console.log('Guardando respuesta:', { title, content, category });
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('newQuickReplyModal'));
            if (modal) modal.hide();
            
            // Limpiar formulario
            document.getElementById('newReplyTitle').value = '';
            document.getElementById('newReplyContent').value = '';
            
            mostrarToast('success', 'Guardado', 'Respuesta predefinida creada exitosamente');
        }

        function sendChatMessage() {
            // Llamar a la función enviarMensaje() de ticket-chat.js
            // que guarda el mensaje en la base de datos
            if (typeof enviarMensaje === 'function') {
                enviarMensaje();
            } else {
                console.error('Función enviarMensaje() no está disponible');
            }
        }

        // Cargar tema guardado al inicializar
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedTheme();
        });

        // ============================================
        // SISTEMA DE TEMAS (Dark Mode)
        // ============================================
        
        function changeTheme(theme) {
            if (theme === 'auto') {
                // Detectar preferencia del sistema
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
            } else {
                document.documentElement.setAttribute('data-theme', theme);
            }
            
            // Guardar preferencia
            localStorage.setItem('theme', theme);
            
            mostrarToast('success', 'Tema actualizado', `Tema ${theme === 'dark' ? 'oscuro' : theme === 'light' ? 'claro' : 'automático'} aplicado`);
        }
        
        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            const themeSelector = document.getElementById('themeSelector');
            
            if (themeSelector) {
                themeSelector.value = savedTheme;
            }
            
            if (savedTheme === 'auto') {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
            } else {
                document.documentElement.setAttribute('data-theme', savedTheme);
            }
        }
        
        // Escuchar cambios en la preferencia del sistema
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'auto') {
                document.documentElement.setAttribute('data-theme', e.matches ? 'dark' : 'light');
            }
        });

        // ============================================
        // MODALES DE CONFIRMACIÓN
        // ============================================
        
        function showConfirmModal(options) {
            const { type = 'warning', title, message, confirmText = 'Confirmar', cancelText = 'Cancelar', onConfirm } = options;
            
            const icons = {
                warning: 'bi-exclamation-triangle-fill',
                danger: 'bi-x-circle-fill',
                success: 'bi-check-circle-fill',
                info: 'bi-info-circle-fill'
            };
            
            const confirmBtnClass = type === 'danger' ? 'btn-danger' : 'btn-primary';
            
            const modalHTML = `
                <div class="modal fade confirm-modal" id="confirmModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered modal-sm">
                        <div class="modal-content border-0 shadow">
                            <div class="modal-body">
                                <div class="confirm-icon ${type}">
                                    <i class="bi ${icons[type]}"></i>
                                </div>
                                <h5 class="confirm-title">${title}</h5>
                                <p class="confirm-message">${message}</p>
                                <div class="confirm-actions">
                                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">${cancelText}</button>
                                    <button type="button" class="btn ${confirmBtnClass}" id="confirmModalBtn">${confirmText}</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remover modal anterior si existe
            const existingModal = document.getElementById('confirmModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            const modalElement = document.getElementById('confirmModal');
            const modal = new bootstrap.Modal(modalElement);
            
            document.getElementById('confirmModalBtn').addEventListener('click', function() {
                modal.hide();
                if (onConfirm) onConfirm();
            });
            
            modalElement.addEventListener('hidden.bs.modal', function() {
                modalElement.remove();
            });
            
            modal.show();
        }

        // ============================================
        // SKELETON LOADERS
        // ============================================
        
        function showSkeletonLoader(containerId, count = 3) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            let skeletonHTML = '';
            for (let i = 0; i < count; i++) {
                skeletonHTML += `
                    <div class="skeleton-card mb-3">
                        <div class="d-flex align-items-center">
                            <div class="skeleton skeleton-icon me-3"></div>
                            <div class="flex-grow-1">
                                <div class="skeleton skeleton-title"></div>
                                <div class="skeleton skeleton-value"></div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = skeletonHTML;
        }
        
        function hideSkeletonLoader(containerId, content) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = content;
        }

        // ============================================
        // EMPTY STATES
        // ============================================
        
        function showEmptyState(containerId, options) {
            const { icon = 'bi-inbox', title = 'No hay datos', message = '', actionText = '', onAction = null } = options;
            
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const actionButton = actionText ? `<button class="empty-state-action btn-ripple" onclick="${onAction}">${actionText}</button>` : '';
            
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="bi ${icon}"></i>
                    </div>
                    <h5 class="empty-state-title">${title}</h5>
                    <p class="empty-state-text">${message}</p>
                    ${actionButton}
                </div>
            `;
        }

        // ============================================
        // ADMINISTRATION TAB FUNCTIONS
        // ============================================
        
        // Search users in the admin table and mobile cards
        function searchUsers() {
            const searchInput = document.getElementById('searchUsers');
            const filter = searchInput.value.toLowerCase();
            
            // Search in desktop table
            const table = document.querySelector('.table-hover tbody');
            if (table) {
                const rows = table.getElementsByTagName('tr');
                
                for (let i = 0; i < rows.length; i++) {
                    const nameCell = rows[i].getElementsByTagName('td')[0];
                    const emailCell = rows[i].getElementsByTagName('td')[2];
                    const roleCell = rows[i].getElementsByTagName('td')[1];
                    
                    if (nameCell && emailCell && roleCell) {
                        const nameText = nameCell.textContent || nameCell.innerText;
                        const emailText = emailCell.textContent || emailCell.innerText;
                        const roleText = roleCell.textContent || roleCell.innerText;
                        
                        if (nameText.toLowerCase().indexOf(filter) > -1 || 
                            emailText.toLowerCase().indexOf(filter) > -1 || 
                            roleText.toLowerCase().indexOf(filter) > -1) {
                            rows[i].style.display = '';
                        } else {
                            rows[i].style.display = 'none';
                        }
                    }
                }
            }
            
            // Search in mobile cards
            const mobileCards = document.getElementById('usersCardsMobile');
            if (mobileCards) {
                const cards = mobileCards.querySelectorAll('.card');
                
                cards.forEach(card => {
                    const cardText = card.textContent || card.innerText;
                    
                    if (cardText.toLowerCase().indexOf(filter) > -1) {
                        card.style.display = '';
                    } else {
                        card.style.display = 'none';
                    }
                });
            }
        }
        
        // Add new user modal
        function addNewUser() {
            const newUserModal = new bootstrap.Modal(document.getElementById('newUserModal'));
            newUserModal.show();
        }
        
        // Edit user
        function editUser(userId) {
            // Load user data based on userId (in real implementation, fetch from API)
            const userModal = new bootstrap.Modal(document.getElementById('editUserModal'));
            userModal.show();
        }
        
        // View user activity
        function viewUserActivity(userName) {
            const activityModal = new bootstrap.Modal(document.getElementById('userActivityModal'));
            document.getElementById('activityUserName').textContent = userName;
            activityModal.show();
        }
        
        // Toggle user status
        function toggleUserStatus(userId, currentStatus) {
            const action = currentStatus === 'active' ? 'desactivar' : 'activar';
            if (confirm(`¿Estás seguro de que deseas ${action} este usuario?`)) {
                // In a real implementation, make API call to toggle status
                console.log(`Toggle user ${userId} status`);
                // Reload user table or update UI
                location.reload();
            }
        }
        
        // Save new user
        function saveNewUser() {
            // Validate form and make API call
            console.log('Saving new user...');
            alert('Usuario creado correctamente');
            const modal = bootstrap.Modal.getInstance(document.getElementById('newUserModal'));
            modal.hide();
            // Reload user table
        }
        
        // Save user changes
        function saveUserChanges() {
            console.log('Saving user changes...');
            alert('Cambios guardados correctamente');
            const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
            modal.hide();
            // Reload user table
        }
        
        // Reset user password
        function resetUserPassword() {
            if (confirm('¿Enviar email con nueva contraseña temporal al usuario?')) {
                console.log('Resetting password...');
                alert('Se ha enviado un email al usuario con la nueva contraseña');
            }
        }
        
        // Export user activity
        function exportUserActivity() {
            console.log('Exporting user activity...');
            alert('Descargando actividad del usuario...');
        }
        
        // Save new role
        function saveNewRole() {
            console.log('Saving new role...');
            alert('Rol creado correctamente');
            const modal = bootstrap.Modal.getInstance(document.getElementById('newRoleModal'));
            modal.hide();
        }
        
        // Filter audit log
        function filterAuditLog() {
            const userFilter = document.getElementById('auditUserFilter').value.toLowerCase();
            const actionFilter = document.getElementById('auditActionFilter').value.toLowerCase();
            const auditItems = document.querySelectorAll('.audit-item');
            
            auditItems.forEach(item => {
                const auditText = item.textContent.toLowerCase();
                
                const matchesUser = !userFilter || auditText.includes(userFilter);
                const matchesAction = !actionFilter || actionFilter === 'all' || auditText.includes(actionFilter);
                
                if (matchesUser && matchesAction) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        // Edit role permissions
        function editRole(roleId) {
            alert('Editar permisos del rol: ' + roleId);
        }

        // Cargar lista de operadores en el dropdown
        function cargarOperadoresAsignacion() {
            const selectOperadores = document.getElementById('ticketOperadorAsignado');
            if (!selectOperadores) return;

            // Usar window.operadores si está disponible
            if (window.operadores && window.operadores.length > 0) {
                selectOperadores.innerHTML = '<option value="">-- Seleccionar operador --</option>';
                window.operadores.forEach(operador => {
                    const option = document.createElement('option');
                    option.value = operador.id_operador || operador.id;
                    option.textContent = operador.nombre;
                    selectOperadores.appendChild(option);
                });
            } else {
                // Si no está disponible, intentar cargar del API con token JWT
                const token = localStorage.getItem('access_token') || sessionStorage.getItem('access_token');
                fetch('/api/operadores', {
                    headers: {
                        'Authorization': token ? `Bearer ${token}` : ''
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        selectOperadores.innerHTML = '<option value="">-- Seleccionar operador --</option>';
                        const operadores = data.operadores || data.data || [];
                        if (Array.isArray(operadores)) {
                            operadores.forEach(operador => {
                                const option = document.createElement('option');
                                option.value = operador.id_operador || operador.id;
                                option.textContent = operador.nombre;
                                selectOperadores.appendChild(option);
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error cargando operadores:', error);
                    });
            }
        }

        // Llamar al cargar la página y cuando se abre el modal de nuevo ticket
        document.addEventListener('DOMContentLoaded', function() {
            cargarOperadoresAsignacion();

            const newTicketModal = document.getElementById('newTicketModal');
            if (newTicketModal) {
                newTicketModal.addEventListener('show.bs.modal', cargarOperadoresAsignacion);
            }
        });
    </script>
    <script src="{{ url_for('static', filename='js/features.js') }}"></script>
</body>
</html>